# CORE_NEW: Проектирование ядра системы

## Миссия

**Eldoleado — CRM с единым клиентом.**

Все каналы коммуникации (telegram, whatsapp, vk, avito, звонки, визиты) привязаны к одному клиенту. Все касания отслеживаются и доступны в едином контексте.

**Инструменты системы:**
- **Отслеживание касаний** — каждое взаимодействие = touchpoint
- **Единый клиент** — все каналы привязаны к одному профилю
- **Удержание** — автоматические реакции на события (не пришёл, не ответил)
- **Обогащение** — сбор данных о клиенте из разных источников
- **Социальные связи** — граф связей между клиентами (семья, друзья, рефералы)

---

## Философия

**Всё есть касание (touchpoint).** Клиент взаимодействует с сервисом через касания — сообщения, звонки, визиты, промо.

**Устройства — центр системы.** Вся история, все проблемы, все касания привязаны к устройству (для ремонтных вертикалей).

**Контекст общий.** Если Иван принёс телефон жены — вся история по этому телефону доступна и Ивану, и жене.

**Граф хранит связи**, PostgreSQL хранит данные.

**Социальные связи = рост.** Друг привёл друга → связь в графе → потенциал для реферальных программ.

---

## Архитектура ядра

```
┌─────────────────────────────────────────────────────────────────┐
│                     ВХОДЯЩЕЕ СООБЩЕНИЕ                          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                   БЛОК КОНТЕКСТА                                │
│  ─────────────────────────────────────────────────────────────  │
│  1. Извлекает сущности из сообщения                            │
│  2. Сверяет с графом: есть ли уже?                             │
│  3. Определяет/уточняет ФОКУС диалога                          │
│  4. Достраивает ЛИНИЮ в графе                                  │
│                                                                 │
│  Цель: собрать полный пазл линии                               │
│  Клиент → Тип обращения → [Устройство] → [Тип ремонта] → [Поломка] │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                         ГРАФ                                    │
│  ─────────────────────────────────────────────────────────────  │
│  Хранит ВСЕ знания:                                            │
│  - Устройства (текущие и прошлые)                              │
│  - Проблемы (активные и решённые)                              │
│  - Связи между людьми (жена, сын, друг)                        │
│  - Связи людей с устройствами (владелец, принёс, пользуется)   │
│  - История взаимодействий                                       │
│                                                                 │
│  Каждое касание привязано к устройству                         │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      ОРКЕСТРАТОР                                │
│  ─────────────────────────────────────────────────────────────  │
│  Знает что делать дальше:                                      │
│  - Линия неполная → задать уточняющий вопрос                   │
│  - Линия полная → рассчитать стоимость / записать на ремонт    │
│  - Нужно уточнение → "Это тот же iPhone или новый?"            │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    [EventStore - будущее]                       │
│  ─────────────────────────────────────────────────────────────  │
│  Внешние события: клиент не пришёл, мастер заболел             │
│  Планы реакций на события                                       │
└─────────────────────────────────────────────────────────────────┘
```

---

## Ключевые концепции

### ЛИНИЯ в графе

Линия — это путь от клиента до конкретной проблемы. Цель Блока Контекста — собрать полную линию.

**Тип "ремонт":**
```
Client ──→ Request(ремонт) ──→ Device ──→ RepairType ──→ Issue
  │            │                  │            │           │
  │            │                  │            │           └── "не работает Face ID"
  │            │                  │            └── "замена модуля"
  │            │                  └── "iPhone 14 Pro (мой)"
  │            └── тип обращения
  └── Иван
```

**Тип "консультация":**
```
Client ──→ Request(консультация) ──→ Topic
                                       └── "сколько стоит ремонт экрана"
```

**Тип "покупка":**
```
Client ──→ Request(покупка) ──→ Item
                                  └── "чехол на iPhone 14"
```

### ФОКУС диалога

Фокус — это текущая точка внимания в диалоге.

```javascript
focus: {
  client_id: "...",
  request_type: "repair",
  device_id: "...",        // текущее устройство
  repair_type_id: null,    // ещё не выяснили
  issue_id: null           // ещё не выяснили
}
```

### Общий контекст устройства

Устройство — центр. Все касания по устройству видны всем связанным людям.

```
┌─────────────────────────────────────────────────────────────────┐
│                     DEVICE (iPhone 13)                          │
│  ─────────────────────────────────────────────────────────────  │
│  owner: Мария                                                   │
│  связан: Иван (муж) - принёс на ремонт                         │
│                                                                 │
│  ВСЯ ИСТОРИЯ ПО УСТРОЙСТВУ (независимо кто писал):             │
│  ├── [Иван] "у жены iPhone 13 разбит экран"                    │
│  ├── [Бот → Иван] "Оригинал или копия дисплея?"                │
│  ├── [Иван] "жена сама выберет"                                │
│  ├── [Бот → Мария] "Муж принёс ваш iPhone 13. Какой дисплей?"  │
│  └── [Мария] "копию поставьте"                                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**Сценарий:**
```
Мария пишет: "Алло, это по поводу айфона"

Блок контекста:
1. Клиент = Мария
2. Ищем в графе устройства Марии:
   - iPhone 13 (owner)
   - Активная проблема: экран
   - Последний контекст: Иван спрашивал про дисплей, ждём выбор

3. Фокус автоматически на iPhone 13 + проблема "экран"

4. Контекст из ВСЕХ касаний по этому устройству:
   - Иван сказал "жена сама выберет"
   - Вопрос про дисплей открыт

Ответ: "Здравствуйте, Мария! Да, муж принёс ваш iPhone 13.
        Какой дисплей ставить — оригинал (25000р) или копия (12000р)?"
```

---

## Связи между людьми и устройствами

### Граф связей

```
                    Device (iPhone 13)
                           │
          ┌────────────────┼────────────────┐
          │                │                │
    [:OWNED_BY]      [:BROUGHT_BY]    [:HAS_TOUCHPOINT]
          │                │                │
          ▼                ▼                ▼
       Мария            Иван          Touchpoints[]
       (owner)        (accessor)           │
          │                │               │
          └───[:SPOUSE]────┘    из чатов обоих
```

### Типы связей клиент-клиент

- `SPOUSE` — супруг/супруга
- `PARENT` — родитель
- `CHILD` — ребёнок
- `FRIEND` — друг
- `COLLEAGUE` — коллега

### Типы связей клиент-устройство

- `OWNS` — владелец (основная связь)
- `BROUGHT_FOR_REPAIR` — принёс на ремонт (не владелец)
- `MANAGES` — управляет (например, IT для корпоративных)
- `USES` — пользуется (но не владеет)

---

## UI/UX: Client-centric подход

**Было (appeal-centric):**
```
Список заявок → Заявка → Устройство + Сообщения
```

**Стало (client-centric):**
```
Список клиентов → Клиент → Устройства + Связи + История
```

**Экран клиента:**
```
┌─ Клиент: Иван ────────────────────────────────┐
│                                                │
│  Устройства:                                   │
│  ┌────────────────────────────────────────┐   │
│  │ 📱 iPhone 14 Pro (мой)                 │   │
│  │    └─ Экран разбит [В РАБОТЕ]          │   │
│  ├────────────────────────────────────────┤   │
│  │ 📱 iPhone 13 (жена)                    │   │
│  │    └─ Экран разбит [ЖДЁТ СОГЛАСИЯ]     │   │
│  │    → Владелец: Мария (перейти)         │   │
│  └────────────────────────────────────────┘   │
│                                                │
│  Связи:                                        │
│  👫 Мария (жена) - 1 устройство               │
│                                                │
│  История (чат):                                │
│  └─ [объединённый чат по всем устройствам]    │
│                                                │
└────────────────────────────────────────────────┘
```

**У связанного клиента (Мария):**
```
┌─ Клиент: Мария ───────────────────────────────┐
│                                                │
│  Устройства:                                   │
│  ┌────────────────────────────────────────┐   │
│  │ 📱 iPhone 13 (мой)                     │   │
│  │    └─ Экран разбит [ЖДЁТ СОГЛАСИЯ]     │   │
│  │    → Принёс: Иван (муж)                │   │
│  └────────────────────────────────────────┘   │
│                                                │
│  Связи:                                        │
│  👫 Иван (муж) - 2 устройства                 │
│                                                │
└────────────────────────────────────────────────┘
```

---

## Изменение парадигмы

```
БЫЛО:  Клиент → Обращение → Устройство → Сообщения
                    ↑
              привязка тут

СТАЛО: Устройство → Проблема → Касания (от разных людей)
            ↑
      центр всего

      Клиенты связаны С УСТРОЙСТВОМ, не друг с другом напрямую
```

---

## Принятые решения

### R1: Цели обращений (intent)

На MVP поддерживаем:
- [x] **REPAIR** — ремонт устройства
- [x] **PURCHASE** — покупка товара/услуги
- [x] **SALE** — клиент хочет что-то продать
- [x] **QUESTION** — вопрос (график работы, цены, наличие)
- [x] **SPAM** — спам/реклама
- [x] **UNCLEAR** — непонятно, требует уточнения

> **Примечание:** "Консультация" = QUESTION. Если клиент спрашивает "сколько стоит ремонт экрана" — это QUESTION, не требует устройства в фокусе.

### R2: Воронка (MVP)

Фиксированный пресет для вертикали "ремонт телефонов":

```
NEW → QUOTED → SCHEDULED → RECEIVED → IN_PROGRESS → READY → DELIVERED
                                                      ↓
                                                  CANCELLED
```

| Статус | Описание |
|--------|----------|
| NEW | Новое обращение, проблема выявлена |
| QUOTED | Озвучена стоимость |
| SCHEDULED | Клиент записан на визит |
| RECEIVED | Устройство принято в работу |
| IN_PROGRESS | Ремонт выполняется |
| READY | Готово к выдаче |
| DELIVERED | Выдано клиенту |
| CANCELLED | Отменено на любом этапе |

### R3: Определение владельца устройства

1. **По умолчанию:** кто написал про устройство = владелец
2. **Если указано иначе:** "телефон сына" → ищем связь "сын" в графе
   - Если найден → передаём владение
   - Если не найден → создаём placeholder, уточняем позже
3. **Связанные клиенты:** видят ВСЕ устройства своей "сети"

### R4: Android UI (Client-centric)

**Экран 1: Список клиентов**
```
┌─────────────────────────────────────┐
│ 🔍 Поиск                            │
├─────────────────────────────────────┤
│ Иван Петров                         │
│ 📱 2 устройства  ⚠️ 1 проблема      │
│ 💬 telegram, whatsapp               │
├─────────────────────────────────────┤
│ Мария Сидорова                      │
│ 📱 1 устройство  ⚠️ 1 проблема      │
│ 💬 telegram                         │
└─────────────────────────────────────┘
```

**Экран 2: Карточка клиента**
```
┌─────────────────────────────────────┐
│ ← Иван Петров                       │
├─────────────────────────────────────┤
│ УСТРОЙСТВА:                         │
│ ┌─────────────────────────────────┐ │
│ │ ★ iPhone 14 Pro [В ФОКУСЕ]      │ │
│ │   └─ Экран [В РАБОТЕ]           │ │
│ ├─────────────────────────────────┤ │
│ │   iPhone 13 (жена)              │ │
│ │   └─ Экран [ЖДЁТ]               │ │
│ │   → Владелец: Мария             │ │
│ └─────────────────────────────────┘ │
├─────────────────────────────────────┤
│ СВЯЗИ: 👫 Мария (жена)              │
├─────────────────────────────────────┤
│ ЧАТ: [объединённый по устройствам]  │
│ ...                                 │
└─────────────────────────────────────┘
```

**Экран 3: Карточка устройства**
```
┌─────────────────────────────────────┐
│ ← iPhone 14 Pro                     │
├─────────────────────────────────────┤
│ Владелец: Иван Петров               │
│ Принёс: —                           │
├─────────────────────────────────────┤
│ ПРОБЛЕМЫ:                           │
│ ├─ Экран разбит [В РАБОТЕ]          │
│ │  Стоимость: 15000₽                │
│ │  Статус: IN_PROGRESS              │
│ └─ Face ID [РЕШЕНО 12.11.2024]      │
├─────────────────────────────────────┤
│ ИСТОРИЯ КАСАНИЙ:                    │
│ [все сообщения по этому устройству] │
└─────────────────────────────────────┘
```

---

## Следующие шаги

1. [x] Описать архитектуру ядра
2. [x] Описать концепцию линий и фокуса
3. [x] Описать связи между людьми и устройствами
4. [x] Ответить на открытые вопросы (см. Принятые решения)
5. [ ] Спроектировать схему PostgreSQL → `02_POSTGRESQL_SCHEMA.md`
6. [ ] Спроектировать схему Neo4j → `03_NEO4J_SCHEMA.md`
7. [ ] Определить API контракты → `04_API_CONTRACTS.md`
8. [ ] Переписать Core workflows
