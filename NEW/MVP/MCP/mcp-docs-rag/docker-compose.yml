version: '3.8'

services:
  mcp-docs-rag:
    build: .
    container_name: mcp-docs-rag
    ports:
      - "8090:8090"
    environment:
      - DATABASE_URL=postgresql://supabase_admin:Mi31415926pS@185.221.214.83:6544/postgres
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - DOCS_PATH=/app/docs
    volumes:
      # Mount Plans folder as docs
      - ../../Plans:/app/docs:ro
      # Mount flow docs
      - ../../docs/flows:/app/docs/flows:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8090/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Optional: Run indexer periodically
  indexer:
    build: .
    container_name: mcp-docs-indexer
    environment:
      - DATABASE_URL=postgresql://supabase_admin:Mi31415926pS@185.221.214.83:6544/postgres
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - DOCS_PATH=/app/docs
    volumes:
      - ../../Plans:/app/docs:ro
    command: ["python", "indexer.py"]
    profiles:
      - indexer  # Only run when explicitly requested
