# ELO Product Roadmap

> Стратегия: Заходим с козырей. Не MVP, а полноценный вертикальный продукт с максимальным WOW-эффектом.

**Последнее обновление:** 2025-12-10

---

## Вертикаль MVP

**Домен:** Сервис телефонов = Ремонт + Покупка/Продажа (trade-in, б/у)

**Философия:** "Люди общаются. Машина ведёт учёт."

**Ключевой инсайт:** B2C сервис = 15 минут до решения, ответ за 1-2 минуты. amoCRM/Bitrix с канбанами на несколько дней НЕ ПОДХОДЯТ.

---

## Конкурентное преимущество

```
Конкуренты:                          ELO:
─────────────────────────────────────────────────────────
Канал = 600₽/мес                     Канал = 0₽ (смартфон-сервер)
Ручной прайс-лист                    Парсер + автоцены
Потерял звонок = потерял клиента     Звонок → Граф → Мессенджер
"Заполните форму"                    AI понимает "14ка про макс"
Ответили через 2 часа                AI ответил в 23:00
Канбан на 3 дня                      15 минут до сделки
```

---

## WOW-эффект (выбран)

**"Не теряются клиенты"**

> "Клиент написал в 23:00. Ты спал. AI ответил, записал на завтра. Сколько таких ты теряешь в месяц?"

---

## Killer Features

### 1. Смартфон-сервер (бесплатные каналы)

```
Проблема:
  WhatsApp Wappi/GreenAPI = 600₽/канал/мес
  Avito API = 1500-3000₽/мес
  MAX = платный

Решение:
  Приложение на смартфон клиента (тенанта)
  ├── Reverse-engineered WhatsApp API
  ├── Reverse-engineered MAX API
  └── Бесплатный Avito API

Архитектура:
  ┌─────────────────────────────────────────────────┐
  │  Смартфон клиента (реальный IP)                 │
  │  ├── ELO App (скрытый функционал)               │
  │  └── Локальный сервер API                       │
  └─────────────────────────────────────────────────┘
                      ↓ NAT traversal
  ┌─────────────────────────────────────────────────┐
  │  ELO Backend                                    │
  │  └── Определяет: сервер или приложение          │
  └─────────────────────────────────────────────────┘

Авторизация:
  1. Клиент вводит логин/пароль в приложении
  2. Backend определяет режим:
     - Сервер (наш) → используем платные API
     - Приложение (смартфон клиента) → используем бесплатные API

Дистрибуция:
  ├── Google Play (со скрытым функционалом)
  └── RuStore (со скрытым функционалом)

Невидимость:
  - Реальный IP смартфона
  - Реальный user-agent
  - Нет признаков автоматизации
```

**ROI для клиента:** Экономия 600-3000₽/мес на каналах

---

### 2. Умный прайс-лист с парсером

```
Источники:
  ├── Магазины запчастей (парсинг)
  └── Собственная база цен

Нормализация (чёткая, не fuzzy):
  Входные данные:
    "Дисплей айфон 12 копия олед черный"
    "Display iPhone 12 OLED Copy Black"
    "дисп. ip12 oled коп."

  Нормализованный результат:
  ┌──────────┬───────────┬──────┬──────┬─────────────┬───────┬────────────┐
  │ Тип      │ Модель    │ Тип  │ Цвет │ Производит. │ Цена  │ Магазин    │
  ├──────────┼───────────┼──────┼──────┼─────────────┼───────┼────────────┤
  │ Display  │ iPhone 12 │ OLED │ Black│ China Copy  │ 2500₽ │ MobileOpt  │
  │ Display  │ iPhone 12 │ OLED │ Black│ OEM         │ 4500₽ │ iPartsRu   │
  │ Display  │ iPhone 12 │ Orig │ Black│ Apple       │ 8500₽ │ iPartsRu   │
  └──────────┴───────────┴──────┴──────┴─────────────┴───────┴────────────┘

Категории ремонта:
  ├── АКБ (аккумулятор)
  ├── Дисплей (Original/OEM/Copy/OLED/LCD)
  ├── Задняя крышка
  ├── Шлейфа (зарядки, кнопок, камеры)
  ├── Камера (фронт/тыл)
  └── Корпусные элементы

AI подстановка:
  Клиент: "разбил экран на 12ке"
  AI: "Замена дисплея iPhone 12:
       • Копия LCD: 1800₽
       • Копия OLED: 2500₽
       • Оригинал: 8500₽
       Какой вариант рассмотрите?"
```

**ROI для клиента:** Актуальные цены без ручного обновления, быстрые ответы

---

### 3. Голос → Граф → Мессенджер

```
┌─────────────────────────────────────────────────────────┐
│ 1. ЗВОНОК                                               │
│    Клиент звонит: "Алло, у меня айфон не заряжается,    │
│    можете посмотреть? Завтра в три подойду"             │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│ 2. ЗАПИСЬ + ТРАНСКРИБАЦИЯ                               │
│    Whisper API → текст разговора                        │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│ 3. AI ИЗВЛЕЧЕНИЕ СУЩНОСТЕЙ                              │
│    ├── Устройство: iPhone (модель неизвестна)           │
│    ├── Проблема: не заряжается                          │
│    ├── Договорённость: завтра в 15:00                   │
│    └── Настроение: нейтральное                          │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│ 4. ЗАПИСЬ В ГРАФ Neo4j                                  │
│    (Client)-[:OWNS]->(Device:iPhone)                    │
│    (Device)-[:HAS_PROBLEM]->(Problem:не_заряжается)     │
│    (Client)-[:TOUCHPOINT {channel:phone, direction:in}] │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│ 5. НОВАЯ ЛИНИЯ КОНТЕКСТА                                │
│    Диалог продолжается с полным контекстом звонка       │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│ 6. ПРОДОЛЖЕНИЕ В МЕССЕНДЖЕРЕ                            │
│    AI в Telegram/WhatsApp:                              │
│    "Добрый день! Вы звонили по поводу iPhone,           │
│    который не заряжается. Ждём вас завтра в 15:00.      │
│    Напомнить за час до визита?"                         │
└─────────────────────────────────────────────────────────┘
```

**ROI для клиента:** Звонок не теряется, контекст сохраняется, допродажи через мессенджер

---

### 4. QR для идентификации клиента

```
Сценарий 1: Новый клиент в сервисе
  ┌─────────────────────────────────────────────────┐
  │ QR-код на стойке / визитке                      │
  │ → Клиент сканирует                              │
  │ → Открывается Telegram/WhatsApp                 │
  │ → Система создаёт профиль                       │
  │ → Оператор видит "новый клиент"                 │
  └─────────────────────────────────────────────────┘

Сценарий 2: Повторный клиент
  ┌─────────────────────────────────────────────────┐
  │ QR-код на стойке                                │
  │ → Клиент сканирует                              │
  │ → Система узнаёт по номеру телефона             │
  │ → Оператор видит всю историю:                   │
  │   "Иван, был 2 недели назад, менял дисплей      │
  │    на iPhone 13, гарантия до 15.01"             │
  └─────────────────────────────────────────────────┘

Сценарий 3: QR на устройстве после ремонта
  ┌─────────────────────────────────────────────────┐
  │ Наклейка с QR на телефон клиента                │
  │ → Клиент сканирует через месяц                  │
  │ → Попадает в чат с историей ремонта             │
  │ → Может задать вопрос по гарантии               │
  └─────────────────────────────────────────────────┘
```

**ROI для клиента:** Быстрая идентификация, лояльность, повторные продажи

---

### 5. Интеграции с учётными системами

```
Поддерживаемые системы:
  ├── LiveSklad
  ├── Remonline
  └── Другие по запросу

Двусторонняя синхронизация:

  ELO → Учётка:
  ┌─────────────────────────────────────────────────┐
  │ AI собрал данные из диалога:                    │
  │ • Клиент: Иван Петров, +79991234567             │
  │ • Устройство: iPhone 14 Pro Max                 │
  │ • Проблема: разбит дисплей                      │
  │ • Тип ремонта: замена дисплея                   │
  │                                                 │
  │ → Создаётся заявка в LiveSklad/Remonline        │
  │   с заполненными полями                         │
  └─────────────────────────────────────────────────┘

  Учётка → ELO:
  ┌─────────────────────────────────────────────────┐
  │ Мастер закрыл заявку:                           │
  │ • Фактический ремонт: замена дисплея + АКБ      │
  │ • Запчасти: Display OLED Copy, Battery OEM      │
  │ • Стоимость: 4500₽                              │
  │                                                 │
  │ → Данные возвращаются в ELO                     │
  │ → AI обучается на реальных ремонтах             │
  │ → Граф обогащается фактическими данными         │
  └─────────────────────────────────────────────────┘

Обучение AI:
  • Что клиенты говорят vs что реально ремонтируют
  • Какие запчасти чаще всего используются
  • Средняя стоимость по типам ремонта
```

**ROI для клиента:** Нет двойного ввода, AI становится умнее

---

### 6. Самообучение + предписанные ответы

```
Источники обучения:

1. Предписанные ответы (тенант задаёт сам):
   ┌─────────────────────────────────────────────────┐
   │ Триггер: "гарантия"                             │
   │ Ответ: "Гарантия 30 дней на работу,             │
   │        90 дней на оригинальные запчасти"        │
   ├─────────────────────────────────────────────────┤
   │ Триггер: "как добраться"                        │
   │ Ответ: "Мы находимся по адресу: ул. Ленина 15,  │
   │        вход со двора. Ориентир - красная дверь" │
   └─────────────────────────────────────────────────┘

2. Ответы операторов (подтверждённые):
   ┌─────────────────────────────────────────────────┐
   │ AI предложил ответ                              │
   │ Оператор подтвердил / исправил                  │
   │ → AI запоминает правильный вариант              │
   └─────────────────────────────────────────────────┘

3. Реальные ремонты (из учётки):
   ┌─────────────────────────────────────────────────┐
   │ Клиент сказал: "телефон глючит"                 │
   │ Реальный ремонт: замена АКБ                     │
   │ → AI учится: "глючит" часто = проблема с АКБ    │
   └─────────────────────────────────────────────────┘

4. Голосовые ответы операторов:
   ┌─────────────────────────────────────────────────┐
   │ Оператор надиктовал ответ голосом               │
   │ → Транскрибация                                 │
   │ → Нормализация (убрать "эээ", "ну")             │
   │ → Отправка клиенту                              │
   │ → Добавление в базу знаний                      │
   └─────────────────────────────────────────────────┘
```

---

## AI Tools / Инструменты

> Атомарные инструменты которые вызывает AI для выполнения задач

### Обзор инструментов

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          AI TOOLS                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ИЗВЛЕЧЕНИЕ (Extraction)          ДЕЙСТВИЯ (Actions)                        │
│  ├── device_extract               ├── appointment_create                    │
│  ├── issue_extract                ├── appointment_reschedule                │
│  ├── intent_classify              ├── parts_search                          │
│  ├── price_extract                ├── price_lookup                          │
│  ├── appointment_extract          ├── order_create (Remonline/LiveSklad)    │
│  └── sentiment_analyze            └── notification_send                     │
│                                                                              │
│  ПОИСК (Lookup)                   ГЕНЕРАЦИЯ (Generation)                    │
│  ├── client_lookup                ├── response_generate                     │
│  ├── device_history               ├── summary_generate                      │
│  ├── parts_catalog_search         └── greeting_generate                     │
│  ├── knowledge_lookup                                                       │
│  └── qr_resolve                   ИНТЕГРАЦИИ (External)                     │
│                                   ├── remonline_sync                        │
│                                   ├── livesklad_sync                        │
│                                   └── voice_transcribe                      │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### 1. Запись на приём (Appointment)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                              │
│  TOOL: appointment_extract                                                   │
│  Назначение: Извлечь из сообщения дату/время/пожелания                      │
│                                                                              │
│  Вход: "Завтра в три подойду, после обеда"                                  │
│  Выход: {                                                                    │
│    date: "2025-12-11",                                                       │
│    time: "15:00",                                                            │
│    time_flexible: true,                                                      │
│    notes: "после обеда"                                                      │
│  }                                                                           │
│                                                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  TOOL: appointment_create                                                    │
│  Назначение: Создать запись в календаре/системе                             │
│                                                                              │
│  Вход: {                                                                     │
│    client_id: "uuid",                                                        │
│    date: "2025-12-11",                                                       │
│    time: "15:00",                                                            │
│    service_type: "repair",                                                   │
│    device: "iPhone 14",                                                      │
│    issue: "экран"                                                            │
│  }                                                                           │
│                                                                              │
│  Действия:                                                                   │
│  ├── Проверить свободные слоты                                              │
│  ├── Создать запись в elo_appointments                                      │
│  ├── Создать событие в Google Calendar (опц.)                               │
│  ├── Создать заявку в Remonline/LiveSklad (опц.)                            │
│  └── Запланировать напоминание клиенту                                      │
│                                                                              │
│  Выход: {                                                                    │
│    appointment_id: "uuid",                                                   │
│    confirmed_time: "15:00",                                                  │
│    reminder_scheduled: true                                                  │
│  }                                                                           │
│                                                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  TOOL: appointment_reschedule                                                │
│  Назначение: Перенести существующую запись                                  │
│                                                                              │
│  Вход: "Не смогу завтра, давайте в пятницу"                                 │
│                                                                              │
│  Логика:                                                                     │
│  ├── Найти активную запись клиента                                          │
│  ├── Извлечь новую дату/время                                               │
│  ├── Проверить доступность                                                  │
│  ├── Обновить запись                                                        │
│  └── Уведомить клиента о подтверждении                                      │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘

Таблица:

CREATE TABLE elo_appointments (
  id UUID PRIMARY KEY,
  tenant_id UUID REFERENCES elo_tenants(id),
  client_id UUID REFERENCES elo_clients(id),
  dialog_id UUID REFERENCES elo_dialogs(id),

  -- Время
  scheduled_date DATE NOT NULL,
  scheduled_time TIME,
  time_flexible BOOLEAN DEFAULT false,
  duration_minutes INT DEFAULT 30,

  -- Тип
  service_type VARCHAR,            -- repair, consultation, pickup

  -- Связь с устройством/проблемой
  device_info JSONB,               -- {brand, model, issue}

  -- Статус
  status VARCHAR DEFAULT 'scheduled',  -- scheduled, confirmed, completed, cancelled, no_show

  -- Напоминания
  reminder_sent BOOLEAN DEFAULT false,
  reminder_scheduled_at TIMESTAMPTZ,

  -- Внешние системы
  external_ids JSONB,              -- {remonline: "123", google_calendar: "abc"}

  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

### 2. Поиск запчастей (Parts Search)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                              │
│  TOOL: parts_search                                                          │
│  Назначение: Найти запчасти по параметрам                                   │
│                                                                              │
│  Вход: {                                                                     │
│    device_brand: "Apple",                                                    │
│    device_model: "iPhone 14",                                                │
│    part_type: "display",                                                     │
│    quality: null  // все варианты                                           │
│  }                                                                           │
│                                                                              │
│  Выход: {                                                                    │
│    parts: [                                                                  │
│      {                                                                       │
│        id: "uuid",                                                           │
│        name: "Дисплей iPhone 14 OLED Copy",                                 │
│        quality: "copy",                                                      │
│        subtype: "oled",                                                      │
│        price: 4500,                                                          │
│        in_stock: true,                                                       │
│        supplier: "mobileboost.ru"                                           │
│      },                                                                      │
│      {                                                                       │
│        id: "uuid",                                                           │
│        name: "Дисплей iPhone 14 Original",                                  │
│        quality: "original",                                                  │
│        price: 12000,                                                         │
│        in_stock: false,                                                      │
│        delivery_days: 3                                                      │
│      }                                                                       │
│    ],                                                                        │
│    tenant_markup: 1.3,                                                       │
│    final_prices: [5850, 15600]                                              │
│  }                                                                           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘

Сценарии использования:

1. Клиент спрашивает цену:
   "Сколько стоит поменять экран на 14ке?"
   → device_extract → parts_search → response_generate
   → "Замена дисплея iPhone 14: копия 5850₽, оригинал 15600₽"

2. Оператор проверяет наличие:
   Приложение → parts_search (internal) → показать stock status

3. AI предлагает альтернативы:
   "Оригинал нет в наличии, доставка 3 дня. Копия OLED есть сейчас."
```

---

### 3. Блок создания файла запчастей (Parts Catalog)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                              │
│  PRICE ENGINE: Parts Catalog                                                 │
│  Назначение: Создание и поддержка каталога запчастей                        │
│                                                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ИСТОЧНИКИ ДАННЫХ                                                           │
│                                                                              │
│  1. Парсинг магазинов (автоматически):                                      │
│     ├── mobileboost.ru                                                      │
│     ├── all-spares.ru                                                       │
│     ├── gsm-komplekt.ru                                                     │
│     └── opt-mobile.ru                                                       │
│                                                                              │
│  2. Импорт от тенанта (вручную):                                            │
│     ├── Excel/CSV файл                                                      │
│     ├── API поставщика                                                      │
│     └── Ручной ввод                                                         │
│                                                                              │
│  3. Синхронизация из учётки:                                                │
│     ├── LiveSklad → актуальные остатки                                      │
│     └── Remonline → актуальные остатки                                      │
│                                                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ПРОЦЕСС НОРМАЛИЗАЦИИ                                                       │
│                                                                              │
│  Сырые данные:                                                              │
│  "Дисп. айф. 14 олед копия чёрн."                                           │
│  "LCD iPhone14 black copy"                                                  │
│  "Экран для Apple iPhone 14 OLED (черный) - копия"                          │
│                                                                              │
│                          ↓                                                   │
│                                                                              │
│  Справочники:                                                               │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │ elo_device_models                                                  │     │
│  │ ├── brand: "Apple"                                                 │     │
│  │ ├── model: "iPhone 14"                                             │     │
│  │ └── aliases: ["айф 14", "iphone14", "ip14", "14ка", "айфон 14"]   │     │
│  ├────────────────────────────────────────────────────────────────────┤     │
│  │ elo_part_types                                                     │     │
│  │ ├── name: "display"                                                │     │
│  │ ├── display_name: "Дисплей"                                        │     │
│  │ ├── aliases: ["экран", "дисп", "lcd", "стекло", "тач"]            │     │
│  │ └── subtypes: ["lcd", "oled", "amoled", "incell"]                 │     │
│  ├────────────────────────────────────────────────────────────────────┤     │
│  │ elo_part_qualities                                                 │     │
│  │ ├── name: "copy"                                                   │     │
│  │ ├── display_name: "Копия"                                          │     │
│  │ ├── aliases: ["копия", "copy", "коп", "реплика", "china"]         │     │
│  │ └── rank: 3  // 1=best, 3=cheapest                                │     │
│  └────────────────────────────────────────────────────────────────────┘     │
│                                                                              │
│                          ↓                                                   │
│                                                                              │
│  Нормализованная запись:                                                    │
│  {                                                                           │
│    device_model_id: 142,       // → Apple iPhone 14                         │
│    part_type_id: 1,            // → display                                 │
│    part_quality_id: 3,         // → copy                                    │
│    subtype: "oled",                                                         │
│    color: "black",                                                          │
│    price: 4500,                                                             │
│    source: "mobileboost.ru",                                                │
│    raw_title: "Дисп. айф. 14 олед копия чёрн."                             │
│  }                                                                           │
│                                                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  WORKFLOW СОЗДАНИЯ КАТАЛОГА                                                 │
│                                                                              │
│  Шаг 1: Парсинг (ежедневно 3:00)                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ ELO_Price_Parser                                                    │   │
│  │ ├── Fetch HTML/API from sources                                     │   │
│  │ ├── Extract raw items                                               │   │
│  │ └── Save to elo_price_raw (staging)                                 │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                          ↓                                                   │
│  Шаг 2: Нормализация                                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ ELO_Price_Normalizer                                                │   │
│  │ ├── Match against dictionaries                                      │   │
│  │ ├── AI fallback for unmatched (GPT classify)                       │   │
│  │ ├── Flag uncertain matches for review                               │   │
│  │ └── Save to elo_price_catalog                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                          ↓                                                   │
│  Шаг 3: Дедупликация                                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ ELO_Price_Deduplicator                                              │   │
│  │ ├── Find duplicates (same part, different sources)                  │   │
│  │ ├── Calculate market average                                        │   │
│  │ └── Update elo_price_market_avg                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                          ↓                                                   │
│  Шаг 4: Применение наценок                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ parts_search (runtime)                                              │   │
│  │ ├── Load market prices                                              │   │
│  │ ├── Apply tenant markup (elo_tenant_pricing)                        │   │
│  │ └── Return final prices                                             │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘

Таблицы:

-- Сырые данные (staging)
CREATE TABLE elo_price_raw (
  id UUID PRIMARY KEY,
  source_name VARCHAR NOT NULL,
  source_url VARCHAR,
  raw_title VARCHAR NOT NULL,
  raw_price DECIMAL(10,2),
  raw_data JSONB,
  parsed_at TIMESTAMPTZ DEFAULT NOW(),
  processed BOOLEAN DEFAULT false
);

-- Нормализованный каталог
CREATE TABLE elo_price_catalog (
  id UUID PRIMARY KEY,
  device_model_id INT REFERENCES elo_device_models(id),
  part_type_id INT REFERENCES elo_part_types(id),
  part_quality_id INT REFERENCES elo_part_qualities(id),
  subtype VARCHAR,
  color VARCHAR,
  price DECIMAL(10,2) NOT NULL,
  source_name VARCHAR,
  source_url VARCHAR,
  raw_title VARCHAR,
  confidence DECIMAL(3,2),    -- 0.00-1.00, уверенность нормализации
  parsed_at TIMESTAMPTZ DEFAULT NOW(),
  is_active BOOLEAN DEFAULT true
);

-- Средние цены по рынку
CREATE TABLE elo_price_market_avg (
  id UUID PRIMARY KEY,
  device_model_id INT,
  part_type_id INT,
  part_quality_id INT,
  subtype VARCHAR,
  avg_price DECIMAL(10,2),
  min_price DECIMAL(10,2),
  max_price DECIMAL(10,2),
  sources_count INT,
  calculated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Наценки тенанта
CREATE TABLE elo_tenant_pricing (
  id UUID PRIMARY KEY,
  tenant_id UUID REFERENCES elo_tenants(id),
  global_markup DECIMAL(5,2) DEFAULT 1.30,  -- +30%
  markup_by_type JSONB,          -- {"display": 1.4, "battery": 1.2}
  markup_by_quality JSONB,       -- {"original": 1.2, "copy": 1.5}
  fixed_prices JSONB,            -- override specific parts
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

### 4. QR код авторизация/регистрация

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                              │
│  TOOL: qr_resolve                                                            │
│  Назначение: Определить клиента/контекст по QR коду                         │
│                                                                              │
│  Типы QR кодов:                                                             │
│                                                                              │
│  1. TENANT QR (на стойке, визитке)                                          │
│     URL: https://elo.do/ABC123                                              │
│     → Новый клиент: создать профиль, начать диалог                          │
│     → Существующий: узнать по telegram_id/phone, показать историю           │
│                                                                              │
│  2. DEVICE QR (на устройстве после ремонта)                                 │
│     URL: https://elo.do/ABC123/d/XYZ789                                     │
│     → Клиент сканирует → видит историю ремонтов этого устройства            │
│     → Может задать вопрос по гарантии                                       │
│                                                                              │
│  3. REPAIR QR (на чеке/квитанции)                                           │
│     URL: https://elo.do/ABC123/r/REP456                                     │
│     → Клиент сканирует → видит детали конкретного ремонта                   │
│     → Статус, стоимость, гарантия                                           │
│                                                                              │
│  4. PROMO QR (на рекламе)                                                   │
│     URL: https://elo.do/ABC123/p/PROMO1                                     │
│     → Отслеживание источника привлечения                                    │
│     → Автоматическое применение скидки                                      │
│                                                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  FLOW: QR → Мессенджер → Авторизация                                        │
│                                                                              │
│  1. Клиент сканирует QR                                                     │
│  2. Открывается ссылка → редирект на Telegram/WhatsApp                      │
│  3. Автостарт: /start ABC123_d_XYZ789                                       │
│  4. Backend парсит код:                                                     │
│     ├── tenant_code: ABC123 → tenant_id                                     │
│     ├── type: d (device)                                                    │
│     └── entity_id: XYZ789 → device_id                                       │
│  5. Резолв клиента:                                                         │
│     ├── По telegram_id → найден → подгрузить историю                        │
│     └── Не найден → создать профиль                                         │
│  6. Подгрузить контекст устройства/ремонта                                  │
│  7. AI готов к диалогу с полным контекстом                                  │
│                                                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  TOOL: qr_generate                                                           │
│  Назначение: Создать QR код                                                 │
│                                                                              │
│  Вход: {                                                                     │
│    tenant_id: "uuid",                                                        │
│    type: "device",                                                           │
│    entity_id: "uuid",      // device_id, repair_id, promo_id                │
│    label: "iPhone 14 Иванов"  // для отслеживания                           │
│  }                                                                           │
│                                                                              │
│  Выход: {                                                                    │
│    qr_id: "uuid",                                                            │
│    code: "ABC123_d_XYZ789",                                                 │
│    url: "https://elo.do/ABC123/d/XYZ789",                                   │
│    qr_image_url: "https://api.elo.do/qr/ABC123_d_XYZ789.png"               │
│  }                                                                           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘

Таблица:

CREATE TABLE elo_qr_codes (
  id UUID PRIMARY KEY,
  tenant_id UUID REFERENCES elo_tenants(id),

  code VARCHAR UNIQUE NOT NULL,    -- ABC123_d_XYZ789
  type VARCHAR NOT NULL,           -- tenant, device, repair, promo

  -- Привязка к сущности
  entity_type VARCHAR,             -- device, repair, promo
  entity_id UUID,

  -- Для промо
  promo_config JSONB,              -- {discount: 10, valid_until: "2025-01-01"}

  -- Статистика
  scans_count INT DEFAULT 0,
  unique_clients INT DEFAULT 0,
  last_scanned_at TIMESTAMPTZ,

  -- Метаданные
  label VARCHAR,                   -- "Стойка у входа", "Визитка Иван"

  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Логирование сканирований
CREATE TABLE elo_qr_scans (
  id UUID PRIMARY KEY,
  qr_id UUID REFERENCES elo_qr_codes(id),
  client_id UUID REFERENCES elo_clients(id),
  channel VARCHAR,                 -- telegram, whatsapp
  scanned_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

### 5. API Remonline

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                              │
│  TOOL: remonline_sync                                                        │
│  Назначение: Двусторонняя синхронизация с Remonline                         │
│                                                                              │
│  API: https://api.remonline.app/                                            │
│  Docs: https://remonline.app/docs/api/                                      │
│                                                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  НАПРАВЛЕНИЕ: ELO → Remonline                                               │
│                                                                              │
│  Триггер: dialog.stage = SCHEDULED или RECEIVED                             │
│                                                                              │
│  Действия:                                                                   │
│  1. POST /orders/ — создать заявку                                          │
│     {                                                                        │
│       "client": {                                                            │
│         "name": "Иван Петров",                                              │
│         "phone": "+79991234567"                                             │
│       },                                                                     │
│       "order_type": "repair",                                               │
│       "device_type": "iPhone 14",                                           │
│       "malfunction": "Разбит экран",                                        │
│       "estimated_cost": 5000,                                               │
│       "scheduled_for": "2025-12-11T15:00:00"                                │
│     }                                                                        │
│                                                                              │
│  2. Сохранить external_id в elo_dialogs.external_ids.remonline             │
│                                                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  НАПРАВЛЕНИЕ: Remonline → ELO (webhook)                                     │
│                                                                              │
│  Endpoint: POST /webhook/remonline                                          │
│                                                                              │
│  События:                                                                    │
│  ├── order.status_changed → обновить dialog.stage                          │
│  ├── order.completed → получить фактические данные                          │
│  └── order.part_used → обновить learning data                              │
│                                                                              │
│  Пример payload (order.completed):                                          │
│  {                                                                           │
│    "event": "order.completed",                                              │
│    "order_id": "123456",                                                    │
│    "actual_repairs": [                                                       │
│      {"type": "Замена дисплея", "price": 5000}                              │
│    ],                                                                        │
│    "parts_used": [                                                           │
│      {"name": "Дисплей iPhone 14 OLED", "price": 3500, "qty": 1}           │
│    ],                                                                        │
│    "total": 5000,                                                            │
│    "completed_at": "2025-12-11T18:30:00"                                    │
│  }                                                                           │
│                                                                              │
│  Действия:                                                                   │
│  1. Обновить elo_dialogs.context.actual_repair                             │
│  2. Обновить Neo4j: Problem.resolved = true                                │
│  3. Сохранить в elo_learning_examples для обучения AI                      │
│  4. Отправить клиенту: "Ваш iPhone 14 готов! Стоимость: 5000₽"             │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### 6. API LiveSklad

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                              │
│  TOOL: livesklad_sync                                                        │
│  Назначение: Двусторонняя синхронизация с LiveSklad                         │
│                                                                              │
│  API: https://livesklad.com/api/                                            │
│                                                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  НАПРАВЛЕНИЕ: ELO → LiveSklad                                               │
│                                                                              │
│  Триггер: dialog.stage = SCHEDULED или RECEIVED                             │
│                                                                              │
│  Действия:                                                                   │
│  1. POST /api/orders — создать заказ                                        │
│     {                                                                        │
│       "client_name": "Иван Петров",                                         │
│       "client_phone": "+79991234567",                                       │
│       "device": "Apple iPhone 14",                                          │
│       "defect": "Разбит экран",                                             │
│       "preliminary_price": 5000,                                            │
│       "reception_date": "2025-12-11"                                        │
│     }                                                                        │
│                                                                              │
│  2. POST /api/clients — создать/найти клиента (если не существует)         │
│                                                                              │
│  3. Сохранить external_id в elo_dialogs.external_ids.livesklad             │
│                                                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  НАПРАВЛЕНИЕ: LiveSklad → ELO (webhook)                                     │
│                                                                              │
│  Endpoint: POST /webhook/livesklad                                          │
│                                                                              │
│  События:                                                                    │
│  ├── order.status → обновить dialog.stage                                  │
│  │   - "В работе" → IN_PROGRESS                                            │
│  │   - "Готов" → READY                                                      │
│  │   - "Выдан" → DELIVERED                                                  │
│  │                                                                           │
│  ├── order.completed → получить итоговые данные                            │
│  │   {                                                                       │
│  │     "order_id": "LS-12345",                                              │
│  │     "works": [{"name": "Замена дисплея", "price": 5000}],               │
│  │     "parts": [{"name": "Дисплей OLED", "price": 3500}],                 │
│  │     "total": 5000                                                        │
│  │   }                                                                       │
│  │                                                                           │
│  └── stock.updated → обновить остатки запчастей                            │
│      {                                                                       │
│        "part_id": "P-123",                                                  │
│        "name": "Дисплей iPhone 14 OLED",                                   │
│        "quantity": 5,                                                        │
│        "price": 3500                                                         │
│      }                                                                       │
│                                                                              │
│  Действия на stock.updated:                                                 │
│  1. Обновить elo_price_catalog (in_stock, local_price)                     │
│  2. Помечать запчасти как "в наличии" для parts_search                     │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### Общая таблица интеграций

```sql
CREATE TABLE elo_external_integrations (
  id UUID PRIMARY KEY,
  tenant_id UUID REFERENCES elo_tenants(id),

  provider VARCHAR NOT NULL,       -- remonline, livesklad, google_calendar

  -- Credentials (encrypted)
  api_key_encrypted VARCHAR,
  api_secret_encrypted VARCHAR,
  api_url VARCHAR,

  -- Webhook
  webhook_secret VARCHAR,
  webhook_url VARCHAR,             -- наш endpoint для приёма

  -- Настройки
  sync_on_stages VARCHAR[],        -- {SCHEDULED, RECEIVED}
  sync_back_enabled BOOLEAN DEFAULT true,
  sync_stock_enabled BOOLEAN DEFAULT false,

  -- Маппинг полей (кастомизация)
  field_mapping JSONB,             -- {"elo_field": "external_field"}

  -- Статус
  is_active BOOLEAN DEFAULT true,
  last_sync_at TIMESTAMPTZ,
  last_error TEXT,

  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Лог синхронизации
CREATE TABLE elo_integration_logs (
  id UUID PRIMARY KEY,
  integration_id UUID REFERENCES elo_external_integrations(id),
  dialog_id UUID REFERENCES elo_dialogs(id),

  direction VARCHAR,               -- outbound, inbound
  event_type VARCHAR,              -- order.create, order.completed, stock.updated

  external_id VARCHAR,
  request_payload JSONB,
  response_payload JSONB,

  status VARCHAR,                  -- success, error, pending
  error_message TEXT,

  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

### Матрица Tools по фазам

| Tool | Фаза | Приоритет | Зависимости |
|------|------|-----------|-------------|
| device_extract | MVP | ⭐⭐⭐⭐⭐ | — |
| issue_extract | MVP | ⭐⭐⭐⭐⭐ | — |
| intent_classify | MVP | ⭐⭐⭐⭐ | — |
| response_generate | MVP | ⭐⭐⭐⭐⭐ | — |
| appointment_extract | MVP | ⭐⭐⭐⭐ | — |
| appointment_create | MVP | ⭐⭐⭐⭐ | appointment_extract |
| qr_resolve | Фаза 2 | ⭐⭐⭐ | — |
| qr_generate | Фаза 2 | ⭐⭐⭐ | — |
| parts_search | Фаза 2 | ⭐⭐⭐⭐ | Price Engine |
| knowledge_lookup | Фаза 2 | ⭐⭐⭐ | Knowledge Base |
| voice_transcribe | Фаза 2 | ⭐⭐⭐⭐⭐ | Whisper API |
| remonline_sync | Фаза 3 | ⭐⭐⭐ | Remonline API key |
| livesklad_sync | Фаза 3 | ⭐⭐⭐ | LiveSklad API key |
| price_lookup | Фаза 2 | ⭐⭐⭐⭐ | Price Engine |

---

## Roadmap по фазам

### Фаза 1: MVP (текущая)

| Компонент | Статус | Описание |
|-----------|--------|----------|
| Омниканальность | 80% | 7 каналов (TG, WA, Avito, VK, MAX, Form, Phone) |
| AI auto-ответ 24/7 | 70% | Debounce 10s, понимание контекста |
| AI assist | 70% | Подсказки оператору |
| История клиента | 60% | Neo4j граф |
| Определение устройства/проблемы | 70% | AI extraction |
| Android App | 60% | Уведомления, ответы |
| Web App оператора | 0% | **BLOCKER** |

### Фаза 2: +1-2 месяца после MVP

| Компонент | Приоритет | Описание |
|-----------|-----------|----------|
| Голос → Граф → Мессенджер | ⭐⭐⭐⭐⭐ | Запись, транскрибация, продолжение в чате |
| QR идентификация | ⭐⭐⭐ | На стойке, визитке, устройстве |
| Прайс-парсер | ⭐⭐⭐⭐ | Парсинг магазинов, нормализация |
| Автоподстановка цен | ⭐⭐⭐⭐ | AI называет актуальные цены |
| Предписанные ответы | ⭐⭐⭐ | Тенант задаёт свои шаблоны |

### Фаза 3: +3-4 месяца после MVP

| Компонент | Приоритет | Описание |
|-----------|-----------|----------|
| Смартфон-сервер | ⭐⭐⭐⭐⭐ | Бесплатные WhatsApp/Avito/MAX |
| Интеграция LiveSklad | ⭐⭐⭐ | Двусторонняя синхронизация |
| Интеграция Remonline | ⭐⭐⭐ | Двусторонняя синхронизация |
| Голосовые ответы | ⭐⭐⭐ | Оператор диктует, AI отправляет текст |
| Самообучение | ⭐⭐⭐⭐ | На реальных ремонтах и ответах |

### Фаза 4: 100+ тенантов (НЕ СТРОИМ СЕЙЧАС)

| Компонент | Почему отложено |
|-----------|-----------------|
| Аналитика по рынку | Нужна статистика от 100+ сервисов |
| Бенчмарки | Сравнение требует данных |
| Рекомендации цен | На основе других сервисов |
| Рейтинги тенантов | Нужны отзывы клиентов |
| Догрев/рассылки | После накопления базы |
| Обмен между тенантами | Сеть сервисов |

---

## Технические требования

### Android App (одно приложение — два режима)

```
┌─────────────────────────────────────────────────────────┐
│              ELO Android App                            │
│              (Google Play / RuStore)                    │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  РЕЖИМ 1: ОПЕРАТОР (всегда активен)                     │
│  ├── Push-уведомления о новых сообщениях                │
│  ├── Ответы клиентам (текст, голос)                     │
│  ├── История диалогов                                   │
│  ├── AI подсказки                                       │
│  ├── Информация о клиенте из графа                      │
│  └── QR-сканер для идентификации                        │
│                                                         │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  РЕЖИМ 2: СЕРВЕР (скрытый, активируется по флагу)       │
│  ├── Foreground Service (не убивается системой)         │
│  ├── Local HTTP Server (для API запросов)               │
│  ├── WebSocket Client (связь с backend)                 │
│  ├── WhatsApp Module (reverse-engineered)               │
│  ├── Avito Module (reverse-engineered)                  │
│  └── MAX Module (reverse-engineered)                    │
│                                                         │
└─────────────────────────────────────────────────────────┘

Требования для режима СЕРВЕР:
  • Android 8.0+
  • Постоянный интернет (WiFi/4G)
  • Телефон на зарядке 24/7
  • Реальный IP (или NAT traversal через backend)

Авторизация и активация:
  ┌─────────────────────────────────────────────────────┐
  │  1. Пользователь вводит логин/пароль                │
  │  2. Backend возвращает tenant_config:               │
  │     {                                               │
  │       "operator_mode": true,      // всегда        │
  │       "server_mode": true/false,  // по тарифу     │
  │       "channels": ["whatsapp", "avito", "max"]     │
  │     }                                               │
  │  3. Приложение включает нужные режимы               │
  └─────────────────────────────────────────────────────┘

Безопасность (для маркетов):
  • Режим СЕРВЕР скрыт в UI
  • Активируется только через backend флаг
  • Нет явных признаков автоматизации в коде
  • Шифрование всего трафика

Backend логика маршрутизации:
  IF tenant.server_mode AND device.is_online:
      route_via_smartphone(tenant.device_id)
  ELSE:
      route_via_paid_api(tenant.api_keys)
```

### Прайс-парсер

```
Источники (примеры):
  • mobileboost.ru
  • all-spares.ru
  • gsm-komplekt.ru
  • opt-mobile.ru

Частота парсинга:
  • Ежедневно (ночью)
  • По запросу тенанта

Нормализация:
  • Справочник моделей (iPhone 12, iPhone 12 Pro, ...)
  • Справочник типов (Original, OEM, Copy, OLED, LCD)
  • Справочник цветов
  • Fuzzy matching для названий
```

### Голос → Граф

```
Компоненты:
  ├── Запись звонка (Asterisk/FreePBX или облако)
  ├── Транскрибация (Whisper API)
  ├── AI Extraction (устройство, проблема, договорённости)
  ├── Neo4j Sync (новые узлы и связи)
  └── Messenger Continuation (Telegram/WhatsApp)

Телефония:
  Вариант A: Своя АТС (Asterisk)
  Вариант B: Облачная АТС (Mango, Zadarma)
  Вариант C: Приложение на смартфон (запись через mic)
```

---

## Монетизация

### Тарифы (черновик)

| Тариф | Цена | Что включено |
|-------|------|--------------|
| **Free** | 0₽ | 1 канал, 100 сообщений/мес, история 7 дней |
| **Minimal** | 300-500₽ | 3 канала, 1000 сообщений, AI assist |
| **Basic** | 1500-2000₽ | 7 каналов, безлимит, AI auto, прайс-парсер |
| **Business** | 4000+₽ | + смартфон-сервер, интеграции, голос |

### Unit economics

```
Расходы на 1 тенанта (Basic):
  • WhatsApp API: 600₽ (или 0₽ со смартфон-сервером)
  • AI (OpenAI): ~200-500₽/мес
  • Инфра: ~100₽/мес
  • Итого: 400-1200₽/мес

Маржа:
  • Basic (1500₽): 300-1100₽ (20-70%)
  • Business (4000₽): 2800-3600₽ (70-90%)
```

---

## WOW-демо сценарий

```
Для первого клиента (владелец сервиса):

1. "Напиши мне в Telegram как клиент — 'привет, разбил экран на айфоне'"
   → AI отвечает через 10 сек, спрашивает модель, называет цены

2. "Теперь позвони на этот номер и скажи то же самое"
   → После звонка показать: запись, транскрипт, данные в графе
   → "Теперь напиши в мессенджер"
   → AI продолжает с контекстом звонка

3. "Вот QR — отсканируй"
   → Открылся чат, система тебя узнала как того кто звонил

4. "Смотри — вот изменились цены в магазине"
   → Через 5 минут AI называет новую цену

5. "И всё это — твои каналы бесплатно. WhatsApp, Avito — 0₽"
   → Показать смартфон-сервер
```

---

## Связь с архитектурой CORE_NEW

См. `CORE_NEW/docs/` для технической документации:

| Фича | Блоки архитектуры |
|------|-------------------|
| Омниканальность | Channel Layer (7 MCP) |
| AI auto/assist | Core (Dialog Engine + AI Pipeline) |
| История клиента | Graph (Neo4j) |
| Голос → Граф | Input Contour + Graph + Core |
| Прайс-парсер | Новый блок: Price Engine |
| Смартфон-сервер | Новый блок: Device Gateway |
| Интеграции | Новый блок: External Integrations |

---

## Следующие шаги

1. **Graph вопросы** — разобрать 4 открытых вопроса (Register vs Tracker, direction, enrichment)
2. **Core блок** — документация и адаптация
3. **Web App оператора** — начать разработку (blocker для MVP)
4. **Прайс-парсер** — прототип нормализации
5. **Голос** — выбор телефонии (Asterisk vs облако vs смартфон)
