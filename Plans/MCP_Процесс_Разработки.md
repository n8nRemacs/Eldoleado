# Разработка MCP — Workflow с AI-ассистентом

> **Диалоговый подход к созданию MCP-расширений с минимальным "сломанным телефоном"**

---

## Концепция

MCP (Model Context Protocol) — это расширения для блоков системы Eldoleado. Когда стандартных блоков не хватает, создаётся MCP.

**Ключевая идея:** Разработка MCP через AI-посредника, который:
- Слушает клиента и задаёт вопросы
- Генерирует понятное ТЗ
- Даёт разработчику прямой доступ к системе
- Переводит технические вопросы на человеческий язык
- Автоматически тестирует совместимость

---

## Workflow создания MCP

### Этап 1: Выслушивание потребности

**AI (Claude Opus):** "Какой функционал вам нужен?"

**Клиент:** "Нужна интеграция с 1С для выгрузки товаров на склад"

**AI начинает задавать уточняющие вопросы:**

- Какая версия 1С? (УТ 11, Бухгалтерия, ERP)
- Откуда берём товары? (Номенклатура, Остатки на складах)
- Как часто выгружать? (по запросу, раз в час, в реальном времени)
- Что делать с ценами? (выгружать или устанавливать в CRM отдельно)
- Нужно ли синхронизировать обратно? (когда товар продан в CRM → списать в 1С)

**Клиент:** "1С УТ 11, остатки со склада 'Основной', раз в час, цены выгружать тоже. Обратная синхронизация не нужна."

**AI:** "Ещё вопросы:
- Все товары или только определённые категории?
- Что делать если товара нет в CRM? (создать новый или игнорировать)
- Нужно ли получать уведомление если товар закончился?"

**Клиент:** "Все товары, если нет — создать. Да, хочу уведомление при низком остатке."

---

### Этап 2: Показ результата без технических деталей

**AI:** "Отлично! Вот что получится:

## MCP: Интеграция 1С → Склад

### Что делает
- Каждый час подключается к вашей 1С
- Забирает список товаров со склада 'Основной'
- Обновляет количество и цены в **Блоке Склад/Инвентарь**
- Если товара нет в системе — создаёт новый
- Если остаток изменился — обновляет
- Если остаток ниже минимума — отправляет уведомление вам

### Что вы настраиваете
- Адрес вашей 1С и логин/пароль
- Какой склад смотреть (по умолчанию 'Основной')
- Как часто проверять (по умолчанию раз в час)
- Минимальный остаток для уведомления (для каждого товара)

### Что увидите
- В **Блоке Склад** автоматически обновляются остатки и цены
- Если что-то пошло не так (1С недоступна, неверный пароль) — получите уведомление

### Зависимости
Требуется **Блок Склад/Инвентарь** в вашей вертикали (у вас он уже есть ✓)

Подходит?"

**Клиент:** "Да, идеально!"

---

### Этап 3: Генерация подробного ТЗ

**AI:** "Отлично! Генерирую техническое задание для разработчика..."

**AI создаёт подробное ТЗ:**

```markdown
# ТЗ: MCP Интеграция 1С → Склад

**ID:** MCP-1C-STOCK-001
**Клиент:** [Client ID]
**Дата:** 2025-01-24

---

## 1. Назначение

Автоматическая выгрузка товаров и остатков из 1С:Управление торговлей 11
в Блок Склад/Инвентарь системы Eldoleado.

---

## 2. Входные параметры (настройки)

| Параметр | Тип | Обязательный | По умолчанию | Описание |
|----------|-----|--------------|--------------|----------|
| `1c_url` | string | Да | - | URL API 1С (OData или веб-сервис) |
| `1c_login` | string | Да | - | Логин для доступа к 1С |
| `1c_password` | string | Да | - | Пароль (хранить encrypted) |
| `warehouse` | string | Нет | "Основной" | Название склада для выгрузки |
| `sync_interval` | number | Нет | 3600 | Интервал синхронизации (секунды) |
| `min_stock_alert` | boolean | Нет | true | Отправлять алерт при низком остатке |

---

## 3. Выходные данные (что отдаёт MCP)

Список товаров в формате:

```json
{
  "items": [
    {
      "external_id": "uuid из 1С",
      "name": "string",
      "sku": "string (артикул)",
      "quantity": "number",
      "price": "number",
      "category": "string (группа товара)",
      "unit": "string (шт, кг, л)"
    }
  ],
  "sync_timestamp": "ISO 8601",
  "warehouse": "string"
}
```

---

## 4. Куда записывает

**Блок:** Склад/Инвентарь
**Контракт блока (входы):**

```json
{
  "item_id": "uuid (опционально, для обновления)",
  "name": "string (required)",
  "sku": "string (required)",
  "quantity": "number (required)",
  "price": "number (required)",
  "category": "string (required)",
  "unit": "string (default: 'шт')"
}
```

**Действия:**
- Если товар с таким `sku` существует → обновить `quantity` и `price`
- Если не существует → создать новый с полученными данными
- Если `quantity < min_stock` → вызвать Блок Уведомления

---

## 5. Внутренняя логика (алгоритм)

1. **Подключение к 1С**
   - Проверка доступности API
   - Авторизация (логин/пароль)
   - Если ошибка → отправить уведомление владельцу, повторить через 5 минут

2. **Получение списка товаров**
   - OData запрос: `/odata/standard.odata/Catalog_Номенклатура`
   - Фильтр по складу: `?$filter=Склад eq '{warehouse}'`
   - Получить: Наименование, Артикул, Количество, Цена, Группа, ЕдиницаИзмерения

3. **Маппинг полей 1С → Eldoleado**
   ```
   Наименование → name
   Артикул → sku
   Количество → quantity (convert to number)
   Цена → price (convert to number)
   Группа → category (если пусто → "Без категории")
   ЕдиницаИзмерения → unit (если пусто → "шт")
   ```

4. **Запись в Блок Склад**
   - Для каждого товара:
     - Проверить существование по `sku`
     - Если есть → обновить
     - Если нет → создать
   - Логировать результаты

5. **Проверка низких остатков**
   - Если `quantity < item.min_stock` → вызвать Блок Уведомления:
     ```json
     {
       "recipient": "owner_id",
       "message": "Низкий остаток товара {name}: {quantity} {unit}",
       "channel": "push"
     }
     ```

6. **Логирование**
   - Время синхронизации
   - Количество обработанных товаров
   - Количество созданных/обновлённых
   - Ошибки (если были)

---

## 6. Обработка ошибок

| Ошибка | Действие |
|--------|----------|
| 1С недоступна | Повторить через 5 минут, уведомить владельца после 3 попыток |
| Неверный логин/пароль | Уведомить владельца, остановить синхронизацию |
| Некорректные данные от 1С | Пропустить товар, залогировать, продолжить |
| Ошибка записи в Блок Склад | Залогировать, повторить для этого товара |
| Rate limit от 1С | Снизить частоту запросов, повторить |

---

## 7. Безопасность

- Хранение credentials в **зашифрованном виде** (AES-256)
- Валидация всех входных данных
- Rate limiting: не более 100 запросов к 1С в минуту
- Логи не должны содержать credentials
- Доступ к MCP только у владельца вертикали

---

## 8. Зависимости

**Обязательные блоки в вертикали клиента:**
- Блок Склад/Инвентарь (уже есть ✓)

**Опциональные блоки:**
- Блок Уведомления (для алертов о низких остатках)

---

## 9. Технические требования

**Язык:** Python 3.10+ или Node.js 18+
**Библиотеки:**
- requests / axios (для HTTP)
- cryptography / crypto (для шифрования credentials)
- schedule / node-cron (для периодических задач)

**Протокол 1С:** OData v4 (fallback на веб-сервисы если OData недоступен)

**Формат MCP:** MCP Server спецификация (совместимо с Claude MCP)

---

## 10. Тестирование

**Sandbox окружение:**
- Копия вертикали клиента
- Тестовые данные
- Мок 1С API для автотестов

**Тест-кейсы:**
1. Успешная синхронизация 100 товаров
2. Создание нового товара (которого нет в Блоке Склад)
3. Обновление существующего товара
4. Обработка ошибки подключения к 1С
5. Обработка некорректных данных (price как string)
6. Алерт при низком остатке
7. Rate limiting (не более 100 req/min)

---

## 11. Для разработчика

### Доступ к системе:
- Временный аккаунт в sandbox
- AI-ассистент с полным контекстом ТЗ
- Доступ к логам и тестированию

### Контракты блоков:
- Блок Склад/Инвентарь: [ссылка на спецификацию]
- Блок Уведомления: [ссылка на спецификацию]

### Вопросы:
- Задавайте вопросы AI-ассистенту в специальном чате
- AI может связаться с клиентом для уточнений

---

## 12. Приёмка

**Критерии готовности:**
1. Все тест-кейсы проходят
2. MCP деплоится в sandbox
3. Клиент проверил на своих данных в sandbox
4. Нет критических ошибок в логах
5. Документация по настройке готова

**Срок:** [обсуждается с разработчиком]

---

## Контекст диалога с клиентом

(AI сохраняет весь диалог для дальнейших уточнений)

**Клиент сказал:**
- 1С УТ 11
- Склад 'Основной'
- Раз в час
- Цены выгружать
- Уведомление при низком остатке

**Дополнительные пожелания:**
- Все товары (без фильтров)
- Если товара нет — создать
```

**AI сохраняет:**
- Полный текст ТЗ
- Контекст диалога
- Версию ТЗ (для отслеживания изменений)

---

### Этап 4: Выдача доступа разработчику

**AI создаёт временный аккаунт разработчика:**

**Email разработчику:**
```
Привет!

Вам создан временный аккаунт для разработки MCP "1С → Склад".

Доступ: https://dev.eldoleado.io
Логин: dev_mcp1c001
Пароль: [временный пароль]
Срок: 14 дней (продлевается автоматически если нужно)

Что доступно:
✓ AI-ассистент с полным контекстом ТЗ
✓ Sandbox вертикали клиента (копия)
✓ Тестовые данные
✓ Автоматическое тестирование
✓ Логи и отчёты об ошибках
✓ Спецификации блоков

Начните с чтения ТЗ в разделе "Проекты → MCP-1C-STOCK-001"
Вопросы задавайте AI-ассистенту прямо в чате.

Удачи!
```

---

### Этап 5: Работа разработчика с AI-ассистентом

#### Сценарий 1: Уточняющий вопрос

**Разработчик (в чате с AI):** "В ТЗ указано поле `quantity`, а в API 1С оно называется `Количество`. Как правильно маппить?"

**AI (помнит весь контекст):** "Правильно, делай маппинг:
```python
1С: Количество → MCP: quantity (type: number)
```

Важно: в 1С это может прийти как Decimal, конвертируй в float/number перед отправкой в Блок Склад.

Пример:
```python
quantity = float(item['Количество'])
```

Нужна ещё помощь?"

---

#### Сценарий 2: Обнаружена ошибка

**Разработчик:** "При записи в Блок Склад получаю ошибку:
```
ValidationError: field 'category' is required
```
Но в ТЗ категория опциональная?"

**AI (проверяет контракт Блока Склад):** "Нашёл проблему! Блок Склад в версии 2.1 требует `category` обязательно.

Обновляю ТЗ:
- Маппинг: `1С.Номенклатура.Группа → category`
- Если группы нет → использовать 'Без категории' (default)

Код:
```python
category = item.get('Группа') or 'Без категории'
```

ТЗ обновлено ✓"

---

#### Сценарий 3: Нужно уточнить у клиента

**Разработчик:** "В 1С обнаружил несколько складов: 'Основной', 'Розничный', 'Оптовый'. Клиент сказал 'Основной', но точное название в 1С — 'Склад Основной (Москва)'. Уточнить?"

**AI:** "Хороший вопрос! Спрошу у клиента."

**AI → Клиенту (через основной чат):** "Разработчик нашёл в вашей 1С склад с названием 'Склад Основной (Москва)'. Это тот который нужен?"

**Клиент:** "Да, именно он"

**AI → Разработчику:** "Клиент подтвердил: 'Склад Основной (Москва)'. Обновляю ТЗ ✓"

---

### Этап 6: Тестирование в sandbox

#### Автоматическое тестирование

**Разработчик деплоит MCP в sandbox:**
```bash
eldoleado mcp deploy --sandbox mcp_1c_stock.py
```

**AI автоматически запускает тесты:**

```
Тестирование MCP "1С → Склад"
Sandbox: client_123_sandbox
Дата: 2025-01-24 14:30

┌─────────────────────────────────────────┐
│ Тест 1: Подключение к 1С                │
└─────────────────────────────────────────┘
✅ Подключение успешно
✅ Авторизация пройдена
   Время ответа: 342ms

┌─────────────────────────────────────────┐
│ Тест 2: Получение списка товаров        │
└─────────────────────────────────────────┘
✅ Запрос выполнен
✅ Получено 127 товаров
   Склад: "Основной (Москва)"

┌─────────────────────────────────────────┐
│ Тест 3: Запись в Блок Склад             │
└─────────────────────────────────────────┘
❌ Ошибка при записи товара "Масло 5W40"

Детали ошибки:
  Field: price
  Expected: number
  Received: string "890.00"

Рекомендация:
  Конвертируй price в number перед отправкой

  Код:
  price = float(item['Цена'])

  Файл: mcp_1c_stock.py:145

┌─────────────────────────────────────────┐
│ Итого                                   │
└─────────────────────────────────────────┘
Успешно: 2/3
Ошибок: 1
Время: 5.2s

Логи сохранены: /logs/mcp_1c_stock_20250124_1430.log
```

**AI → Разработчику:**
"Нашёл проблему с типом поля `price`. См. детали выше. Исправь и задеплой снова."

---

#### Промежуточный результат клиенту

**После исправления:**

**AI → Клиенту:** "Разработчик подключился к вашей 1С и выгрузил тестовые данные в sandbox. Вот что получилось:

**Выгружено товаров:** 127
**Примеры:**
- Аккумулятор 60Ah — 15 шт, цена 3500₽
- Масло 5W40 — 24 шт, цена 890₽
- Фильтр воздушный — 8 шт, цена 450₽

Данные корректные?"

**Клиент:** "Да, правильно"

**AI → Разработчику:** "Клиент подтвердил корректность данных ✓"

---

### Этап 7: Финальная проверка

**Все тесты проходят:**

```
Финальное тестирование MCP "1С → Склад"
Дата: 2025-01-25 10:15

✅ Все тест-кейсы пройдены (8/8)
✅ Нет критических ошибок
✅ Performance: avg 2.3s на синхронизацию
✅ Memory usage: 45MB
✅ Rate limiting: 32 req/min (в пределах нормы)

Готово к деплою в продакшн ✓
```

**AI → Клиенту:** "Интеграция с 1С готова и протестирована!

**Что сделано:**
- Подключение к вашей 1С
- Выгрузка товаров каждый час
- Обновление остатков и цен в Блоке Склад
- Уведомления при низких остатках

**Тесты:** все пройдены
**Sandbox:** работает корректно

Хотите запустить в продакшн?"

**Клиент:** "Да, запускайте"

---

### Этап 8: Деплой в продакшн

**AI:**
```bash
Deploying MCP "1С → Склад" to production...

✓ Backup created
✓ Dependencies installed
✓ MCP deployed
✓ Configuration applied
✓ First sync scheduled in 5 minutes

Status: Running ✓
```

**AI → Клиенту:** "MCP развёрнут и запущен!
Первая синхронизация через 5 минут. Вы получите уведомление с результатами."

---

### Этап 9: Мониторинг

**Через час после запуска:**

**AI (автоматически) → Клиенту:**
```
Отчёт о первой синхронизации с 1С

✅ Синхронизация завершена успешно

Статистика:
- Обработано товаров: 127
- Создано новых: 3
- Обновлено: 124
- Ошибок: 0
- Время: 4.8s

Следующая синхронизация: через 59 минут

Всё работает корректно ✓
```

---

### Этап 10: Закрытие аккаунта разработчика

**После 7 дней стабильной работы:**

**AI → Разработчику:**
"MCP работает стабильно 7 дней без ошибок. Аккаунт будет закрыт через 48 часов.

Если нужна поддержка — напишите, продлим доступ.

Спасибо за работу!"

**AI сохраняет:**
- Весь контекст разработки
- Финальную версию кода
- Логи тестирования
- Для будущих обновлений или похожих MCP

---

## Ключевые преимущества подхода

### 1. Нет "сломанного телефона"
- Разработчик общается с AI, который помнит весь контекст
- Клиент получает понятные объяснения
- AI переводит с технического на человеческий

### 2. Быстрая разработка
- Вопросы решаются мгновенно
- Автоматическое тестирование
- Sandbox для безопасной отладки

### 3. Контекст сохранён
- AI помнит весь диалог с клиентом
- ТЗ обновляется автоматически при уточнениях
- История изменений доступна

### 4. Прозрачность для клиента
- Видит прогресс разработки
- Получает промежуточные результаты
- Может вносить коррективы на любом этапе

### 5. Обучение системы
- AI учится на каждом MCP
- База знаний растёт
- Будущие похожие MCP создаются быстрее

---

## Архитектура взаимодействия

```
┌──────────────┐
│   Клиент     │
└──────┬───────┘
       │
       │ (диалог на человеческом языке)
       │
       ↓
┌─────────────────────────────┐
│   AI Assistant (Opus+RAG)   │
│   - Слушает потребность     │
│   - Генерирует ТЗ           │
│   - Переводит вопросы       │
└──────┬──────────────────┬───┘
       │                  │
       │ (ТЗ)            │ (вопросы/ответы)
       │                  │
       ↓                  ↓
┌──────────────┐    ┌─────────────────┐
│ Разработчик  │←───│ Dev Account     │
│              │    │ - Sandbox       │
│              │    │ - AI Chat       │
│              │    │ - Auto-testing  │
│              │    │ - Logs          │
└──────────────┘    └─────────────────┘
       │
       │ (деплой)
       │
       ↓
┌─────────────────────────────┐
│   Client Vertical           │
│   (production)              │
└─────────────────────────────┘
```

---

*Этот подход делает разработку MCP максимально быстрой, прозрачной и безопасной для всех участников процесса.*
