# AI Система Eldoleado — Архитектура и Workflow

> **Концепция AI-системы для создания вертикалей и MCP с диалоговым подходом**

---

## 1. Формат описания блоков

### Гибридный подход: Natural Language → AI → Structured

Блоки описываются **человеко-понятным языком** в Markdown, AI парсит и строит граф автоматически.

**Пример описания блока:**
```markdown
# Блок Коммуникаций

Базовый блок для связи с клиентами через WhatsApp, Telegram, VK, телефонию.
Не зависит от других блоков.

## Что делает
Принимает сообщения от клиентов, отправляет сообщения клиентам.

## Выходы
- Сообщение от клиента (ID клиента, текст, канал, время)

## Кому нужен
- Блок Уведомления (для отправки)
- Блок AI Контекста (для анализа)
- Блок Репутация (запрос отзывов)
```

AI читает это и автоматически:
- Определяет тип блока (foundation/dependent)
- Строит граф зависимостей
- Создаёт контракты входов/выходов
- Проверяет совместимость

---

## 2. Уровни AI для разных задач

### Задача 1: Сборка вертикали из готовых блоков
**AI:** Claude Sonnet (средний уровень)

**Что делает:**
- Читает описания блоков из каталога
- Ведёт диалог с клиентом
- Предлагает готовые пакеты или собирает с нуля
- Проверяет зависимости между блоками
- Генерирует конфигурацию вертикали (JSON/YAML)

**Не создаёт код**, только собирает из готовых блоков.

---

### Задача 2: Генерация ТЗ для новых MCP
**AI:** Claude Sonnet/Opus

**Что делает:**
- Слушает потребность клиента
- Задаёт уточняющие вопросы
- Показывает результат **без технических деталей**
- Согласовывает с клиентом
- Генерирует **подробное техническое задание** для разработчика/AI

**Пример ТЗ:**
```markdown
# ТЗ: MCP интеграция с 1С

## Назначение
Выгрузка товаров из 1С в систему Eldoleado для синхронизации склада.

## Вход (Input)
- API endpoint 1С
- Credentials (логин/пароль или токен)
- Параметры фильтрации (склад, категории)

## Выход (Output)
```json
{
  "items": [
    {
      "id": "uuid",
      "name": "string",
      "sku": "string",
      "quantity": "number",
      "price": "number"
    }
  ]
}
```

## Внутренняя логика
1. Подключение к API 1С по протоколу OData
2. Запрос товаров с фильтрами
3. Маппинг полей 1С → Eldoleado
4. Обработка ошибок
5. Логирование операций

## Зависимости
- Блок Склад/Инвентарь (куда записывать товары)

## Безопасность
- Хранение credentials в зашифрованном виде
- Валидация входных данных
- Rate limiting
```

---

### Задача 3: Консультативная роль (продавец + эксперт)
**AI:** Claude Opus + RAG (векторная БД)

**Что делает:**
- Знает best practices по нишам
- Предлагает оптимизации на основе статистики
- Консультирует как эксперт-продавец
- Учится на успешных кейсах клиентов

**База знаний (RAG):**
- Статистика по нишам
- Успешные вертикали (какие блоки использовали)
- Кейсы клиентов
- Best practices (например, "салоны с автонапоминаниями имеют -40% no-show")

---

## 3. Архитектура AI-системы

```
┌─────────────────────────────────────────┐
│  User (клиент)                          │
└────────────────┬────────────────────────┘
                 │
                 ↓
┌─────────────────────────────────────────┐
│  AI Assistant (Claude Opus + RAG)       │
│  - Диалог с клиентом                    │
│  - Консультирование                     │
│  - Предложение блоков и идей            │
└────────────────┬────────────────────────┘
                 │
        ┌────────┴────────┐
        │                 │
        ↓                 ↓
┌──────────────┐   ┌──────────────┐
│  Blocks DB   │   │ Knowledge    │
│  (Markdown   │   │ Base (RAG)   │
│  + metadata) │   │              │
└──────┬───────┘   └──────┬───────┘
       │                  │
       │           ┌──────┴────────┐
       │           │               │
       │      ┌────▼────┐   ┌─────▼─────┐
       │      │ Best    │   │ Successful│
       │      │practices│   │ verticals │
       │      └─────────┘   └───────────┘
       │
       ↓
┌────────────────────────────┐
│ Dependency Graph Engine    │
│ (Claude Sonnet)            │
│ - Парсинг описаний блоков  │
│ - Построение графа         │
│ - Проверка зависимостей    │
└────────────────┬───────────┘
                 │
                 ↓
┌────────────────────────────┐
│ Vertical Config (JSON)     │
│ - Список блоков            │
│ - Связи между блоками      │
│ - Настройки                │
└────────────────────────────┘
```

---

## 4. Workflow создания вертикали

### Шаг 1: Диалог и консультирование
**AI (Opus + RAG)** разговаривает с клиентом:
- Узнаёт бизнес и потребности
- Предлагает идеи на основе best practices
- Консультирует как эксперт-продавец

### Шаг 2: Подбор блоков
**AI (Sonnet)** выбирает нужные блоки:
- Из готовых пакетов или с нуля
- Проверяет зависимости
- Предлагает дополнительные блоки

### Шаг 3: Проверка и согласование
AI показывает визуальную схему вертикали:
- Какие блоки подключены
- Как они связаны
- Что настроено

Клиент может изменить, добавить, убрать.

### Шаг 4: Генерация конфигурации
AI создаёт JSON/YAML конфигурацию для развёртывания вертикали.

### Шаг 5: Если нужен MCP
AI генерирует ТЗ для разработчика или другого AI.

---

## 5. Workflow создания MCP (диалоговый подход)

### Этап 1: Выслушивание и уточнение

**AI:** "Какой функционал вам нужен?"

**Клиент:** "Нужна интеграция с 1С для выгрузки товаров"

**AI:** "Понял! Уточню детали:
- Какая версия 1С?
- Откуда берём товары?
- Как часто выгружать?
- Что делать с ценами?"

**Клиент:** "1С УТ 11, остатки со склада 'Основной', раз в час, цены выгружать"

---

### Этап 2: Показ результата без технических деталей

**AI:** "Отлично! Вот что получится:

**MCP: Интеграция 1С → Склад**

**Что делает:**
- Каждый час подключается к вашей 1С
- Забирает список товаров со склада 'Основной'
- Обновляет количество и цены в Блоке Склад
- Если товара нет — создаёт новый
- Если остаток изменился — обновляет

**Что настраивается:**
- Адрес 1С и логин/пароль
- Какой склад смотреть
- Как часто проверять (по умолчанию раз в час)

**Что увидите:**
- В Блоке Склад автоматически обновляются остатки
- Если что-то пошло не так — уведомление вам

Подходит?"

**Клиент:** "Да, но ещё хочу чтобы при низком остатке мне приходило уведомление"

**AI:** "Добавил! Когда товар падает ниже минимума — вам придёт уведомление. Минимум настраивается для каждого товара."

---

### Этап 3: Согласование и генерация ТЗ

**AI:** "Всё согласовали. Теперь сгенерирую техническое задание для разработчика..."

AI генерирует **подробное ТЗ** + **сохраняет полный контекст диалога**.

---

### Этап 4: Специальный аккаунт для разработчика

После согласования ТЗ, разработчику выдаётся **временный аккаунт** с доступом к:

#### 1. AI-ассистенту с полным контекстом
Разработчик может вести диалог напрямую с AI:

**Разработчик:** "В ТЗ указано поле `quantity`, а в API 1С оно `Количество`. Как маппить?"

**AI (помнит контекст):** "Правильно, делай маппинг:
```
1С: Количество → MCP: quantity (number)
```
Также проверь что это number, а не string."

---

#### 2. Тестовой вертикали (sandbox)
- Копия вертикали клиента
- Тестовые данные
- Безопасная среда (не влияет на продакшн)

---

#### 3. Системе отчётов об ошибках

**Разработчик кидает ошибку:**
```
ValidationError: field 'category' is required
```

**AI (проверяет контракт Блока Склад):** "Нашёл проблему! Блок Склад требует категорию обязательно. Обновил ТЗ:
- Маппинг: 1С.Номенклатура.Группа → category
- Если группы нет — использовать 'Без категории'"

---

#### 4. Автоматическому тестированию

После деплоя в sandbox, **AI автоматически тестирует** MCP:

```
Тест интеграции MCP "1С → Склад"

✅ Подключение к 1С: успешно
✅ Получение списка товаров: 127 позиций
❌ Запись в Блок Склад: ошибка

Детали ошибки:
- Товар "Масло 5W40": поле 'price' ожидает number,
  получен string "890.00"
- Рекомендация: конвертировать в number

Файл: mcp_1c_stock.py:145
```

---

#### 5. Каналу связи с клиентом через AI

**Разработчик → AI:** "Нужно уточнить у клиента: в 1С несколько складов. Какой использовать?"

**AI → Клиенту:** "Разработчик спрашивает: в вашей 1С несколько складов. Какой выгружать?"

**Клиент:** "Склад 'Основной'"

**AI → Разработчику:** "Клиент подтвердил: склад 'Основной'"

**Нет "сломанного телефона"** — прямое общение через AI-посредника.

---

### Этап 5: Итеративная разработка

**Разработчик показывает промежуточный результат:**
"Сделал подключение к 1С, выгрузка работает. Тестовые данные в аттаче."

**AI → Клиенту (переводит с технического):** "Разработчик подключился к вашей 1С и выгрузил тестовые данные:
- Товар 'Аккумулятор 60Ah' — 15 штук, цена 3500₽
- Товар 'Масло 5W40' — 24 штуки, цена 890₽

Выглядит правильно?"

**Клиент:** "Да, правильно"

**AI → Разработчику:** "Клиент подтвердил, формат корректный. Можно продолжать."

---

### Этап 6: Отладка совместимости

**Разработчик:** "При создании товара в Блоке Склад вылетает ошибка 'поле category обязательно'"

**AI (анализирует контракт):** "Блок Склад требует категорию. В 1С она есть?"

**Клиент:** "Да, там есть группы товаров"

**AI → Разработчику:** "В 1С есть группы товаров (Номенклатура.Группа). Добавь в маппинг."

Разработчик исправляет → "Готово, теперь работает!"

---

### Этап 7: Финальная проверка и деплой

**AI тестирует на реальных данных** (в sandbox):
- Все сценарии проходят
- Ошибок нет

**AI → Клиенту:** "Интеграция готова и протестирована! Хотите запустить?"

**Клиент:** "Да"

**AI:** "MCP развёрнут и работает. Первая синхронизация через 5 минут."

---

### Этап 8: Мониторинг и поддержка

*Через час после запуска:*

**AI (автоматически):** "Прошла первая синхронизация с 1С:
- Загружено 127 товаров
- Обновлено 84 остатка
- Ошибок нет

Всё работает корректно!"

---

### Этап 9: Закрытие аккаунта разработчика

После успешного деплоя:
- Аккаунт разработчика закрывается (или остаётся для поддержки на N дней)
- Весь контекст сохраняется в AI для будущих обновлений

---

## 6. Архитектура аккаунта разработчика

```
┌─────────────────────────────────────┐
│  Developer Account                  │
│  (временный, на срок разработки)    │
└───────────┬─────────────────────────┘
            │
    ┌───────┴────────┐
    │                │
    ↓                ↓
┌─────────┐   ┌──────────────┐
│ AI Chat │   │ Sandbox      │
│ (context│   │ Environment  │
│ aware)  │   │              │
└────┬────┘   └──────┬───────┘
     │               │
     │        ┌──────┴──────────┐
     │        │                 │
     │   ┌────▼────┐    ┌──────▼─────┐
     │   │ Client  │    │ Test Data  │
     │   │ Vertical│    │            │
     │   │ (copy)  │    └────────────┘
     │   └─────────┘
     │
     ↓
┌──────────────────┐
│ Error Logs       │
│ & Reports        │
│ Auto-testing     │
└──────────────────┘
```

---

## 7. Ключевые преимущества подхода

### Для создания вертикали:
1. **Простота для клиента** — диалог, а не техническая настройка
2. **Консультирование** — AI предлагает идеи и улучшения
3. **Быстрота** — вертикаль собирается за 10-15 минут
4. **Гибкость** — можно изменять на лету

### Для создания MCP:
1. **Нет "сломанного телефона"** — разработчик общается с AI напрямую
2. **Контекст сохранён** — AI помнит весь диалог с клиентом
3. **Автоматическое тестирование** — AI проверяет совместимость
4. **Итеративность** — можно показывать промежуточные результаты
5. **Перевод технического на человеческий** — клиент понимает что происходит

### Для системы в целом:
1. **Обучение AI** — система учится на каждом кейсе
2. **База знаний растёт** — лучшие практики накапливаются
3. **Скорость разработки** — меньше итераций, меньше ошибок
4. **Прозрачность** — клиент видит весь процесс

---

## 8. Распределение AI по задачам

| Задача | AI уровень | Модель | Примечание |
|--------|-----------|--------|------------|
| Консультирование клиента | Сильный + RAG | Claude Opus | Знает best practices |
| Сборка вертикали | Средний | Claude Sonnet | Работает с блоками |
| Генерация ТЗ для MCP | Средний/Сильный | Sonnet/Opus | Создаёт спецификации |
| Общение с разработчиком | Средний | Sonnet | Помнит контекст ТЗ |
| Реализация MCP (код) | Сильный | Opus / Dev | Пишет код |
| Валидация зависимостей | Простая логика | Graph алгоритм | Не нужен LLM |
| Автотестирование MCP | Средний | Sonnet | Запускает тесты |
| Мониторинг работы | Простая логика | Скрипты + AI | Алерты если проблема |

---

## 9. Открытые вопросы для проработки

### Технические:
- Формат хранения контекста диалогов (для долгосрочной памяти AI)
- Как версионировать ТЗ MCP при изменениях
- Безопасность sandbox для разработчиков
- Лимиты на время работы временного аккаунта

### UX:
- Как показывать клиенту прогресс разработки MCP
- Нужна ли возможность клиенту самому общаться с разработчиком
- Визуализация тестирования MCP

### AI:
- Как обучать RAG на успешных кейсах
- Персонализация подсказок под нишу
- Может ли AI сам предлагать MCP до того как клиент попросит

---

*Этот документ описывает архитектуру AI-системы Eldoleado для создания вертикалей и MCP с максимальной автоматизацией и упрощением для клиента.*
