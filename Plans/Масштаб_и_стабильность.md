# Ğ¢Ğ—: ĞœĞ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸ Ğ¾Ñ‚ĞºĞ°Ğ·Ğ¾ÑƒÑÑ‚Ğ¾Ğ¹Ñ‡Ğ¸Ğ²Ğ¾ÑÑ‚ÑŒ Eldoleado

> **Ğ¦ĞµĞ»ÑŒ:** ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°, ÑĞ¿Ğ¾ÑĞ¾Ğ±Ğ½Ğ°Ñ Ğ¾Ğ±ÑĞ»ÑƒĞ¶Ğ¸Ğ²Ğ°Ñ‚ÑŒ 100 â†’ 1000 Ñ‚ĞµĞ½Ğ°Ğ½Ñ‚Ğ¾Ğ² Ñ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¼ ÑƒÑ‡Ğ°ÑÑ‚Ğ¸ĞµĞ¼ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ°, Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑ n8n

---

## 1. Ğ¢ĞµĞºÑƒÑ‰ĞµĞµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ

### ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°
- **n8n** â€” Ğ¾Ğ´Ğ¸Ğ½ ÑĞµÑ€Ğ²ĞµÑ€, Ğ²ÑĞµ workflows
- **PostgreSQL** â€” Supabase (185.221.214.83:6544)
- **Neo4j** â€” Ğ³Ñ€Ğ°Ñ„Ğ¾Ğ²Ğ°Ñ Ğ‘Ğ” (45.144.177.128)
- **ĞšĞ°Ğ½Ğ°Ğ»Ñ‹:** Telegram, VK, WhatsApp, Avito, MAX

### ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹
| ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° | Ğ’Ğ»Ğ¸ÑĞ½Ğ¸Ğµ |
|----------|---------|
| ĞĞ´Ğ¸Ğ½ n8n ÑĞµÑ€Ğ²ĞµÑ€ | Single point of failure |
| Execute Workflow | Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ñ‹Ğµ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ñ‹, Ğ½Ğµ Ğ¼Ğ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ |
| AI Ğ² n8n | Polling 5 ÑĞµĞº, max 7 workers |
| ĞĞµÑ‚ Ñ€ĞµĞ¿Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸ Ğ‘Ğ” | ĞŸĞ¾Ñ‚ĞµÑ€Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ñ€Ğ¸ ÑĞ±Ğ¾Ğµ |

### Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğµ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚Ñ‹
- **Throughput:** ~3 msg/sec
- **AI workers:** 7 (n8n Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ğµ)
- **Ğ¢ĞµĞ½Ğ°Ğ½Ñ‚Ñ‹:** ~10-20 (ĞºĞ¾Ğ¼Ñ„Ğ¾Ñ€Ñ‚Ğ½Ğ¾)

---

## 2. Ğ¦ĞµĞ»ĞµĞ²Ğ¾Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ

### Ğ¢Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
- **100 Ñ‚ĞµĞ½Ğ°Ğ½Ñ‚Ğ¾Ğ²** â€” Ğ±ĞµĞ· Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ Ğ¸Ğ½Ñ„Ñ€Ğ°ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñ‹
- **200-500 Ñ‚ĞµĞ½Ğ°Ğ½Ñ‚Ğ¾Ğ²** â€” Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑĞµÑ€Ğ²ĞµÑ€Ğ¾Ğ² ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ğ¾Ğ¼
- **1000 Ñ‚ĞµĞ½Ğ°Ğ½Ñ‚Ğ¾Ğ²** â€” Ğ¿Ğ¾Ğ»Ğ½Ğ°Ñ Ğ³Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ½Ñ‚Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¼Ğ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€ÑƒĞµĞ¼Ğ¾ÑÑ‚ÑŒ
- **ĞÑ‚ĞºĞ°Ğ·Ğ¾ÑƒÑÑ‚Ğ¾Ğ¹Ñ‡Ğ¸Ğ²Ğ¾ÑÑ‚ÑŒ** â€” Ğ¿Ñ€Ğ¸ Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ğ¸ ÑĞµÑ€Ğ²ĞµÑ€Ğ° Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ failover
- **ĞœĞ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ ĞºĞ¾Ğ´Ğ°** â€” Ğ¼Ğ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ n8n, Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ Python

### Ğ¦ĞµĞ»ĞµĞ²Ñ‹Ğµ Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸
| ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ° | Ğ—Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ |
|---------|----------|
| Throughput | 50-100 msg/sec |
| AI latency | <3 ÑĞµĞº (ÑÑ€ĞµĞ´Ğ½ĞµĞµ) |
| Uptime | 99.9% |
| Failover time | <60 ÑĞµĞº |

---

## 3. ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ

### 3.1. ĞĞ±Ñ‰Ğ°Ñ ÑÑ…ĞµĞ¼Ğ°

```
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚           LOAD BALANCER             â”‚
                         â”‚      (Nginx / Cloudflare)           â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â–¼                             â–¼                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   n8n TRANSPORT  â”‚          â”‚  n8n PROCESSING  â”‚          â”‚     n8n API      â”‚
â”‚                  â”‚          â”‚                  â”‚          â”‚                  â”‚
â”‚  â€¢ BAT IN TG     â”‚  â”€â”€â”€â”€â”€â”€â–¶ â”‚  â€¢ Tenant Res    â”‚          â”‚  â€¢ Android API   â”‚
â”‚  â€¢ BAT IN VK     â”‚  webhook â”‚  â€¢ Client Res    â”‚          â”‚  â€¢ Operator API  â”‚
â”‚  â€¢ BAT IN WA     â”‚          â”‚  â€¢ Appeal Mgr    â”‚          â”‚                  â”‚
â”‚  â€¢ BAT IN Avito  â”‚          â”‚  â€¢ Batcher       â”‚          â”‚                  â”‚
â”‚                  â”‚          â”‚  â€¢ Notifier      â”‚          â”‚                  â”‚
â”‚  â€¢ BAT OUT TG    â”‚  â—€â”€â”€â”€â”€â”€â”€ â”‚  â€¢ Msg Router    â”‚          â”‚                  â”‚
â”‚  â€¢ BAT OUT VK    â”‚  webhook â”‚                  â”‚          â”‚                  â”‚
â”‚  â€¢ BAT OUT WA    â”‚          â”‚                  â”‚          â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                 Redis Queue
                                       â”‚
                                       â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚  PYTHON AI       â”‚
                              â”‚  WORKER          â”‚
                              â”‚                  â”‚
                              â”‚  20-50 workers   â”‚
                              â”‚  parallel        â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚  PostgreSQL      â”‚
                              â”‚  Primary         â”‚
                              â”‚        â”‚         â”‚
                              â”‚        â–¼         â”‚
                              â”‚  Standby         â”‚
                              â”‚  (replica)       â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2. ĞŸÑ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿ Ñ€Ğ°Ğ·Ğ´ĞµĞ»ĞµĞ½Ğ¸Ñ

| Ğ¡ĞµÑ€Ğ²ĞµÑ€ | Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ | Workflows |
|--------|---------|-----------|
| **n8n Transport** | Ğ’Ñ…Ğ¾Ğ´ÑÑ‰Ğ¸Ğµ/Ğ¸ÑÑ…Ğ¾Ğ´ÑÑ‰Ğ¸Ğµ ĞºĞ°Ğ½Ğ°Ğ»Ñ‹ | BAT IN *, BAT OUT * |
| **n8n Processing** | Ğ‘Ğ¸Ğ·Ğ½ĞµÑ-Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° | Resolver, Manager, Router, Notifier |
| **n8n API** | HTTP API Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¹ | API_Android_*, API_Operator_* |
| **Python AI Worker** | AI extraction, response | ĞĞ´Ğ¸Ğ½ ÑĞºÑ€Ğ¸Ğ¿Ñ‚ ~100 ÑÑ‚Ñ€Ğ¾Ğº |

### 3.3. Ğ¡Ğ²ÑĞ·ÑŒ Ğ¼ĞµĞ¶Ğ´Ñƒ ÑĞµÑ€Ğ²ĞµÑ€Ğ°Ğ¼Ğ¸

**Ğ’Ğ¼ĞµÑÑ‚Ğ¾ Execute Workflow â†’ HTTP Webhook:**

```
# Ğ‘Ñ‹Ğ»Ğ¾ (Execute Workflow â€” Ğ¾Ğ´Ğ¸Ğ½ ÑĞµÑ€Ğ²ĞµÑ€)
BAT IN Telegram
    â””â”€â”€ Execute Workflow: BAT_Tenant_Resolver
            â””â”€â”€ Execute Workflow: Universal_Batcher
                    â””â”€â”€ ...

# Ğ¡Ñ‚Ğ°Ğ»Ğ¾ (HTTP â€” Ñ€Ğ°Ğ·Ğ½Ñ‹Ğµ ÑĞµÑ€Ğ²ĞµÑ€Ñ‹)
BAT IN Telegram (n8n Transport)
    â””â”€â”€ HTTP POST â†’ n8n-processing:5678/webhook/tenant-resolver
            â””â”€â”€ HTTP POST â†’ n8n-processing:5678/webhook/batcher
                    â””â”€â”€ ...
```

**AI Ñ‡ĞµÑ€ĞµĞ· Redis (Ğ½Ğµ Execute Workflow):**

```
n8n Processing                    Python AI Worker
      â”‚                                  â”‚
      â”‚  LPUSH ai:queue                  â”‚
      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶
      â”‚                                  â”‚
      â”‚           (Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ°)            â”‚
      â”‚                                  â”‚
      â”‚  BRPOP ai:results:{id}           â”‚
      â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
      â”‚                                  â”‚
```

---

## 4. ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹

### 4.1. n8n Transport Server

**ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ:** ĞŸÑ€Ğ¸Ñ‘Ğ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ¸Ğ· ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ², Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¾Ğ²

**Workflows:**
| Workflow | Ğ¢Ñ€Ğ¸Ğ³Ğ³ĞµÑ€ | Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ |
|----------|---------|----------|
| BAT IN Telegram | Telegram Trigger | Normalize â†’ HTTP POST to Processing |
| BAT IN VK | Webhook | Normalize â†’ HTTP POST to Processing |
| BAT IN WhatsApp | Webhook | Normalize â†’ HTTP POST to Processing |
| BAT IN Avito | Webhook | Normalize â†’ HTTP POST to Processing |
| BAT IN MAX | Webhook | Normalize â†’ HTTP POST to Processing |
| BAT OUT Telegram | Webhook from Processing | Send via Telegram API |
| BAT OUT VK | Webhook from Processing | Send via VK API |
| BAT OUT WhatsApp | Webhook from Processing | Send via WhatsApp API |

**Environment:**
```env
N8N_PROCESSING_URL=http://n8n-processing:5678
WEBHOOK_URL=https://transport.eldoleado.ru
```

### 4.2. n8n Processing Server

**ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ:** Ğ’ÑÑ Ğ±Ğ¸Ğ·Ğ½ĞµÑ-Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹

**Workflows:**
| Workflow | Ğ¢Ñ€Ğ¸Ğ³Ğ³ĞµÑ€ | Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ |
|----------|---------|----------|
| BAT_Tenant_Resolver | Webhook | SQL lookup tenant â†’ return |
| BAT_Client_Resolver | Webhook | SQL find/create client â†’ return |
| BAT_Client_Creator | Webhook | SQL insert client â†’ return |
| BAT_Appeal_Manager | Webhook | SQL manage appeal â†’ return |
| Universal_Batcher | Webhook | Batch messages â†’ trigger processing |
| BAT_AI_Dispatcher | Internal | LPUSH to Redis â†’ wait BRPOP result |
| BAT_Operator_Notifier | Webhook | Send notifications to operators |
| BAT_Message_Router | Webhook | HTTP POST to Transport (OUT) |
| BAT_FCM_Sender | Webhook | Send FCM push |

**Environment:**
```env
N8N_TRANSPORT_URL=http://n8n-transport:5678
N8N_API_URL=http://n8n-api:5678
REDIS_URL=redis://redis:6379
DATABASE_URL=postgresql://...
```

### 4.3. n8n API Server

**ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ:** REST API Ğ´Ğ»Ñ Android Ğ¸ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€ÑĞºĞ¾Ğ³Ğ¾ Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑĞ°

**Workflows:**
| Workflow | Endpoint | Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ |
|----------|----------|----------|
| API_Android_Auth | POST /webhook/android/auth/login | Auth â†’ return session |
| API_Android_Logout | POST /webhook/android/auth/logout | Invalidate session |
| API_Operator_Appeals_List | GET /webhook/operator/appeals/list | Query appeals â†’ return |
| API_Operator_Appeal_Detail | GET /webhook/operator/appeals/:id | Query detail â†’ return |
| API_Operator_Take_Appeal | POST /webhook/operator/appeals/:id/take | Update appeal |
| API_Operator_Send_Response | POST /webhook/operator/appeals/:id/send | HTTP to Processing |

**Environment:**
```env
N8N_PROCESSING_URL=http://n8n-processing:5678
WEBHOOK_URL=https://api.eldoleado.ru
DATABASE_URL=postgresql://...
```

### 4.4. Python AI Worker

**ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ:** Ğ‘Ñ‹ÑÑ‚Ñ€Ğ°Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° AI extraction (bottleneck n8n)

**Ğ¤Ğ°Ğ¹Ğ»:** `services/ai-worker/ai_worker.py`

```python
#!/usr/bin/env python3
"""
AI Worker for Eldoleado.
Ğ•Ğ´Ğ¸Ğ½ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğ¹ Python ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ Ğ² ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ.
"""

import asyncio
import json
import os
from datetime import datetime

import redis.asyncio as redis
from openai import AsyncOpenAI

# Config
REDIS_URL = os.getenv("REDIS_URL", "redis://localhost:6379")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")

# Queues
QUEUE_IN = "ai:extraction:queue"
QUEUE_OUT_PREFIX = "ai:extraction:results:"

# OpenAI
openai_client = AsyncOpenAI(api_key=OPENAI_API_KEY)

SYSTEM_PROMPT = """Ğ¢Ñ‹ â€” AI-Ğ°ÑÑĞ¸ÑÑ‚ĞµĞ½Ñ‚ ÑĞµÑ€Ğ²Ğ¸ÑĞ½Ğ¾Ğ³Ğ¾ Ñ†ĞµĞ½Ñ‚Ñ€Ğ°. Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ¸ Ğ¸Ğ· ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ:
1. Ğ¢Ğ¸Ğ¿ Ğ¾Ğ±Ñ€Ğ°Ñ‰ĞµĞ½Ğ¸Ñ (Ñ€ĞµĞ¼Ğ¾Ğ½Ñ‚/Ğ¿Ğ¾ĞºÑƒĞ¿ĞºĞ°/Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶Ğ°/Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ)
2. Ğ‘Ñ€ĞµĞ½Ğ´ ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ°
3. ĞœĞ¾Ğ´ĞµĞ»ÑŒ ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ°
4. Ğ¢Ğ¸Ğ¿ Ñ€ĞµĞ¼Ğ¾Ğ½Ñ‚Ğ°
5. Ğ§ÑŒÑ Ğ·Ğ°Ğ¿Ñ‡Ğ°ÑÑ‚ÑŒ (Ğ½Ğ°ÑˆĞ°/ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°)

Ğ’ĞµÑ€Ğ½Ğ¸ JSON:
{
  "type": "Ñ€ĞµĞ¼Ğ¾Ğ½Ñ‚",
  "brand": "Apple",
  "model": "iPhone 14",
  "repair_type": "Ğ±Ğ°Ñ‚Ğ°Ñ€ĞµÑ",
  "parts_owner": "Ğ½Ğ°ÑˆĞ°",
  "confidence": 0.95,
  "missing_fields": [],
  "suggested_response": "ĞÑ‚Ğ²ĞµÑ‚ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ñƒ..."
}"""


async def process_task(task: dict) -> dict:
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ AI extraction."""
    try:
        response = await openai_client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "system", "content": SYSTEM_PROMPT},
                {"role": "user", "content": task.get("text", "")}
            ],
            response_format={"type": "json_object"},
            temperature=0.1,
            max_tokens=500
        )

        result = json.loads(response.choices[0].message.content)
        result["success"] = True
        return result

    except Exception as e:
        return {"success": False, "error": str(e)}


async def worker(worker_id: int, r: redis.Redis):
    """Worker loop."""
    print(f"[Worker {worker_id}] Started")

    while True:
        try:
            result = await r.brpop(QUEUE_IN, timeout=30)
            if result is None:
                continue

            _, task_json = result
            task = json.loads(task_json)
            callback_id = task.get("callback_id")

            ai_result = await process_task(task)
            ai_result["callback_id"] = callback_id

            await r.lpush(f"{QUEUE_OUT_PREFIX}{callback_id}", json.dumps(ai_result))
            await r.expire(f"{QUEUE_OUT_PREFIX}{callback_id}", 300)

        except Exception as e:
            print(f"[Worker {worker_id}] Error: {e}")
            await asyncio.sleep(1)


async def main():
    r = redis.from_url(REDIS_URL)
    await r.ping()

    num_workers = int(os.getenv("NUM_WORKERS", "10"))
    workers = [worker(i, r) for i in range(num_workers)]
    await asyncio.gather(*workers)


if __name__ == "__main__":
    asyncio.run(main())
```

**Dockerfile:**
```dockerfile
FROM python:3.11-slim
WORKDIR /app
RUN pip install redis openai
COPY ai_worker.py .
ENV NUM_WORKERS=10
CMD ["python", "ai_worker.py"]
```

### 4.5. Redis

**ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ:** ĞÑ‡ĞµÑ€ĞµĞ´Ğ¸ Ğ´Ğ»Ñ AI Ğ¸ Ğ¼ĞµĞ¶ÑĞµÑ€Ğ²Ğ¸ÑĞ½Ğ¾Ğ³Ğ¾ Ğ²Ğ·Ğ°Ğ¸Ğ¼Ğ¾Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ

**ĞÑ‡ĞµÑ€ĞµĞ´Ğ¸:**
| Queue | Producer | Consumer |
|-------|----------|----------|
| `ai:extraction:queue` | n8n Processing | Python AI Worker |
| `ai:extraction:results:{callback_id}` | Python AI Worker | n8n Processing |

### 4.6. PostgreSQL

**ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ:** Ğ¥Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ±Ğ¸Ğ·Ğ½ĞµÑ-Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… + Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… n8n

**Ğ‘Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…:**
| Database | ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ |
|----------|------------|
| `n8n_transport` | Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ n8n Transport |
| `n8n_processing` | Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ n8n Processing |
| `n8n_api` | Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ n8n API |
| `eldoleado` | Ğ‘Ğ¸Ğ·Ğ½ĞµÑ-Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ (tenants, clients, appeals...) |

**Ğ ĞµĞ¿Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ:**
```
Primary (Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹)
    â”‚
    â”‚  Streaming Replication
    â–¼
Standby (Ñ€ĞµĞ¿Ğ»Ğ¸ĞºĞ°, read-only)
```

---

## 5. Docker Compose

### 5.1. ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ñ„Ğ°Ğ¹Ğ»

**Ğ¤Ğ°Ğ¹Ğ»:** `docker-compose.yml`

```yaml
version: '3.8'

services:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # n8n Transport
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  n8n-transport:
    image: n8nio/n8n:latest
    container_name: n8n-transport
    ports:
      - "5678:5678"
    environment:
      - N8N_HOST=0.0.0.0
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - WEBHOOK_URL=${TRANSPORT_WEBHOOK_URL}
      - N8N_PROCESSING_URL=http://n8n-processing:5678
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=n8n_transport
      - DB_POSTGRESDB_USER=${DB_USER}
      - DB_POSTGRESDB_PASSWORD=${DB_PASSWORD}
      - GENERIC_TIMEZONE=Europe/Moscow
    volumes:
      - n8n_transport_data:/home/node/.n8n
    depends_on:
      - postgres
    restart: always
    networks:
      - eldoleado

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # n8n Processing
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  n8n-processing:
    image: n8nio/n8n:latest
    container_name: n8n-processing
    ports:
      - "5679:5678"
    environment:
      - N8N_HOST=0.0.0.0
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - WEBHOOK_URL=http://n8n-processing:5678
      - N8N_TRANSPORT_URL=http://n8n-transport:5678
      - N8N_API_URL=http://n8n-api:5678
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=n8n_processing
      - DB_POSTGRESDB_USER=${DB_USER}
      - DB_POSTGRESDB_PASSWORD=${DB_PASSWORD}
      - GENERIC_TIMEZONE=Europe/Moscow
      # Ğ‘Ğ¸Ğ·Ğ½ĞµÑ-Ğ±Ğ°Ğ·Ğ°
      - DATABASE_URL=postgresql://${DB_USER}:${DB_PASSWORD}@postgres:5432/eldoleado
    volumes:
      - n8n_processing_data:/home/node/.n8n
    depends_on:
      - postgres
      - redis
    restart: always
    networks:
      - eldoleado

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # n8n API
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  n8n-api:
    image: n8nio/n8n:latest
    container_name: n8n-api
    ports:
      - "5680:5678"
    environment:
      - N8N_HOST=0.0.0.0
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - WEBHOOK_URL=${API_WEBHOOK_URL}
      - N8N_PROCESSING_URL=http://n8n-processing:5678
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=n8n_api
      - DB_POSTGRESDB_USER=${DB_USER}
      - DB_POSTGRESDB_PASSWORD=${DB_PASSWORD}
      - GENERIC_TIMEZONE=Europe/Moscow
      - DATABASE_URL=postgresql://${DB_USER}:${DB_PASSWORD}@postgres:5432/eldoleado
    volumes:
      - n8n_api_data:/home/node/.n8n
    depends_on:
      - postgres
    restart: always
    networks:
      - eldoleado

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Python AI Worker
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ai-worker:
    build:
      context: ./services/ai-worker
      dockerfile: Dockerfile
    container_name: ai-worker
    environment:
      - REDIS_URL=redis://redis:6379
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - NUM_WORKERS=20
    depends_on:
      - redis
    restart: always
    deploy:
      replicas: 2
    networks:
      - eldoleado

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Redis
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    restart: always
    networks:
      - eldoleado

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PostgreSQL
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  postgres:
    image: postgres:16
    container_name: postgres
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_DB=eldoleado
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init.sql
    restart: always
    networks:
      - eldoleado

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Nginx Reverse Proxy
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  nginx:
    image: nginx:alpine
    container_name: nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/certs:/etc/nginx/certs:ro
    depends_on:
      - n8n-transport
      - n8n-processing
      - n8n-api
    restart: always
    networks:
      - eldoleado

volumes:
  n8n_transport_data:
  n8n_processing_data:
  n8n_api_data:
  redis_data:
  postgres_data:

networks:
  eldoleado:
    driver: bridge
```

### 5.2. Environment Ñ„Ğ°Ğ¹Ğ»

**Ğ¤Ğ°Ğ¹Ğ»:** `.env`

```env
# Database
DB_USER=eldoleado
DB_PASSWORD=your_secure_password_here

# Webhooks (Ğ¿ÑƒĞ±Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğµ URL)
TRANSPORT_WEBHOOK_URL=https://transport.eldoleado.ru
API_WEBHOOK_URL=https://api.eldoleado.ru

# OpenAI
OPENAI_API_KEY=sk-...

# Optional
GENERIC_TIMEZONE=Europe/Moscow
```

### 5.3. Init DB

**Ğ¤Ğ°Ğ¹Ğ»:** `init-db.sql`

```sql
-- Ğ‘Ğ°Ğ·Ñ‹ Ğ´Ğ»Ñ n8n
CREATE DATABASE n8n_transport;
CREATE DATABASE n8n_processing;
CREATE DATABASE n8n_api;

-- Ğ‘Ğ¸Ğ·Ğ½ĞµÑ-Ğ±Ğ°Ğ·Ğ° ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚ (eldoleado)
-- Ğ•ÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ:
-- CREATE DATABASE eldoleado;
```

### 5.4. Nginx ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ

**Ğ¤Ğ°Ğ¹Ğ»:** `nginx/nginx.conf`

```nginx
events {
    worker_connections 1024;
}

http {
    upstream transport {
        server n8n-transport:5678;
    }

    upstream processing {
        server n8n-processing:5678;
    }

    upstream api {
        server n8n-api:5678;
    }

    # Transport (Telegram/VK/WA webhooks)
    server {
        listen 443 ssl http2;
        server_name transport.eldoleado.ru;

        ssl_certificate /etc/nginx/certs/fullchain.pem;
        ssl_certificate_key /etc/nginx/certs/privkey.pem;

        location / {
            proxy_pass http://transport;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 300s;
        }
    }

    # API (Android app)
    server {
        listen 443 ssl http2;
        server_name api.eldoleado.ru;

        ssl_certificate /etc/nginx/certs/fullchain.pem;
        ssl_certificate_key /etc/nginx/certs/privkey.pem;

        location / {
            proxy_pass http://api;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # n8n UI (Ğ´Ğ»Ñ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸)
    server {
        listen 443 ssl http2;
        server_name n8n.eldoleado.ru;

        ssl_certificate /etc/nginx/certs/fullchain.pem;
        ssl_certificate_key /etc/nginx/certs/privkey.pem;

        # Processing UI ĞºĞ°Ğº Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹
        location / {
            proxy_pass http://processing;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğº Transport UI
        location /transport/ {
            rewrite ^/transport/(.*) /$1 break;
            proxy_pass http://transport;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğº API UI
        location /api-admin/ {
            rewrite ^/api-admin/(.*) /$1 break;
            proxy_pass http://api;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }

    # HTTP â†’ HTTPS redirect
    server {
        listen 80;
        server_name *.eldoleado.ru;
        return 301 https://$host$request_uri;
    }
}
```

---

## 6. ĞœĞ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ workflows

### 6.1. Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ² workflows

**Ğ—Ğ°Ğ¼ĞµĞ½Ğ° Execute Workflow Ğ½Ğ° HTTP Request:**

| Workflow | Ğ‘Ñ‹Ğ»Ğ¾ | Ğ¡Ñ‚Ğ°Ğ»Ğ¾ |
|----------|------|-------|
| BAT IN Telegram | Execute: BAT_Tenant_Resolver | HTTP POST: n8n-processing/webhook/tenant-resolver |
| BAT IN VK | Execute: BAT_Tenant_Resolver | HTTP POST: n8n-processing/webhook/tenant-resolver |
| All IN workflows | Execute: Universal_Batcher | HTTP POST: n8n-processing/webhook/batcher |
| BAT_Message_Router | Execute: BAT OUT * | HTTP POST: n8n-transport/webhook/out-{channel} |
| API_Operator_Send | Execute: BAT_Message_Router | HTTP POST: n8n-processing/webhook/message-router |

### 6.2. ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ½Ğ¾Ğ´Ñ‹

**Ğ‘Ñ‹Ğ»Ğ¾ (Execute Workflow):**
```json
{
  "name": "Execute Tenant Resolver",
  "type": "n8n-nodes-base.executeWorkflow",
  "parameters": {
    "workflowId": "={{ $workflow.id }}",
    "mode": "sync"
  }
}
```

**Ğ¡Ñ‚Ğ°Ğ»Ğ¾ (HTTP Request):**
```json
{
  "name": "Call Tenant Resolver",
  "type": "n8n-nodes-base.httpRequest",
  "parameters": {
    "method": "POST",
    "url": "={{ $env.N8N_PROCESSING_URL }}/webhook/tenant-resolver",
    "sendBody": true,
    "specifyBody": "json",
    "jsonBody": "={{ JSON.stringify($json) }}",
    "options": {
      "timeout": 30000
    }
  }
}
```

### 6.3. Ğ Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ workflows

**n8n Transport (port 5678):**
```
workflows/transport/
â”œâ”€â”€ BAT_IN_Telegram.json
â”œâ”€â”€ BAT_IN_VK.json
â”œâ”€â”€ BAT_IN_WhatsApp.json
â”œâ”€â”€ BAT_IN_Avito.json
â”œâ”€â”€ BAT_IN_MAX.json
â”œâ”€â”€ BAT_OUT_Telegram.json
â”œâ”€â”€ BAT_OUT_VK.json
â”œâ”€â”€ BAT_OUT_WhatsApp.json
â”œâ”€â”€ BAT_OUT_Avito.json
â””â”€â”€ BAT_OUT_MAX.json
```

**n8n Processing (port 5679):**
```
workflows/processing/
â”œâ”€â”€ BAT_Tenant_Resolver.json
â”œâ”€â”€ BAT_Client_Resolver.json
â”œâ”€â”€ BAT_Client_Creator.json
â”œâ”€â”€ BAT_Appeal_Manager.json
â”œâ”€â”€ Universal_Batcher.json
â”œâ”€â”€ BAT_AI_Dispatcher.json
â”œâ”€â”€ BAT_AI_Appeal_Router.json
â”œâ”€â”€ BAT_Operator_Notifier.json
â”œâ”€â”€ BAT_Message_Router.json
â””â”€â”€ BAT_FCM_Sender.json
```

**n8n API (port 5680):**
```
workflows/api/
â”œâ”€â”€ API_Android_Auth.json
â”œâ”€â”€ API_Android_Logout.json
â”œâ”€â”€ API_Operator_Appeals_List.json
â”œâ”€â”€ API_Operator_Appeal_Detail.json
â”œâ”€â”€ API_Operator_Take_Appeal.json
â””â”€â”€ API_Operator_Send_Response.json
```

---

## 7. ĞÑ‚ĞºĞ°Ğ·Ğ¾ÑƒÑÑ‚Ğ¾Ğ¹Ñ‡Ğ¸Ğ²Ğ¾ÑÑ‚ÑŒ

### 7.1. PostgreSQL Replication

**Primary â†’ Standby:**
```yaml
# docker-compose.ha.yml (Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ)
services:
  postgres-standby:
    image: postgres:16
    environment:
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
    volumes:
      - postgres_standby_data:/var/lib/postgresql/data
    command: |
      bash -c "
        until pg_basebackup -h postgres -D /var/lib/postgresql/data -U ${DB_USER} -Fp -Xs -P -R; do
          echo 'Waiting for primary...'
          sleep 5
        done
        postgres
      "
    depends_on:
      - postgres
```

### 7.2. Health Check Script

**Ğ¤Ğ°Ğ¹Ğ»:** `scripts/health_check.py`

```python
#!/usr/bin/env python3
"""
Health check Ğ´Ğ»Ñ Ğ²ÑĞµÑ… ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ².
Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°Ñ‚ÑŒ Ñ‡ĞµÑ€ĞµĞ· cron ĞºĞ°Ğ¶Ğ´ÑƒÑ Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñƒ.
"""

import requests
import smtplib
from email.message import EmailMessage

SERVICES = {
    "n8n-transport": "http://localhost:5678/healthz",
    "n8n-processing": "http://localhost:5679/healthz",
    "n8n-api": "http://localhost:5680/healthz",
    "redis": "redis://localhost:6379",
}

ALERT_EMAIL = "admin@eldoleado.ru"

def check_services():
    failed = []

    for name, url in SERVICES.items():
        try:
            if url.startswith("redis://"):
                import redis
                r = redis.from_url(url)
                r.ping()
            else:
                resp = requests.get(url, timeout=5)
                if resp.status_code != 200:
                    failed.append(name)
        except Exception as e:
            failed.append(f"{name}: {e}")

    if failed:
        send_alert(failed)

def send_alert(failed):
    msg = EmailMessage()
    msg["Subject"] = "ğŸ”´ Eldoleado: Service Down"
    msg["From"] = "monitor@eldoleado.ru"
    msg["To"] = ALERT_EMAIL
    msg.set_content(f"Failed services:\n" + "\n".join(failed))

    # Send via SMTP
    # ...

if __name__ == "__main__":
    check_services()
```

### 7.3. Auto-restart (Docker)

Ğ’ÑĞµ ÑĞµÑ€Ğ²Ğ¸ÑÑ‹ Ğ¸Ğ¼ĞµÑÑ‚ `restart: always` â€” Docker Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ Ğ¿Ñ€Ğ¸ Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ğ¸.

---

## 8. ĞœĞ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

### 8.1. Ğ’ĞµÑ€Ñ‚Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğµ (ÑƒĞ²ĞµĞ»Ğ¸Ñ‡ĞµĞ½Ğ¸Ğµ Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ²)

| ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ | ĞœĞ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ | Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ | ĞœĞ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ |
|-----------|---------|---------------|----------|
| n8n Transport | 1 vCPU, 1GB | 2 vCPU, 2GB | 4 vCPU, 4GB |
| n8n Processing | 2 vCPU, 2GB | 4 vCPU, 4GB | 8 vCPU, 8GB |
| n8n API | 1 vCPU, 1GB | 2 vCPU, 2GB | 4 vCPU, 4GB |
| AI Worker | 1 vCPU, 512MB | 2 vCPU, 1GB | 4 vCPU, 2GB |
| Redis | 1 vCPU, 512MB | 1 vCPU, 1GB | 2 vCPU, 2GB |
| PostgreSQL | 2 vCPU, 2GB | 4 vCPU, 8GB | 8 vCPU, 16GB |

### 8.2. Ğ“Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ½Ñ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ (Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑĞµÑ€Ğ²ĞµÑ€Ğ¾Ğ²)

**Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹: 100 â†’ 200 Ñ‚ĞµĞ½Ğ°Ğ½Ñ‚Ğ¾Ğ²**

1. Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ²Ñ‚Ğ¾Ñ€Ğ¾Ğ¹ ÑĞµÑ€Ğ²ĞµÑ€ Ñ n8n-processing-2
2. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ² nginx upstream
3. Ğ Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸Ñ‚ÑŒ Ñ‚ĞµĞ½Ğ°Ğ½Ñ‚Ñ‹ Ğ¿Ğ¾ ÑĞµÑ€Ğ²ĞµÑ€Ğ°Ğ¼

**nginx upstream Ğ´Ğ»Ñ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ¸Ñ€Ğ¾Ğ²ĞºĞ¸:**
```nginx
upstream processing {
    server n8n-processing-1:5678 weight=1;
    server n8n-processing-2:5678 weight=1;
}
```

### 8.3. Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ ÑĞµÑ€Ğ²ĞµÑ€Ğ°

**Ğ¤Ğ°Ğ¹Ğ»:** `scripts/add_server.sh`

```bash
#!/bin/bash
# Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ ÑĞµÑ€Ğ²ĞµÑ€Ğ° Ğ² ĞºĞ»Ğ°ÑÑ‚ĞµÑ€

SERVER_NAME=$1
SERVER_IP=$2

echo "Adding server: $SERVER_NAME ($SERVER_IP)"

# 1. SSH Ğ¸ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Docker
ssh root@$SERVER_IP << 'EOF'
    apt update && apt install -y docker.io docker-compose
    systemctl enable docker
EOF

# 2. ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ docker-compose
scp docker-compose.yml root@$SERVER_IP:/opt/eldoleado/

# 3. ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ .env
scp .env root@$SERVER_IP:/opt/eldoleado/

# 4. Ğ—Ğ°Ğ¿ÑƒÑĞº
ssh root@$SERVER_IP "cd /opt/eldoleado && docker-compose up -d"

# 5. ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ nginx
echo "server $SERVER_IP:5678;" >> nginx/upstream_processing.conf
docker exec nginx nginx -s reload

echo "Done! Server $SERVER_NAME added."
```

---

## 9. ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³

### 9.1. Ğ›Ğ¾Ğ³Ğ¸

```bash
# ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ Ğ»Ğ¾Ğ³Ğ¾Ğ² Ğ²ÑĞµÑ… ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
docker-compose logs -f

# Ğ›Ğ¾Ğ³Ğ¸ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ ÑĞµÑ€Ğ²Ğ¸ÑĞ°
docker-compose logs -f n8n-processing

# Ğ›Ğ¾Ğ³Ğ¸ AI worker
docker-compose logs -f ai-worker
```

### 9.2. ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸ Redis

```bash
# Ğ”Ğ»Ğ¸Ğ½Ğ° Ğ¾Ñ‡ĞµÑ€ĞµĞ´ĞµĞ¹
redis-cli LLEN ai:extraction:queue

# ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ Ğ² Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸
redis-cli MONITOR
```

### 9.3. Dashboard (Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ¹)

**Ğ¤Ğ°Ğ¹Ğ»:** `scripts/dashboard.py`

```python
#!/usr/bin/env python3
"""ĞŸÑ€Ğ¾ÑÑ‚Ğ¾Ğ¹ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ dashboard."""

import redis
import psycopg2
import requests
from datetime import datetime

def main():
    r = redis.from_url("redis://localhost:6379")

    while True:
        print("\033[2J\033[H")  # Clear screen
        print(f"â•â•â• Eldoleado Dashboard â•â•â• {datetime.now()}")
        print()

        # Redis queues
        ai_queue = r.llen("ai:extraction:queue")
        print(f"AI Queue: {ai_queue} tasks")

        # n8n health
        for name, port in [("Transport", 5678), ("Processing", 5679), ("API", 5680)]:
            try:
                resp = requests.get(f"http://localhost:{port}/healthz", timeout=2)
                status = "ğŸŸ¢" if resp.status_code == 200 else "ğŸŸ¡"
            except:
                status = "ğŸ”´"
            print(f"n8n {name}: {status}")

        print()
        time.sleep(5)

if __name__ == "__main__":
    main()
```

---

## 10. ĞŸĞ»Ğ°Ğ½ Ğ²Ğ½ĞµĞ´Ñ€ĞµĞ½Ğ¸Ñ

### Ğ­Ñ‚Ğ°Ğ¿ 1: ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ° (1 Ğ´ĞµĞ½ÑŒ)

| Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ° | Ğ˜ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒ | Ğ’Ñ€ĞµĞ¼Ñ |
|--------|-------------|-------|
| Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ Ğ¿Ğ°Ğ¿Ğ¾Ğº | Claude | 10 Ğ¼Ğ¸Ğ½ |
| ĞĞ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ docker-compose.yml | Claude | 30 Ğ¼Ğ¸Ğ½ |
| ĞĞ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ ai_worker.py | Claude | 30 Ğ¼Ğ¸Ğ½ |
| ĞĞ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ nginx.conf | Claude | 20 Ğ¼Ğ¸Ğ½ |
| ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ .env | Ğ¢Ñ‹ | 10 Ğ¼Ğ¸Ğ½ |

### Ğ­Ñ‚Ğ°Ğ¿ 2: Ğ Ğ°Ğ·Ğ²Ñ‘Ñ€Ñ‚Ñ‹Ğ²Ğ°Ğ½Ğ¸Ğµ (1 Ğ´ĞµĞ½ÑŒ)

| Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ° | Ğ˜ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒ | Ğ’Ñ€ĞµĞ¼Ñ |
|--------|-------------|-------|
| Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ docker-compose | Ğ¢Ñ‹ | 15 Ğ¼Ğ¸Ğ½ |
| ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ»Ğ¾Ğ³Ğ¸ | Ğ¢Ñ‹ | 15 Ğ¼Ğ¸Ğ½ |
| ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ SSL ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ñ‹ | Ğ¢Ñ‹ | 30 Ğ¼Ğ¸Ğ½ |
| ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ğº n8n UI | Ğ¢Ñ‹ | 10 Ğ¼Ğ¸Ğ½ |

### Ğ­Ñ‚Ğ°Ğ¿ 3: ĞœĞ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ workflows (2-3 Ğ´Ğ½Ñ)

| Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ° | Ğ˜ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒ | Ğ’Ñ€ĞµĞ¼Ñ |
|--------|-------------|-------|
| Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ Ğ²ÑĞµÑ… workflows | Ğ¢Ñ‹ | 30 Ğ¼Ğ¸Ğ½ |
| ĞœĞ¾Ğ´Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ IN workflows | Claude | 2 Ñ‡Ğ°ÑĞ° |
| ĞœĞ¾Ğ´Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Processing workflows | Claude | 3 Ñ‡Ğ°ÑĞ° |
| ĞœĞ¾Ğ´Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ API workflows | Claude | 1 Ñ‡Ğ°Ñ |
| Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ Ğ² Ğ½Ğ¾Ğ²Ñ‹Ğµ n8n | Ğ¢Ñ‹ | 1 Ñ‡Ğ°Ñ |
| Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ | Ğ¢Ñ‹ | 2-3 Ñ‡Ğ°ÑĞ° |

### Ğ­Ñ‚Ğ°Ğ¿ 4: ĞŸĞµÑ€ĞµĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ (1 Ğ´ĞµĞ½ÑŒ)

| Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ° | Ğ˜ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒ | Ğ’Ñ€ĞµĞ¼Ñ |
|--------|-------------|-------|
| ĞŸĞµÑ€ĞµĞ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ webhooks | Ğ¢Ñ‹ | 30 Ğ¼Ğ¸Ğ½ |
| ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ Ğ¿ĞµÑ€Ğ²Ñ‹Ğµ Ñ‡Ğ°ÑÑ‹ | Ğ¢Ñ‹ | 2-3 Ñ‡Ğ°ÑĞ° |
| ĞÑ‚ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ ÑÑ‚Ğ°Ñ€Ğ¾Ğ³Ğ¾ n8n | Ğ¢Ñ‹ | 10 Ğ¼Ğ¸Ğ½ |

**Ğ˜Ñ‚Ğ¾Ğ³Ğ¾: ~5-6 Ğ´Ğ½ĞµĞ¹** Ñ Ğ·Ğ°Ğ¿Ğ°ÑĞ¾Ğ¼ Ğ½Ğ° Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹

---

## 11. Ğ Ğ¸ÑĞºĞ¸ Ğ¸ Ğ¼Ğ¸Ñ‚Ğ¸Ğ³Ğ°Ñ†Ğ¸Ñ

| Ğ Ğ¸ÑĞº | Ğ’ĞµÑ€Ğ¾ÑÑ‚Ğ½Ğ¾ÑÑ‚ÑŒ | Ğ’Ğ»Ğ¸ÑĞ½Ğ¸Ğµ | ĞœĞ¸Ñ‚Ğ¸Ğ³Ğ°Ñ†Ğ¸Ñ |
|------|-------------|---------|-----------|
| HTTP Ğ¼ĞµĞ¶Ğ´Ñƒ n8n Ğ¼ĞµĞ´Ğ»ĞµĞ½Ğ½ĞµĞµ Execute | Ğ¡Ñ€ĞµĞ´Ğ½ÑÑ | ĞĞ¸Ğ·ĞºĞ¾Ğµ | Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ°Ñ ÑĞµÑ‚ÑŒ Docker, latency <1ms |
| Redis Ğ¿Ğ°Ğ´Ğ°ĞµÑ‚ | ĞĞ¸Ğ·ĞºĞ°Ñ | Ğ’Ñ‹ÑĞ¾ĞºĞ¾Ğµ | Persistence (appendonly), restart: always |
| AI Worker Ğ¿Ğ°Ğ´Ğ°ĞµÑ‚ | ĞĞ¸Ğ·ĞºĞ°Ñ | Ğ¡Ñ€ĞµĞ´Ğ½ĞµĞµ | Docker restart, 2 replicas |
| ĞŸĞ¾Ñ‚ĞµÑ€Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… PostgreSQL | ĞĞ¸Ğ·ĞºĞ°Ñ | ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ | Streaming replication, Ğ±ÑĞºĞ°Ğ¿Ñ‹ |
| n8n Ğ¿Ğ°Ğ´Ğ°ĞµÑ‚ | Ğ¡Ñ€ĞµĞ´Ğ½ÑÑ | Ğ’Ñ‹ÑĞ¾ĞºĞ¾Ğµ | Docker restart, health checks |

---

## 12. Ğ§ĞµĞºĞ»Ğ¸ÑÑ‚ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸

### ĞŸĞµÑ€ĞµĞ´ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ¾Ğ¼

- [ ] Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ° Ğ¿Ğ°Ğ¿ĞºĞ° `services/ai-worker/` Ñ `ai_worker.py` Ğ¸ `Dockerfile`
- [ ] Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½ `docker-compose.yml`
- [ ] Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½ `.env` Ñ credentials
- [ ] Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½ `nginx/nginx.conf`
- [ ] Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½ `init-db.sql`
- [ ] ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ñ‹ SSL ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ñ‹
- [ ] DNS Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ñ‹ (transport., api., n8n.)

### ĞŸĞ¾ÑĞ»Ğµ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°

- [ ] Ğ’ÑĞµ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ñ‹ running (`docker-compose ps`)
- [ ] n8n UI Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ Ğ½Ğ° Ğ²ÑĞµÑ… ÑĞµÑ€Ğ²ĞµÑ€Ğ°Ñ…
- [ ] Redis Ğ¾Ñ‚Ğ²ĞµÑ‡Ğ°ĞµÑ‚ (`redis-cli ping`)
- [ ] PostgreSQL Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½
- [ ] AI Worker Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸
- [ ] Webhooks Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ÑÑ‚ (Ñ‚ĞµÑÑ‚ Telegram)

---

## 13. ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹ Ğ¸ Ñ€ĞµÑÑƒÑ€ÑÑ‹

### Ğ¡ĞµÑ€Ğ²ĞµÑ€Ñ‹
| Ğ¡ĞµÑ€Ğ²ĞµÑ€ | IP | ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ |
|--------|-----|------------|
| n8n (Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹) | n8n.n8nsrv.ru | ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ n8n |
| PostgreSQL | 185.221.214.83:6544 | Supabase |
| Neo4j | 45.144.177.128 | Ğ“Ñ€Ğ°Ñ„Ğ¾Ğ²Ğ°Ñ Ğ‘Ğ” |

### Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ
- n8n: https://docs.n8n.io
- Redis: https://redis.io/docs
- PostgreSQL Replication: https://www.postgresql.org/docs/current/warm-standby.html

---

## 14. Ğ Ğ°ÑÑ‡Ñ‘Ñ‚ Ğ¸Ğ½Ñ„Ñ€Ğ°ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñ‹ Ğ´Ğ»Ñ 100 Ñ‚ĞµĞ½Ğ°Ğ½Ñ‚Ğ¾Ğ²

### 14.1. Ğ˜ÑÑ…Ğ¾Ğ´Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ

| ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€ | Ğ—Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ | ĞšĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¹ |
|----------|----------|-------------|
| Ğ¢ĞµĞ½Ğ°Ğ½Ñ‚Ñ‹ | 100 | Ğ¡Ñ‚Ğ°Ñ€Ñ‚Ğ¾Ğ²Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ |
| Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ½Ğ° Ñ‚ĞµĞ½Ğ°Ğ½Ñ‚Ğ° | 1000/Ğ´ĞµĞ½ÑŒ | Ğ¢ĞµĞºÑÑ‚Ğ¾Ğ²Ñ‹Ğµ + Ğ³Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ñ‹Ğµ |
| Ğ“Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ñ‹Ñ… Ğ½Ğ° Ñ‚ĞµĞ½Ğ°Ğ½Ñ‚Ğ° | 120 Ğ¼Ğ¸Ğ½/Ğ´ĞµĞ½ÑŒ | Ğ’ Ñ€Ğ°Ğ±Ğ¾Ñ‡Ğ¸Ğµ 10 Ñ‡Ğ°ÑĞ¾Ğ² |
| Ğ Ğ°Ğ±Ğ¾Ñ‡Ğ¸Ğ¹ Ğ´ĞµĞ½ÑŒ | 10 Ñ‡Ğ°ÑĞ¾Ğ² | 08:00 - 18:00 |
| ĞŸĞ¸ĞºĞ¾Ğ²Ñ‹Ğ¹ ĞºĞ¾ÑÑ„Ñ„Ğ¸Ñ†Ğ¸ĞµĞ½Ñ‚ | 3x | Peak vs Average |

### 14.2. Ğ Ğ°ÑÑ‡Ñ‘Ñ‚ Ğ½Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸

#### Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ
```
Ğ’ÑĞµĞ³Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ² Ğ´ĞµĞ½ÑŒ:     100 Ã— 1000 = 100,000 msg/day
Ğ¡Ñ€ĞµĞ´Ğ½ĞµĞµ Ğ² ÑĞµĞºÑƒĞ½Ğ´Ñƒ:          100,000 / (10 Ã— 3600) = 2.78 msg/sec
ĞŸĞ¸ĞºĞ¾Ğ²Ğ¾Ğµ:                    2.78 Ã— 3 = 8.3 msg/sec
Ğ¡ Ğ·Ğ°Ğ¿Ğ°ÑĞ¾Ğ¼ (Ã—2):             ~17 msg/sec
```

#### Ğ“Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ñ‹Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ (Ñ‚Ñ€Ğ°Ğ½ÑĞºÑ€Ğ¸Ğ±Ğ°Ñ†Ğ¸Ñ)
```
Ğ’ÑĞµĞ³Ğ¾ Ğ¼Ğ¸Ğ½ÑƒÑ‚ Ğ² Ğ´ĞµĞ½ÑŒ:         100 Ã— 120 = 12,000 Ğ¼Ğ¸Ğ½/Ğ´ĞµĞ½ÑŒ
Ğ¡Ñ€ĞµĞ´Ğ½ĞµĞµ Ğ² Ñ‡Ğ°Ñ:              12,000 / 10 = 1,200 Ğ¼Ğ¸Ğ½/Ñ‡Ğ°Ñ = 20 Ğ¼Ğ¸Ğ½/Ğ¼Ğ¸Ğ½
ĞŸĞ¸ĞºĞ¾Ğ²Ğ¾Ğµ (Ã—3):               60 Ğ¼Ğ¸Ğ½ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼Ñ‹Ñ… Ğ² Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñƒ
```

#### AI Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹
```
ĞŸÑ€ĞµĞ´Ğ¿Ğ¾Ğ»Ğ¾Ğ¶Ğ¸Ğ¼ 30% ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ñ‚Ñ€ĞµĞ±ÑƒÑÑ‚ AI:
AI Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğ² Ğ´ĞµĞ½ÑŒ:         100,000 Ã— 0.3 = 30,000 Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²/Ğ´ĞµĞ½ÑŒ
Ğ¡Ñ€ĞµĞ´Ğ½ĞµĞµ Ğ² ÑĞµĞºÑƒĞ½Ğ´Ñƒ:          30,000 / 36,000 sec = 0.83 req/sec
ĞŸĞ¸ĞºĞ¾Ğ²Ğ¾Ğµ (Ã—3):               2.5 req/sec
```

---

### 14.3. Ğ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ AI Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ² (OpenRouter Qwen3 30B)

#### Ğ¦ĞµĞ½Ñ‹ OpenRouter (Ğ´ĞµĞºĞ°Ğ±Ñ€ÑŒ 2025)

| ĞœĞ¾Ğ´ĞµĞ»ÑŒ | Input | Output | ĞŸÑ€Ğ¸Ğ¼ĞµÑ‡Ğ°Ğ½Ğ¸Ğµ |
|--------|-------|--------|------------|
| **Qwen3 30B A3B Instruct** | $0.06/M | $0.25/M | Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµĞ¼Ğ°Ñ |
| Qwen3 30B A3B Thinking | $0.40/M | $4.00/M | Ğ”Ğ»Ñ ÑĞ»Ğ¾Ğ¶Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ´Ğ°Ñ‡ |
| Qwen3 30B A3B (Free) | $0.00 | $0.00 | Ğ›Ğ¸Ğ¼Ğ¸Ñ‚Ñ‹, Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸ |

*Ğ˜ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº: [OpenRouter Qwen Pricing](https://openrouter.ai/qwen)*

#### Ğ Ğ°ÑÑ‡Ñ‘Ñ‚ Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ² Ğ½Ğ° Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ

```
Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ (extraction):
- System prompt:      ~500 tokens
- Context/Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ:    ~300 tokens
- Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ:          ~100 tokens
- Input total:        ~900 tokens

- Output (JSON):      ~200 tokens

ĞĞ° 1 Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ:          900 input + 200 output
```

#### ĞœĞµÑÑÑ‡Ğ½Ñ‹Ğµ Ñ€Ğ°ÑÑ…Ğ¾Ğ´Ñ‹ Ğ½Ğ° AI

```
Ğ—Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğ² Ğ¼ĞµÑÑÑ†:     30,000 Ã— 30 = 900,000 Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²

Input tokens:         900,000 Ã— 900 = 810M tokens
Output tokens:        900,000 Ã— 200 = 180M tokens

Qwen3 30B A3B Instruct:
  Input:   810M Ã— $0.06/M = $48.60
  Output:  180M Ã— $0.25/M = $45.00
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Ğ˜Ğ¢ĞĞ“Ğ:                    $93.60/Ğ¼ĞµÑ (~9,400 â‚½)
```

#### Ğ¡Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ Ñ Ğ´Ñ€ÑƒĞ³Ğ¸Ğ¼Ğ¸ Ğ¼Ğ¾Ğ´ĞµĞ»ÑĞ¼Ğ¸

| ĞœĞ¾Ğ´ĞµĞ»ÑŒ | Input/M | Output/M | ĞœĞµÑÑÑ† 100 Ñ‚ĞµĞ½Ğ°Ğ½Ñ‚Ğ¾Ğ² |
|--------|---------|----------|-------------------|
| **Qwen3 30B Instruct** | $0.06 | $0.25 | **$94** |
| GPT-4o-mini | $0.15 | $0.60 | $232 |
| Claude 3.5 Haiku | $0.25 | $1.25 | $427 |
| GPT-4o | $2.50 | $10.00 | $2,025 |

**Ğ’Ñ‹Ğ²Ğ¾Ğ´:** Qwen3 30B A3B Instruct â€” Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ²Ñ‹Ğ±Ğ¾Ñ€ Ğ¿Ğ¾ Ñ†ĞµĞ½Ğµ/ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ñƒ.

---

### 14.4. Ğ¢Ñ€Ğ°Ğ½ÑĞºÑ€Ğ¸Ğ±Ğ°Ñ†Ğ¸Ñ (Ğ²Ğ½ĞµÑˆĞ½Ğ¸Ğ¹ ÑĞµÑ€Ğ²Ğ¸Ñ)

> **ĞŸÑ€Ğ¸Ğ¼ĞµÑ‡Ğ°Ğ½Ğ¸Ğµ:** Ğ¢Ñ€Ğ°Ğ½ÑĞºÑ€Ğ¸Ğ±Ğ°Ñ†Ğ¸Ñ Ğ²Ñ‹Ğ´ĞµĞ»ĞµĞ½Ğ° Ğ² Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ ÑĞµÑ€Ğ²Ğ¸Ñ Ñ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ¾Ğ¹ Ğ·Ğ° Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñƒ.
> ĞĞµ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ° Ğ² Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚ Ğ¸Ğ½Ñ„Ñ€Ğ°ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñ‹. Ğ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ¿ĞµÑ€ĞµĞºĞ»Ğ°Ğ´Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ğ½Ğ° Ñ‚ĞµĞ½Ğ°Ğ½Ñ‚Ğ°.

```
ĞĞ±ÑŠÑ‘Ğ¼ Ğ½Ğ° Ñ‚ĞµĞ½Ğ°Ğ½Ñ‚Ğ°:     120 Ğ¼Ğ¸Ğ½/Ğ´ĞµĞ½ÑŒ Ã— 30 Ğ´Ğ½ĞµĞ¹ = 3,600 Ğ¼Ğ¸Ğ½/Ğ¼ĞµÑ
ĞŸÑ€Ğ¸ Ñ†ĞµĞ½Ğµ 0.5 â‚½/Ğ¼Ğ¸Ğ½:   3,600 Ã— 0.5 = 1,800 â‚½/Ğ¼ĞµÑ Ğ½Ğ° Ñ‚ĞµĞ½Ğ°Ğ½Ñ‚Ğ°

Ğ¢ĞµĞ½Ğ°Ğ½Ñ‚ Ğ¿Ğ»Ğ°Ñ‚Ğ¸Ñ‚ Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ğ·Ğ° Ñ‚Ñ€Ğ°Ğ½ÑĞºÑ€Ğ¸Ğ±Ğ°Ñ†Ğ¸Ñ Ğ¸Ğ»Ğ¸ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾ Ğ² Ñ‚Ğ°Ñ€Ğ¸Ñ„.
```

---

### 14.5. ĞŸĞ¾Ğ»Ğ½Ğ°Ñ ÑĞ¿ĞµÑ†Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ ÑĞµÑ€Ğ²ĞµÑ€Ğ¾Ğ²

#### Ğ¡ĞµÑ€Ğ²ĞµÑ€ 1: ĞĞ¡ĞĞĞ’ĞĞĞ™ (Primary)

| ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ | vCPU | RAM | Ğ”Ğ¸ÑĞº | ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ |
|-----------|------|-----|------|------------|
| n8n Transport | 2 | 2 GB | 10 GB | Ğ’Ñ…Ğ¾Ğ´ÑÑ‰Ğ¸Ğµ/Ğ¸ÑÑ…Ğ¾Ğ´ÑÑ‰Ğ¸Ğµ |
| n8n Processing | 4 | 4 GB | 10 GB | Ğ‘Ğ¸Ğ·Ğ½ĞµÑ-Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° |
| n8n API | 2 | 2 GB | 10 GB | Android API |
| AI Worker (Python) | 2 | 1 GB | 5 GB | 20 workers |
| Redis | 1 | 1 GB | 5 GB | ĞÑ‡ĞµÑ€ĞµĞ´Ğ¸ |
| PostgreSQL Primary | 4 | 8 GB | 100 GB | ĞÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ Ğ‘Ğ” |
| Nginx | 1 | 512 MB | 1 GB | Reverse proxy |
| **Ğ˜Ğ¢ĞĞ“Ğ** | **16** | **18.5 GB** | **141 GB** |

**Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµĞ¼Ñ‹Ğ¹ ÑĞµÑ€Ğ²ĞµÑ€ (Ğ Ğ¾ÑÑĞ¸Ñ):**
- **Selectel**: 16 vCPU AMD EPYC, 32 GB RAM, 500 GB NVMe â€” ~15,000 â‚½/Ğ¼ĞµÑ
- **Timeweb**: 16 vCPU, 32 GB RAM, 480 GB NVMe â€” ~12,000 â‚½/Ğ¼ĞµÑ
- **REG.RU / FirstVDS**: Ğ°Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¸Ñ‡Ğ½Ñ‹Ğµ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸ â€” 10,000-15,000 â‚½/Ğ¼ĞµÑ

#### Ğ¡ĞµÑ€Ğ²ĞµÑ€ 2: Ğ Ğ•Ğ—Ğ•Ğ Ğ’ĞĞ«Ğ™ (Standby)

| ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ | vCPU | RAM | Ğ”Ğ¸ÑĞº | ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ |
|-----------|------|-----|------|------------|
| n8n Transport (standby) | 2 | 2 GB | 10 GB | Ğ ĞµĞ·ĞµÑ€Ğ² |
| n8n Processing (standby) | 4 | 4 GB | 10 GB | Ğ ĞµĞ·ĞµÑ€Ğ² |
| n8n API (standby) | 2 | 2 GB | 10 GB | Ğ ĞµĞ·ĞµÑ€Ğ² |
| AI Worker (Python) | 2 | 1 GB | 5 GB | Ğ ĞµĞ·ĞµÑ€Ğ² |
| Redis Replica | 1 | 1 GB | 5 GB | Ğ ĞµĞ¿Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ |
| PostgreSQL Standby | 4 | 8 GB | 100 GB | Streaming replication |
| **Ğ˜Ğ¢ĞĞ“Ğ** | **15** | **18 GB** | **140 GB** |

**Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµĞ¼Ñ‹Ğ¹ ÑĞµÑ€Ğ²ĞµÑ€:** Ğ¢Ğ°ĞºĞ¾Ğ¹ Ğ¶Ğµ ĞºĞ°Ğº Primary â€” ~12,000-15,000 â‚½/Ğ¼ĞµÑ

#### Ğ¡ĞµÑ€Ğ²ĞµÑ€ 3: PostgreSQL Standby (Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ğ¹)

Ğ”Ğ»Ñ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… â€” Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ ÑĞµÑ€Ğ²ĞµÑ€ Ğ‘Ğ”:

| ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ | vCPU | RAM | Ğ”Ğ¸ÑĞº |
|-----------|------|-----|------|
| PostgreSQL Standby | 4 | 16 GB | 200 GB |
| **Ğ˜Ğ¢ĞĞ“Ğ** | **4** | **16 GB** | **200 GB** |

**Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµĞ¼Ñ‹Ğ¹ ÑĞµÑ€Ğ²ĞµÑ€ (Ğ Ğ¾ÑÑĞ¸Ñ):**
- **Selectel VDS**: 4 vCPU, 16 GB RAM, 200 GB â€” ~5,000 â‚½/Ğ¼ĞµÑ
- **Timeweb VDS**: 4 vCPU, 16 GB RAM, 200 GB â€” ~4,000 â‚½/Ğ¼ĞµÑ

---

### 14.6. Ğ˜Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ğ°Ñ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ¸Ğ½Ñ„Ñ€Ğ°ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñ‹

#### Ğ¡ĞµÑ€Ğ²ĞµÑ€Ñ‹ (Ğ Ğ¾ÑÑĞ¸Ñ â€” Selectel/Timeweb/FirstVDS)

| Ğ¡ĞµÑ€Ğ²ĞµÑ€ | ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ | Ğ¦ĞµĞ½Ğ°/Ğ¼ĞµÑ |
|--------|--------------|----------|
| Primary | 16 vCPU, 32 GB RAM, 500 GB NVMe | ~12,000 â‚½ |
| Standby | 16 vCPU, 32 GB RAM, 500 GB NVMe | ~12,000 â‚½ |
| DB Replica | 4 vCPU, 16 GB RAM, 200 GB | ~4,000 â‚½ |
| **Ğ¡ĞµÑ€Ğ²ĞµÑ€Ñ‹ Ğ¸Ñ‚Ğ¾Ğ³Ğ¾** | | **~28,000 â‚½** |

#### AI Ğ¸ API

| Ğ¡ĞµÑ€Ğ²Ğ¸Ñ | Ğ Ğ°ÑÑ‡Ñ‘Ñ‚ | Ğ¦ĞµĞ½Ğ°/Ğ¼ĞµÑ |
|--------|--------|----------|
| OpenRouter Qwen3 30B | 900K Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² | $94 (~9,400 â‚½) |
| **AI Ğ¸Ñ‚Ğ¾Ğ³Ğ¾** | | **~9,400 â‚½** |

#### Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾

| Ğ¡ĞµÑ€Ğ²Ğ¸Ñ | Ğ¦ĞµĞ½Ğ°/Ğ¼ĞµÑ |
|--------|----------|
| Ğ”Ğ¾Ğ¼ĞµĞ½Ñ‹ Ğ¸ DNS | ~500 â‚½ |
| SSL (Let's Encrypt) | 0 â‚½ |
| Ğ‘ÑĞºĞ°Ğ¿Ñ‹ (Selectel Object Storage) | ~1,000 â‚½ |
| ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ (Ğ±ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ñ‹Ğ¹/ÑĞ²Ğ¾Ğ¹) | 0 â‚½ |
| **Ğ”Ğ¾Ğ¿. Ğ¸Ñ‚Ğ¾Ğ³Ğ¾** | **~1,500 â‚½** |

---

### 14.7. Ğ˜Ğ¢ĞĞ“Ğ: Ğ•Ğ¶ĞµĞ¼ĞµÑÑÑ‡Ğ½Ñ‹Ğµ Ñ€Ğ°ÑÑ…Ğ¾Ğ´Ñ‹ Ğ½Ğ° 100 Ñ‚ĞµĞ½Ğ°Ğ½Ñ‚Ğ¾Ğ²

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Ğ•Ğ–Ğ•ĞœĞ•Ğ¡Ğ¯Ğ§ĞĞ«Ğ• Ğ ĞĞ¡Ğ¥ĞĞ”Ğ« (Ğ Ğ¾ÑÑĞ¸Ñ)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Ğ¡ĞµÑ€Ğ²ĞµÑ€Ñ‹ (3 ÑˆÑ‚, Ğ Ğ¾ÑÑĞ¸Ñ)                    ~28,000 â‚½       â”‚
â”‚  AI Ñ‚Ğ¾ĞºĞµĞ½Ñ‹ (Qwen3 30B)                     ~9,400 â‚½        â”‚
â”‚  Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾                             ~1,500 â‚½        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  Ğ˜Ğ¢ĞĞ“Ğ:                                    ~38,900 â‚½/Ğ¼ĞµÑ   â”‚
â”‚                                                             â”‚
â”‚  ĞĞ° 1 Ñ‚ĞµĞ½Ğ°Ğ½Ñ‚Ğ°:                             ~389 â‚½/Ğ¼ĞµÑ      â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ĞŸÑ€Ğ¸ Ñ‚Ğ°Ñ€Ğ¸Ñ„Ğµ 1500 â‚½/Ğ¼ĞµÑ Ğ½Ğ° Ñ‚ĞµĞ½Ğ°Ğ½Ñ‚Ğ°:

```
Ğ’Ñ‹Ñ€ÑƒÑ‡ĞºĞ°:              100 Ã— 1500 = 150,000 â‚½/Ğ¼ĞµÑ
Ğ Ğ°ÑÑ…Ğ¾Ğ´Ñ‹ Ğ¸Ğ½Ñ„Ñ€Ğ°:                    38,900 â‚½/Ğ¼ĞµÑ
ĞœĞ°Ñ€Ğ¶Ğ° Ğ¸Ğ½Ñ„Ñ€Ğ°ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñ‹:            111,100 â‚½/Ğ¼ĞµÑ (74%)
```

#### Ğ¢Ğ¾Ñ‡ĞºĞ° Ğ±ĞµĞ·ÑƒĞ±Ñ‹Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ÑÑ‚Ğ¸:

```
ĞœĞ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ Ñ‚ĞµĞ½Ğ°Ğ½Ñ‚Ğ¾Ğ²:     38,900 / 1500 = 26 Ñ‚ĞµĞ½Ğ°Ğ½Ñ‚Ğ¾Ğ²
Ğ¡ Ğ·Ğ°Ğ¿Ğ°ÑĞ¾Ğ¼ (Ã—1.5):     ~39 Ñ‚ĞµĞ½Ğ°Ğ½Ñ‚Ğ¾Ğ² Ğ´Ğ»Ñ ÑƒÑÑ‚Ğ¾Ğ¹Ñ‡Ğ¸Ğ²Ğ¾ÑÑ‚Ğ¸
```

---

### 14.8. ĞŸĞ¾ÑÑ‚Ğ°Ğ¿Ğ½Ñ‹Ğ¹ Ñ€Ğ¾ÑÑ‚ Ñ HA-Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ¾Ğ¹

> **ĞŸÑ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿:** ĞŸÑ€Ğ¾Ğ´Ğ°ĞºÑˆĞµĞ½ Ñ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼ Ñ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ³Ğ¾ Ğ´Ğ½Ñ. ĞĞ¿Ğ³Ñ€ĞµĞ¹Ğ´ VDS Ğ½Ğ° Ğ»ĞµÑ‚Ñƒ Ğ±ĞµĞ· Ğ´Ğ°ÑƒĞ½Ñ‚Ğ°Ğ¹Ğ¼Ğ°.

#### Ğ¡Ñ‚Ğ°Ñ€Ñ‚Ğ¾Ğ²Ğ°Ñ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ (10-20 Ñ‚ĞµĞ½Ğ°Ğ½Ñ‚Ğ¾Ğ²)

| Ğ¡ĞµÑ€Ğ²ĞµÑ€ | ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ | ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ | Ğ¦ĞµĞ½Ğ°/Ğ¼ĞµÑ |
|--------|--------------|------------|----------|
| **Primary** | 4 vCPU, 8 GB, 100 GB | n8n + AI Worker + Redis | ~2,500 â‚½ |
| **Standby** | 4 vCPU, 8 GB, 100 GB | Hot standby | ~2,500 â‚½ |
| **DB Primary** | 2 vCPU, 4 GB, 50 GB | PostgreSQL | ~1,500 â‚½ |
| **DB Replica** | 2 vCPU, 4 GB, 50 GB | Streaming replication | ~1,500 â‚½ |
| **Ğ˜Ğ¢ĞĞ“Ğ** | 4 ÑĞµÑ€Ğ²ĞµÑ€Ğ° | HA Ñ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ³Ğ¾ Ğ´Ğ½Ñ | **~8,000 â‚½** |

#### Ğ¢Ñ€Ğ°ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ°Ğ¿Ğ³Ñ€ĞµĞ¹Ğ´Ğ° (Ğ½Ğ° Ğ»ĞµÑ‚Ñƒ Ñ‡ĞµÑ€ĞµĞ· Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ VDS)

| Ğ¢ĞµĞ½Ğ°Ğ½Ñ‚Ñ‹ | Primary + Standby | DB Primary + Replica | Ğ¡ĞµÑ€Ğ²ĞµÑ€Ñ‹ | AI | Ğ˜Ñ‚Ğ¾Ğ³Ğ¾/Ğ¼ĞµÑ |
|---------|-------------------|----------------------|---------|-----|-----------|
| **10-20** | 2Ã— (4 vCPU, 8 GB) | 2Ã— (2 vCPU, 4 GB) | ~8,000 â‚½ | ~1,900 â‚½ | **~10,400 â‚½** |
| **30-50** | 2Ã— (6 vCPU, 16 GB) | 2Ã— (4 vCPU, 8 GB) | ~14,000 â‚½ | ~4,700 â‚½ | **~19,200 â‚½** |
| **50-80** | 2Ã— (10 vCPU, 24 GB) | 2Ã— (4 vCPU, 16 GB) | ~22,000 â‚½ | ~7,500 â‚½ | **~30,000 â‚½** |
| **80-100** | 2Ã— (16 vCPU, 32 GB) | 2Ã— (4 vCPU, 16 GB) | ~28,000 â‚½ | ~9,400 â‚½ | **~38,900 â‚½** |

#### Ğ­ĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸ĞºĞ° Ğ½Ğ° ÑÑ‚Ğ°Ñ€Ñ‚Ğµ (20 Ñ‚ĞµĞ½Ğ°Ğ½Ñ‚Ğ¾Ğ²)

```
Ğ’Ñ‹Ñ€ÑƒÑ‡ĞºĞ°:           20 Ã— 1500 = 30,000 â‚½/Ğ¼ĞµÑ
Ğ¡ĞµÑ€Ğ²ĞµÑ€Ñ‹ (4 ÑˆÑ‚):                 8,000 â‚½/Ğ¼ĞµÑ
AI (Qwen3 30B):                 1,900 â‚½/Ğ¼ĞµÑ
Ğ”Ğ¾Ğ¿:                              500 â‚½/Ğ¼ĞµÑ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Ğ Ğ°ÑÑ…Ğ¾Ğ´Ñ‹:                       10,400 â‚½/Ğ¼ĞµÑ
ĞœĞ°Ñ€Ğ¶Ğ°:                         19,600 â‚½/Ğ¼ĞµÑ (65%)
Ğ‘ĞµĞ·ÑƒĞ±Ñ‹Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ÑÑ‚ÑŒ:                 7 Ñ‚ĞµĞ½Ğ°Ğ½Ñ‚Ğ¾Ğ²
```

#### ĞŸÑ€Ğ¾Ñ†ĞµĞ´ÑƒÑ€Ğ° Ğ°Ğ¿Ğ³Ñ€ĞµĞ¹Ğ´Ğ° Ğ±ĞµĞ· Ğ´Ğ°ÑƒĞ½Ñ‚Ğ°Ğ¹Ğ¼Ğ°

```
1. ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ â†’ CPU/RAM > 70% ÑÑ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½Ğ¾
2. ĞĞ¾Ñ‡ÑŒÑ â†’ ĞĞ¿Ğ³Ñ€ĞµĞ¹Ğ´ Standby (Ğ¾Ğ½ Ğ½Ğµ Ğ¿Ğ¾Ğ´ Ğ½Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¾Ğ¹)
3. ĞŸĞµÑ€ĞµĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ DNS â†’ Standby ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑÑ Primary
4. ĞĞ¿Ğ³Ñ€ĞµĞ¹Ğ´ â†’ Ğ¡Ñ‚Ğ°Ñ€Ñ‹Ğ¹ Primary Ğ´Ğ¾Ğ³Ğ¾Ğ½ÑĞµÑ‚ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ
5. Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾ â†’ Ğ”Ğ°ÑƒĞ½Ñ‚Ğ°Ğ¹Ğ¼ = 0
```

---

### 14.8.1. ĞœĞ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ: 100 â†’ 1000 Ñ‚ĞµĞ½Ğ°Ğ½Ñ‚Ğ¾Ğ²

| Ğ¢ĞµĞ½Ğ°Ğ½Ñ‚Ñ‹ | Ğ¡ĞµÑ€Ğ²ĞµÑ€Ñ‹ | AI Ñ‚Ğ¾ĞºĞµĞ½Ñ‹ | Ğ˜Ñ‚Ğ¾Ğ³Ğ¾/Ğ¼ĞµÑ | ĞĞ° Ñ‚ĞµĞ½Ğ°Ğ½Ñ‚Ğ° | Ğ’Ñ‹Ñ€ÑƒÑ‡ĞºĞ° (1500â‚½) | ĞœĞ°Ñ€Ğ¶Ğ° |
|---------|---------|-----------|-----------|------------|-----------------|-------|
| **100** | 28,000 â‚½ | 9,400 â‚½ | ~38,900 â‚½ | ~389 â‚½ | 150,000 â‚½ | 111,100 â‚½ (74%) |
| **200** | 52,000 â‚½ | 18,800 â‚½ | ~72,300 â‚½ | ~362 â‚½ | 300,000 â‚½ | 227,700 â‚½ (76%) |
| **500** | 100,000 â‚½ | 47,000 â‚½ | ~148,500 â‚½ | ~297 â‚½ | 750,000 â‚½ | 601,500 â‚½ (80%) |
| **1000** | 180,000 â‚½ | 94,000 â‚½ | ~275,500 â‚½ | ~276 â‚½ | 1,500,000 â‚½ | 1,224,500 â‚½ (82%) |

**Ğ­Ñ„Ñ„ĞµĞºÑ‚ Ğ¼Ğ°ÑÑˆÑ‚Ğ°Ğ±Ğ°:** Ğ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ½Ğ° Ñ‚ĞµĞ½Ğ°Ğ½Ñ‚Ğ° Ğ¿Ğ°Ğ´Ğ°ĞµÑ‚, Ğ¼Ğ°Ñ€Ğ¶Ğ° Ñ€Ğ°ÑÑ‚Ñ‘Ñ‚.

---

### 14.9. ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ½Ğ°Ñ ÑÑ…ĞµĞ¼Ğ°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         PRIMARY SERVER                               â”‚
â”‚                     (16 vCPU, 32 GB RAM)                            â”‚
â”‚                   Selectel / Timeweb / FirstVDS                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚ n8n         â”‚  â”‚ n8n         â”‚  â”‚ n8n         â”‚                 â”‚
â”‚  â”‚ Transport   â”‚  â”‚ Processing  â”‚  â”‚ API         â”‚                 â”‚
â”‚  â”‚ 2C/2G       â”‚  â”‚ 4C/4G       â”‚  â”‚ 2C/2G       â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚         â”‚                â”‚                                          â”‚
â”‚         â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚         â”‚         â”‚    Redis    â”‚                                   â”‚
â”‚         â”‚         â”‚   1C/1G     â”‚                                   â”‚
â”‚         â”‚         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚         â”‚                â”‚                                          â”‚
â”‚         â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚         â”‚         â”‚ AI Worker   â”‚                                   â”‚
â”‚         â”‚         â”‚ (Python)    â”‚                                   â”‚
â”‚         â”‚         â”‚ 2C/1G       â”‚                                   â”‚
â”‚         â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚         â”‚                                                           â”‚
â”‚         â”‚                                                           â”‚
â”‚         â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚    Ğ’Ğ½ĞµÑˆĞ½Ğ¸Ğ¹ ÑĞµÑ€Ğ²Ğ¸Ñ STT        â”‚                  â”‚
â”‚                   â”‚    (Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ° Ğ·Ğ° Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñƒ)        â”‚                  â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚              PostgreSQL Primary                       â”‚           â”‚
â”‚  â”‚                   4C/8G                               â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    Streaming Replication
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        STANDBY SERVER                                â”‚
â”‚                     (16 vCPU, 32 GB RAM)                            â”‚
â”‚                   Selectel / Timeweb / FirstVDS                     â”‚
â”‚                                                                     â”‚
â”‚         Ğ˜Ğ´ĞµĞ½Ñ‚Ğ¸Ñ‡Ğ½Ğ°Ñ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ, hot standby                        â”‚
â”‚         ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸ ÑĞ±Ğ¾Ğµ                        â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      DB REPLICA SERVER                               â”‚
â”‚                     (4 vCPU, 16 GB RAM)                             â”‚
â”‚                   Selectel VDS / Timeweb VDS                        â”‚
â”‚                                                                     â”‚
â”‚         PostgreSQL Standby (Ñ‚Ñ€ĞµÑ‚ÑŒÑ ĞºĞ¾Ğ¿Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…)                    â”‚
â”‚         Ğ“ĞµĞ¾Ğ³Ñ€Ğ°Ñ„Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ Ğ´Ğ°Ñ‚Ğ°Ñ†ĞµĞ½Ñ‚Ñ€ (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)             â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 14.10. Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ STT (Ğ²Ğ½ĞµÑˆĞ½Ğ¸Ğ¹ ÑĞµÑ€Ğ²Ğ¸Ñ) Ğ² workflow

> **ĞŸÑ€Ğ¸Ğ¼ĞµÑ‡Ğ°Ğ½Ğ¸Ğµ:** Ğ¢Ñ€Ğ°Ğ½ÑĞºÑ€Ğ¸Ğ±Ğ°Ñ†Ğ¸Ñ Ğ²Ñ‹Ğ½ĞµÑĞµĞ½Ğ° Ğ²Ğ¾ Ğ²Ğ½ĞµÑˆĞ½Ğ¸Ğ¹ ÑĞµÑ€Ğ²Ğ¸Ñ Ñ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ¾Ğ¹ Ğ·Ğ° Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñƒ.
> Ğ­Ñ‚Ğ¾ ÑƒĞ¿Ñ€Ğ¾Ñ‰Ğ°ĞµÑ‚ Ğ¸Ğ½Ñ„Ñ€Ğ°ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ Ğ¸ Ğ¿Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑĞµÑ‚ Ğ³Ğ¸Ğ±ĞºĞ¾ Ğ¼Ğ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ.

#### n8n workflow Ğ´Ğ»Ñ Ğ³Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ñ‹Ñ…

```javascript
// BAT IN Telegram (Ğ³Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ)
{
  "nodes": [
    {
      "name": "Telegram Trigger",
      "type": "n8n-nodes-base.telegramTrigger"
    },
    {
      "name": "Check Voice",
      "type": "n8n-nodes-base.if",
      "parameters": {
        "conditions": {
          "boolean": [
            { "value1": "={{ $json.message.voice !== undefined }}" }
          ]
        }
      }
    },
    {
      "name": "Download Voice",
      "type": "n8n-nodes-base.telegram",
      "parameters": {
        "operation": "getFile",
        "fileId": "={{ $json.message.voice.file_id }}"
      }
    },
    {
      "name": "Transcribe STT",
      "type": "n8n-nodes-base.httpRequest",
      "parameters": {
        "method": "POST",
        "url": "={{ $env.STT_SERVICE_URL }}/recognize",
        "sendBody": true,
        "bodyParameters": {
          "audio_url": "={{ $json.file_path }}",
          "tenant_id": "={{ $json.tenant_id }}"
        },
        "authentication": "headerAuth",
        "headerAuth": {
          "name": "Authorization",
          "value": "Bearer {{ $env.STT_API_KEY }}"
        }
      }
    },
    {
      "name": "Merge Text",
      "type": "n8n-nodes-base.set",
      "parameters": {
        "values": {
          "string": [
            {
              "name": "text",
              "value": "={{ $json.text }}"
            }
          ]
        }
      }
    },
    {
      "name": "Continue to Processing",
      "type": "n8n-nodes-base.httpRequest",
      "parameters": {
        "url": "={{ $env.N8N_PROCESSING_URL }}/webhook/tenant-resolver"
      }
    }
  ]
}
```

#### ĞŸĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ Ğ´Ğ»Ñ STT

```env
# Ğ’Ğ½ĞµÑˆĞ½Ğ¸Ğ¹ ÑĞµÑ€Ğ²Ğ¸Ñ Ñ‚Ñ€Ğ°Ğ½ÑĞºÑ€Ğ¸Ğ±Ğ°Ñ†Ğ¸Ğ¸
STT_SERVICE_URL=https://stt-service.example.com/api/v1
STT_API_KEY=your_stt_api_key
```

---

## 15. Ğ§ĞµĞºĞ»Ğ¸ÑÑ‚ Ğ·Ğ°ĞºÑƒĞ¿ĞºĞ¸ Ğ¸Ğ½Ñ„Ñ€Ğ°ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñ‹

### Ğ¡ĞµÑ€Ğ²ĞµÑ€Ñ‹ â€” Ğ¡Ğ¢ĞĞ Ğ¢ (10-20 Ñ‚ĞµĞ½Ğ°Ğ½Ñ‚Ğ¾Ğ², Ğ Ğ¾ÑÑĞ¸Ñ)

- [ ] Ğ—Ğ°ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Primary â€” 4 vCPU, 8 GB RAM, 100 GB NVMe (~2,500 â‚½/Ğ¼ĞµÑ)
- [ ] Ğ—Ğ°ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Standby â€” 4 vCPU, 8 GB RAM, 100 GB NVMe (~2,500 â‚½/Ğ¼ĞµÑ)
- [ ] Ğ—Ğ°ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ DB Primary â€” 2 vCPU, 4 GB RAM, 50 GB (~1,500 â‚½/Ğ¼ĞµÑ)
- [ ] Ğ—Ğ°ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ DB Replica â€” 2 vCPU, 4 GB RAM, 50 GB (~1,500 â‚½/Ğ¼ĞµÑ)
- [ ] ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ Private Network Ğ¼ĞµĞ¶Ğ´Ñƒ ÑĞµÑ€Ğ²ĞµÑ€Ğ°Ğ¼Ğ¸
- [ ] ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ S3/Object Storage Ğ´Ğ»Ñ Ğ±ÑĞºĞ°Ğ¿Ğ¾Ğ² (~500 â‚½/Ğ¼ĞµÑ)

**Ğ˜Ñ‚Ğ¾Ğ³Ğ¾ Ğ½Ğ° ÑÑ‚Ğ°Ñ€Ñ‚Ğµ: ~8,500 â‚½/Ğ¼ĞµÑ (4 ÑĞµÑ€Ğ²ĞµÑ€Ğ° Ñ HA)**

### Ğ¡ĞµÑ€Ğ²ĞµÑ€Ñ‹ â€” Ğ ĞĞ¡Ğ¢ (80-100 Ñ‚ĞµĞ½Ğ°Ğ½Ñ‚Ğ¾Ğ²)

*ĞĞ¿Ğ³Ñ€ĞµĞ¹Ğ´ Ñ‡ĞµÑ€ĞµĞ· Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ VDS Ğ½Ğ° Ğ»ĞµÑ‚Ñƒ:*

- [ ] ĞĞ¿Ğ³Ñ€ĞµĞ¹Ğ´ Primary â†’ 16 vCPU, 32 GB RAM, 500 GB NVMe (~12,000 â‚½/Ğ¼ĞµÑ)
- [ ] ĞĞ¿Ğ³Ñ€ĞµĞ¹Ğ´ Standby â†’ 16 vCPU, 32 GB RAM, 500 GB NVMe (~12,000 â‚½/Ğ¼ĞµÑ)
- [ ] ĞĞ¿Ğ³Ñ€ĞµĞ¹Ğ´ DB Primary â†’ 4 vCPU, 16 GB RAM, 200 GB (~4,000 â‚½/Ğ¼ĞµÑ)
- [ ] ĞĞ¿Ğ³Ñ€ĞµĞ¹Ğ´ DB Replica â†’ 4 vCPU, 16 GB RAM, 200 GB (~4,000 â‚½/Ğ¼ĞµÑ)
- [ ] Ğ£Ğ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ñ‚ÑŒ Object Storage (~1,000 â‚½/Ğ¼ĞµÑ)

### Ğ”Ğ¾Ğ¼ĞµĞ½Ñ‹ Ğ¸ DNS

- [ ] ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ transport.eldoleado.ru â†’ Primary IP
- [ ] ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ api.eldoleado.ru â†’ Primary IP
- [ ] ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ n8n.eldoleado.ru â†’ Primary IP
- [ ] ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ SSL ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ñ‹ (Let's Encrypt)

### ĞĞºĞºĞ°ÑƒĞ½Ñ‚Ñ‹

- [ ] OpenRouter Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚ + Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ $100 (~10,000 â‚½)
- [ ] ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ API key Ğ´Ğ»Ñ Qwen3 30B
- [ ] ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚ STT-ÑĞµÑ€Ğ²Ğ¸ÑĞ° (Ğ²Ğ½ĞµÑˆĞ½ÑÑ Ñ‚Ñ€Ğ°Ğ½ÑĞºÑ€Ğ¸Ğ±Ğ°Ñ†Ğ¸Ñ)

### ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³

- [ ] UptimeRobot â€” 3 endpoint Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³Ğ° (Ğ±ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ğ¾)
- [ ] ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ Ğ°Ğ»ĞµÑ€Ñ‚Ñ‹ Ğ² Telegram

---

*Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚ ÑĞ¾Ğ·Ğ´Ğ°Ğ½: Ğ´ĞµĞºĞ°Ğ±Ñ€ÑŒ 2025*
*Ğ’ĞµÑ€ÑĞ¸Ñ: 1.2*
*ĞĞ²Ñ‚Ğ¾Ñ€: Claude (Opus 4.5) + Human*

---

## Ğ˜ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ¸

- [OpenRouter Qwen Pricing](https://openrouter.ai/qwen)
- [OpenRouter Models](https://openrouter.ai/models)
- [Selectel VDS](https://selectel.ru/services/cloud/servers/)
- [Timeweb Cloud](https://timeweb.cloud/)
- [FirstVDS](https://firstvds.ru/)
