# План реализации: operation_mode для каждой заявки

## Текущее состояние

### Android (уже реализовано)
- [x] Тумблер AUTO/ASSIST в `AppealDetailActivity`
- [x] Чтение `operation_mode` из API ответа
- [x] Сохранение через API `android-update-appeal-mode`
- [x] Логика: зелёный = АВТО, серый = РУЧН

### База данных
- [x] `tenants.operation_mode` - глобальная настройка по умолчанию (миграция 012)
- [x] `appeals.operation_mode` - поле для каждой заявки (миграция 013)

### n8n Workflows
- [x] `API_Operator_Appeal_Detail` - уже возвращает `operation_mode`
- [x] `API_Android_Update_Appeal_Mode` - endpoint для сохранения режима
- [x] Логика создания заявки - копирование `operation_mode` из tenant (BAT Appeal Manager)
- [x] BAT AI Appeal Router - ветвление AUTO/ASSIST

---

## Шаг 1: Миграция БД - добавить поле в appeals

```sql
-- Migration 013: Add operation_mode to appeals table
-- Описание: Режим AI для каждой заявки (auto/assist)

-- Добавляем поле
ALTER TABLE appeals
ADD COLUMN IF NOT EXISTS operation_mode TEXT DEFAULT NULL;

-- Комментарий
COMMENT ON COLUMN appeals.operation_mode IS
'AI operation mode per appeal: auto (AI responds directly) or assist (AI suggests, operator confirms). NULL = inherit from tenant default';

-- Индекс для фильтрации
CREATE INDEX IF NOT EXISTS idx_appeals_operation_mode ON appeals(operation_mode);
```

---

## Шаг 2: n8n Workflow - API_Android_Update_Appeal_Mode

**Webhook path:** `android-update-appeal-mode`
**Method:** POST

### Входные данные:
```json
{
  "operator_id": "uuid",
  "appeal_id": "uuid",
  "operation_mode": "auto" | "assist"
}
```

### SQL для обновления:
```sql
UPDATE appeals
SET operation_mode = $1, updated_at = NOW()
WHERE id = $2
  AND tenant_id = (SELECT tenant_id FROM operators WHERE id = $3)
RETURNING id, operation_mode;
```

### Ответ:
```json
{
  "success": true,
  "appeal_id": "uuid",
  "operation_mode": "auto"
}
```

### Структура workflow:

```
Webhook → Parse Body → Validate Operator → Update Appeal → Respond
```

**Nodes:**

1. **Webhook** - path: `android-update-appeal-mode`, method: POST
2. **Parse Body** - извлечь operator_id, appeal_id, operation_mode
3. **Validate** - проверить что operator_id существует и активен
4. **Update Appeal** - SQL UPDATE
5. **Respond 200/400** - вернуть результат

---

## Шаг 3: Логика создания заявки - наследование от tenant

В workflow создания заявки (BAT Client Creator или аналог) добавить:

```sql
INSERT INTO appeals (
  tenant_id,
  client_id,
  operation_mode,  -- добавить это поле
  ...
)
SELECT
  t.id,
  :client_id,
  COALESCE(t.operation_mode, 'assist'),  -- наследуем от tenant
  ...
FROM tenants t
WHERE t.id = :tenant_id;
```

Или в отдельном шаге после создания:

```sql
UPDATE appeals a
SET operation_mode = COALESCE(t.operation_mode, 'assist')
FROM tenants t
WHERE a.id = :new_appeal_id
  AND a.tenant_id = t.id
  AND a.operation_mode IS NULL;
```

---

## Шаг 4: BAT AI Appeal Router - учитывать operation_mode заявки

В workflow обработки AI (`BAT AI Appeal Router`) нужно:

1. **Читать** `operation_mode` из заявки (не из tenant!)
2. **Если AUTO** - отправлять ответ клиенту сразу
3. **Если ASSIST** - сохранять как черновик, уведомлять оператора

```sql
SELECT a.operation_mode
FROM appeals a
WHERE a.id = :appeal_id;
```

Логика ветвления:
```
IF operation_mode = 'auto' THEN
  → Send to client immediately
  → Notify operator (optional)
ELSE
  → Save as draft (ai_response)
  → Notify operator to review
END IF
```

---

## Шаг 5: Настройки оператора (глобальный переключатель)

`MainActivity` уже имеет глобальный переключатель, который вызывает `android-update-settings`.

Этот endpoint должен обновлять `tenants.operation_mode`:

```sql
UPDATE tenants
SET operation_mode = $1
WHERE id = (SELECT tenant_id FROM operators WHERE id = $2);
```

**Важно:** Это меняет только DEFAULT для новых заявок, не затрагивает существующие!

---

## Порядок внедрения

1. **БД:** Выполнить миграцию 013 (добавить поле в appeals)
2. **n8n:** Создать workflow `API_Android_Update_Appeal_Mode`
3. **n8n:** Обновить workflow создания заявок (добавить наследование)
4. **n8n:** Обновить `BAT AI Appeal Router` (читать mode из appeals)
5. **Тест:** Проверить работу через Android приложение

---

## Файлы для изменения

### База данных
- `database/migrations/013_add_operation_mode_to_appeals.sql` (новый)

### n8n Workflows
- `API_Android_Update_Appeal_Mode.json` (новый)
- `BAT Client Creator.json` (или где создаются заявки)
- `BAT AI Appeal Router.json` (ветвление по operation_mode)

### Android (уже сделано)
- `AppealDetailActivity.kt` - тумблер ✓
- `ApiService.kt` - endpoint ✓
- `AppealEntity.kt` - поле operationMode ✓

---

## Проверка

После внедрения:

1. Создать новую заявку → должен унаследовать mode от tenant
2. Открыть заявку в приложении → должен показать текущий mode
3. Переключить mode → должен сохраниться
4. Получить сообщение от клиента:
   - AUTO: AI отвечает сразу
   - ASSIST: AI создаёт черновик, оператор видит его в поле ввода
