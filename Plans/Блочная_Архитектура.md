# Архитектура взаимодействия блоков — Концепция

> **Размышления о совместимости, зависимостях и стыкуемости блоков в конструкторе**

---

## 1. Типы блоков по зависимостям

### Независимые блоки (Standalone)
Работают автономно, не требуют других блоков для функционирования:
- **Блок Календарь/Расписание** — просто календарь с записями
- **Блок Склад/Инвентарь** — учёт товаров и остатков
- **Блок Задачи/Проекты** — task-менеджер
- **Блок Финансы** — учёт доходов/расходов

### Базовые блоки (Foundation)
Фундамент, на котором строятся другие блоки:
- **Блок Коммуникаций** — почти все вертикали нуждаются в связи с клиентами
- **Блок AI Контекста** — извлечение данных из диалогов
- **Блок Канбан** — управление процессами и статусами

### Зависимые блоки (Dependent)
Не могут работать без других блоков:
- **Блок Уведомления** → требует Блок Коммуникаций (куда отправлять?)
- **Блок Триггеров** → требует события от других блоков
- **Блок Лояльности** → требует данные о клиентах и их активности
- **Блок Репутация** → требует данные о завершённых услугах

---

## 2. Матрица зависимостей

### Блок Коммуникаций (фундамент)
- **Зависит от:** ничего
- **Кому нужен:** Уведомления, AI Контекста, Репутация, почти все вертикали
- **Что отдаёт:** входящие сообщения от клиентов
- **Что принимает:** исходящие сообщения для отправки

### Блок AI Контекста
- **Зависит от:** Коммуникации (откуда брать сообщения для анализа)
- **Кому нужен:** Канбан, Стационарные/Выездные/Онлайн услуги
- **Что отдаёт:** извлечённые сущности (имя, устройство, проблема и тд)
- **Что принимает:** текст сообщения, конфигурация полей для извлечения

### Блок Канбан
- **Зависит от:** опционально AI Контекста (автосоздание карточек)
- **Кому нужен:** Триггеры (события переходов между статусами)
- **Что отдаёт:** события смены статусов, данные карточек
- **Что принимает:** новые карточки, обновления статусов

### Блок Уведомления
- **Зависит от:** Коммуникации (через что отправлять)
- **Кому нужен:** Триггеры, Лояльность, Календарь, Репутация
- **Что отдаёт:** подтверждение отправки
- **Что принимает:** текст сообщения, получатель, канал

### Блок Триггеров
- **Зависит от:** события от других блоков (Календарь, Канбан, Лояльность)
- **Кому нужен:** все блоки (запускает действия)
- **Что отдаёт:** действия (отправить уведомление, изменить статус)
- **Что принимает:** события и условия срабатывания

### Блок Календарь/Расписание
- **Зависит от:** опционально Коммуникации (для онлайн-записи)
- **Кому нужен:** Триггеры (напоминания), Онлайн-услуги (время сессий)
- **Что отдаёт:** события записей (создана, изменена, приближается)
- **Что принимает:** новые записи, изменения

### Блок Платежей
- **Зависит от:** Канбан или Услуги (что оплачиваем)
- **Кому нужен:** Финансы, Государство/Compliance (фискализация)
- **Что отдаёт:** данные о платежах, чеки
- **Что принимает:** запрос на оплату, сумма, плательщик

### Блок Лояльности
- **Зависит от:** данные о клиентах (визиты, покупки), Платежи
- **Кому нужен:** Уведомления (отправить награду)
- **Что отдаёт:** события достижений (5-й визит, сумма накоплена)
- **Что принимает:** события активности клиента

### Блок Репутация
- **Зависит от:** Канбан или Услуги (когда услуга завершена), Уведомления
- **Кому нужен:** Аналитика
- **Что отдаёт:** отзывы, рейтинги
- **Что принимает:** событие завершения услуги

### Блоки Услуг (Стационарные/Выездные/Онлайн)
- **Зависят от:** Коммуникации (заявка), AI Контекста (извлечение данных)
- **Кому нужны:** Платежи, Канбан, Уведомления, Репутация
- **Что отдают:** события статусов заявки (принята, в работе, завершена)
- **Что принимают:** новые заявки, обновления

---

## 3. Контракты блоков (Inputs/Outputs)

### Пример: Блок AI Контекста

**Входы (Inputs):**
```
{
  "source": "communications",
  "data": {
    "client_id": "uuid",
    "message_text": "string",
    "channel": "whatsapp|telegram|vk",
    "timestamp": "ISO 8601"
  }
}
```

**Выходы (Outputs):**
```
{
  "entities": {
    "client_name": "string",
    "phone": "string",
    "brand": "string",
    "model": "string",
    "issue_type": "string"
  },
  "event": "context_extracted"
}
```

### Пример: Блок Триггеров

**Входы (Events):**
```
{
  "source_block": "calendar|kanban|loyalty",
  "event_type": "new_booking|status_changed|milestone_reached",
  "data": { ... }
}
```

**Выходы (Actions):**
```
{
  "action": "send_notification|create_task|change_status",
  "target_block": "notifications|tasks|kanban",
  "params": { ... }
}
```

---

## 4. Стандартные пакеты блоков

AI-конструктор предлагает готовые связки для популярных ниш.

### Пакет "Салон красоты"
- Блок Коммуникаций (WhatsApp)
- Блок Календарь/Расписание (записи клиентов)
- Блок Уведомления (SMS, Push)
- Блок Триггеров (за день и за час до визита)
- Блок Платежей (оплата услуг)
- Блок Лояльности (каждый 5-й визит со скидкой)
- Блок Репутация (просьба оставить отзыв)

**Связи:**
```
Коммуникации → Календарь (онлайн-запись)
Календарь → Триггеры (события записей)
Триггеры → Уведомления (напоминания)
Уведомления → Коммуникации (отправка)
Календарь → Лояльность (подсчёт визитов)
Лояльность → Уведомления (промокод на 5-й визит)
Календарь → Репутация (после визита)
Репутация → Уведомления (запрос отзыва)
```

### Пакет "Сервисный центр"
- Блок Коммуникаций (все каналы)
- Блок AI Контекста (извлечение устройства/проблемы)
- Блок Стационарных услуг (приём/выдача устройств)
- Блок Канбан (статусы ремонта)
- Блок Склад/Инвентарь (запчасти)
- Блок Платежей (оплата ремонта)
- Блок Уведомления (уведомления о статусе)
- Блок Репутация (отзывы после ремонта)

**Связи:**
```
Коммуникации → AI Контекста (анализ сообщений)
AI Контекста → Стационарные услуги (создание заявки)
Стационарные услуги → Канбан (карточка ремонта)
Канбан → Триггеры (смена статуса)
Триггеры → Уведомления (клиенту о статусе)
Стационарные услуги → Склад (списание запчастей)
Канбан → Платежи (ремонт завершён)
Платежи → Репутация (после оплаты запросить отзыв)
```

### Пакет "Онлайн-репетитор"
- Блок Коммуникаций (Telegram, WhatsApp)
- Блок Календарь/Расписание (периодические занятия)
- Блок Онлайн-услуг (Zoom ссылки)
- Блок Платежей (абонементы)
- Блок Уведомления (начало урока)
- Блок Триггеров (за 10 минут до урока)

**Связи:**
```
Коммуникации → Календарь (запись на занятие)
Календарь → Онлайн-услуги (генерация Zoom ссылки)
Календарь → Триггеры (время урока приближается)
Триггеры → Уведомления (напоминание + ссылка)
Календарь → Платежи (списание с абонемента)
```

---

## 5. Как AI-конструктор учитывает зависимости

### Автоматическое предложение зависимых блоков

**Сценарий 1: Добавление блока с зависимостью**

Клиент: "Добавь Блок Уведомления"

AI: "Блок Уведомления отправляет сообщения клиентам. Для этого нужен **Блок Коммуникаций** (через какой канал отправлять: WhatsApp, SMS, email?). У вас его ещё нет. Добавить?"

Клиент: "Да"

AI: "Добавил Блок Коммуникаций. Какие каналы подключить?"

---

**Сценарий 2: Функционал без указания блока**

Клиент: "Хочу чтобы клиентам напоминало о записи"

AI: "Отлично! Для этого нужна цепочка блоков:
1. **Блок Календарь** — хранит записи
2. **Блок Триггеров** — запускает напоминание за N времени
3. **Блок Уведомления** — отправляет сообщение
4. **Блок Коммуникаций** — канал отправки (WhatsApp?)

Добавить всю цепочку?"

Клиент: "Да"

AI: "Готово! За сколько времени напоминать? За день и за час?"

---

**Сценарий 3: Проверка при удалении блока**

Клиент: "Убери Блок Коммуникаций"

AI: "⚠️ Внимание! Блок Коммуникаций используется в:
- Блок Уведомления (отправка сообщений)
- Блок AI Контекста (приём сообщений от клиентов)
- Блок Репутация (запрос отзывов)

Если удалить, эти блоки перестанут работать. Что делать?
1. Удалить всё равно (другие блоки станут неактивны)
2. Удалить Блок Коммуникаций и все зависимые блоки
3. Оставить как есть"

---

### Умные подсказки и улучшения

**1. Предложение дополнительных блоков:**
- "Вы добавили Блок Платежей. Хотите **Блок Государство/Compliance** для фискализации чеков?"

**2. Предупреждение о неоптимальности:**
- "У вас Блок Лояльности, но нет Блока Уведомления. Как клиент узнает о скидке?"

**3. Предложения на основе статистики:**
- "Заметил, что у вас Блок Календарь. Добавить Блок Триггеров для автонапоминаний? Это снижает no-show на 40%!"

**4. Популярные связки:**
- "80% салонов с Блоком Календарь используют также: Уведомления, Лояльность, Репутация. Хотите добавить?"

---

## 6. Визуализация связей в конструкторе

### UI как в n8n
- Каждый блок = нода на канвасе
- Стрелки показывают поток данных
- Типы связей:
  - **Жирная красная линия** — обязательная зависимость
  - **Пунктирная серая** — опциональная связь
  - **Зелёная** — активная связь (работает)
  - **Серая** — неактивная (блок отключён)

### Пример схемы "Салон красоты":

```
┌─────────────────┐
│  Коммуникации   │ ─────┐
│   (WhatsApp)    │      │
└─────────────────┘      │
         │               │
         ↓               │
┌─────────────────┐      │
│  AI Контекста   │      │
└─────────────────┘      │
         │               │
         ↓               │
┌─────────────────┐      │
│    Календарь    │      │
└─────────────────┘      │
         │               │
         ↓               │
┌─────────────────┐      │
│    Триггеры     │      │
└─────────────────┘      │
         │               │
         ↓               │
┌─────────────────┐      │
│  Уведомления    │ ─────┘
└─────────────────┘
```

---

## 7. Уровни использования конструктора

### Уровень 1: Готовые пакеты (для новичков)
- AI предлагает проверенную связку блоков
- Всё настроено "из коробки"
- Можно сразу использовать
- **Пример:** "Хочу CRM для маникюра" → пакет развёрнут за 5 минут

### Уровень 2: Кастомизация пакета (средний)
- Берём готовый пакет
- Добавляем/убираем блоки по вкусу
- AI помогает сохранить зависимости
- **Пример:** Пакет "Салон" + добавить Блок Склад (учёт материалов)

### Уровень 3: Сборка с нуля (продвинутые)
- Выбираем блоки один за другим
- Настраиваем связи вручную
- AI предупреждает о зависимостях, но не навязывает
- Полная свобода
- **Пример:** Нестандартная вертикаль с уникальными процессами

---

## 8. Проверка совместимости

### При добавлении блока:
- AI проверяет наличие зависимостей
- Если не хватает — предлагает добавить
- Показывает какие блоки станут доступны после добавления

### При удалении блока:
- AI проверяет кто использует этот блок
- Предупреждает о последствиях
- Предлагает варианты действий

### При изменении настроек:
- Проверяет влияние на связанные блоки
- Если изменение ломает связь — предупреждает

---

## 9. Открытые вопросы для проработки

### Технические:
- Как хранить граф зависимостей блоков?
- Как обрабатывать циклические зависимости (если появятся)?
- Версионирование блоков и обратная совместимость?

### UX:
- Как показывать сложные связи в простом UI?
- Нужен ли режим "эксперта" без подсказок?
- Как визуализировать поток данных в реальном времени?

### AI:
- Как AI обучается на популярных связках?
- Персонализация подсказок под нишу клиента?
- Может ли AI предложить оптимизацию существующей вертикали?

---

*Этот документ — концепция для дальнейшей проработки архитектуры взаимодействия блоков в конструкторе.*
