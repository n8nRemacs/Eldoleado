# ELO_Resolver — Анализ проблемы с IF nodes

**Дата:** 2025-12-26

---

## Краткое описание проблемы

ELO_Resolver workflow не работает корректно из-за неправильной обработки условий в n8n IF nodes. Данные без `tenant_id` идут в TRUE branch вместо FALSE branch.

---

## Архитектура ELO_Resolver

```
┌─────────────────┐
│  Input (payload)│
└────────┬────────┘
         ▼
┌─────────────────┐
│ Validate Input  │  ← Извлекает channel, credential, external_chat_id
└────────┬────────┘
         ▼
┌─────────────────┐
│ Redis Get Tenant│  ← Проверяет кеш cache:tenant:{channel}:{credential}
└────────┬────────┘
         ▼
┌─────────────────┐
│Check Tenant Cache│ ← Если кеш есть → добавляет tenant_id
└────────┬────────┘    Если кеша нет → возвращает данные БЕЗ tenant_id
         ▼
┌─────────────────┐
│  Tenant Cached? │  ← IF node: проверяет tenant_id
└────────┬────────┘
    TRUE │ FALSE
    ▼         ▼
┌───────┐  ┌─────────────┐
│Combine│  │DB Get Tenant│ ← Запрос в PostgreSQL
│Tenant │  └──────┬──────┘
└───┬───┘         ▼
    │      ┌─────────────┐
    │      │Merge Tenant │
    │      └──────┬──────┘
    │             ▼
    │      ┌─────────────┐
    │      │Redis Set    │
    │      └──────┬──────┘
    │             ▼
    │      ┌─────────────┐
    │      │Restore After│
    │      └──────┬──────┘
    │             │
    └─────────────┘
              ▼
       ┌─────────────┐
       │Combine Tenant│ ← Собирает данные из обеих веток
       └─────────────┘
```

---

## Что происходит сейчас

### 1. Входные данные (из ELO_Input_Processor)

```json
{
  "channel": "whatsapp",
  "external_chat_id": "79997253777@s.whatsapp.net",
  "client_name": "Дмитрий",
  "text": "...",
  "meta": {
    "raw": {
      "sessionId": "wa_22222222-2222-2222-2222-222222222222_1766570899887"
    }
  }
}
```

### 2. После Validate Input

```json
{
  "channel": "whatsapp",
  "credential": "wa_22222222-2222-2222-2222-222222222222_1766570899887",
  "external_chat_id": "79997253777@s.whatsapp.net",
  "tenantCacheKey": "cache:tenant:whatsapp:wa_22222222-...",
  // tenant_id НЕТ
}
```

### 3. После Redis Get Tenant

Redis возвращает:
```json
{ "propertyName": null }  // кеш пустой
```

### 4. После Check Tenant Cache

```json
{
  "channel": "whatsapp",
  "credential": "wa_22222222-...",
  "external_chat_id": "79997253777@s.whatsapp.net",
  "_tenant_from_cache": false
  // tenant_id НЕТ - потому что в кеше ничего не было
}
```

### 5. IF Node "Tenant Cached?"

**Ожидаемое поведение:**
- Условие: `tenant_id exists`
- `tenant_id` отсутствует → FALSE → идем в DB Get Tenant

**Фактическое поведение:**
- `tenant_id` отсутствует → TRUE → идем в Combine Tenant
- Combine Tenant не находит tenant_id → **ОШИБКА**

---

## Почему IF node работает неправильно?

### Гипотеза 1: Операция "exists" не поддерживается

n8n IF node v2 может не поддерживать операцию `exists` для string type. Поддерживаемые операции:
- `equals` / `notEquals`
- `contains` / `notContains`
- `startsWith` / `endsWith`
- `regex`
- `isEmpty` / `isNotEmpty`

Операции `exists` / `notExists` могут не существовать или работать иначе.

### Гипотеза 2: undefined vs empty string

JavaScript различает:
- `undefined` — ключ не существует
- `null` — ключ существует, значение null
- `""` — пустая строка

n8n IF node может не различать эти случаи:
```javascript
// Для n8n:
undefined.exists === ???  // не определено
"".isEmpty === true
null.exists === ???
```

### Гипотеза 3: Type coercion

n8n может приводить типы неожиданным образом:
```javascript
// В JavaScript:
!!undefined === false
!!"" === false
!!null === false
!!0 === false

// Но в n8n template expressions:
{{ $json.tenant_id }}  // может вернуть строку "undefined"?
```

### Гипотеза 4: Expression evaluation

Expression `={{ $json.tenant_id }}` может возвращать:
- `undefined` — если ключа нет
- `null` — если значение null
- `""` — пустую строку

И `exists` может проверять только строковое представление.

---

## Доказательства

### Тест 1: Boolean флаги не работают

Пробовали:
```json
{
  "leftValue": "={{ $json._tenant_from_cache }}",
  "rightValue": true,
  "operator": { "type": "boolean", "operation": "equals" }
}
```

Результат: `_tenant_from_cache: false` идет в TRUE branch.

### Тест 2: isEmpty/isNotEmpty не работают

Пробовали:
```json
{
  "leftValue": "={{ $json.tenant_id }}",
  "operator": { "type": "string", "operation": "isNotEmpty" }
}
```

Результат: undefined идет в TRUE branch (как будто не пустой).

### Тест 3: exists не работает

Пробовали:
```json
{
  "leftValue": "={{ $json.tenant_id }}",
  "operator": { "type": "string", "operation": "exists" }
}
```

Результат: undefined идет в TRUE branch.

---

## Варианты решения

### Вариант A: Использовать expression с !!

```json
{
  "leftValue": "={{ !!$json.tenant_id }}",
  "rightValue": true,
  "operator": { "type": "boolean", "operation": "equals" }
}
```

`!!undefined` → `false`, `!!"uuid"` → `true`

### Вариант B: Использовать строковое сравнение

```json
{
  "leftValue": "={{ $json.tenant_id || '' }}",
  "rightValue": "",
  "operator": { "type": "string", "operation": "notEquals" }
}
```

### Вариант C: Убрать IF nodes

Сделать линейный flow где Code nodes сами решают логику:

```javascript
// В Check Tenant Cache
const cached = redis.value;
if (cached) {
  // Есть в кеше - используем
  return { ...input, ...JSON.parse(cached), _source: 'cache' };
} else {
  // Нет в кеше - нужно запросить из DB
  // Но Code node не может сделать DB запрос...
}
```

**Проблема:** Code node не может вызывать другие nodes.

### Вариант D: Использовать Switch node

Switch node может иметь другую логику сравнения.

### Вариант E: Всегда идти в DB, использовать UPSERT логику

```javascript
// Не проверять кеш на уровне IF node
// Просто проверить в Code node и передать флаг
// А DB запрос делать всегда с ON CONFLICT DO NOTHING
```

### Вариант F: Переписать на Function node

Function node в n8n имеет доступ к более сложной логике и может возвращать разные outputs.

---

## Текущее состояние данных

### Redis
```
cache:tenant:whatsapp:wa_22222222-2222-2222-2222-222222222222_1766570899887
= {"tenant_id":"11111111-1111-1111-1111-111111111111","channel_account_id":"f9f4d6e9-d2ae-42fd-8602-90e4d4c3472a","channel_id":2}
```

### PostgreSQL - elo_t_clients
```
id                                   | name    | phone        | tenant_id
d9f48ac6-b00d-4904-a2ff-86698479b920 | Дмитрий | +79997253777 | 11111111-...
482acec9-1ab2-4013-a329-aae1184da15f | Ремакс  | +79171708077 | 11111111-...
```

### PostgreSQL - elo_t_client_channels
```
client_id                            | channel_id | external_id
d9f48ac6-b00d-4904-a2ff-86698479b920 | 2          | 79997253777@s.whatsapp.net
482acec9-1ab2-4013-a329-aae1184da15f | 2          | 79171708077@s.whatsapp.net
```

### PostgreSQL - elo_t_channel_accounts
```
id          | tenant_id    | channel_id | session_id
f9f4d6e9-.. | 11111111-... | 2          | wa_22222222-2222-2222-2222-222222222222_1766570899887
```

---

## Рекомендация

**Попробовать Вариант A** — использовать `!!` в expression:

```json
{
  "conditions": [
    {
      "leftValue": "={{ !!$json.tenant_id }}",
      "rightValue": true,
      "operator": { "type": "boolean", "operation": "equals" }
    }
  ]
}
```

Это должно работать потому что:
- `!!undefined` → `false`
- `!!null` → `false`
- `!!""` → `false`
- `!!"11111111-..."` → `true`

---

## Файлы

- `NEW/workflows/ELO_Resolver_v2.json` — текущая версия workflow
- `NEW/workflows/ELO_Unifier.json` — модуль объединения клиентов по телефону

---

*Последнее обновление: 2025-12-26 22:40*
