# ELO_Resolver - Статус работы

**Дата:** 2025-12-27

---

## Что сделано

### 1. Полная переработка ELO_Resolver
- **47 нод** с правильным потоком данных
- Логика: Tenant → Client → Dialog resolution
- ONE dialog per client (channel-agnostic)
- Добавлены колонки `first_contact_channel_id` и `last_client_channel_id` в elo_t_dialogs

### 2. Исправлена потеря данных между нодами
**Проблема:** Redis GET возвращает только `{propertyName: value}`, а не предыдущие данные. Каждая нода получает только output предыдущей ноды.

**Решение:** Добавлены Merge ноды после каждой Redis/DB операции:
- `Merge Tenant Redis` - объединяет Validate Input + Redis результат
- `Merge DB Tenant` - объединяет предыдущие данные + DB результат
- `Merge Client Redis` - объединяет tenant данные + Redis результат
- `Merge DB Client` - объединяет предыдущие данные + DB результат
- `Merge Dialog Redis` - объединяет client данные + Redis результат
- `Merge DB Dialog` - объединяет предыдущие данные + DB результат

### 3. Исправлен парсинг Redis
**Проблема:** Redis в n8n возвращает значение в поле `propertyName`, а не `value`.

**Решение:** Проверяем оба поля:
```javascript
const cachedValue = redis.propertyName || redis.value || null;
```

### 4. Добавлена валидация парсинга
Merge ноды теперь валидируют распарсенные данные:
```javascript
let parsed = null;
if (cachedValue && cachedValue !== 'null' && cachedValue !== '') {
  try {
    parsed = JSON.parse(cachedValue);
    if (!parsed || !parsed.client_id) parsed = null;  // проверка нужного поля
  } catch (e) {
    parsed = null;
  }
}
```

### 5. Исправлены IF ноды (ПОСЛЕДНЕЕ ИЗМЕНЕНИЕ)
**Проблема:** `!!$json._client_cached` пропускал null в TRUE ветку. n8n IF node v2 некорректно обрабатывает undefined/null.

**Решение:** Изменены условия на проверку конкретных полей через optional chaining:
```
Tenant Cached?:  $json._tenant_cached?.tenant_id || ''  notEquals  ''
Client Cached?:  $json._client_cached?.client_id || ''  notEquals  ''
Dialog Cached?:  $json._dialog_cached?.dialog_id || ''  notEquals  ''
```

### 6. Добавлены Restore ноды
После Redis SET и DB UPDATE операций добавлены Restore ноды для восстановления данных (т.к. Redis SET возвращает "OK", а не наши данные).

### 7. Все IF ноды имеют looseTypeValidation: true

---

## Структура данных

### Кешированные значения
| Поле | Описание |
|------|----------|
| `_tenant_cached` | Распарсенный tenant из Redis |
| `_client_cached` | Распарсенный client из Redis |
| `_dialog_cached` | Распарсенный dialog из Redis |
| `_db_tenant` | Tenant объект из DB |
| `_db_client_id` | Client ID из DB |
| `_db_dialog_id` | Dialog ID из DB |

### Redis ключи
- `cache:tenant:{channel}:{credential}` → `{tenant_id, channel_account_id, channel_id}`
- `cache:client:{tenant_id}:{channel}:{external_chat_id}` → `{client_id}`
- `cache:dialog:{tenant_id}:{client_id}` → `{dialog_id}`

---

## Поток данных

```
Execute Workflow Trigger
         ↓
    Validate Input (нормализация, trace_id, hasPhoneInExternalId)
         ↓
    Cache Get Tenant (Redis GET)
         ↓
    Merge Tenant Redis (input + redis)
         ↓
    Tenant Cached? ─────────────────────────────┐
         ↓ TRUE                                 ↓ FALSE
    Use Cached Tenant                      DB Get Tenant
         ↓                                      ↓
         │                                 Merge DB Tenant
         │                                      ↓
         │                                 Tenant Found?
         │                                   ↓ TRUE    ↓ FALSE
         │                              Use DB Tenant   Error
         │                                   ↓
         │                              Cache Tenant (SET)
         │                                   ↓
         │                              Restore Tenant
         │                                   ↓
         └──────────────────────────────────→↓
                                     Cache Get Client
                                             ↓
                                     Merge Client Redis
                                             ↓
                                     Client Cached?
                                       ... (аналогично)
                                             ↓
                                     Has Phone?
                                       ↓ TRUE    ↓ FALSE
                                  Call Unifier   Skip Unifier
                                       ↓             ↓
                                     After Unifier   │
                                       └─────────────┘
                                             ↓
                                     Cache Get Dialog
                                             ↓
                                     ... (аналогично)
                                             ↓
                                     Build Response
```

---

## Что работает

1. ✅ Validate Input - нормализация входящих данных
2. ✅ Определение hasPhoneInExternalId для WhatsApp/MAX
3. ✅ Генерация trace_id
4. ✅ Формирование ключей кеша
5. ✅ Merge ноды сохраняют данные между шагами

---

## Что НЕ работает / НЕ протестировано

1. ❓ **IF ноды** - последнее исправление (optional chaining) НЕ ТЕСТИРОВАЛОСЬ
2. ❓ **Полный флоу** - не завершён ни один успешный прогон
3. ❓ **Call Unifier** - вызов ELO_Unifier для объединения клиентов по телефону
4. ❓ **Кеширование** - не проверено, правильно ли сохраняются/читаются данные

---

## Известные проблемы n8n IF node v2

1. `!!$json.field` не работает правильно с undefined/null
2. `exists` оператор ненадёжен
3. `isEmpty` может давать неожиданные результаты
4. **Решение:** использовать optional chaining + string comparison: `$json.field?.id || '' notEquals ''`

---

## Следующие шаги

1. Импортировать обновлённый `ELO_Resolver.json` в n8n
2. Протестировать IF ноды с новыми условиями
3. Если IF работает - проверить полный флоу
4. Проверить что Redis кеш работает корректно

---

## Файлы

- **Workflow:** `NEW\workflows\Resolve Contour\ELO_Resolver.json`
- **Unifier:** `NEW\workflows\Resolve Contour\ELO_Unifier.json`

---

*Последнее обновление: 2025-12-27*
