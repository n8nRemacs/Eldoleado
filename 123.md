# ELO_Resolver - –°—Ç–∞—Ç—É—Å —Ä–∞–±–æ—Ç—ã

**–î–∞—Ç–∞:** 2025-12-27

---

## –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞ ELO_Resolver
- **47 –Ω–æ–¥** —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –ø–æ—Ç–æ–∫–æ–º –¥–∞–Ω–Ω—ã—Ö
- –õ–æ–≥–∏–∫–∞: Tenant ‚Üí Client ‚Üí Dialog resolution
- ONE dialog per client (channel-agnostic)
- –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–æ–ª–æ–Ω–∫–∏ `first_contact_channel_id` –∏ `last_client_channel_id` –≤ elo_t_dialogs

### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –Ω–æ–¥–∞–º–∏
**–ü—Ä–æ–±–ª–µ–º–∞:** Redis GET –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ `{propertyName: value}`, –∞ –Ω–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ. –ö–∞–∂–¥–∞—è –Ω–æ–¥–∞ –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ output –ø—Ä–µ–¥—ã–¥—É—â–µ–π –Ω–æ–¥—ã.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω—ã Merge –Ω–æ–¥—ã –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π Redis/DB –æ–ø–µ—Ä–∞—Ü–∏–∏:
- `Merge Tenant Redis` - –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç Validate Input + Redis —Ä–µ–∑—É–ª—å—Ç–∞—Ç
- `Merge DB Tenant` - –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ + DB —Ä–µ–∑—É–ª—å—Ç–∞—Ç
- `Merge Client Redis` - –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç tenant –¥–∞–Ω–Ω—ã–µ + Redis —Ä–µ–∑—É–ª—å—Ç–∞—Ç
- `Merge DB Client` - –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ + DB —Ä–µ–∑—É–ª—å—Ç–∞—Ç
- `Merge Dialog Redis` - –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç client –¥–∞–Ω–Ω—ã–µ + Redis —Ä–µ–∑—É–ª—å—Ç–∞—Ç
- `Merge DB Dialog` - –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ + DB —Ä–µ–∑—É–ª—å—Ç–∞—Ç

### 3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –ø–∞—Ä—Å–∏–Ω–≥ Redis
**–ü—Ä–æ–±–ª–µ–º–∞:** Redis –≤ n8n –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –ø–æ–ª–µ `propertyName`, –∞ –Ω–µ `value`.

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–∞ –ø–æ–ª—è:
```javascript
const cachedValue = redis.propertyName || redis.value || null;
```

### 4. –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä—Å–∏–Ω–≥–∞
Merge –Ω–æ–¥—ã —Ç–µ–ø–µ—Ä—å –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
```javascript
let parsed = null;
if (cachedValue && cachedValue !== 'null' && cachedValue !== '') {
  try {
    parsed = JSON.parse(cachedValue);
    if (!parsed || !parsed.client_id) parsed = null;  // –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω—É–∂–Ω–æ–≥–æ –ø–æ–ª—è
  } catch (e) {
    parsed = null;
  }
}
```

### 5. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã IF –Ω–æ–¥—ã (–ü–û–°–õ–ï–î–ù–ï–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï)
**–ü—Ä–æ–±–ª–µ–º–∞:** `!!$json._client_cached` –ø—Ä–æ–ø—É—Å–∫–∞–ª null –≤ TRUE –≤–µ—Ç–∫—É. n8n IF node v2 –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç undefined/null.

**–†–µ—à–µ–Ω–∏–µ:** –ò–∑–º–µ–Ω–µ–Ω—ã —É—Å–ª–æ–≤–∏—è –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø–æ–ª–µ–π —á–µ—Ä–µ–∑ optional chaining:
```
Tenant Cached?:  $json._tenant_cached?.tenant_id || ''  notEquals  ''
Client Cached?:  $json._client_cached?.client_id || ''  notEquals  ''
Dialog Cached?:  $json._dialog_cached?.dialog_id || ''  notEquals  ''
```

### 6. –î–æ–±–∞–≤–ª–µ–Ω—ã Restore –Ω–æ–¥—ã
–ü–æ—Å–ª–µ Redis SET –∏ DB UPDATE –æ–ø–µ—Ä–∞—Ü–∏–π –¥–æ–±–∞–≤–ª–µ–Ω—ã Restore –Ω–æ–¥—ã –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö (—Ç.–∫. Redis SET –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç "OK", –∞ –Ω–µ –Ω–∞—à–∏ –¥–∞–Ω–Ω—ã–µ).

### 7. –í—Å–µ IF –Ω–æ–¥—ã –∏–º–µ—é—Ç looseTypeValidation: true

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### –ö–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
| –ü–æ–ª–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|
| `_tenant_cached` | –†–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–π tenant –∏–∑ Redis |
| `_client_cached` | –†–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–π client –∏–∑ Redis |
| `_dialog_cached` | –†–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–π dialog –∏–∑ Redis |
| `_db_tenant` | Tenant –æ–±—ä–µ–∫—Ç –∏–∑ DB |
| `_db_client_id` | Client ID –∏–∑ DB |
| `_db_dialog_id` | Dialog ID –∏–∑ DB |

### Redis –∫–ª—é—á–∏
- `cache:tenant:{channel}:{credential}` ‚Üí `{tenant_id, channel_account_id, channel_id}`
- `cache:client:{tenant_id}:{channel}:{external_chat_id}` ‚Üí `{client_id}`
- `cache:dialog:{tenant_id}:{client_id}` ‚Üí `{dialog_id}`

---

## –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

```
Execute Workflow Trigger
         ‚Üì
    Validate Input (–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è, trace_id, hasPhoneInExternalId)
         ‚Üì
    Cache Get Tenant (Redis GET)
         ‚Üì
    Merge Tenant Redis (input + redis)
         ‚Üì
    Tenant Cached? ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚Üì TRUE                                 ‚Üì FALSE
    Use Cached Tenant                      DB Get Tenant
         ‚Üì                                      ‚Üì
         ‚îÇ                                 Merge DB Tenant
         ‚îÇ                                      ‚Üì
         ‚îÇ                                 Tenant Found?
         ‚îÇ                                   ‚Üì TRUE    ‚Üì FALSE
         ‚îÇ                              Use DB Tenant   Error
         ‚îÇ                                   ‚Üì
         ‚îÇ                              Cache Tenant (SET)
         ‚îÇ                                   ‚Üì
         ‚îÇ                              Restore Tenant
         ‚îÇ                                   ‚Üì
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí‚Üì
                                     Cache Get Client
                                             ‚Üì
                                     Merge Client Redis
                                             ‚Üì
                                     Client Cached?
                                       ... (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ)
                                             ‚Üì
                                     Has Phone?
                                       ‚Üì TRUE    ‚Üì FALSE
                                  Call Unifier   Skip Unifier
                                       ‚Üì             ‚Üì
                                     After Unifier   ‚îÇ
                                       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                             ‚Üì
                                     Cache Get Dialog
                                             ‚Üì
                                     ... (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ)
                                             ‚Üì
                                     Build Response
```

---

## –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. ‚úÖ Validate Input - –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –≤—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
2. ‚úÖ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ hasPhoneInExternalId –¥–ª—è WhatsApp/MAX
3. ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è trace_id
4. ‚úÖ –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª—é—á–µ–π –∫–µ—à–∞
5. ‚úÖ Merge –Ω–æ–¥—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç –¥–∞–Ω–Ω—ã–µ –º–µ–∂–¥—É —à–∞–≥–∞–º–∏

---

## –ß—Ç–æ –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç / –ù–ï –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ

1. ‚ùì **IF –Ω–æ–¥—ã** - –ø–æ—Å–ª–µ–¥–Ω–µ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (optional chaining) –ù–ï –¢–ï–°–¢–ò–†–û–í–ê–õ–û–°–¨
2. ‚ùì **–ü–æ–ª–Ω—ã–π —Ñ–ª–æ—É** - –Ω–µ –∑–∞–≤–µ—Ä—à—ë–Ω –Ω–∏ –æ–¥–∏–Ω —É—Å–ø–µ—à–Ω—ã–π –ø—Ä–æ–≥–æ–Ω
3. ‚ùì **Call Unifier** - –≤—ã–∑–æ–≤ ELO_Unifier –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É
4. ‚ùì **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ** - –Ω–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ, –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è/—á–∏—Ç–∞—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ

---

## –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã n8n IF node v2

1. `!!$json.field` –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å undefined/null
2. `exists` –æ–ø–µ—Ä–∞—Ç–æ—Ä –Ω–µ–Ω–∞–¥—ë–∂–µ–Ω
3. `isEmpty` –º–æ–∂–µ—Ç –¥–∞–≤–∞—Ç—å –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
4. **–†–µ—à–µ–Ω–∏–µ:** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å optional chaining + string comparison: `$json.field?.id || '' notEquals ''`

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π `ELO_Resolver.json` –≤ n8n
2. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å IF –Ω–æ–¥—ã —Å –Ω–æ–≤—ã–º–∏ —É—Å–ª–æ–≤–∏—è–º–∏
3. –ï—Å–ª–∏ IF —Ä–∞–±–æ—Ç–∞–µ—Ç - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª–Ω—ã–π —Ñ–ª–æ—É
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ Redis –∫–µ—à —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## –§–∞–π–ª—ã

- **Workflow:** `NEW\workflows\Resolve Contour\ELO_Resolver.json`
- **Unifier:** `NEW\workflows\Resolve Contour\ELO_Unifier.json`

---

*–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ: 2025-12-27*

---
---
---

# –û–¢–ß–Å–¢ –ò –ü–õ–ê–ù: 2026-01-03

---

## –ß–ê–°–¢–¨ 1: –ß–¢–û –°–î–ï–õ–ê–ù–û (—Å–µ—Å—Å–∏—è 2026-01-03)

### 1.1 –û—á–∏—Å—Ç–∫–∞ ELO_In_* workflows

–£–¥–∞–ª–µ–Ω—ã –∏–∑–±—ã—Ç–æ—á–Ω—ã–µ –≤—ã–∑–æ–≤—ã Tenant Resolver –∏–∑ –≤—Ö–æ–¥—è—â–∏—Ö –∫–∞–Ω–∞–ª–æ–≤, —Ç.–∫. —Ä–µ–∑–æ–ª—å–≤–∏–Ω–≥ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ü–û–°–õ–ï –±–∞—Ç—á–∏–Ω–≥–∞:

| Workflow | –ò–∑–º–µ–Ω–µ–Ω–∏—è |
|----------|-----------|
| ELO_In_Telegram | –£–¥–∞–ª—ë–Ω Tenant Resolver |
| ELO_In_Telegram_Bot | –£–¥–∞–ª—ë–Ω Tenant Resolver |
| ELO_In_Avito | –£–¥–∞–ª—ë–Ω Tenant Resolver |
| ELO_In_MAX | –£–¥–∞–ª—ë–Ω Tenant Resolver (–≤–∫–ª—é—á–∞—è activeVersion) |
| ELO_In_VK | –ë—ã–ª —á–∏—Å—Ç |
| ELO_In_Form | **–ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–¥–µ–ª–∞–Ω** ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∞ –æ—á–µ—Ä–µ–¥—å Redis |
| ELO_In_Phone | **–ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–¥–µ–ª–∞–Ω** ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∞ –æ—á–µ—Ä–µ–¥—å Redis |

**–ù–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≤—Ö–æ–¥–∞:**
```
ELO_In_* ‚Üí Normalize ‚Üí Prepare for Queue ‚Üí Push to queue:incoming ‚Üí Respond
```

### 1.2 –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å n8n

–í—ã–≥—Ä—É–∂–µ–Ω—ã –∏ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –≤—Å–µ workflows:

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | Active | Inactive | Total |
|-----------|--------|----------|-------|
| Channel Contour (In) | 8 | 3 | 11 |
| Channel Contour (Out) | 4 | 3 | 7 |
| API | 11 | 0 | 11 |
| AI Contour | 4 | 11 | 15 |
| Input Contour | 2 | 1 | 3 |
| Resolve Contour | 0 | 6 | 6 |
| Core Contour | 0 | 4 | 4 |
| **Total** | **26** | **31** | **57** |

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: `NEW/DOCS/WORKFLOWS_ANALYSIS.md`

### 1.3 –ê–Ω–∞–ª–∏–∑ AI Contour ‚Äî –ù–ê–ô–î–ï–ù–´ –ü–†–û–ë–õ–ï–ú–´

**–ü—Ä–æ–±–ª–µ–º–∞ 1: –†–∞–∑—Ä—ã–≤ –≤ –ø–∞–π–ø–ª–∞–π–Ω–µ**
```
ELO_Resolver ‚Üí webhook /elo-core-ingest ‚Üí ELO_Core_AI_Test_Stub_WS [OFF]
                                                   ‚Üì
                                        (—Ç–µ—Å—Ç–æ–≤–∞—è –∑–∞–≥–ª—É—à–∫–∞, –Ω–µ AI!)

ELO_Pipeline_Orchestrator [OFF] ‚Üê –ù–ò–ö–¢–û –ù–ï –í–´–ó–´–í–ê–ï–¢!
```

**–ü—Ä–æ–±–ª–µ–º–∞ 2: ELO_Core_AI_Test_Stub_WS** ‚Äî —ç—Ç–æ –±—ã–ª–∞ —Ç–µ—Å—Ç–æ–≤–∞—è –∑–∞–≥–ª—É—à–∫–∞:
- –ü—Ä–∏–Ω–∏–º–∞–ª–∞ webhook `/elo-core-ingest`
- –°—Ç—Ä–æ–∏–ª–∞ —Ç–µ—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç (—ç—Ö–æ, –±–µ–∑ AI)
- –û—Ç–ø—Ä–∞–≤–ª—è–ª–∞ WebSocket push –æ–ø–µ—Ä–∞—Ç–æ—Ä—É
- –ù–ï –≤—ã–∑—ã–≤–∞–ª–∞ –Ω–∞—Å—Ç–æ—è—â–∏–π AI pipeline

**–ü—Ä–æ–±–ª–µ–º–∞ 3:** ELO_Pipeline_Orchestrator –∏–º–µ–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É –≤ –∫–∞–Ω–∞–ª—ã (–¥—É–±–ª–∏—Ä—É–µ—Ç ELO_Out_Router)

### 1.4 –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ ‚Äî –°–ü–†–û–ï–ö–¢–ò–†–û–í–ê–ù–ê

**–¢—Ä–∏ —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞:**

| –†–µ–∂–∏–º | Generate | Approve | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|---------|----------|
| `manual` | ‚ùå | ‚ùå | –û–ø–µ—Ä–∞—Ç–æ—Ä –ø–∏—à–µ—Ç —Å–∞–º, –≤–∏–¥–∏—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç |
| `semi_auto` | ‚úÖ | ‚úÖ | AI –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç, –æ–ø–µ—Ä–∞—Ç–æ—Ä —É—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç |
| `auto` | ‚úÖ | ‚ùå | AI –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Ä–∞–∑—É, —ç—Å–∫–∞–ª–∞—Ü–∏—è –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö |

**–ö–ª—é—á–µ–≤–æ–π –ø—Ä–∏–Ω—Ü–∏–ø:**
–ü–∞–π–ø–ª–∞–π–Ω (extraction, funnel, context) —Ä–∞–±–æ—Ç–∞–µ—Ç –û–î–ò–ù–ê–ö–û–í–û –¥–ª—è –≤—Å–µ—Ö —Ä–µ–∂–∏–º–æ–≤.
–†–∞–∑–Ω–∏—Ü–∞ —Ç–æ–ª—å–∫–æ –≤:
1. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –ª–∏ –æ—Ç–≤–µ—Ç AI
2. –£—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç—Å—è –ª–∏ –æ–Ω –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º

**–•—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞:**
```
effective_mode = operator.settings.ai_mode   ‚Üê –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
              ?? tenant.settings.ai_mode     ‚Üê fallback
              ?? 'manual'                    ‚Üê default
```

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** `NEW/DOCS/OPERATOR_NOTIFICATION_ARCHITECTURE.md`

---

## –ß–ê–°–¢–¨ 2: –¢–ï–ö–£–©–ï–ï –°–û–°–¢–û–Ø–ù–ò–ï –ü–ê–ô–ü–õ–ê–ô–ù–ê

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      –¢–ï–ö–£–©–ò–ô –ü–ê–ô–ü–õ–ê–ô–ù (–†–ê–ó–û–†–í–ê–ù!)                               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                                  ‚îÇ
‚îÇ  ELO_In_* ‚Üí queue:incoming ‚Üí ELO_Input_Batcher ‚Üí batch:*                        ‚îÇ
‚îÇ                                      ‚Üì                                           ‚îÇ
‚îÇ                            ELO_Input_Processor [ON]                              ‚îÇ
‚îÇ                                      ‚Üì                                           ‚îÇ
‚îÇ                              ELO_Resolver [OFF]                                  ‚îÇ
‚îÇ                                      ‚Üì                                           ‚îÇ
‚îÇ                     webhook /elo-core-ingest  ‚Üê –†–ê–ó–†–´–í!                         ‚îÇ
‚îÇ                                      ‚Üì                                           ‚îÇ
‚îÇ                   ELO_Core_AI_Test_Stub_WS [OFF] ‚Üê –ó–∞–≥–ª—É—à–∫–∞                     ‚îÇ
‚îÇ                                      ‚Üì                                           ‚îÇ
‚îÇ                        WebSocket push (–±–µ–∑ AI!)                                  ‚îÇ
‚îÇ                                                                                  ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ù–ï –ü–û–î–ö–õ–Æ–ß–ï–ù–û ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
‚îÇ                                                                                  ‚îÇ
‚îÇ  ELO_Pipeline_Orchestrator [OFF]     ‚Üê –ù–∞—Å—Ç–æ—è—â–∏–π AI, –Ω–∏–∫—Ç–æ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç!         ‚îÇ
‚îÇ    ‚îú‚îÄ ELO_Task_Dispatcher [ON]                                                   ‚îÇ
‚îÇ    ‚îú‚îÄ ELO_Results_Aggregator [ON]                                                ‚îÇ
‚îÇ    ‚îî‚îÄ ELO_Funnel_Controller [ON]                                                 ‚îÇ
‚îÇ                                                                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## –ß–ê–°–¢–¨ 3: –ü–õ–ê–ù –†–ê–ë–û–¢

### üî¥ –§–∞–∑–∞ 1: –ü–æ—á–∏–Ω–∫–∞ –ø–∞–π–ø–ª–∞–π–Ω–∞ (–ö–†–ò–¢–ò–ß–ù–û)

#### 1.1 –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Å–≤—è–∑—å Resolver ‚Üí Pipeline

**–ü—Ä–æ–±–ª–µ–º–∞:** ELO_Resolver –≤—ã–∑—ã–≤–∞–µ—Ç webhook ‚Üí —Ç–µ—Å—Ç–æ–≤–∞—è –∑–∞–≥–ª—É—à–∫–∞

**–†–µ—à–µ–Ω–∏–µ:**
```
–ë–´–õ–û:
  ELO_Resolver ‚Üí HTTP Request ‚Üí /elo-core-ingest ‚Üí Test_Stub [OFF]

–°–¢–ê–ù–ï–¢:
  ELO_Resolver ‚Üí Execute Workflow ‚Üí ELO_Pipeline_Orchestrator
```

**–î–µ–π—Å—Ç–≤–∏—è:**
1. –í ELO_Resolver: –∑–∞–º–µ–Ω–∏—Ç—å "Forward to Core" (HTTP) –Ω–∞ Execute Workflow
2. –ü–µ—Ä–µ–¥–∞—Ç—å: tenant_id, client_id, dialog_id, message, operator_id, mode
3. –í–∫–ª—é—á–∏—Ç—å ELO_Resolver

#### 1.2 –î–æ–±–∞–≤–∏—Ç—å Mode Router –≤ Pipeline Orchestrator

**–î–µ–π—Å—Ç–≤–∏—è:**
1. –í –Ω–∞—á–∞–ª–µ –¥–æ–±–∞–≤–∏—Ç—å:
   - Get Assigned Operator (–µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω)
   - Get Mode (–∏–∑ operator/tenant settings)
2. –ü–æ—Å–ª–µ Context Building ‚Äî Switch –ø–æ mode:
   - `manual` ‚Üí Skip Generate ‚Üí Notify Operator
   - `semi_auto` ‚Üí Generate ‚Üí Notify with Draft
   - `auto` ‚Üí Generate ‚Üí Auto Send / Escalate

#### 1.3 –°–æ–∑–¥–∞—Ç—å ELO_Operator_Notify (–Ω–æ–≤—ã–π workflow)

```
Input: {
  operator_id, dialog_id,
  notification_type: "new_message" | "approval_needed" | "escalation",
  context: { device, symptom, stage },
  draft: string | null
}

Nodes:
1. Get Operator FCM tokens
2. Build Notification Payload
3. Send WebSocket ‚Üí api-android:8780
4. Send FCM Push
5. Log Event
```

#### 1.4 –£–¥–∞–ª–∏—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É –∏–∑ Pipeline

–£–±—Ä–∞—Ç—å Channel Router ‚Üí Send Telegram/WhatsApp –∏–∑ ELO_Pipeline_Orchestrator.
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ELO_Out_Router.

---

### üü° –§–∞–∑–∞ 2: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤

| –¢–µ—Å—Ç | –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º |
|------|---------------|
| MANUAL | –û–ø–µ—Ä–∞—Ç–æ—Ä –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ + –∫–æ–Ω—Ç–µ–∫—Å—Ç, –ë–ï–ó —á–µ—Ä–Ω–æ–≤–∏–∫–∞ |
| SEMI_AUTO | –û–ø–µ—Ä–∞—Ç–æ—Ä –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ + –∫–æ–Ω—Ç–µ–∫—Å—Ç + —á–µ—Ä–Ω–æ–≤–∏–∫ AI |
| AUTO | AI –æ—Ç–≤–µ—á–∞–µ—Ç —Å—Ä–∞–∑—É, —ç—Å–∫–∞–ª–∞—Ü–∏—è –ø—Ä–∏ —Å–ª–æ–∂–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö |

---

### üü¢ –§–∞–∑–∞ 3: Funnel Behavior Types

**–ò–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–ª–∞–Ω–∞ (adaptive-sprouting-stream.md):**

#### 3.1 –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î

```sql
ALTER TABLE elo_funnel_stages
ADD COLUMN behavior_type VARCHAR(30) DEFAULT 'COLLECT_REQUIRED',
ADD COLUMN behavior_config JSONB DEFAULT '{}',
ADD COLUMN on_complete_transitions JSONB DEFAULT '[]';

CREATE TABLE elo_stage_fields (...);
CREATE TABLE elo_dialog_field_tracking (...);
CREATE TABLE elo_stage_cta_actions (...);
```

#### 3.2 –¢–∏–ø—ã –ø–æ–≤–µ–¥–µ–Ω–∏—è

| –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----|----------|
| `COLLECT_REQUIRED` | –°–±–æ—Ä –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π |
| `COLLECT_OPTIONAL` | –°–±–æ—Ä –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π |
| `SEND_PROMO` | –û—Ç–ø—Ä–∞–≤–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ |
| `CTA_WAIT` | –û–∂–∏–¥–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è |

#### 3.3 Auto-Skip Logic

```javascript
// –ü–µ—Ä–µ–¥ –≤—Ö–æ–¥–æ–º –≤ —ç—Ç–∞–ø ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω—É–∂–µ–Ω –ª–∏ –æ–Ω
if ((current_mask & required_mask) === required_mask) {
  skip_to_next_stage();
}
```

---

## –ß–ê–°–¢–¨ 4: –ü–†–ò–û–†–ò–¢–ï–¢–´

### üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø—É—Ç—å (–±–µ–∑ —ç—Ç–æ–≥–æ –Ω–∏—á–µ–≥–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç):

1. **–ü–æ—á–∏–Ω–∏—Ç—å Resolver ‚Üí Pipeline** ‚Äî —Ä–∞–∑—Ä—ã–≤ –ø–∞–π–ø–ª–∞–π–Ω–∞
2. **–î–æ–±–∞–≤–∏—Ç—å Mode Router** ‚Äî –¥–ª—è 3 —Ä–µ–∂–∏–º–æ–≤ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
3. **–°–æ–∑–¥–∞—Ç—å ELO_Operator_Notify** ‚Äî —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
4. **–í–∫–ª—é—á–∏—Ç—å ELO_Resolver + ELO_Pipeline_Orchestrator**

### üü° –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:

5. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö 3 —Ä–µ–∂–∏–º–æ–≤
6. –ú–∏–≥—Ä–∞—Ü–∏—è Funnel Behavior Types
7. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ ELO_Funnel_Controller

### üü¢ –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:

8. Auto-Skip Logic
9. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
10. Silent notifications –¥–ª—è AUTO —Ä–µ–∂–∏–º–∞

---

## –ß–ê–°–¢–¨ 5: –§–ê–ô–õ–´

### –î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:

| –§–∞–π–ª | –î–µ–π—Å—Ç–≤–∏–µ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç |
|------|----------|-----------|
| `ELO_Resolver.json` | –ó–∞–º–µ–Ω–∏—Ç—å webhook –Ω–∞ Execute Workflow | üî¥ |
| `ELO_Pipeline_Orchestrator.json` | –î–æ–±–∞–≤–∏—Ç—å Mode Router | üî¥ |
| `NEW: ELO_Operator_Notify.json` | –°–æ–∑–¥–∞—Ç—å | üî¥ |
| `ELO_Funnel_Controller.json` | –î–æ–±–∞–≤–∏—Ç—å Behavior Router | üü° |
| `migrations/008_funnel_behavior.sql` | –°–æ–∑–¥–∞—Ç—å | üü° |

### –°–æ–∑–¥–∞–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:

| –§–∞–π–ª | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|
| `NEW/DOCS/WORKFLOWS_ANALYSIS.md` | –ê–Ω–∞–ª–∏–∑ –≤—Å–µ—Ö 57 workflows |
| `NEW/DOCS/OPERATOR_NOTIFICATION_ARCHITECTURE.md` | –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ 3 —Ä–µ–∂–∏–º–æ–≤ |
| `NEW/DOCS/DATABASE_ANALYSIS.md` | –ê–Ω–∞–ª–∏–∑ 56 —Ç–∞–±–ª–∏—Ü –ë–î |

---

## –ß–ê–°–¢–¨ 6: –°–õ–ï–î–£–Æ–©–ò–ô –®–ê–ì

**–ù–∞—á–∞—Ç—å —Å –§–∞–∑—ã 1.1:** –û—Ç–∫—Ä—ã—Ç—å ELO_Resolver.json –∏ –∑–∞–º–µ–Ω–∏—Ç—å HTTP Request –Ω–∞ Execute Workflow –¥–ª—è –≤—ã–∑–æ–≤–∞ ELO_Pipeline_Orchestrator.

---

*–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: 2026-01-03*
