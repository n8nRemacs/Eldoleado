{"data":[{"updatedAt":"2025-12-11T13:00:45.535Z","createdAt":"2025-12-10T09:59:48.480Z","id":"1TA6vErCOXG0eChF","name":"ELO_In_Phone","active":false,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"phone","responseMode":"lastNode","options":{}},"id":"d4ccfbc5-a544-4a48-a34a-5aa7e86727e0","name":"Phone Trigger","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[-864,-80],"webhookId":"phone-webhook"},{"parameters":{"jsCode":"const call = $input.first().json;\n\n// Нормализуем номер телефона\nlet phone = call.from || call.caller_id || call.phone;\nif (phone) {\n  phone = phone.replace(/\\D/g, '');\n  if (phone.length === 11 && phone.startsWith('8')) {\n    phone = '7' + phone.substring(1);\n  }\n  phone = '+' + phone;\n}\n\nconst hasVoice = true;\nconst recordingUrl = call.recording_url || call.record_url || null;\n\nreturn {\n  has_voice: hasVoice,\n  voice_url: recordingUrl,\n  raw_call: call,\n  phone: phone,\n  call_id: call.call_id || call.id || Date.now().toString(),\n  call_duration: call.duration || 0,\n  call_status: call.status || 'completed',\n  start_time: call.start_time || call.created_at || new Date().toISOString()\n};"},"id":"43b0edb5-7a0e-4889-8821-0c928a51bc0a","name":"Extract Phone Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[-640,-80]},{"parameters":{"url":"={{ $json.voice_url }}","options":{"response":{"response":{"responseFormat":"file"}}}},"id":"7aaaef68-15fb-445b-a5f6-567374b28ab3","name":"Download Recording","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-416,-80]},{"parameters":{"resource":"audio","operation":"transcribe","options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[-192,-80],"id":"736ca027-6099-4312-bedb-f22e18ffc05a","name":"Transcribe Recording","credentials":{"openAiApi":{"id":"ptoy1RvCOn39G0Af","name":"OpenAi account"}}},{"parameters":{"jsCode":"const data = $('Extract Phone Data').first().json;\nconst transcription = $input.first().json.text;\n\nreturn {\n  channel: 'phone',\n  external_user_id: data.phone?.replace(/\\+/g, ''),\n  external_chat_id: data.phone,\n  \n  text: transcription,\n  timestamp: data.start_time,\n  \n  client_phone: data.phone,\n  client_name: null,\n  client_email: null,\n  \n  media: {\n    has_voice: true,\n    voice_transcribed_text: transcription,\n    has_images: false,\n    images: [],\n    has_video: false,\n    videos: [],\n    has_document: false\n  },\n  \n  meta: {\n    external_message_id: data.call_id,\n    ad_channel: 'phone',\n    ad_id: null,\n    original_media_type: 'voice',\n    raw: data.raw_call,\n    call_duration: data.call_duration,\n    call_status: data.call_status,\n    recording_url: data.voice_url\n  },\n  \n  prefilled_data: {\n    model: null,\n    parts_owner: null\n  }\n};"},"id":"4c5aa6df-e33d-4397-9721-a6266d573c62","name":"Normalize Phone","type":"n8n-nodes-base.code","typeVersion":2,"position":[16,-80]},{"parameters":{"workflowId":"={{ $env.CLIENT_RESOLVER_WORKFLOW_ID }}","options":{}},"id":"50aeabce-e19e-43fd-a41e-d927c4540d1a","name":"Execute Client Resolver","type":"n8n-nodes-base.executeWorkflow","typeVersion":1,"position":[432,-80]},{"parameters":{"respondWith":"json","responseBody":"={{ { \\\"success\\\": true } }}","options":{}},"id":"3c2e9321-7fb3-49af-88f4-3779475e30ab","name":"Respond Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[656,-80]},{"parameters":{"workflowId":{"__rl":true,"value":"rRO6sxLqiCdgvLZz","mode":"list","cachedResultUrl":"/workflow/rRO6sxLqiCdgvLZz","cachedResultName":"ELO_Core_Tenant_Resolver"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[208,-80],"id":"7e8a7e18-53ed-424d-ad44-d4be5dd728d0","name":"Execute Tenant Resolver"}],"connections":{"Phone Trigger":{"main":[[{"node":"Extract Phone Data","type":"main","index":0}]]},"Extract Phone Data":{"main":[[{"node":"Download Recording","type":"main","index":0}]]},"Download Recording":{"main":[[{"node":"Transcribe Recording","type":"main","index":0}]]},"Transcribe Recording":{"main":[[{"node":"Normalize Phone","type":"main","index":0}]]},"Normalize Phone":{"main":[[{"node":"Execute Tenant Resolver","type":"main","index":0}]]},"Execute Client Resolver":{"main":[[{"node":"Respond Success","type":"main","index":0}]]},"Execute Tenant Resolver":{"main":[[{"node":"Execute Client Resolver","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"80f4be67-b03b-4929-920d-cb597392aa97","activeVersionId":null,"triggerCount":1,"shared":[{"updatedAt":"2025-12-10T09:59:48.485Z","createdAt":"2025-12-10T09:59:48.485Z","role":"workflow:owner","workflowId":"1TA6vErCOXG0eChF","projectId":"x7frUSUEowDAk8Dt"}],"activeVersion":null,"tags":[{"updatedAt":"2025-11-23T04:03:40.721Z","createdAt":"2025-11-23T04:03:40.721Z","id":"nLdF41tEx70V7m3A","name":"In"},{"updatedAt":"2025-12-09T18:50:08.518Z","createdAt":"2025-12-09T18:50:08.518Z","id":"tMSCjbvPU3xrNUqz","name":"ELO"}]},{"updatedAt":"2025-12-20T17:09:52.550Z","createdAt":"2025-12-18T10:30:02.005Z","id":"2EH6NEVKrvAuGSo6","name":"ELO_API_Android_Dialogs","active":true,"isArchived":false,"nodes":[{"parameters":{"path":"android/dialogs","responseMode":"responseNode","options":{"allowedOrigins":"*"}},"id":"fc7c818a-9f7e-4e1e-a11e-99ddf452949a","name":"Webhook - Get Dialogs","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-928,32],"webhookId":"android-dialogs"},{"parameters":{"operation":"executeQuery","query":"SELECT od.operator_id, od.tenant_id, o.name as operator_name\nFROM elo_t_operator_devices od\nJOIN elo_t_operators o ON od.operator_id = o.id\nWHERE od.session_token = '{{ $json.query.session_token }}'\n  AND od.is_active = true\nLIMIT 1;","options":{}},"id":"8128e0db-4778-4303-9b19-d34aea21dfa3","name":"Postgres - Validate Session","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-704,32],"alwaysOutputData":true,"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"session-valid","leftValue":"={{ $json.operator_id }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"id":"d88f7ede-5240-4938-899c-2486310179a9","name":"IF - Session Valid","type":"n8n-nodes-base.if","typeVersion":2,"position":[-480,32]},{"parameters":{"operation":"executeQuery","query":" SELECT\n    d.id,\n    c.name as client_name,\n    c.phone as client_phone,\n    LOWER(ch.name) as channel,\n    d.external_chat_id as chat_id,\n    COALESCE(m.content, '') as last_message_text,\n    EXTRACT(EPOCH FROM d.last_message_at)::bigint * 1000 as last_message_time,\n    false as last_message_is_voice,\n    0 as unread_count\n  FROM elo_t_dialogs d\n  JOIN elo_t_clients c ON d.client_id = c.id\n  JOIN elo_channels ch ON d.channel_id = ch.id\n  LEFT JOIN LATERAL (\n    SELECT content FROM elo_t_messages\n    WHERE dialog_id = d.id\n    ORDER BY timestamp DESC LIMIT 1\n  ) m ON true\n  WHERE d.assigned_operator_id = '{{ $('Postgres - Validate Session').item.json.operator_id }}'::uuid\n    AND d.tenant_id = '{{ $('Postgres - Validate Session').item.json.tenant_id }}'::uuid\n  ORDER BY d.last_message_at DESC NULLS LAST;","options":{}},"id":"98f2ee89-b0da-4cbd-9303-794ae299949d","name":"Postgres - Get Dialogs","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-256,-64],"alwaysOutputData":true,"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"jsCode":"const dialogs = $input.all().map(item => {\n  const d = item.json;\n  return {\n    id: d.id,\n    client_name: d.client_name || 'Unknown',\n    client_phone: d.client_phone || '',\n    channel: d.channel,\n    chat_id: d.chat_id || '',\n    last_message_text: d.last_message_text || '',\n    last_message_time: d.last_message_time || 0,\n    last_message_is_voice: d.last_message_is_voice || false,\n    unread_count: d.unread_count || 0\n  };\n});\n\nreturn { dialogs };"},"id":"ac5f3cff-a754-47cd-b16f-8be82d190284","name":"Format Dialogs Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[-32,-64]},{"parameters":{"respondWith":"json","responseBody":"={\n  \"success\": true,\n  \"dialogs\": {{ JSON.stringify($json.dialogs) }}\n}","options":{"responseCode":200,"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"},{"name":"Access-Control-Allow-Origin","value":"*"}]}}},"id":"e0eb2a8c-b9db-4523-8d1e-15abae82b97f","name":"Response - Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[192,-64]},{"parameters":{"respondWith":"json","responseBody":"={\n  \"success\": false,\n  \"error\": \"invalid_session\"\n}","options":{"responseCode":401,"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"},{"name":"Access-Control-Allow-Origin","value":"*"}]}}},"id":"6d7bda2e-57ff-4f78-b3a9-3523c12f9236","name":"Response - Unauthorized","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-256,128]}],"connections":{"Webhook - Get Dialogs":{"main":[[{"node":"Postgres - Validate Session","type":"main","index":0}]]},"Postgres - Validate Session":{"main":[[{"node":"IF - Session Valid","type":"main","index":0}]]},"IF - Session Valid":{"main":[[{"node":"Postgres - Get Dialogs","type":"main","index":0}],[{"node":"Response - Unauthorized","type":"main","index":0}]]},"Postgres - Get Dialogs":{"main":[[{"node":"Format Dialogs Response","type":"main","index":0}]]},"Format Dialogs Response":{"main":[[{"node":"Response - Success","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"69e0ea36-f5d9-4748-9246-84de6b5ce386","activeVersionId":"69e0ea36-f5d9-4748-9246-84de6b5ce386","triggerCount":1,"shared":[{"updatedAt":"2025-12-18T10:30:02.012Z","createdAt":"2025-12-18T10:30:02.012Z","role":"workflow:owner","workflowId":"2EH6NEVKrvAuGSo6","projectId":"x7frUSUEowDAk8Dt"}],"activeVersion":{"updatedAt":"2025-12-20T17:09:52.551Z","createdAt":"2025-12-20T17:09:52.551Z","versionId":"69e0ea36-f5d9-4748-9246-84de6b5ce386","workflowId":"2EH6NEVKrvAuGSo6","nodes":[{"parameters":{"path":"android/dialogs","responseMode":"responseNode","options":{"allowedOrigins":"*"}},"id":"fc7c818a-9f7e-4e1e-a11e-99ddf452949a","name":"Webhook - Get Dialogs","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-928,32],"webhookId":"android-dialogs"},{"parameters":{"operation":"executeQuery","query":"SELECT od.operator_id, od.tenant_id, o.name as operator_name\nFROM elo_t_operator_devices od\nJOIN elo_t_operators o ON od.operator_id = o.id\nWHERE od.session_token = '{{ $json.query.session_token }}'\n  AND od.is_active = true\nLIMIT 1;","options":{}},"id":"8128e0db-4778-4303-9b19-d34aea21dfa3","name":"Postgres - Validate Session","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-704,32],"alwaysOutputData":true,"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"session-valid","leftValue":"={{ $json.operator_id }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"id":"d88f7ede-5240-4938-899c-2486310179a9","name":"IF - Session Valid","type":"n8n-nodes-base.if","typeVersion":2,"position":[-480,32]},{"parameters":{"operation":"executeQuery","query":" SELECT\n    d.id,\n    c.name as client_name,\n    c.phone as client_phone,\n    LOWER(ch.name) as channel,\n    d.external_chat_id as chat_id,\n    COALESCE(m.content, '') as last_message_text,\n    EXTRACT(EPOCH FROM d.last_message_at)::bigint * 1000 as last_message_time,\n    false as last_message_is_voice,\n    0 as unread_count\n  FROM elo_t_dialogs d\n  JOIN elo_t_clients c ON d.client_id = c.id\n  JOIN elo_channels ch ON d.channel_id = ch.id\n  LEFT JOIN LATERAL (\n    SELECT content FROM elo_t_messages\n    WHERE dialog_id = d.id\n    ORDER BY timestamp DESC LIMIT 1\n  ) m ON true\n  WHERE d.assigned_operator_id = '{{ $('Postgres - Validate Session').item.json.operator_id }}'::uuid\n    AND d.tenant_id = '{{ $('Postgres - Validate Session').item.json.tenant_id }}'::uuid\n  ORDER BY d.last_message_at DESC NULLS LAST;","options":{}},"id":"98f2ee89-b0da-4cbd-9303-794ae299949d","name":"Postgres - Get Dialogs","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-256,-64],"alwaysOutputData":true,"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"jsCode":"const dialogs = $input.all().map(item => {\n  const d = item.json;\n  return {\n    id: d.id,\n    client_name: d.client_name || 'Unknown',\n    client_phone: d.client_phone || '',\n    channel: d.channel,\n    chat_id: d.chat_id || '',\n    last_message_text: d.last_message_text || '',\n    last_message_time: d.last_message_time || 0,\n    last_message_is_voice: d.last_message_is_voice || false,\n    unread_count: d.unread_count || 0\n  };\n});\n\nreturn { dialogs };"},"id":"ac5f3cff-a754-47cd-b16f-8be82d190284","name":"Format Dialogs Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[-32,-64]},{"parameters":{"respondWith":"json","responseBody":"={\n  \"success\": true,\n  \"dialogs\": {{ JSON.stringify($json.dialogs) }}\n}","options":{"responseCode":200,"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"},{"name":"Access-Control-Allow-Origin","value":"*"}]}}},"id":"e0eb2a8c-b9db-4523-8d1e-15abae82b97f","name":"Response - Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[192,-64]},{"parameters":{"respondWith":"json","responseBody":"={\n  \"success\": false,\n  \"error\": \"invalid_session\"\n}","options":{"responseCode":401,"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"},{"name":"Access-Control-Allow-Origin","value":"*"}]}}},"id":"6d7bda2e-57ff-4f78-b3a9-3523c12f9236","name":"Response - Unauthorized","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-256,128]}],"connections":{"Webhook - Get Dialogs":{"main":[[{"node":"Postgres - Validate Session","type":"main","index":0}]]},"Postgres - Validate Session":{"main":[[{"node":"IF - Session Valid","type":"main","index":0}]]},"IF - Session Valid":{"main":[[{"node":"Postgres - Get Dialogs","type":"main","index":0}],[{"node":"Response - Unauthorized","type":"main","index":0}]]},"Postgres - Get Dialogs":{"main":[[{"node":"Format Dialogs Response","type":"main","index":0}]]},"Format Dialogs Response":{"main":[[{"node":"Response - Success","type":"main","index":0}]]}},"authors":"Dmitriy Remacs","name":null,"description":null},"tags":[{"updatedAt":"2025-11-23T03:58:34.844Z","createdAt":"2025-11-23T03:58:34.844Z","id":"0yzk30hhaSzkl8bF","name":"API"},{"updatedAt":"2025-12-09T18:50:08.518Z","createdAt":"2025-12-09T18:50:08.518Z","id":"tMSCjbvPU3xrNUqz","name":"ELO"}]},{"updatedAt":"2025-12-12T08:43:02.088Z","createdAt":"2025-12-11T17:11:42.826Z","id":"2ZzFlQ5LOZzJ5bGo","name":"ELO_Graph_Query","active":false,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"elo-graph-query","responseMode":"responseNode","options":{}},"id":"45142c7b-0be0-492c-b982-261d71c300ec","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-656,-64],"webhookId":"elo-graph-query-001"},{"parameters":{"jsCode":"// Validate Input - v2 compatible (no process.env)\nconst input = $input.first().json;\n\n// Required field check\nif (!input.query_code) {\n  throw new Error('Missing required field: query_code');\n}\n\n// Default params to empty object\nconst params = input.params || {};\n\n// Generate trace_id if not provided\nconst trace_id = input.trace_id || `trace_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n\nreturn {\n  query_code: input.query_code,\n  params: params,\n  trace_id: trace_id,\n  received_at: new Date().toISOString()\n};"},"id":"3c9fa748-1c59-4f31-b3ca-37a1135d2893","name":"Validate Input","type":"n8n-nodes-base.code","typeVersion":2,"position":[-432,-64]},{"parameters":{"method":"POST","url":"http://45.144.177.128:8773/query","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ query_code: $json.query_code, params: $json.params }) }}","options":{"timeout":30000}},"id":"c9498849-aacd-4617-875b-1e9e1160270a","name":"Graph Tool Request","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-208,-64]},{"parameters":{"jsCode":"// Add trace_id to response\nconst validateNode = $('Validate Input').first().json;\nconst response = $input.first().json;\n\nreturn {\n  ...response,\n  trace_id: validateNode.trace_id\n};"},"id":"d96cdd54-7ce0-40f3-9abd-e12ca0094ffb","name":"Add Trace ID","type":"n8n-nodes-base.code","typeVersion":2,"position":[16,-64]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"c5dbda6e-d5e0-4b9c-b1e2-0d757b8426f7","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[224,-64]}],"connections":{"Webhook":{"main":[[{"node":"Validate Input","type":"main","index":0}]]},"Validate Input":{"main":[[{"node":"Graph Tool Request","type":"main","index":0}]]},"Graph Tool Request":{"main":[[{"node":"Add Trace ID","type":"main","index":0}]]},"Add Trace ID":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"c1ebcd9b-d1f2-415e-b22c-001105adad6a","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2025-12-11T17:11:42.834Z","createdAt":"2025-12-11T17:11:42.834Z","role":"workflow:owner","workflowId":"2ZzFlQ5LOZzJ5bGo","projectId":"x7frUSUEowDAk8Dt"}],"activeVersion":null,"tags":[{"updatedAt":"2025-11-23T04:02:03.765Z","createdAt":"2025-11-23T04:02:03.765Z","id":"JkzPlhYcdcsJtFGG","name":"Tool"},{"updatedAt":"2025-12-09T18:50:08.518Z","createdAt":"2025-12-09T18:50:08.518Z","id":"tMSCjbvPU3xrNUqz","name":"ELO"}]},{"updatedAt":"2025-12-20T19:55:39.547Z","createdAt":"2025-12-18T11:15:39.467Z","id":"2uj0zqoqbSRd0iue","name":"ELO_API_Android_Messages","active":true,"isArchived":false,"nodes":[{"parameters":{"path":"android/messages","responseMode":"responseNode","options":{"allowedOrigins":"*"}},"id":"8e21cd92-3e8a-45f9-b24e-630d65ec35d8","name":"Webhook - Get Messages","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1008,16],"webhookId":"android-messages"},{"parameters":{"operation":"executeQuery","query":"SELECT od.operator_id, od.tenant_id\nFROM elo_t_operator_devices od\nWHERE od.session_token = '{{ $json.query.session_token }}'\n  AND od.is_active = true\nLIMIT 1;","options":{}},"id":"4349fa27-5a40-4b86-9a29-1c70013713a4","name":"Postgres - Validate Session","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-784,16],"alwaysOutputData":true,"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"session-valid","leftValue":"={{ $json.operator_id }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"id":"1780273f-5798-4899-bd0b-2aa815f691ee","name":"IF - Session Valid","type":"n8n-nodes-base.if","typeVersion":2,"position":[-560,16]},{"parameters":{"operation":"executeQuery","query":"SELECT\n    d.id as dialog_id,\n    c.name as client_name,\n    c.phone as client_phone,\n    LOWER(ch.name) as channel,\n    d.external_chat_id as chat_id\n  FROM elo_t_dialogs d\n  JOIN elo_t_clients c ON d.client_id = c.id\n  JOIN elo_channels ch ON d.channel_id = ch.id\n  WHERE d.id = '{{ $('Webhook - Get Messages').item.json.query.dialog_id }}'::uuid\n    AND d.tenant_id = '{{ $('Postgres - Validate Session').item.json.tenant_id }}'::uuid\n  LIMIT 1;","options":{}},"id":"c45ab15b-fcae-4d6e-8a65-2ee6ad35842c","name":"Postgres - Get Dialog Info","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-336,-80],"alwaysOutputData":true,"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"SELECT\n    m.id,\n    m.content as text,\n    m.direction_id,\n    CASE WHEN m.direction_id = 1 THEN 'in' ELSE 'out' END as direction,\n    m.actor_type as sender_type,\n    CASE\n      WHEN m.actor_type = 'client' THEN (SELECT name FROM elo_t_clients WHERE id = m.client_id)\n      WHEN m.actor_type = 'operator' THEN (SELECT name FROM elo_t_operators WHERE id = m.actor_id)\n      WHEN m.actor_type = 'ai' THEN 'AI'\n      ELSE m.actor_type\n    END as sender_name,\n    m.message_type_id,\n    m.media,\n    EXTRACT(EPOCH FROM m.timestamp)::bigint * 1000 as timestamp\n  FROM elo_t_messages m\n  WHERE m.dialog_id = '{{ $('Webhook - Get Messages').item.json.query.dialog_id }}'::uuid\n  ORDER BY m.timestamp ASC\n  LIMIT 100;","options":{}},"id":"c6e04cc6-44fe-47f7-9ab0-0756eb571567","name":"Postgres - Get Messages","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-112,-80],"alwaysOutputData":true,"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"jsCode":"const dialogInfo = $('Postgres - Get Dialog Info').first().json;\nconst messagesRaw = $('Postgres - Get Messages').all();\n\nconst messages = messagesRaw.map(item => {\n  const m = item.json;\n  return {\n    id: m.id,\n    text: m.text || '',\n    direction: m.direction || 'in',\n    sender_type: m.sender_type || 'client',\n    sender_name: m.sender_name || '',\n    timestamp: m.timestamp || 0,\n    media: m.media || null\n  };\n});\n\nreturn {\n  dialog: {\n    id: dialogInfo.dialog_id,\n    client_name: dialogInfo.client_name,\n    client_phone: dialogInfo.client_phone,\n    channel: dialogInfo.channel,\n    chat_id: dialogInfo.chat_id\n  },\n  messages: messages\n};"},"id":"78768cc5-1274-4efd-8da0-2d54cb2fd38e","name":"Format Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[112,-80]},{"parameters":{"respondWith":"json","responseBody":"={\n  \"success\": true,\n  \"dialog\": {{ JSON.stringify($json.dialog) }},\n  \"messages\": {{ JSON.stringify($json.messages) }}\n}","options":{"responseCode":200,"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"},{"name":"Access-Control-Allow-Origin","value":"*"}]}}},"id":"e4ceb354-3e46-4d88-925c-fd27436223e0","name":"Response - Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[336,-80]},{"parameters":{"respondWith":"json","responseBody":"={\n  \"success\": false,\n  \"error\": \"invalid_session\"\n}","options":{"responseCode":401,"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"},{"name":"Access-Control-Allow-Origin","value":"*"}]}}},"id":"cb096d82-0812-461e-b279-695b57bf6e39","name":"Response - Unauthorized","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-336,112]}],"connections":{"Webhook - Get Messages":{"main":[[{"node":"Postgres - Validate Session","type":"main","index":0}]]},"Postgres - Validate Session":{"main":[[{"node":"IF - Session Valid","type":"main","index":0}]]},"IF - Session Valid":{"main":[[{"node":"Postgres - Get Dialog Info","type":"main","index":0}],[{"node":"Response - Unauthorized","type":"main","index":0}]]},"Postgres - Get Dialog Info":{"main":[[{"node":"Postgres - Get Messages","type":"main","index":0}]]},"Postgres - Get Messages":{"main":[[{"node":"Format Response","type":"main","index":0}]]},"Format Response":{"main":[[{"node":"Response - Success","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{"Webhook - Get Messages":[{"json":{"headers":{"host":"n8n.n8nsrv.ru","user-agent":"curl/8.17.0","accept":"*/*","via":"1.1 Caddy","x-forwarded-for":"176.100.126.94","x-forwarded-host":"n8n.n8nsrv.ru","x-forwarded-proto":"https","accept-encoding":"gzip"},"params":{},"query":{"dialog_id":"cff56064-1fc3-4152-8e64-6e0266a87bf6","session_token":"85bc5364-7765-4562-be9e-02d899bb575e"},"body":{},"webhookUrl":"https://n8n.n8nsrv.ru/webhook/android/messages","executionMode":"production"},"pairedItem":{"item":0}}]},"versionId":"68f53671-3c8c-473e-9ef7-673de86c9305","activeVersionId":"68f53671-3c8c-473e-9ef7-673de86c9305","triggerCount":1,"shared":[{"updatedAt":"2025-12-18T11:15:39.475Z","createdAt":"2025-12-18T11:15:39.475Z","role":"workflow:owner","workflowId":"2uj0zqoqbSRd0iue","projectId":"x7frUSUEowDAk8Dt"}],"activeVersion":{"updatedAt":"2025-12-20T19:55:39.549Z","createdAt":"2025-12-20T19:55:39.549Z","versionId":"68f53671-3c8c-473e-9ef7-673de86c9305","workflowId":"2uj0zqoqbSRd0iue","nodes":[{"parameters":{"path":"android/messages","responseMode":"responseNode","options":{"allowedOrigins":"*"}},"id":"8e21cd92-3e8a-45f9-b24e-630d65ec35d8","name":"Webhook - Get Messages","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1008,16],"webhookId":"android-messages"},{"parameters":{"operation":"executeQuery","query":"SELECT od.operator_id, od.tenant_id\nFROM elo_t_operator_devices od\nWHERE od.session_token = '{{ $json.query.session_token }}'\n  AND od.is_active = true\nLIMIT 1;","options":{}},"id":"4349fa27-5a40-4b86-9a29-1c70013713a4","name":"Postgres - Validate Session","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-784,16],"alwaysOutputData":true,"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"session-valid","leftValue":"={{ $json.operator_id }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"id":"1780273f-5798-4899-bd0b-2aa815f691ee","name":"IF - Session Valid","type":"n8n-nodes-base.if","typeVersion":2,"position":[-560,16]},{"parameters":{"operation":"executeQuery","query":"SELECT\n    d.id as dialog_id,\n    c.name as client_name,\n    c.phone as client_phone,\n    LOWER(ch.name) as channel,\n    d.external_chat_id as chat_id\n  FROM elo_t_dialogs d\n  JOIN elo_t_clients c ON d.client_id = c.id\n  JOIN elo_channels ch ON d.channel_id = ch.id\n  WHERE d.id = '{{ $('Webhook - Get Messages').item.json.query.dialog_id }}'::uuid\n    AND d.tenant_id = '{{ $('Postgres - Validate Session').item.json.tenant_id }}'::uuid\n  LIMIT 1;","options":{}},"id":"c45ab15b-fcae-4d6e-8a65-2ee6ad35842c","name":"Postgres - Get Dialog Info","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-336,-80],"alwaysOutputData":true,"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"SELECT\n    m.id,\n    m.content as text,\n    m.direction_id,\n    CASE WHEN m.direction_id = 1 THEN 'in' ELSE 'out' END as direction,\n    m.actor_type as sender_type,\n    CASE\n      WHEN m.actor_type = 'client' THEN (SELECT name FROM elo_t_clients WHERE id = m.client_id)\n      WHEN m.actor_type = 'operator' THEN (SELECT name FROM elo_t_operators WHERE id = m.actor_id)\n      WHEN m.actor_type = 'ai' THEN 'AI'\n      ELSE m.actor_type\n    END as sender_name,\n    m.message_type_id,\n    m.media,\n    EXTRACT(EPOCH FROM m.timestamp)::bigint * 1000 as timestamp\n  FROM elo_t_messages m\n  WHERE m.dialog_id = '{{ $('Webhook - Get Messages').item.json.query.dialog_id }}'::uuid\n  ORDER BY m.timestamp ASC\n  LIMIT 100;","options":{}},"id":"c6e04cc6-44fe-47f7-9ab0-0756eb571567","name":"Postgres - Get Messages","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-112,-80],"alwaysOutputData":true,"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"jsCode":"const dialogInfo = $('Postgres - Get Dialog Info').first().json;\nconst messagesRaw = $('Postgres - Get Messages').all();\n\nconst messages = messagesRaw.map(item => {\n  const m = item.json;\n  return {\n    id: m.id,\n    text: m.text || '',\n    direction: m.direction || 'in',\n    sender_type: m.sender_type || 'client',\n    sender_name: m.sender_name || '',\n    timestamp: m.timestamp || 0,\n    media: m.media || null\n  };\n});\n\nreturn {\n  dialog: {\n    id: dialogInfo.dialog_id,\n    client_name: dialogInfo.client_name,\n    client_phone: dialogInfo.client_phone,\n    channel: dialogInfo.channel,\n    chat_id: dialogInfo.chat_id\n  },\n  messages: messages\n};"},"id":"78768cc5-1274-4efd-8da0-2d54cb2fd38e","name":"Format Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[112,-80]},{"parameters":{"respondWith":"json","responseBody":"={\n  \"success\": true,\n  \"dialog\": {{ JSON.stringify($json.dialog) }},\n  \"messages\": {{ JSON.stringify($json.messages) }}\n}","options":{"responseCode":200,"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"},{"name":"Access-Control-Allow-Origin","value":"*"}]}}},"id":"e4ceb354-3e46-4d88-925c-fd27436223e0","name":"Response - Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[336,-80]},{"parameters":{"respondWith":"json","responseBody":"={\n  \"success\": false,\n  \"error\": \"invalid_session\"\n}","options":{"responseCode":401,"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"},{"name":"Access-Control-Allow-Origin","value":"*"}]}}},"id":"cb096d82-0812-461e-b279-695b57bf6e39","name":"Response - Unauthorized","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-336,112]}],"connections":{"Webhook - Get Messages":{"main":[[{"node":"Postgres - Validate Session","type":"main","index":0}]]},"Postgres - Validate Session":{"main":[[{"node":"IF - Session Valid","type":"main","index":0}]]},"IF - Session Valid":{"main":[[{"node":"Postgres - Get Dialog Info","type":"main","index":0}],[{"node":"Response - Unauthorized","type":"main","index":0}]]},"Postgres - Get Dialog Info":{"main":[[{"node":"Postgres - Get Messages","type":"main","index":0}]]},"Postgres - Get Messages":{"main":[[{"node":"Format Response","type":"main","index":0}]]},"Format Response":{"main":[[{"node":"Response - Success","type":"main","index":0}]]}},"authors":"Dmitriy Remacs","name":null,"description":null},"tags":[{"updatedAt":"2025-11-23T03:58:34.844Z","createdAt":"2025-11-23T03:58:34.844Z","id":"0yzk30hhaSzkl8bF","name":"API"},{"updatedAt":"2025-12-09T18:50:08.518Z","createdAt":"2025-12-09T18:50:08.518Z","id":"tMSCjbvPU3xrNUqz","name":"ELO"}]},{"updatedAt":"2025-12-15T17:26:47.977Z","createdAt":"2025-12-15T17:26:42.749Z","id":"2xOOPR7TeNxw9O2D","name":"ELO_Core_Graph_Writer","active":false,"isArchived":false,"nodes":[{"parameters":{"path":"elo-core-graph-writer","responseMode":"responseNode","options":{}},"id":"3028f81a-3625-4fcc-bdaf-a4390adf03c5","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1296,32],"webhookId":"elo-core-graph-writer"},{"parameters":{"jsCode":"const input = $input.first().json;\nconst context = input.context;\nconst writeMode = input.write_mode || 'incremental';\n\n// Validate required fields\nif (!context) {\n  throw new Error('Missing required field: context');\n}\n\nconst clientId = context.client_id;\nconst dialogId = context.dialog_id;\nconst tenantId = context.tenant_id;\n\nif (!clientId) {\n  throw new Error('Missing required field: context.client_id');\n}\n\n// Prepare data for Neo4j writes\nconst writes = {\n  client: {\n    id: clientId,\n    name: context.client?.name || null,\n    phone: context.client?.phone || null,\n    tenant_id: tenantId\n  },\n  devices: [],\n  problems: [],\n  touchpoint: {\n    dialog_id: dialogId,\n    timestamp: new Date().toISOString(),\n    stage: context.current_stage,\n    channel_id: context.channel_id\n  }\n};\n\n// Extract devices and problems from lines\nif (context.lines && context.lines.length > 0) {\n  for (const line of context.lines) {\n    const device = line.slots?.device;\n    if (device) {\n      writes.devices.push({\n        line_id: line.id,\n        brand: device.brand,\n        model: device.model,\n        owner_label: device.owner_label || 'main'\n      });\n    }\n    \n    // Problem from symptom/diagnosis\n    const symptom = line.slots?.symptom;\n    const diagnosis = line.slots?.diagnosis;\n    const repair = line.slots?.repair_type;\n    \n    if (symptom || diagnosis) {\n      writes.problems.push({\n        line_id: line.id,\n        symptom_text: symptom?.text,\n        symptom_type_code: line.slots?.symptom_type?.code,\n        diagnosis_code: diagnosis?.code,\n        repair_code: repair?.code,\n        price: line.slots?.price?.amount,\n        status: line.status === 'done' ? 'quoted' : 'collecting_info'\n      });\n    }\n  }\n}\n\nreturn {\n  context: context,\n  writes: writes,\n  write_mode: writeMode,\n  trace_id: context.trace_id\n};"},"id":"de8066fe-9f03-4c28-b57c-a33b172e4889","name":"Prepare Writes","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1072,32]},{"parameters":{"method":"POST","url":"http://45.144.177.128:7474/db/neo4j/tx/commit","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({\n  statements: [{\n    statement: `\n      MERGE (c:Client {id: $clientId})\n      ON CREATE SET \n        c.created_at = datetime(),\n        c.tenant_id = $tenantId\n      ON MATCH SET\n        c.updated_at = datetime()\n      SET\n        c.name = COALESCE($clientName, c.name),\n        c.phone = COALESCE($clientPhone, c.phone)\n      RETURN c.id as client_id, c.name as client_name\n    `,\n    parameters: {\n      clientId: $json.writes.client.id,\n      clientName: $json.writes.client.name,\n      clientPhone: $json.writes.client.phone,\n      tenantId: $json.writes.client.tenant_id\n    }\n  }]\n}) }}","options":{"allowUnauthorizedCerts":true,"timeout":30000}},"id":"96f8122a-5054-42fe-a6dc-6460aa3928c2","name":"Write Client","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-848,32],"credentials":{"httpBasicAuth":{"id":"bkJBnz7p38fXY4AN","name":"Neo4j"}}},{"parameters":{"jsCode":"const prepareData = $('Prepare Writes').first().json;\nconst devices = prepareData.writes.devices;\n\nif (!devices || devices.length === 0) {\n  return { skip: true, devices_written: 0 };\n}\n\n// Build batch MERGE statements for devices\nconst statements = devices.map((device, idx) => ({\n  statement: `\n    MATCH (c:Client {id: $clientId})\n    MERGE (d:Device {\n      client_id: $clientId,\n      brand: $brand,\n      model: $model,\n      owner_label: $ownerLabel\n    })\n    ON CREATE SET\n      d.id = randomUUID(),\n      d.created_at = datetime()\n    ON MATCH SET\n      d.updated_at = datetime()\n    MERGE (c)-[:OWNS]->(d)\n    RETURN d.id as device_id, d.brand as brand, d.model as model\n  `,\n  parameters: {\n    clientId: prepareData.writes.client.id,\n    brand: device.brand,\n    model: device.model,\n    ownerLabel: device.owner_label || 'main'\n  }\n}));\n\nreturn {\n  skip: false,\n  statements: statements,\n  client_id: prepareData.writes.client.id\n};"},"id":"96277db3-d020-43cf-bbcb-f9d69427ecfa","name":"Prepare Devices","type":"n8n-nodes-base.code","typeVersion":2,"position":[-640,32]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"check-skip","leftValue":"={{ $json.skip }}","rightValue":true,"operator":{"type":"boolean","operation":"notEquals"}}],"combinator":"and"},"options":{}},"id":"6ab25329-72ea-4774-8345-d6bb1f0f8d13","name":"Has Devices?","type":"n8n-nodes-base.if","typeVersion":2,"position":[-416,32]},{"parameters":{"method":"POST","url":"http://45.144.177.128:7474/db/neo4j/tx/commit","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ statements: $json.statements }) }}","options":{"allowUnauthorizedCerts":true,"timeout":30000}},"id":"dee889e8-c67e-4926-9dca-44ef3cce6b88","name":"Write Devices","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-192,-80],"credentials":{"httpBasicAuth":{"id":"bkJBnz7p38fXY4AN","name":"Neo4j"}}},{"parameters":{"jsCode":"const prepareData = $('Prepare Writes').first().json;\nconst problems = prepareData.writes.problems;\nconst devices = prepareData.writes.devices;\n\nif (!problems || problems.length === 0) {\n  return { skip: true, problems_written: 0 };\n}\n\n// Build batch statements for problems\nconst statements = problems.map((problem, idx) => {\n  // Find corresponding device\n  const device = devices.find(d => d.line_id === problem.line_id);\n  \n  return {\n    statement: `\n      MATCH (c:Client {id: $clientId})-[:OWNS]->(d:Device)\n      WHERE d.brand = $brand AND d.model = $model\n      MERGE (p:Problem {\n        device_id: d.id,\n        symptom_text: $symptomText\n      })\n      ON CREATE SET\n        p.id = randomUUID(),\n        p.created_at = datetime(),\n        p.status = $status\n      ON MATCH SET\n        p.updated_at = datetime()\n      SET\n        p.symptom_type_code = $symptomTypeCode,\n        p.diagnosis_code = $diagnosisCode,\n        p.repair_code = $repairCode,\n        p.price = $price,\n        p.status = $status\n      MERGE (d)-[:HAS_PROBLEM]->(p)\n      WITH p\n      OPTIONAL MATCH (pt:ProblemType {code: $symptomTypeCode})\n      FOREACH (_ IN CASE WHEN pt IS NOT NULL THEN [1] ELSE [] END |\n        MERGE (p)-[:OF_TYPE]->(pt)\n      )\n      RETURN p.id as problem_id, p.status as status\n    `,\n    parameters: {\n      clientId: prepareData.writes.client.id,\n      brand: device?.brand || 'Unknown',\n      model: device?.model || 'Unknown',\n      symptomText: problem.symptom_text || 'Unknown issue',\n      symptomTypeCode: problem.symptom_type_code,\n      diagnosisCode: problem.diagnosis_code,\n      repairCode: problem.repair_code,\n      price: problem.price,\n      status: problem.status\n    }\n  };\n});\n\nreturn {\n  skip: false,\n  statements: statements\n};"},"id":"0604265e-60b6-4167-abf2-e8cdeeeaa3c8","name":"Prepare Problems","type":"n8n-nodes-base.code","typeVersion":2,"position":[32,32]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"check-skip-problems","leftValue":"={{ $json.skip }}","rightValue":true,"operator":{"type":"boolean","operation":"notEquals"}}],"combinator":"and"},"options":{}},"id":"be49f0f5-325d-4ab5-9972-9c12a8d1c4b2","name":"Has Problems?","type":"n8n-nodes-base.if","typeVersion":2,"position":[256,32]},{"parameters":{"method":"POST","url":"http://45.144.177.128:7474/db/neo4j/tx/commit","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ statements: $json.statements }) }}","options":{"allowUnauthorizedCerts":true,"timeout":30000}},"id":"cb7fe94f-8191-4d14-a0a2-226bf26211ec","name":"Write Problems","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[480,-80],"credentials":{"httpBasicAuth":{"id":"bkJBnz7p38fXY4AN","name":"Neo4j"}}},{"parameters":{"jsCode":"const prepareData = $('Prepare Writes').first().json;\nconst touchpoint = prepareData.writes.touchpoint;\nconst clientId = prepareData.writes.client.id;\nconst devices = prepareData.writes.devices;\n\n// Create touchpoint for this interaction\nconst statements = [{\n  statement: `\n    MATCH (c:Client {id: $clientId})\n    CREATE (t:Touchpoint {\n      id: randomUUID(),\n      dialog_id: $dialogId,\n      timestamp: datetime($timestamp),\n      stage: $stage,\n      channel_id: $channelId\n    })\n    MERGE (c)-[:HAD_TOUCHPOINT]->(t)\n    WITH t\n    UNWIND $deviceBrands as deviceBrand\n    OPTIONAL MATCH (c)-[:OWNS]->(d:Device {brand: deviceBrand.brand, model: deviceBrand.model})\n    FOREACH (_ IN CASE WHEN d IS NOT NULL THEN [1] ELSE [] END |\n      MERGE (t)-[:ABOUT_DEVICE]->(d)\n    )\n    RETURN t.id as touchpoint_id\n  `,\n  parameters: {\n    clientId: clientId,\n    dialogId: touchpoint.dialog_id,\n    timestamp: touchpoint.timestamp,\n    stage: touchpoint.stage,\n    channelId: touchpoint.channel_id,\n    deviceBrands: devices.map(d => ({ brand: d.brand, model: d.model }))\n  }\n}];\n\nreturn { statements: statements };"},"id":"de0b43f5-27bc-49dd-b720-80300e60d6bc","name":"Prepare Touchpoint","type":"n8n-nodes-base.code","typeVersion":2,"position":[688,32]},{"parameters":{"method":"POST","url":"http://45.144.177.128:7474/db/neo4j/tx/commit","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ statements: $json.statements }) }}","options":{"allowUnauthorizedCerts":true,"timeout":30000}},"id":"a8765df7-4513-4bdc-a85a-f3cd46b5b64e","name":"Write Touchpoint","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[912,32],"credentials":{"httpBasicAuth":{"id":"bkJBnz7p38fXY4AN","name":"Neo4j"}}},{"parameters":{"jsCode":"const prepareData = $('Prepare Writes').first().json;\nconst devicesWritten = $('Prepare Devices').first()?.json?.skip === false ? \n  prepareData.writes.devices.length : 0;\nconst problemsWritten = $('Prepare Problems').first()?.json?.skip === false ?\n  prepareData.writes.problems.length : 0;\n\nreturn {\n  success: true,\n  writes: {\n    client: 1,\n    devices: devicesWritten,\n    problems: problemsWritten,\n    touchpoint: 1\n  },\n  trace_id: prepareData.trace_id\n};"},"id":"a0ebc9a6-8962-4eda-be4f-602cea70802d","name":"Build Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[1136,32]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"e7e4bb85-baf9-40fd-ba22-4bc68e740cc5","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1360,32]}],"connections":{"Webhook":{"main":[[{"node":"Prepare Writes","type":"main","index":0}]]},"Prepare Writes":{"main":[[{"node":"Write Client","type":"main","index":0}]]},"Write Client":{"main":[[{"node":"Prepare Devices","type":"main","index":0}]]},"Prepare Devices":{"main":[[{"node":"Has Devices?","type":"main","index":0}]]},"Has Devices?":{"main":[[{"node":"Write Devices","type":"main","index":0}],[{"node":"Prepare Problems","type":"main","index":0}]]},"Write Devices":{"main":[[{"node":"Prepare Problems","type":"main","index":0}]]},"Prepare Problems":{"main":[[{"node":"Has Problems?","type":"main","index":0}]]},"Has Problems?":{"main":[[{"node":"Write Problems","type":"main","index":0}],[{"node":"Prepare Touchpoint","type":"main","index":0}]]},"Write Problems":{"main":[[{"node":"Prepare Touchpoint","type":"main","index":0}]]},"Prepare Touchpoint":{"main":[[{"node":"Write Touchpoint","type":"main","index":0}]]},"Write Touchpoint":{"main":[[{"node":"Build Response","type":"main","index":0}]]},"Build Response":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"0a4f5e38-47be-4757-adf1-81d4f99c617a","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2025-12-15T17:26:42.753Z","createdAt":"2025-12-15T17:26:42.753Z","role":"workflow:owner","workflowId":"2xOOPR7TeNxw9O2D","projectId":"x7frUSUEowDAk8Dt"}],"activeVersion":null,"tags":[{"updatedAt":"2025-12-12T08:39:41.170Z","createdAt":"2025-12-12T08:39:41.170Z","id":"8dihLRJvdhkW2kZ1","name":"AI"},{"updatedAt":"2025-12-09T18:50:08.518Z","createdAt":"2025-12-09T18:50:08.518Z","id":"tMSCjbvPU3xrNUqz","name":"ELO"}]},{"updatedAt":"2025-12-23T09:19:44.928Z","createdAt":"2025-12-14T07:11:27.172Z","id":"3AfObE32mua4kLmr","name":"ELO_Input_Batcher","active":false,"isArchived":false,"nodes":[{"parameters":{"rule":{"interval":[{"field":"seconds","secondsInterval":3}]}},"id":"d87a59a2-7fe9-471a-afb3-d74b02627e8a","name":"Schedule Trigger","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[-1216,80]},{"parameters":{"jsCode":"// === CONFIG ===\nconst DEBOUNCE_MS = 10000;  // 10 сек тишины\nconst MAX_WAIT_MS = 40000;  // 40 сек максимум\n\nreturn [{\n  json: {\n    config: {\n      debounce_ms: DEBOUNCE_MS,\n      max_wait_ms: MAX_WAIT_MS\n    },\n    now: Date.now()\n  }\n}];"},"id":"bb398205-8f2e-4421-90fb-286557c07e59","name":"Config","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1008,80]},{"parameters":{"operation":"pop","list":"queue:incoming","options":{}},"id":"530738d2-9847-4725-bf27-3af8f494d72f","name":"Pop Message","type":"n8n-nodes-base.redis","typeVersion":1,"position":[-816,80],"credentials":{"redis":{"id":"7FQcEivUY94atW24","name":"Redis account"}}},{"parameters":{"jsCode":"// Парсим сообщение из Redis\nconst config = $('Config').first().json.config;\nconst now = $('Config').first().json.now;\n\n// Redis POP возвращает данные в разных форматах\nlet raw = $json.value;\nlet message = null;\n\nif ($json.propertyName && typeof $json.propertyName === 'object') {\n  message = $json.propertyName;\n  raw = JSON.stringify(message);\n} else if (raw && raw !== 'null' && raw !== '') {\n  try {\n    message = JSON.parse(raw);\n  } catch (e) {\n    return [{ json: { is_empty: true, config, now } }];\n  }\n}\n\nif (!message) {\n  return [{ json: { is_empty: true, config, now } }];\n}\n\nconst batch_key = `${message.channel || 'unknown'}:${message.external_chat_id || 'unknown'}`;\n\nreturn [{\n  json: {\n    is_empty: false,\n    message,\n    batch_key,\n    message_json: raw,\n    config,\n    now\n  }\n}];"},"id":"c1aaf3c9-4d64-4fd9-956d-d3483e0c2af7","name":"Parse Message","type":"n8n-nodes-base.code","typeVersion":2,"position":[-608,80]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"empty-check","leftValue":"={{ $json.is_empty }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"7bd20349-c441-4d9b-90a4-75b45a7f47d7","name":"If Empty","type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-416,80]},{"parameters":{},"id":"4152a3f4-fcd9-4ce8-ba45-f1740235d11b","name":"End (Empty)","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-208,-32]},{"parameters":{"operation":"get","key":"=first_seen:{{ $json.batch_key }}","options":{}},"id":"9c225f11-5d1e-4c51-9c60-d5609296d920","name":"Get First Seen","type":"n8n-nodes-base.redis","typeVersion":1,"position":[-208,176],"credentials":{"redis":{"id":"7FQcEivUY94atW24","name":"Redis account"}}},{"parameters":{"jsCode":"// Вычисляем deadline\nconst prev = $('Parse Message').first().json;\nconst config = prev.config;\nconst now = prev.now;\nconst batch_key = prev.batch_key;\n\n// Получаем first_seen (может быть в value или в ключе объекта)\nlet first_seen_raw = $json.value;\nif (!first_seen_raw) {\n  const keys = Object.keys($json);\n  for (const k of keys) {\n    if (k.startsWith('first_seen:')) {\n      first_seen_raw = $json[k];\n      break;\n    }\n  }\n}\n\nlet first_seen = first_seen_raw ? parseInt(first_seen_raw, 10) : null;\nconst is_new_batch = !first_seen;\n\nif (is_new_batch) {\n  first_seen = now;\n}\n\n// deadline = min(first_seen + max_wait, now + debounce)\n// Это значит: \"обработать через 10 сек тишины, но не позже 40 сек от первого\"\nconst max_deadline = first_seen + config.max_wait_ms;\nconst debounce_deadline = now + config.debounce_ms;\nconst deadline = Math.min(max_deadline, debounce_deadline);\n\nreturn [{\n  json: {\n    batch_key,\n    message_json: prev.message_json,\n    first_seen,\n    is_new_batch,\n    deadline,\n    now\n  }\n}];"},"id":"29c3e06f-dc84-41ba-a419-abc17823b0a8","name":"Calc Deadline","type":"n8n-nodes-base.code","typeVersion":2,"position":[-16,176]},{"parameters":{"operation":"push","list":"=batch:{{ $json.batch_key }}","messageData":"={{ $json.message_json }}","tail":true},"id":"51a76815-47d7-42d6-a481-06da59c5c1aa","name":"Push To Batch","type":"n8n-nodes-base.redis","typeVersion":1,"position":[192,176],"credentials":{"redis":{"id":"7FQcEivUY94atW24","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"new-batch-check","leftValue":"={{ $('Calc Deadline').first().json.is_new_batch }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"e4e87e93-8df3-4ae9-a8f8-78e2cec05c44","name":"If New Batch","type":"n8n-nodes-base.if","typeVersion":2.2,"position":[400,176]},{"parameters":{"operation":"set","key":"=first_seen:{{ $('Calc Deadline').first().json.batch_key }}","value":"={{ String($('Calc Deadline').first().json.first_seen) }}","expire":true,"ttl":120},"id":"93b081c2-8179-471a-87e2-42882bceebf5","name":"Set First Seen","type":"n8n-nodes-base.redis","typeVersion":1,"position":[592,80],"credentials":{"redis":{"id":"7FQcEivUY94atW24","name":"Redis account"}}},{"parameters":{"operation":"set","key":"=deadline:{{ $('Calc Deadline').first().json.batch_key }}","value":"={{ String($('Calc Deadline').first().json.deadline) }}","expire":true,"ttl":120},"id":"aadcb720-a625-4534-9295-3b14eb61b45d","name":"Set Deadline","type":"n8n-nodes-base.redis","typeVersion":1,"position":[800,176],"credentials":{"redis":{"id":"7FQcEivUY94atW24","name":"Redis account"}}},{"parameters":{},"id":"be8d5320-afec-4640-ba8c-437ff3bb52d9","name":"End (Done)","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[992,176]}],"connections":{"Schedule Trigger":{"main":[[{"node":"Config","type":"main","index":0}]]},"Config":{"main":[[{"node":"Pop Message","type":"main","index":0}]]},"Pop Message":{"main":[[{"node":"Parse Message","type":"main","index":0}]]},"Parse Message":{"main":[[{"node":"If Empty","type":"main","index":0}]]},"If Empty":{"main":[[{"node":"End (Empty)","type":"main","index":0}],[{"node":"Get First Seen","type":"main","index":0}]]},"Get First Seen":{"main":[[{"node":"Calc Deadline","type":"main","index":0}]]},"Calc Deadline":{"main":[[{"node":"Push To Batch","type":"main","index":0}]]},"Push To Batch":{"main":[[{"node":"If New Batch","type":"main","index":0}]]},"If New Batch":{"main":[[{"node":"Set First Seen","type":"main","index":0}],[{"node":"Set Deadline","type":"main","index":0}]]},"Set First Seen":{"main":[[{"node":"Set Deadline","type":"main","index":0}]]},"Set Deadline":{"main":[[{"node":"End (Done)","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":{"node:Schedule Trigger":{"recurrenceRules":[]}},"meta":null,"pinData":{"Schedule Trigger":[{"json":{"timestamp":"2025-12-23T12:08:51.002+04:00","Readable date":"December 23rd 2025, 12:08:51 pm","Readable time":"12:08:51 pm","Day of week":"Tuesday","Year":"2025","Month":"December","Day of month":"23","Hour":"12","Minute":"08","Second":"51","Timezone":"Europe/Samara (UTC+04:00)"},"pairedItem":{"item":0}}]},"versionId":"c1f48afe-a46d-4ad9-a897-72c9e0128ec4","activeVersionId":null,"triggerCount":1,"shared":[{"updatedAt":"2025-12-14T07:11:27.179Z","createdAt":"2025-12-14T07:11:27.179Z","role":"workflow:owner","workflowId":"3AfObE32mua4kLmr","projectId":"x7frUSUEowDAk8Dt"}],"activeVersion":null,"tags":[{"updatedAt":"2025-12-20T17:11:33.502Z","createdAt":"2025-12-20T17:11:33.502Z","id":"cuxaBKwkHf1KFGXh","name":"InputCore"},{"updatedAt":"2025-12-09T18:50:08.518Z","createdAt":"2025-12-09T18:50:08.518Z","id":"tMSCjbvPU3xrNUqz","name":"ELO"}]},{"updatedAt":"2025-12-17T08:34:21.033Z","createdAt":"2025-12-09T18:51:33.735Z","id":"3dZPOQ1WgYCx76Om","name":"ELO_In_Avito","active":false,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"avito","responseMode":"responseNode","options":{}},"id":"e0ec0070-382b-4df7-8532-18c1b6dd6259","name":"Avito Trigger","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[-976,144],"webhookId":"avito-webhook"},{"parameters":{"jsCode":"const webhookData = $input.first().json;\nconst msg = webhookData.payload?.value;\n\nif (!msg) {\n  throw new Error('Invalid Avito webhook payload');\n}\n\n// AUTH CHECK - простая проверка что это от Avito\nif (!webhookData.id || !webhookData.timestamp) {\n  throw new Error('Invalid webhook format');\n}\n\n// SYSTEM FILTER - пропускаем системные сообщения\nconst isSystem = (\n  msg.author_id === msg.user_id ||\n  msg.author_id === 0 ||\n  !msg.author_id\n);\n\nif (isSystem) {\n  return { skip: true, reason: 'system_message' };\n}\n\nconst messageText = msg.content?.text || '';\nconst authorName = msg.author?.name || null;\n\n// Проверяем типы медиа\nconst hasPhoto = msg.type === 'image';\nconst hasVoice = msg.type === 'voice';\nconst hasVideo = msg.type === 'video';\nconst hasDocument = msg.type === 'file';\n\nconst urls = [];\nlet photoUrl = null;\nlet voiceUrl = null;\nlet videoUrl = null;\n\nif (msg.content?.url) {\n  urls.push(msg.content.url);\n  if (hasPhoto) photoUrl = msg.content.url;\n  if (hasVoice) voiceUrl = msg.content.url;\n  if (hasVideo) videoUrl = msg.content.url;\n}\n\nreturn {\n  skip: false,\n  has_voice: hasVoice,\n  voice_url: voiceUrl,\n  raw_message: msg,\n  user_id: msg.user_id,\n  author_id: msg.author_id,\n  author_name: authorName,\n  chat_id: msg.chat_id,\n  message_id: msg.id,\n  message_text: messageText,\n  message_type: msg.type,\n  created: msg.created,\n  item_id: msg.item_id,\n  has_photo: hasPhoto,\n  photo_url: photoUrl,\n  has_video: hasVideo,\n  video_url: videoUrl,\n  has_document: hasDocument,\n  urls: urls\n};"},"id":"da471566-755e-4fa1-8412-30ed5a0c7823","name":"Parse Auth Filter","type":"n8n-nodes-base.code","typeVersion":2,"position":[-768,144]},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $json.skip }}","value2":true}]}},"id":"b011e421-d294-4788-b096-19a35fcc9daf","name":"Should Skip?","type":"n8n-nodes-base.if","typeVersion":1,"position":[-544,144]},{"parameters":{"respondWith":"json","responseBody":"={{ { \"ok\": true, \"skipped\": true } }}","options":{}},"id":"00a6605d-1ca4-4ddc-942e-d1340286087d","name":"Respond Skipped","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[-320,32]},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $json.has_voice }}","value2":true}]}},"id":"e76616f6-8b9d-4eca-bf91-ac5637c39e08","name":"Has Voice?","type":"n8n-nodes-base.if","typeVersion":1,"position":[-320,240]},{"parameters":{"url":"={{ $json.voice_url }}","options":{"response":{"response":{"responseFormat":"file"}}}},"id":"47807b4e-f13d-40a3-990c-8dd54c3de3fd","name":"Download Voice","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-96,144]},{"parameters":{"resource":"audio","operation":"transcribe","options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[128,144],"id":"a62e8359-e11e-49e4-bc0b-9cd7859a0ce0","name":"Transcribe Voice","credentials":{"openAiApi":{"id":"ptoy1RvCOn39G0Af","name":"OpenAi account"}}},{"parameters":{"jsCode":"const data = $('Parse Auth Filter').first().json;\nconst transcription = $input.first().json.text;\n\nlet messageText = data.message_text;\nif (transcription) {\n  messageText = (messageText ? messageText + '\\n\\n' : '') + transcription;\n}\n\nreturn {\n  channel: 'avito',\n  external_user_id: data.author_id.toString(),\n  external_chat_id: data.chat_id,\n  \n  text: messageText,\n  timestamp: new Date(data.created * 1000).toISOString(),\n  \n  client_phone: null,\n  client_name: data.author_name,\n  client_email: null,\n  \n  media: {\n    has_voice: true,\n    voice_transcribed_text: transcription,\n    has_images: data.has_photo,\n    images: data.has_photo ? [{ url: data.photo_url }] : [],\n    has_video: data.has_video,\n    videos: data.has_video ? [{ url: data.video_url }] : [],\n    has_document: data.has_document\n  },\n  \n  meta: {\n    external_message_id: data.message_id,\n    ad_channel: 'avito',\n    ad_id: data.item_id?.toString(),\n    original_media_type: 'voice',\n    raw: data.raw_message,\n    chat_type: data.raw_message.chat_type,\n    user_id: data.user_id\n  },\n  \n  prefilled_data: {\n    model: null,\n    parts_owner: null\n  }\n};"},"id":"621dd7a2-af2f-485f-8b94-762aee8d3a09","name":"Normalize with Voice","type":"n8n-nodes-base.code","typeVersion":2,"position":[352,144]},{"parameters":{"jsCode":"const data = $input.first().json;\n\nreturn {\n  channel: 'avito',\n  external_user_id: data.author_id.toString(),\n  external_chat_id: data.chat_id,\n  \n  text: data.message_text,\n  timestamp: new Date(data.created * 1000).toISOString(),\n  \n  client_phone: null,\n  client_name: data.author_name,\n  client_email: null,\n  \n  media: {\n    has_voice: false,\n    voice_transcribed_text: null,\n    has_images: data.has_photo,\n    images: data.has_photo ? [{ url: data.photo_url }] : [],\n    has_video: data.has_video,\n    videos: data.has_video ? [{ url: data.video_url }] : [],\n    has_document: data.has_document\n  },\n  \n  meta: {\n    external_message_id: data.message_id,\n    ad_channel: 'avito',\n    ad_id: data.item_id?.toString(),\n    original_media_type: data.has_photo ? 'photo' : data.has_video ? 'video' : 'text',\n    raw: data.raw_message,\n    chat_type: data.raw_message.chat_type,\n    user_id: data.user_id\n  },\n  \n  prefilled_data: {\n    model: null,\n    parts_owner: null\n  }\n};"},"id":"c7368479-4227-4ff0-947f-29eb37ddee84","name":"Normalize without Voice","type":"n8n-nodes-base.code","typeVersion":2,"position":[-96,336]},{"parameters":{"workflowId":{"__rl":true,"value":"rRO6sxLqiCdgvLZz","mode":"list","cachedResultUrl":"/workflow/rRO6sxLqiCdgvLZz","cachedResultName":"ELO_Core_Tenant_Resolver"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[560,240],"id":"5a9c9a93-dde0-4d1d-995b-c225a7aa8e0c","name":"Execute Tenant Resolver"},{"parameters":{"jsCode":"// Подготавливаем сообщение для Redis очереди\nconst data = $input.first().json;\n\n// Сериализуем в JSON для Redis\nreturn {\n  message_json: JSON.stringify(data),\n  batch_key: `${data.channel}:${data.external_chat_id}`\n};"},"id":"e53d3b0e-62f1-4114-a75d-6957985cfca8","name":"Prepare for Queue","type":"n8n-nodes-base.code","typeVersion":2,"position":[784,240]},{"parameters":{"operation":"push","list":"queue:incoming","messageData":"={{ $json.message_json }}","tail":true},"id":"10c99842-1427-48e4-ad16-bf3728ac15dc","name":"Push to Queue","type":"n8n-nodes-base.redis","typeVersion":1,"position":[1008,240],"credentials":{"redis":{"id":"7FQcEivUY94atW24","name":"Redis account"}}},{"parameters":{"respondWith":"json","responseBody":"={{ { \"ok\": true, \"queued\": true, \"batch_key\": $('Prepare for Queue').item.json.batch_key } }}","options":{}},"id":"af7ecc2a-dbae-4c67-b656-5894460077bf","name":"Respond Queued","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[1232,240]}],"connections":{"Avito Trigger":{"main":[[{"node":"Parse Auth Filter","type":"main","index":0}]]},"Parse Auth Filter":{"main":[[{"node":"Should Skip?","type":"main","index":0}]]},"Should Skip?":{"main":[[{"node":"Respond Skipped","type":"main","index":0}],[{"node":"Has Voice?","type":"main","index":0}]]},"Has Voice?":{"main":[[{"node":"Download Voice","type":"main","index":0}],[{"node":"Normalize without Voice","type":"main","index":0}]]},"Download Voice":{"main":[[{"node":"Transcribe Voice","type":"main","index":0}]]},"Transcribe Voice":{"main":[[{"node":"Normalize with Voice","type":"main","index":0}]]},"Normalize with Voice":{"main":[[{"node":"Execute Tenant Resolver","type":"main","index":0}]]},"Normalize without Voice":{"main":[[{"node":"Execute Tenant Resolver","type":"main","index":0}]]},"Execute Tenant Resolver":{"main":[[{"node":"Prepare for Queue","type":"main","index":0}]]},"Prepare for Queue":{"main":[[{"node":"Push to Queue","type":"main","index":0}]]},"Push to Queue":{"main":[[{"node":"Respond Queued","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"04c871cc-ac93-436c-b177-a6186c5943c6","activeVersionId":null,"triggerCount":1,"shared":[{"updatedAt":"2025-12-09T18:51:33.740Z","createdAt":"2025-12-09T18:51:33.740Z","role":"workflow:owner","workflowId":"3dZPOQ1WgYCx76Om","projectId":"x7frUSUEowDAk8Dt"}],"activeVersion":null,"tags":[{"updatedAt":"2025-11-23T04:03:40.721Z","createdAt":"2025-11-23T04:03:40.721Z","id":"nLdF41tEx70V7m3A","name":"In"},{"updatedAt":"2025-12-09T18:50:08.518Z","createdAt":"2025-12-09T18:50:08.518Z","id":"tMSCjbvPU3xrNUqz","name":"ELO"}]},{"updatedAt":"2025-12-17T08:59:02.934Z","createdAt":"2025-12-15T17:23:55.368Z","id":"3ohsxSod82QjGgXB","name":"ELO_AI_Extract","active":false,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"elo-ai-extract","responseMode":"responseNode","options":{}},"id":"ef98d8ba-4506-472c-838f-ddb214eaf57d","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-160,-96],"webhookId":"elo-ai-extract"},{"parameters":{"jsCode":"const input = $input.first().json.body || $input.first().json;\n\nif (!input.message) {\n  throw new Error('Missing required field: message');\n}\n\nconst schema = input.extraction_schema || {\n  entities: ['device', 'symptom', 'owner', 'intent'],\n  multi_entity: true\n};\n\n// Build extraction prompt\nconst systemPrompt = `You are an entity extraction system for a phone repair service.\nExtract entities from user messages and return ONLY valid JSON.\n\nEntity types to extract:\n- device: {type: \"device\", brand: string, model: string, color?: string}\n- symptom: {type: \"symptom\", text: string, for_device?: string}\n- owner: {type: \"owner\", label: string} (e.g., \"my\", \"wife's\", \"kid's\")\n- intent: {type: \"intent\", value: string} (e.g., \"repair\", \"price_check\", \"book\", \"cancel\")\n\nRULES:\n1. Return ONLY JSON array, no explanations\n2. Extract ALL mentioned devices if multi_entity is true\n3. Brand normalization: \"айфон/iphone\" → \"Apple\", \"самсунг/samsung\" → \"Samsung\", \"сяоми/xiaomi\" → \"Xiaomi\"\n4. If device model unclear, extract what you can\n5. Empty array [] if nothing to extract`;\n\nconst userPrompt = `Extract entities from: \"${input.message}\"\n\nSchema: ${JSON.stringify(schema)}\n\nReturn JSON array:`;\n\nreturn {\n  message: input.message,\n  system_prompt: systemPrompt,\n  user_prompt: userPrompt,\n  schema: schema,\n  trace_id: input.trace_id || `trace_${Date.now()}`\n};"},"id":"7c5be5ec-3913-4b88-8126-be3c3bee7b8e","name":"Build Prompt","type":"n8n-nodes-base.code","typeVersion":2,"position":[64,-96]},{"parameters":{"method":"POST","url":"https://openrouter.ai/api/v1/chat/completions","authentication":"predefinedCredentialType","nodeCredentialType":"openRouterApi","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({\n  model: 'qwen/qwen3-30b-a3b:free',\n  messages: [\n    { role: 'system', content: $json.system_prompt },\n    { role: 'user', content: $json.user_prompt }\n  ],\n  temperature: 0.1,\n  max_tokens: 500\n}) }}","options":{"timeout":60000}},"id":"6c26b2c7-da23-4add-b9ce-941d3e98aa92","name":"Call OpenRouter","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[288,-96],"credentials":{"openRouterApi":{"id":"ameOTCcGgTm3hbtM","name":"OpenRouter account"}}},{"parameters":{"jsCode":"const response = $json;\nconst buildData = $('Build Prompt').first().json;\n\nlet entities = [];\nlet rawContent = '';\n\ntry {\n  rawContent = response.choices?.[0]?.message?.content || '[]';\n  \n  // Clean up response\n  rawContent = rawContent.trim();\n  \n  // Remove thinking tags if present (Qwen3)\n  rawContent = rawContent.replace(/<think>[\\s\\S]*?<\\/think>/g, '').trim();\n  \n  // Extract JSON from response (may have markdown code blocks)\n  const jsonMatch = rawContent.match(/\\[\\s*[\\s\\S]*?\\]/)\n  if (jsonMatch) {\n    rawContent = jsonMatch[0];\n  }\n  \n  entities = JSON.parse(rawContent);\n  \n  // Ensure it's an array\n  if (!Array.isArray(entities)) {\n    entities = [entities];\n  }\n  \n} catch (e) {\n  // If parsing fails, return empty\n  entities = [];\n}\n\nreturn {\n  entities: entities,\n  raw_response: rawContent,\n  message: buildData.message,\n  trace_id: buildData.trace_id,\n  model: response.model,\n  tokens_used: response.usage?.total_tokens\n};"},"id":"8436eabd-e817-4f7d-97bf-92d509a2ba29","name":"Parse Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[512,-96]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"d08e63f8-77dc-495f-9265-68f53b7bc15c","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[720,-96]}],"connections":{"Webhook":{"main":[[{"node":"Build Prompt","type":"main","index":0}]]},"Build Prompt":{"main":[[{"node":"Call OpenRouter","type":"main","index":0}]]},"Call OpenRouter":{"main":[[{"node":"Parse Response","type":"main","index":0}]]},"Parse Response":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"308ca8b4-ee06-4014-972c-89b49fca4b57","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2025-12-15T17:23:55.373Z","createdAt":"2025-12-15T17:23:55.373Z","role":"workflow:owner","workflowId":"3ohsxSod82QjGgXB","projectId":"x7frUSUEowDAk8Dt"}],"activeVersion":null,"tags":[{"updatedAt":"2025-12-12T08:39:41.170Z","createdAt":"2025-12-12T08:39:41.170Z","id":"8dihLRJvdhkW2kZ1","name":"AI"},{"updatedAt":"2025-12-09T18:50:08.518Z","createdAt":"2025-12-09T18:50:08.518Z","id":"tMSCjbvPU3xrNUqz","name":"ELO"}]},{"updatedAt":"2025-12-21T11:29:39.856Z","createdAt":"2025-12-19T08:32:18.873Z","id":"6twQI6tVin73BcN1","name":"ELO_API_Android_Send_Message","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"android/messages/send","responseMode":"responseNode","options":{"allowedOrigins":"*"}},"id":"bdd5d9fe-ba82-4941-899a-095d691e3f58","name":"Webhook - Send Message","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1504,272],"webhookId":"android-send-message"},{"parameters":{"operation":"executeQuery","query":"SELECT od.operator_id, od.tenant_id, o.name as operator_name\nFROM elo_t_operator_devices od\nJOIN elo_t_operators o ON od.operator_id = o.id\nWHERE od.session_token = '{{ $json.body.session_token }}'\n  AND od.is_active = true\nLIMIT 1;","options":{}},"id":"5d13793c-55e1-4b41-bd0d-3ce55b4a33c2","name":"Validate Session","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-1280,272],"alwaysOutputData":true,"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"session-valid","leftValue":"={{ $json.operator_id }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"id":"81af2790-6abc-4820-9cc4-ac01a2506219","name":"IF Session Valid","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1056,272]},{"parameters":{"operation":"executeQuery","query":"SELECT \n  d.id as dialog_id,\n  d.tenant_id,\n  d.client_id,\n  d.channel_id,\n  d.external_chat_id,\n  c.name as client_name,\n  c.phone as client_phone\nFROM elo_t_dialogs d\nJOIN elo_t_clients c ON d.client_id = c.id\nWHERE d.id = '{{ $('Webhook - Send Message').item.json.body.dialog_id }}'::uuid\n  AND d.tenant_id = '{{ $('Validate Session').item.json.tenant_id }}'::uuid\nLIMIT 1;","options":{}},"id":"305a722e-2951-43e7-a249-4f3d2f1e26a1","name":"Get Dialog Info","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-832,160],"alwaysOutputData":true,"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"INSERT INTO elo_t_messages (\n  tenant_id,\n  dialog_id,\n  client_id,\n  direction_id,\n  message_type_id,\n  actor_type,\n  actor_id,\n  content,\n  timestamp\n) VALUES (\n  '{{ $('Get Dialog Info').item.json.tenant_id }}'::uuid,\n  '{{ $('Get Dialog Info').item.json.dialog_id }}'::uuid,\n  '{{ $('Get Dialog Info').item.json.client_id }}'::uuid,\n  2,\n  1,\n  'operator',\n  '{{ $('Validate Session').item.json.operator_id }}'::uuid,\n  '{{ $('Webhook - Send Message').item.json.body.text.replace(/'/g, \"''\") }}',\n  NOW()\n)\nRETURNING id, content as text, 'out' as direction, 'operator' as sender_type,\n  '{{ $('Validate Session').item.json.operator_name }}' as sender_name,\n  EXTRACT(EPOCH FROM timestamp)::bigint * 1000 as timestamp;","options":{}},"id":"fd5b90a0-8572-4997-958e-65bf64f641ef","name":"Insert Message","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-608,160],"alwaysOutputData":true,"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"jsCode":"const dialogInfo = $('Get Dialog Info').first().json;\nconst message = $('Insert Message').first().json;\nconst body = $('Webhook - Send Message').first().json.body;\nconst session = $('Validate Session').first().json;\n\n// Map channel_id to queue name\nconst channelQueues = {\n  1: 'queue:outgoing:telegram',\n  2: 'queue:outgoing:whatsapp',\n  3: 'queue:outgoing:avito',\n  4: 'queue:outgoing:vk',\n  5: 'queue:outgoing:max'\n};\n\nconst queueName = channelQueues[dialogInfo.channel_id] || 'queue:outgoing:unknown';\n\n// Prepare outgoing message for Redis queue\nconst outgoingMessage = {\n  tenant_id: dialogInfo.tenant_id,\n  dialog_id: dialogInfo.dialog_id,\n  client_id: dialogInfo.client_id,\n  external_chat_id: dialogInfo.external_chat_id,\n  message_text: body.text,\n  message_id: message.id,\n  actor_type: 'operator',\n  actor_id: session.operator_id,\n  timestamp: new Date().toISOString()\n};\n\nreturn {\n  queue_name: queueName,\n  outgoing_message: outgoingMessage,\n  message: {\n    id: message.id,\n    text: message.text,\n    direction: message.direction,\n    sender_type: message.sender_type,\n    sender_name: message.sender_name,\n    timestamp: message.timestamp\n  }\n};"},"id":"84c4b410-679b-45e4-922e-49bc9dc8571c","name":"Prepare Outgoing","type":"n8n-nodes-base.code","typeVersion":2,"position":[-384,160]},{"parameters":{"operation":"push","list":"={{ $json.queue_name }}","messageData":"={{ JSON.stringify($json.outgoing_message) }}","tail":true},"id":"0022f456-7f71-4083-8745-98a65332984f","name":"Redis Push to Channel Queue","type":"n8n-nodes-base.redis","typeVersion":1,"position":[-160,160],"credentials":{"redis":{"id":"7FQcEivUY94atW24","name":"Redis account"}}},{"parameters":{"respondWith":"json","responseBody":"={\n  \"success\": true,\n  \"message\": {{ JSON.stringify($('Prepare Outgoing').item.json.message) }},\n  \"queued\": true,\n  \"queue\": \"{{ $('Prepare Outgoing').item.json.queue_name }}\"\n}","options":{"responseCode":200,"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"},{"name":"Access-Control-Allow-Origin","value":"*"}]}}},"id":"ed53ffed-df3c-402e-a26e-a9c64b033954","name":"Response Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[64,160]},{"parameters":{"respondWith":"json","responseBody":"={\n  \"success\": false,\n  \"error\": \"invalid_session\"\n}","options":{"responseCode":401,"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"},{"name":"Access-Control-Allow-Origin","value":"*"}]}}},"id":"1e51c632-f0fc-44bb-ba99-512c3fde886d","name":"Response Unauthorized","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-832,368]}],"connections":{"Webhook - Send Message":{"main":[[{"node":"Validate Session","type":"main","index":0}]]},"Validate Session":{"main":[[{"node":"IF Session Valid","type":"main","index":0}]]},"IF Session Valid":{"main":[[{"node":"Get Dialog Info","type":"main","index":0}],[{"node":"Response Unauthorized","type":"main","index":0}]]},"Get Dialog Info":{"main":[[{"node":"Insert Message","type":"main","index":0}]]},"Insert Message":{"main":[[{"node":"Prepare Outgoing","type":"main","index":0}]]},"Prepare Outgoing":{"main":[[{"node":"Redis Push to Channel Queue","type":"main","index":0}]]},"Redis Push to Channel Queue":{"main":[[{"node":"Response Success","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"eb9236f5-e102-48ca-9add-2708a47e94f8","activeVersionId":"eb9236f5-e102-48ca-9add-2708a47e94f8","triggerCount":1,"shared":[{"updatedAt":"2025-12-19T08:32:18.879Z","createdAt":"2025-12-19T08:32:18.879Z","role":"workflow:owner","workflowId":"6twQI6tVin73BcN1","projectId":"x7frUSUEowDAk8Dt"}],"activeVersion":{"updatedAt":"2025-12-21T11:29:39.858Z","createdAt":"2025-12-21T11:29:39.858Z","versionId":"eb9236f5-e102-48ca-9add-2708a47e94f8","workflowId":"6twQI6tVin73BcN1","nodes":[{"parameters":{"httpMethod":"POST","path":"android/messages/send","responseMode":"responseNode","options":{"allowedOrigins":"*"}},"id":"bdd5d9fe-ba82-4941-899a-095d691e3f58","name":"Webhook - Send Message","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1504,272],"webhookId":"android-send-message"},{"parameters":{"operation":"executeQuery","query":"SELECT od.operator_id, od.tenant_id, o.name as operator_name\nFROM elo_t_operator_devices od\nJOIN elo_t_operators o ON od.operator_id = o.id\nWHERE od.session_token = '{{ $json.body.session_token }}'\n  AND od.is_active = true\nLIMIT 1;","options":{}},"id":"5d13793c-55e1-4b41-bd0d-3ce55b4a33c2","name":"Validate Session","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-1280,272],"alwaysOutputData":true,"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"session-valid","leftValue":"={{ $json.operator_id }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"id":"81af2790-6abc-4820-9cc4-ac01a2506219","name":"IF Session Valid","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1056,272]},{"parameters":{"operation":"executeQuery","query":"SELECT \n  d.id as dialog_id,\n  d.tenant_id,\n  d.client_id,\n  d.channel_id,\n  d.external_chat_id,\n  c.name as client_name,\n  c.phone as client_phone\nFROM elo_t_dialogs d\nJOIN elo_t_clients c ON d.client_id = c.id\nWHERE d.id = '{{ $('Webhook - Send Message').item.json.body.dialog_id }}'::uuid\n  AND d.tenant_id = '{{ $('Validate Session').item.json.tenant_id }}'::uuid\nLIMIT 1;","options":{}},"id":"305a722e-2951-43e7-a249-4f3d2f1e26a1","name":"Get Dialog Info","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-832,160],"alwaysOutputData":true,"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"INSERT INTO elo_t_messages (\n  tenant_id,\n  dialog_id,\n  client_id,\n  direction_id,\n  message_type_id,\n  actor_type,\n  actor_id,\n  content,\n  timestamp\n) VALUES (\n  '{{ $('Get Dialog Info').item.json.tenant_id }}'::uuid,\n  '{{ $('Get Dialog Info').item.json.dialog_id }}'::uuid,\n  '{{ $('Get Dialog Info').item.json.client_id }}'::uuid,\n  2,\n  1,\n  'operator',\n  '{{ $('Validate Session').item.json.operator_id }}'::uuid,\n  '{{ $('Webhook - Send Message').item.json.body.text.replace(/'/g, \"''\") }}',\n  NOW()\n)\nRETURNING id, content as text, 'out' as direction, 'operator' as sender_type,\n  '{{ $('Validate Session').item.json.operator_name }}' as sender_name,\n  EXTRACT(EPOCH FROM timestamp)::bigint * 1000 as timestamp;","options":{}},"id":"fd5b90a0-8572-4997-958e-65bf64f641ef","name":"Insert Message","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-608,160],"alwaysOutputData":true,"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"jsCode":"const dialogInfo = $('Get Dialog Info').first().json;\nconst message = $('Insert Message').first().json;\nconst body = $('Webhook - Send Message').first().json.body;\nconst session = $('Validate Session').first().json;\n\n// Map channel_id to queue name\nconst channelQueues = {\n  1: 'queue:outgoing:telegram',\n  2: 'queue:outgoing:whatsapp',\n  3: 'queue:outgoing:avito',\n  4: 'queue:outgoing:vk',\n  5: 'queue:outgoing:max'\n};\n\nconst queueName = channelQueues[dialogInfo.channel_id] || 'queue:outgoing:unknown';\n\n// Prepare outgoing message for Redis queue\nconst outgoingMessage = {\n  tenant_id: dialogInfo.tenant_id,\n  dialog_id: dialogInfo.dialog_id,\n  client_id: dialogInfo.client_id,\n  external_chat_id: dialogInfo.external_chat_id,\n  message_text: body.text,\n  message_id: message.id,\n  actor_type: 'operator',\n  actor_id: session.operator_id,\n  timestamp: new Date().toISOString()\n};\n\nreturn {\n  queue_name: queueName,\n  outgoing_message: outgoingMessage,\n  message: {\n    id: message.id,\n    text: message.text,\n    direction: message.direction,\n    sender_type: message.sender_type,\n    sender_name: message.sender_name,\n    timestamp: message.timestamp\n  }\n};"},"id":"84c4b410-679b-45e4-922e-49bc9dc8571c","name":"Prepare Outgoing","type":"n8n-nodes-base.code","typeVersion":2,"position":[-384,160]},{"parameters":{"operation":"push","list":"={{ $json.queue_name }}","messageData":"={{ JSON.stringify($json.outgoing_message) }}","tail":true},"id":"0022f456-7f71-4083-8745-98a65332984f","name":"Redis Push to Channel Queue","type":"n8n-nodes-base.redis","typeVersion":1,"position":[-160,160],"credentials":{"redis":{"id":"7FQcEivUY94atW24","name":"Redis account"}}},{"parameters":{"respondWith":"json","responseBody":"={\n  \"success\": true,\n  \"message\": {{ JSON.stringify($('Prepare Outgoing').item.json.message) }},\n  \"queued\": true,\n  \"queue\": \"{{ $('Prepare Outgoing').item.json.queue_name }}\"\n}","options":{"responseCode":200,"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"},{"name":"Access-Control-Allow-Origin","value":"*"}]}}},"id":"ed53ffed-df3c-402e-a26e-a9c64b033954","name":"Response Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[64,160]},{"parameters":{"respondWith":"json","responseBody":"={\n  \"success\": false,\n  \"error\": \"invalid_session\"\n}","options":{"responseCode":401,"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"},{"name":"Access-Control-Allow-Origin","value":"*"}]}}},"id":"1e51c632-f0fc-44bb-ba99-512c3fde886d","name":"Response Unauthorized","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-832,368]}],"connections":{"Webhook - Send Message":{"main":[[{"node":"Validate Session","type":"main","index":0}]]},"Validate Session":{"main":[[{"node":"IF Session Valid","type":"main","index":0}]]},"IF Session Valid":{"main":[[{"node":"Get Dialog Info","type":"main","index":0}],[{"node":"Response Unauthorized","type":"main","index":0}]]},"Get Dialog Info":{"main":[[{"node":"Insert Message","type":"main","index":0}]]},"Insert Message":{"main":[[{"node":"Prepare Outgoing","type":"main","index":0}]]},"Prepare Outgoing":{"main":[[{"node":"Redis Push to Channel Queue","type":"main","index":0}]]},"Redis Push to Channel Queue":{"main":[[{"node":"Response Success","type":"main","index":0}]]}},"authors":"Dmitriy Remacs","name":null,"description":null},"tags":[{"updatedAt":"2025-11-23T03:58:34.844Z","createdAt":"2025-11-23T03:58:34.844Z","id":"0yzk30hhaSzkl8bF","name":"API"},{"updatedAt":"2025-12-09T18:50:08.518Z","createdAt":"2025-12-09T18:50:08.518Z","id":"tMSCjbvPU3xrNUqz","name":"ELO"}]},{"updatedAt":"2025-12-21T11:26:20.156Z","createdAt":"2025-12-10T10:01:07.683Z","id":"8SxXTnGJe4qnN4Kx","name":"ELO_Out_MAX","active":false,"isArchived":false,"nodes":[{"parameters":{"rule":{"interval":[{"field":"seconds","secondsInterval":3}]}},"id":"3c9a21a4-ea12-4d14-86fb-b8c449d549c9","name":"Schedule Trigger","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[-1392,-64]},{"parameters":{"operation":"pop","list":"queue:outgoing:max","options":{}},"id":"41aa49f0-c8db-47e8-a216-0b61ba6dedd9","name":"Redis Pop Message","type":"n8n-nodes-base.redis","typeVersion":1,"position":[-1168,-64],"credentials":{"redis":{"id":"7FQcEivUY94atW24","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"has-message","leftValue":"={{ $json.message_json }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"id":"acaac8f2-f909-45fa-ab8c-82db470b3a8a","name":"IF Has Message","type":"n8n-nodes-base.if","typeVersion":2,"position":[-944,-64]},{"parameters":{"jsCode":"const messageJson = $json.message_json;\nconst message = JSON.parse(messageJson);\n\nreturn {\n  out_message: message\n};"},"id":"83074b92-31ec-4dfb-8420-e32306cab3d0","name":"Parse Message","type":"n8n-nodes-base.code","typeVersion":2,"position":[-720,-160]},{"parameters":{"operation":"executeQuery","query":"SELECT \n  ca.credentials->>'bot_token' as bot_token,\n  ca.account_id,\n  ca.account_name\nFROM elo_t_channel_accounts ca\nWHERE ca.tenant_id = '{{ $json.out_message.tenant_id }}'::uuid\n  AND ca.channel_id = 5\n  AND ca.is_active = true\nLIMIT 1;","options":{}},"id":"2aede235-2939-47a4-80fd-69411416db30","name":"Get MAX Token","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-496,-160],"alwaysOutputData":true,"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"has-token","leftValue":"={{ $json.bot_token }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"id":"ff0736f2-8633-4c22-9df6-62aad46870e4","name":"IF Token Exists","type":"n8n-nodes-base.if","typeVersion":2,"position":[-272,-160]},{"parameters":{"method":"POST","url":"=https://api.max.ru/bot/{{ $json.bot_token }}/messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"chat_id\": \"{{ $('Parse Message').item.json.out_message.external_chat_id }}\",\n  \"text\": {{ JSON.stringify($('Parse Message').item.json.out_message.message_text) }}\n}","options":{"timeout":30000}},"id":"72da228c-793f-4877-ba98-2ff7e88f7188","name":"Send MAX Message","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-48,-256]},{"parameters":{"jsCode":"const parsed = $('Parse Message').first().json;\nconst response = $input.first().json;\n\nconst success = !response.error;\nconst messageId = response.message_id || response.id || Date.now().toString();\n\nreturn {\n  ...parsed,\n  max_response: response,\n  message_id: messageId,\n  sent_at: new Date().toISOString(),\n  send_success: success\n};"},"id":"6b860f3a-727c-41f7-9561-3972a939c5bb","name":"Process MAX Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[176,-256]},{"parameters":{"operation":"executeQuery","query":"UPDATE elo_t_dialogs SET\n  last_message_at = NOW(),\n  last_operator_message_at = NOW(),\n  updated_at = NOW()\nWHERE id = '{{ $json.out_message.dialog_id }}'::uuid;","options":{}},"id":"0d7df1e7-de7b-43eb-85fe-edf0cf32cae8","name":"Update Dialog Timestamp","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[400,-256],"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"jsCode":"// No token found - log error\nconst parsed = $('Parse Message').first().json;\n\nconsole.error('No MAX bot token found for tenant:', parsed.out_message?.tenant_id);\n\nreturn {\n  success: false,\n  error: 'No MAX bot token found for tenant',\n  tenant_id: parsed.out_message?.tenant_id,\n  out_message: parsed.out_message\n};"},"id":"847e6fba-636d-4c08-9357-fd4187899825","name":"No Token Error","type":"n8n-nodes-base.code","typeVersion":2,"position":[-48,-64]},{"parameters":{"jsCode":"// No message in queue - just return\nreturn { empty: true };"},"id":"d8f5166e-937f-463e-9d02-4236c2d759aa","name":"No Message","type":"n8n-nodes-base.code","typeVersion":2,"position":[-720,32]}],"connections":{"Schedule Trigger":{"main":[[{"node":"Redis Pop Message","type":"main","index":0}]]},"Redis Pop Message":{"main":[[{"node":"IF Has Message","type":"main","index":0}]]},"IF Has Message":{"main":[[{"node":"Parse Message","type":"main","index":0}],[{"node":"No Message","type":"main","index":0}]]},"Parse Message":{"main":[[{"node":"Get MAX Token","type":"main","index":0}]]},"Get MAX Token":{"main":[[{"node":"IF Token Exists","type":"main","index":0}]]},"IF Token Exists":{"main":[[{"node":"Send MAX Message","type":"main","index":0}],[{"node":"No Token Error","type":"main","index":0}]]},"Send MAX Message":{"main":[[{"node":"Process MAX Response","type":"main","index":0}]]},"Process MAX Response":{"main":[[{"node":"Update Dialog Timestamp","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"0588ee26-ce23-49d8-9f04-ea0393f2395c","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2025-12-10T10:01:07.689Z","createdAt":"2025-12-10T10:01:07.689Z","role":"workflow:owner","workflowId":"8SxXTnGJe4qnN4Kx","projectId":"x7frUSUEowDAk8Dt"}],"activeVersion":null,"tags":[{"updatedAt":"2025-11-23T04:03:34.766Z","createdAt":"2025-11-23T04:03:34.766Z","id":"IbDkJphbr4EygdRZ","name":"Out"},{"updatedAt":"2025-12-09T18:50:08.518Z","createdAt":"2025-12-09T18:50:08.518Z","id":"tMSCjbvPU3xrNUqz","name":"ELO"}]},{"updatedAt":"2025-12-15T17:26:17.090Z","createdAt":"2025-12-15T17:26:01.901Z","id":"8oyOJpnE7Cc0D27C","name":"ELO_Core_Context_Builder","active":false,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"elo-core-context-builder","responseMode":"responseNode","options":{"allowedOrigins":"*"}},"id":"41826d91-8f5d-41a6-8257-ee1602deda03","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-944,128],"webhookId":"elo-core-context-builder"},{"parameters":{"jsCode":"const body = $json.body || $json;\nconst clientId = body.client_id || null;\nconst dialogId = body.dialog_id || null;\nconst action = body.action || 'get_context';\n\n// For match_entities action\nconst extracted = body.extracted || {};\nconst brand = extracted.brand || null;\nconst model = extracted.model || null;\nconst ownerLabel = extracted.owner_label || null;\nconst problemType = extracted.problem_type || null;\nconst currentFocus = body.current_focus || {};\n\n// Generate trace_id\nconst traceId = body.trace_id || `trace_${Date.now()}_${Math.random().toString(36).slice(2, 10)}`;\n\nreturn {\n  clientId,\n  dialogId,\n  action,\n  extracted: {\n    brand,\n    model,\n    ownerLabel,\n    problemType\n  },\n  currentFocus,\n  traceId\n};"},"id":"9700c8d4-0eb6-4a1b-bf90-428ef1ce7e06","name":"Parse Request","type":"n8n-nodes-base.code","typeVersion":2,"position":[-736,128]},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"typeValidation":"strict"},"conditions":[{"leftValue":"={{ $json.action }}","rightValue":"get_context","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"get_context"},{"conditions":{"options":{"caseSensitive":true,"typeValidation":"strict"},"conditions":[{"leftValue":"={{ $json.action }}","rightValue":"disambiguation","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"disambiguation"},{"conditions":{"options":{"caseSensitive":true,"typeValidation":"strict"},"conditions":[{"leftValue":"={{ $json.action }}","rightValue":"match_entities","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"match_entities"},{"conditions":{"options":{"caseSensitive":true,"typeValidation":"strict"},"conditions":[{"leftValue":"={{ $json.action }}","rightValue":"load_dialog_context","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"load_dialog"}]},"options":{"fallbackOutput":"extra"}},"id":"cb868050-0690-41ac-8bad-b80cf1e2ac98","name":"Route by Action","type":"n8n-nodes-base.switch","typeVersion":3.3,"position":[-544,80]},{"parameters":{"method":"POST","url":"http://45.144.177.128:7474/db/neo4j/tx/commit","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({\n  statements: [{\n    statement: `\n      MATCH (c:Client {id: $clientId})\n      OPTIONAL MATCH (c)-[:OWNS]->(d:Device)\n      OPTIONAL MATCH (d)-[:HAS_PROBLEM]->(p:Problem)-[:OF_TYPE]->(pt:ProblemType)\n      OPTIONAL MATCH (c)-[:HAS_CHANNEL]->(ch:Channel)\n      OPTIONAL MATCH (c)-[:CUSTOMER_OF]->(v:Vertical)\n      OPTIONAL MATCH (t:Touchpoint)-[:ABOUT_DEVICE]->(d)\n      WHERE t.timestamp > datetime() - duration('P7D')\n      RETURN c, \n             collect(DISTINCT {id: d.id, brand: d.brand, model: d.model, owner_label: d.owner_label}) as devices,\n             collect(DISTINCT {id: p.id, status: p.status, type: pt.code}) as problems,\n             collect(DISTINCT {type: ch.type, identifier: ch.identifier}) as channels,\n             collect(DISTINCT v.type) as verticals\n    `,\n    parameters: { clientId: $json.clientId }\n  }]\n}) }}","options":{"allowUnauthorizedCerts":true,"timeout":30000}},"id":"8f496ca5-f887-4e52-9349-0feedf0e34cc","name":"Neo4j Get Context","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-272,-112],"credentials":{"httpBasicAuth":{"id":"bkJBnz7p38fXY4AN","name":"Neo4j"}}},{"parameters":{"method":"POST","url":"http://45.144.177.128:7474/db/neo4j/tx/commit","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({\n  statements: [{\n    statement: `\n      MATCH (c:Client {id: $clientId})-[:OWNS]->(d:Device)\n      OPTIONAL MATCH (t:Touchpoint)-[:ABOUT_DEVICE]->(d)\n      WHERE t.timestamp > datetime() - duration('P1D')\n      WITH d, max(t.timestamp) as lastMentioned, count(t) as mentionCount\n      OPTIONAL MATCH (d)-[:HAS_PROBLEM]->(p:Problem {status: 'in_progress'})\n      RETURN d.id as id, \n             d.brand as brand, \n             d.model as model, \n             d.owner_label as owner_label,\n             lastMentioned,\n             mentionCount,\n             p IS NOT NULL as hasActiveRepair\n      ORDER BY \n        CASE WHEN lastMentioned IS NOT NULL THEN 0 ELSE 1 END,\n        lastMentioned DESC,\n        hasActiveRepair DESC,\n        mentionCount DESC\n    `,\n    parameters: { clientId: $json.clientId }\n  }]\n}) }}","options":{"allowUnauthorizedCerts":true,"timeout":30000}},"id":"f0268ddb-fbce-4b58-a2d3-14e7b485035c","name":"Neo4j Disambiguation","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-272,48],"credentials":{"httpBasicAuth":{"id":"bkJBnz7p38fXY4AN","name":"Neo4j"}}},{"parameters":{"method":"POST","url":"http://45.144.177.128:7474/db/neo4j/tx/commit","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({\n  statements: [{\n    statement: `\n      MATCH (c:Client {id: $clientId})-[:OWNS]->(d:Device)\n      WHERE ($brand IS NULL OR toLower(d.brand) CONTAINS toLower($brand))\n        AND ($model IS NULL OR toLower(d.model) CONTAINS toLower($model))\n        AND ($ownerLabel IS NULL OR toLower(d.owner_label) = toLower($ownerLabel))\n      OPTIONAL MATCH (d)-[:HAS_PROBLEM]->(p:Problem)\n      WHERE $problemType IS NULL OR p.type = $problemType\n      OPTIONAL MATCH (t:Touchpoint)-[:ABOUT_DEVICE]->(d)\n      WHERE t.timestamp > datetime() - duration('P1D')\n      WITH d, \n           collect(DISTINCT {id: p.id, type: p.type, status: p.status}) as problems,\n           max(t.timestamp) as lastMentioned,\n           count(t) as mentionCount\n      RETURN d.id as deviceId,\n             d.brand as brand,\n             d.model as model,\n             d.owner_label as ownerLabel,\n             problems,\n             lastMentioned,\n             mentionCount\n      ORDER BY \n        CASE WHEN lastMentioned IS NOT NULL THEN 0 ELSE 1 END,\n        lastMentioned DESC,\n        mentionCount DESC\n    `,\n    parameters: { \n      clientId: $json.clientId,\n      brand: $json.extracted.brand,\n      model: $json.extracted.model,\n      ownerLabel: $json.extracted.ownerLabel,\n      problemType: $json.extracted.problemType\n    }\n  }]\n}) }}","options":{"allowUnauthorizedCerts":true,"timeout":30000}},"id":"0c2323b8-a82d-4975-a5b1-eb18d5006b1e","name":"Neo4j Match Entities","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-272,192],"credentials":{"httpBasicAuth":{"id":"bkJBnz7p38fXY4AN","name":"Neo4j"}}},{"parameters":{"operation":"get","key":"=dialog:{{$json.dialogId}}","options":{}},"id":"a1acd9c7-18a9-45f2-bd45-ad517e3b142d","name":"Redis Load Context","type":"n8n-nodes-base.redis","typeVersion":1,"position":[-272,352],"credentials":{"redis":{"id":"7FQcEivUY94atW24","name":"Redis account"}},"onError":"continueErrorOutput"},{"parameters":{"jsCode":"const result = $json;\nconst data = result.results?.[0]?.data?.[0]?.row || [];\nconst traceId = $('Parse Request').first().json.traceId;\n\nreturn {\n  success: true,\n  client: data[0],\n  devices: data[1] || [],\n  problems: data[2] || [],\n  channels: data[3] || [],\n  verticals: data[4] || [],\n  trace_id: traceId\n};"},"id":"e9b3874f-edd3-46aa-8774-793038f8e727","name":"Format Context","type":"n8n-nodes-base.code","typeVersion":2,"position":[-48,-112]},{"parameters":{"jsCode":"const result = $json;\nconst data = result.results?.[0]?.data || [];\nconst traceId = $('Parse Request').first().json.traceId;\n\nconst devices = data.map(d => ({\n  id: d.row[0],\n  brand: d.row[1],\n  model: d.row[2],\n  owner_label: d.row[3],\n  lastMentioned: d.row[4],\n  mentionCount: d.row[5],\n  hasActiveRepair: d.row[6]\n}));\n\nlet needsClarification = false;\nlet suggestedDevice = null;\nlet clarificationReason = null;\n\nif (devices.length === 0) {\n  needsClarification = false;\n} else if (devices.length === 1) {\n  suggestedDevice = devices[0];\n} else {\n  const recentlyMentioned = devices.filter(d => d.lastMentioned);\n  \n  if (recentlyMentioned.length === 1) {\n    suggestedDevice = recentlyMentioned[0];\n  } else if (recentlyMentioned.length > 1) {\n    needsClarification = true;\n    clarificationReason = 'multiple_mentioned_today';\n  } else {\n    const withActiveRepair = devices.filter(d => d.hasActiveRepair);\n    if (withActiveRepair.length === 1) {\n      suggestedDevice = withActiveRepair[0];\n    } else {\n      needsClarification = true;\n      clarificationReason = 'none_mentioned_recently';\n    }\n  }\n}\n\nreturn {\n  success: true,\n  devices,\n  needsClarification,\n  suggestedDevice,\n  clarificationReason,\n  trace_id: traceId\n};"},"id":"2a0c7fa5-3958-481c-8fc7-b56f2a841fc1","name":"Format Disambiguation","type":"n8n-nodes-base.code","typeVersion":2,"position":[-48,48]},{"parameters":{"jsCode":"const result = $json;\nconst inputData = $('Parse Request').first()?.json || {};\nconst extracted = inputData.extracted || {};\nconst currentFocus = inputData.currentFocus || {};\nconst traceId = inputData.traceId;\n\nconst data = result.results?.[0]?.data || [];\n\nconst matchedDevices = data.map(d => ({\n  deviceId: d.row[0],\n  brand: d.row[1],\n  model: d.row[2],\n  ownerLabel: d.row[3],\n  problems: d.row[4] || [],\n  lastMentioned: d.row[5],\n  mentionCount: d.row[6]\n}));\n\nlet deviceAction = 'create_new';\nlet matchedDeviceId = null;\nlet matchedDevice = null;\nlet problemAction = 'create_new';\nlet matchedProblemId = null;\nlet needsClarification = false;\nlet clarificationReason = null;\n\nif (!extracted.brand && !extracted.model) {\n  if (currentFocus.device_id) {\n    deviceAction = 'use_focus';\n    matchedDeviceId = currentFocus.device_id;\n  } else if (matchedDevices.length === 1) {\n    deviceAction = 'use_existing';\n    matchedDeviceId = matchedDevices[0].deviceId;\n    matchedDevice = matchedDevices[0];\n  } else if (matchedDevices.length > 1) {\n    deviceAction = 'needs_clarification';\n    needsClarification = true;\n    clarificationReason = 'multiple_devices_no_context';\n  }\n} else if (matchedDevices.length === 0) {\n  deviceAction = 'create_new';\n} else if (matchedDevices.length === 1) {\n  deviceAction = 'use_existing';\n  matchedDeviceId = matchedDevices[0].deviceId;\n  matchedDevice = matchedDevices[0];\n} else {\n  const recentlyMentioned = matchedDevices.filter(d => d.lastMentioned);\n  \n  if (recentlyMentioned.length === 1) {\n    deviceAction = 'use_existing';\n    matchedDeviceId = recentlyMentioned[0].deviceId;\n    matchedDevice = recentlyMentioned[0];\n  } else {\n    deviceAction = 'needs_clarification';\n    needsClarification = true;\n    clarificationReason = 'multiple_similar_devices';\n  }\n}\n\nif (extracted.problemType && matchedDevice) {\n  const existingProblem = matchedDevice.problems.find(\n    p => p.type === extracted.problemType && p.status !== 'closed'\n  );\n  \n  if (existingProblem) {\n    problemAction = 'use_existing';\n    matchedProblemId = existingProblem.id;\n  } else {\n    problemAction = 'create_new';\n  }\n} else if (!extracted.problemType) {\n  problemAction = 'none';\n}\n\nreturn {\n  success: true,\n  device: {\n    action: deviceAction,\n    matched_id: matchedDeviceId,\n    matched_device: matchedDevice,\n    all_matches: matchedDevices\n  },\n  problem: {\n    action: problemAction,\n    matched_id: matchedProblemId\n  },\n  needs_clarification: needsClarification,\n  clarification_reason: clarificationReason,\n  extracted,\n  current_focus: currentFocus,\n  trace_id: traceId\n};"},"id":"d33568fd-0d57-499f-8c3a-bf596de6e4ee","name":"Format Match Result","type":"n8n-nodes-base.code","typeVersion":2,"position":[-48,192]},{"parameters":{"jsCode":"const redisResult = $json;\nconst inputData = $('Parse Request').first()?.json || {};\nconst traceId = inputData.traceId;\nconst dialogId = inputData.dialogId;\n\nlet dialogContext = null;\nlet found = false;\n\nif (redisResult.value) {\n  try {\n    dialogContext = JSON.parse(redisResult.value);\n    found = true;\n  } catch (e) {\n    dialogContext = null;\n  }\n}\n\nreturn {\n  success: true,\n  found: found,\n  dialog_id: dialogId,\n  context: dialogContext,\n  trace_id: traceId\n};"},"id":"89e8628e-9281-4610-ba9e-40a43226fdc7","name":"Format Dialog Context","type":"n8n-nodes-base.code","typeVersion":2,"position":[-48,352]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{"responseCode":200,"responseHeaders":{"entries":[{"name":"Access-Control-Allow-Origin","value":"*"}]}}},"id":"e31a18c8-9f43-436d-ae45-3a8de9939820","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[288,96]}],"connections":{"Webhook":{"main":[[{"node":"Parse Request","type":"main","index":0}]]},"Parse Request":{"main":[[{"node":"Route by Action","type":"main","index":0}]]},"Route by Action":{"main":[[{"node":"Neo4j Get Context","type":"main","index":0}],[{"node":"Neo4j Disambiguation","type":"main","index":0}],[{"node":"Neo4j Match Entities","type":"main","index":0}],[{"node":"Redis Load Context","type":"main","index":0}]]},"Neo4j Get Context":{"main":[[{"node":"Format Context","type":"main","index":0}]]},"Neo4j Disambiguation":{"main":[[{"node":"Format Disambiguation","type":"main","index":0}]]},"Neo4j Match Entities":{"main":[[{"node":"Format Match Result","type":"main","index":0}]]},"Redis Load Context":{"main":[[{"node":"Format Dialog Context","type":"main","index":0}],[{"node":"Format Dialog Context","type":"main","index":0}]]},"Format Context":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Format Disambiguation":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Format Match Result":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Format Dialog Context":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"b7c5b2d2-58de-4757-9b84-413521926917","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2025-12-15T17:26:01.908Z","createdAt":"2025-12-15T17:26:01.908Z","role":"workflow:owner","workflowId":"8oyOJpnE7Cc0D27C","projectId":"x7frUSUEowDAk8Dt"}],"activeVersion":null,"tags":[{"updatedAt":"2025-12-12T08:39:41.170Z","createdAt":"2025-12-12T08:39:41.170Z","id":"8dihLRJvdhkW2kZ1","name":"AI"},{"updatedAt":"2025-12-09T18:50:08.518Z","createdAt":"2025-12-09T18:50:08.518Z","id":"tMSCjbvPU3xrNUqz","name":"ELO"}]},{"updatedAt":"2025-12-21T11:28:23.000Z","createdAt":"2025-12-12T09:48:01.859Z","id":"A924a25CTS3CiJ0N","name":"ELO_Out_Router","active":false,"isArchived":true,"nodes":[{"parameters":{"httpMethod":"POST","path":"elo-out-router","responseMode":"responseNode","options":{}},"id":"22549e3f-74da-4b07-8fe7-601337909bdf","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-816,-16],"webhookId":"elo-out-router"},{"parameters":{"jsCode":"const input = $input.first().json;\n\n// Channel mapping\nconst CHANNELS = {\n  1: { name: 'telegram', webhook: 'elo-out-telegram' },\n  2: { name: 'whatsapp', webhook: 'elo-out-whatsapp' },\n  3: { name: 'avito', webhook: 'elo-out-avito' },\n  4: { name: 'vk', webhook: 'elo-out-vk' },\n  5: { name: 'max', webhook: 'elo-out-max' }\n};\n\nconst channelId = input.channel_id;\nconst channel = CHANNELS[channelId];\n\nif (!channel) {\n  throw new Error(`Unknown channel_id: ${channelId}`);\n}\n\nreturn {\n  ...input,\n  _routing: {\n    channel_id: channelId,\n    channel_name: channel.name,\n    webhook: channel.webhook,\n    webhook_url: `https://n8n.n8nsrv.ru/webhook/${channel.webhook}`\n  }\n};"},"id":"e8964568-779d-4320-bb44-c151da8a8a53","name":"Determine Channel","type":"n8n-nodes-base.code","typeVersion":2,"position":[-608,-16]},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"leftValue":"={{ $json._routing.channel_id }}","rightValue":1,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Telegram"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"leftValue":"={{ $json._routing.channel_id }}","rightValue":2,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"WhatsApp"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"leftValue":"={{ $json._routing.channel_id }}","rightValue":3,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Avito"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"leftValue":"={{ $json._routing.channel_id }}","rightValue":4,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"VK"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"leftValue":"={{ $json._routing.channel_id }}","rightValue":5,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"MAX"}]},"options":{"fallbackOutput":"extra"}},"id":"05d09374-2248-42b4-acfe-e2a80ca8888b","name":"Switch Channel","type":"n8n-nodes-base.switch","typeVersion":3,"position":[-368,-80]},{"parameters":{"respondWith":"json","responseBody":"={{ { sent: true, channel: $json._routing?.channel_name || 'unknown', trace_id: $json.trace_id } }}","options":{}},"id":"e91af3ff-9055-4123-b53c-60acb25ff521","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[336,-16]},{"parameters":{"workflowId":{"__rl":true,"mode":"name","value":"ELO_Out_Telegram"},"options":{"waitForSubWorkflow":true}},"id":"23660263-5a8e-448c-9167-2e8efa9140ab","name":"Call ELO_Out_Telegram","type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[-48,-336]},{"parameters":{"workflowId":{"__rl":true,"mode":"name","value":"ELO_Out_WhatsApp"},"options":{"waitForSubWorkflow":true}},"id":"2fddaf7b-c353-44f0-abe1-b00c206666ef","name":"Call ELO_Out_WhatsApp","type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[-48,-208]},{"parameters":{"workflowId":{"__rl":true,"mode":"name","value":"ELO_Out_Avito"},"options":{"waitForSubWorkflow":true}},"id":"0cbaebe7-c464-4234-b841-cd6ed82a85de","name":"Call ELO_Out_Avito","type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[-48,-96]},{"parameters":{"workflowId":{"__rl":true,"mode":"name","value":"ELO_Out_VK"},"options":{"waitForSubWorkflow":true}},"id":"f9e37e34-0b4b-4582-82f1-35ecb06a62a8","name":"Call ELO_Out_VK","type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[-48,32]},{"parameters":{"workflowId":{"__rl":true,"mode":"name","value":"ELO_Out_MAX"},"options":{"waitForSubWorkflow":true}},"id":"aa0b92f5-ae2d-4e56-b503-38f435c2db99","name":"Call ELO_Out_MAX","type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[-48,144]},{"parameters":{"jsCode":"const input = $input.first().json;\nthrow new Error(`Unknown channel_id: ${input.channel_id}. Expected 1-5.`);"},"id":"0855e0c5-766e-4573-aaca-a6b25f0f83f9","name":"Error Unknown Channel","type":"n8n-nodes-base.code","typeVersion":2,"position":[-48,272]}],"connections":{"Webhook":{"main":[[{"node":"Determine Channel","type":"main","index":0}]]},"Determine Channel":{"main":[[{"node":"Switch Channel","type":"main","index":0}]]},"Switch Channel":{"main":[[{"node":"Call ELO_Out_Telegram","type":"main","index":0}],[{"node":"Call ELO_Out_WhatsApp","type":"main","index":0}],[{"node":"Call ELO_Out_Avito","type":"main","index":0}],[{"node":"Call ELO_Out_VK","type":"main","index":0}],[{"node":"Call ELO_Out_MAX","type":"main","index":0}],[{"node":"Error Unknown Channel","type":"main","index":0}]]},"Call ELO_Out_Telegram":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Call ELO_Out_WhatsApp":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Call ELO_Out_Avito":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Call ELO_Out_VK":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Call ELO_Out_MAX":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Error Unknown Channel":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"d4707d3b-9bdf-4d8f-b651-0919569a59c9","activeVersionId":null,"triggerCount":1,"shared":[{"updatedAt":"2025-12-12T09:48:01.878Z","createdAt":"2025-12-12T09:48:01.878Z","role":"workflow:owner","workflowId":"A924a25CTS3CiJ0N","projectId":"x7frUSUEowDAk8Dt"}],"activeVersion":null,"tags":[{"updatedAt":"2025-11-23T04:03:34.766Z","createdAt":"2025-11-23T04:03:34.766Z","id":"IbDkJphbr4EygdRZ","name":"Out"},{"updatedAt":"2025-12-09T18:50:08.518Z","createdAt":"2025-12-09T18:50:08.518Z","id":"tMSCjbvPU3xrNUqz","name":"ELO"}]},{"updatedAt":"2025-12-20T18:47:31.438Z","createdAt":"2025-12-12T09:11:54.134Z","id":"DgnJMtf2Qu6LCha5","name":"ELO_Core_AI_Test_Stub","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"elo-core-ingest","responseMode":"responseNode","options":{}},"id":"345dd5f7-ea31-48f9-b9cf-d663c93d4004","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-192,-48],"webhookId":"elo-core-ingest"},{"parameters":{"jsCode":"const raw = $input.first().json;\n  const input = raw.body || raw;\n\n  console.log('=== ELO_Core_AI_Test_Stub ===');\n  console.log('Received:', JSON.stringify(input, null, 2));\n\n  const response = {\n    tenant_id: input.tenant_id,\n    dialog_id: input.dialog_id,\n    channel_id: input.channel_id,\n    external_chat_id: input.external_chat_id,\n\n    message: {\n      text: `[TEST] Получено: \"${input.text || 'пусто'}\"`,\n      buttons: [],\n      attachments: []\n    },\n\n    context_updated: true,\n    trace_id: input.trace_id || `trace_${Date.now()}`,\n\n    _debug: {\n      received_at: new Date().toISOString(),\n      input_keys: Object.keys(input),\n      client: input.client,\n      meta: input.meta\n    }\n  };\n\n  return response;"},"id":"93bf5bda-53f2-4a4d-a7f4-eb9bcb4e3ba7","name":"Build Test Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[32,-48]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"2c6082a8-da90-4288-a1d4-f07ab8e98bdf","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1136,-48]},{"parameters":{"operation":"executeQuery","query":"SELECT\n    od.fcm_token,\n    od.operator_id,\n    o.name as operator_name\n  FROM elo_t_operator_devices od\n  JOIN elo_t_operators o ON o.id = od.operator_id\n  WHERE od.tenant_id = '{{ $json.tenant_id }}'::uuid\n    AND od.fcm_token IS NOT NULL\n    AND od.device_type = 'mobile'\n    AND o.is_active = true;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[240,-48],"id":"f0da0f63-d9bb-47d3-ac05-cd65a814d669","name":"Get Operator FCM Tokens","credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"jsCode":" const crypto = require('crypto');\n\n  const keyLines = [\n    \"-----BEGIN PRIVATE KEY-----\",\n    \"MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQCujR+Wss/CQ9JV\",\n    \"dJiwwy0pH9kR2Yr1MYZNBZEPC+BBiZLKUhoIP04TMjuXHQlsuKwfRGUDBO2dKBcv\",\n    \"MHKJ3iezYiroyrIkSz+/CPEHlRcjdgwH8tlQYadLpxKbYqrEGqU3+U+CDDeQTKhB\",\n    \"x89220TSx51UodQZIhcuv9zoiXWkbNam8TBveVKyuyaob9PNBF2XmauKZjf8tC1x\",\n    \"ld15l2VJBkqBKYuO/IrRnIBF7K7vi/UmHQGbi1l4PUsHHGj7/64T0DcJoK/02uBz\",\n    \"0ZOFRTKmwesq7ANug+P76wgni4OBxluupwGUW+dSOjWlAe7Fyy6NtylxzMygC6GZ\",\n    \"Yqy2XR6LAgMBAAECggEASt07UaqyofrtwPonrRShD3TZ6KZ5y20o0WsUSrRIxEMp\",\n    \"or3w7V2dcm1GkqsBClDwfd6bRl68PP3fZ71rOsd+FpmBluOs4RUnK5u9qQdga7Sr\",\n    \"N1OIskmX88IeIGgCnuZgu2+iEsCDqk++kKwOxscHrzGvQIfCDN+KuuHOcSvXuaPA\",\n    \"aWy/R+c98/8pMyii06T3uOqV90RfVuEDlfrWfzhh/vDxKWF7ywwbfZMJVMgBhMb+\",\n    \"j4M1SUSw+2uubhWRpQT8qrsHo00jUnDKMjmEZ9lvYvMeLrcL72a0oXKAbSxJi9Wm\",\n    \"Czz3UYpDYIoOmcJe8aaCQ2fOsEuzTZvVUMKxwe9cmQKBgQDqP5A1QgAFqUOnp2Hf\",\n    \"983/rkPlFDqQjcZqPSf2KxPNPyWmEOOPA6dGhbB5EMPS7SXgzDiLHW7vxRqX8olA\",\n    \"pn5xxrpG7hWJYjjAM9EVTX3dsjJWlgLWL5G8TK+dLLvlLs9+bkh/U4uqd/LhzlRG\",\n    \"MGe37cEILoXNeH4/rEVOnwEWWQKBgQC+wnikB9BX3kXq019Yz3jP8sbcQwvzGxTP\",\n    \"wCKwXWIbo9PrCsJW8O3KdDMvuWz7NGrZSdxU5krp8T47qgMDvAS0w9COxHkEMhCU\",\n    \"zvmf73BOkmwYm0G5QvKJiOgAurJEb5QZL0+EaV+Lxquuty4a8B0tMPsGPoiGVKpU\",\n    \"5HeM7PxHgwKBgGld1BkQqf/h5ku4b78VsTSMB4A4fCtfiltpTNte/xY4jE/JkwJW\",\n    \"a1y+b+XVE7CB+aLHWbvBro/tggvNDc3l1kSJVmrnVwqoAsz5wdeqNq6NJDVsXrRH\",\n    \"S29+sxOo9o+dYboGE1gqlU1FjRvi+mdkCJNkP4rVmlwVEfzEGZzGyu9pAoGBAJ7G\",\n    \"FsvQhSTdqKwviqjM5u2OUN58H7IU1Fmmvji1QTdoQLbdmavrlMBxvzj1yTO9CUIa\",\n    \"K/2uQKQ/W2ElvKSbFf+vDCQIfAF1+j8hlrv7+yoqzTYd47JjeqPnA9O3kTFM/aOI\",\n    \"sVKwsgoRLkyZwxJA0MgQgJ9N5SyJw8ws7SSrC8ApAoGBANB0UpLkoKvo5GEtqiLn\",\n    \"RHsaMa9U7w1Crbvm4JR5RhTe80kNVNx7znVXanyPOE3Qe251bHtSR2Qx1g1a52wx\",\n    \"r0eXgjwLIFtzt3ZmFLFGZ4bdrtxqTdHJDQFWamW1Y7K5w5kYyD3m3ISKjJrlePTU\",\n    \"Z6m4wqgHK1aErtx1REV9qsqb\",\n    \"-----END PRIVATE KEY-----\"\n  ];\n\n  const privateKeyPem = keyLines.join(\"\\n\");\n  const clientEmail = \"firebase-adminsdk-fbsvc@eldoleado.iam.gserviceaccount.com\";\n\n  const now = Math.floor(Date.now() / 1000);\n\n  const header = JSON.stringify({ alg: \"RS256\", typ: \"JWT\" });\n  const payload = JSON.stringify({\n    iss: clientEmail,\n    scope: \"https://www.googleapis.com/auth/firebase.messaging\",\n    aud: \"https://oauth2.googleapis.com/token\",\n    iat: now,\n    exp: now + 3600\n  });\n\n  const base64Header = Buffer.from(header).toString(\"base64url\");\n  const base64Payload = Buffer.from(payload).toString(\"base64url\");\n  const signatureInput = base64Header + \".\" + base64Payload;\n\n  const privateKey = crypto.createPrivateKey(privateKeyPem);\n  const sign = crypto.createSign(\"SHA256\");\n  sign.update(signatureInput);\n  const signature = sign.sign(privateKey, \"base64url\");\n\n  const jwt = signatureInput + \".\" + signature;\n\n  return $input.all().map(item => ({\n    json: {\n      ...item.json,\n      jwt: jwt\n    }\n  }));"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[448,-48],"id":"590df8d7-1528-41ff-868b-675920df13b3","name":"Generate JWT"},{"parameters":{"method":"POST","url":"https://fcm.googleapis.com/v1/projects/eldoleado/messages:send","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer  {{ $json.access_token }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n    \"message\": {\n      \"token\": \"{{ $('Generate JWT').first().json.fcm_token }}\",\n      \"notification\": {\n        \"title\": \"Новое сообщение\",\n        \"body\": \"{{ $('Webhook').first().json.text ? $('Webhook').first().json.text.substring(0, 100) : 'Новое сообщение' }}\"\n      },\n      \"data\": {\n        \"dialog_id\": \"{{ $('Webhook').first().json.dialog_id || '' }}\",\n        \"tenant_id\": \"{{ $('Webhook').first().json.tenant_id || '' }}\",\n        \"type\": \"new_message\"\n      },\n      \"android\": {\n        \"priority\": \"high\"\n      }\n    }\n  }","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[864,-48],"id":"e38e6ae5-7126-415b-82ea-2a6503eec3ec","name":"Send FCM Push"},{"parameters":{"method":"POST","url":"https://oauth2.googleapis.com/token","sendBody":true,"contentType":"form-urlencoded","bodyParameters":{"parameters":[{"name":"grant_type","value":"urn:ietf:params:oauth:grant-type:jwt-bearer"},{"name":"assertion","value":"={{ $json.jwt }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[656,-48],"id":"ffb06aa0-89ca-4475-9b37-cd561661bcfd","name":"Get Access Token"}],"connections":{"Webhook":{"main":[[{"node":"Build Test Response","type":"main","index":0}]]},"Build Test Response":{"main":[[{"node":"Get Operator FCM Tokens","type":"main","index":0}]]},"Get Operator FCM Tokens":{"main":[[{"node":"Generate JWT","type":"main","index":0}]]},"Generate JWT":{"main":[[{"node":"Get Access Token","type":"main","index":0}]]},"Send FCM Push":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Get Access Token":{"main":[[{"node":"Send FCM Push","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"Webhook":[{"json":{"headers":{"host":"n8n.n8nsrv.ru","user-agent":"axios/1.12.0","content-length":"1467","accept":"application/json,text/html,application/xhtml+xml,application/xml,text/*;q=0.9, image/*;q=0.8, */*;q=0.7","accept-encoding":"gzip, compress, deflate, br","content-type":"application/json","via":"1.1 Caddy","x-forwarded-for":"172.19.0.1","x-forwarded-host":"n8n.n8nsrv.ru","x-forwarded-proto":"https"},"params":{},"query":{},"body":{"tenant_id":"11111111-1111-1111-1111-111111111111","domain_id":1,"client_id":"8447d05d-6bad-4247-a1d6-0901675284ca","dialog_id":"cff56064-1fc3-4152-8e64-6e0266a87bf6","channel_id":2,"external_chat_id":"79997253777@s.whatsapp.net","text":"Куку\n\nПривет","timestamp":"2025-12-20T13:16:24.000Z","message_ids":["3A59419A0DA30EC89501","3A2C4194C6D3F6875BDF"],"trace_id":"trace_1766248589245","media":{"items":[{"has_voice":false,"voice_transcribed_text":null,"has_images":false,"images":[],"has_video":false,"videos":[],"has_document":false},{"has_voice":false,"voice_transcribed_text":null,"has_images":false,"images":[],"has_video":false,"videos":[],"has_document":false}]},"meta":{"external_message_id":"3A2C4194C6D3F6875BDF","ad_channel":"whatsapp","ad_id":null,"original_media_type":"text","raw":{"event":"message","sessionId":"eldoleado_main","sessionHash":"f209755183150c5a","timestamp":1766236584255,"data":{"sessionId":"eldoleado_main","sessionHash":"f209755183150c5a","messageId":"3A2C4194C6D3F6875BDF","from":"79997253777","fromName":"Дмитрий","to":"79997253777","isGroup":false,"timestamp":1766236584000,"type":"text","text":"Привет"}},"provider":"baileys","batched":true,"batch_size":2,"batch_reason":"orphan","is_new_client":false,"is_new_dialog":false,"tenant_from_cache":true,"client_from_cache":false,"dialog_from_cache":false},"client":{"id":"8447d05d-6bad-4247-a1d6-0901675284ca","name":"Дмитрий","phone":"+79997253777"}},"webhookUrl":"https://n8n.n8nsrv.ru/webhook/elo-core-ingest","executionMode":"production"},"pairedItem":{"item":0}}]},"versionId":"2f89cd91-54bb-4520-ab8d-4dad188890df","activeVersionId":"2f89cd91-54bb-4520-ab8d-4dad188890df","triggerCount":1,"shared":[{"updatedAt":"2025-12-12T09:11:54.144Z","createdAt":"2025-12-12T09:11:54.144Z","role":"workflow:owner","workflowId":"DgnJMtf2Qu6LCha5","projectId":"x7frUSUEowDAk8Dt"}],"activeVersion":{"updatedAt":"2025-12-20T18:47:31.440Z","createdAt":"2025-12-20T18:47:31.440Z","versionId":"2f89cd91-54bb-4520-ab8d-4dad188890df","workflowId":"DgnJMtf2Qu6LCha5","nodes":[{"parameters":{"httpMethod":"POST","path":"elo-core-ingest","responseMode":"responseNode","options":{}},"id":"345dd5f7-ea31-48f9-b9cf-d663c93d4004","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-192,-48],"webhookId":"elo-core-ingest"},{"parameters":{"jsCode":"const raw = $input.first().json;\n  const input = raw.body || raw;\n\n  console.log('=== ELO_Core_AI_Test_Stub ===');\n  console.log('Received:', JSON.stringify(input, null, 2));\n\n  const response = {\n    tenant_id: input.tenant_id,\n    dialog_id: input.dialog_id,\n    channel_id: input.channel_id,\n    external_chat_id: input.external_chat_id,\n\n    message: {\n      text: `[TEST] Получено: \"${input.text || 'пусто'}\"`,\n      buttons: [],\n      attachments: []\n    },\n\n    context_updated: true,\n    trace_id: input.trace_id || `trace_${Date.now()}`,\n\n    _debug: {\n      received_at: new Date().toISOString(),\n      input_keys: Object.keys(input),\n      client: input.client,\n      meta: input.meta\n    }\n  };\n\n  return response;"},"id":"93bf5bda-53f2-4a4d-a7f4-eb9bcb4e3ba7","name":"Build Test Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[32,-48]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"2c6082a8-da90-4288-a1d4-f07ab8e98bdf","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1136,-48]},{"parameters":{"operation":"executeQuery","query":"SELECT\n    od.fcm_token,\n    od.operator_id,\n    o.name as operator_name\n  FROM elo_t_operator_devices od\n  JOIN elo_t_operators o ON o.id = od.operator_id\n  WHERE od.tenant_id = '{{ $json.tenant_id }}'::uuid\n    AND od.fcm_token IS NOT NULL\n    AND od.device_type = 'mobile'\n    AND o.is_active = true;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[240,-48],"id":"f0da0f63-d9bb-47d3-ac05-cd65a814d669","name":"Get Operator FCM Tokens","credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"jsCode":" const crypto = require('crypto');\n\n  const keyLines = [\n    \"-----BEGIN PRIVATE KEY-----\",\n    \"MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQCujR+Wss/CQ9JV\",\n    \"dJiwwy0pH9kR2Yr1MYZNBZEPC+BBiZLKUhoIP04TMjuXHQlsuKwfRGUDBO2dKBcv\",\n    \"MHKJ3iezYiroyrIkSz+/CPEHlRcjdgwH8tlQYadLpxKbYqrEGqU3+U+CDDeQTKhB\",\n    \"x89220TSx51UodQZIhcuv9zoiXWkbNam8TBveVKyuyaob9PNBF2XmauKZjf8tC1x\",\n    \"ld15l2VJBkqBKYuO/IrRnIBF7K7vi/UmHQGbi1l4PUsHHGj7/64T0DcJoK/02uBz\",\n    \"0ZOFRTKmwesq7ANug+P76wgni4OBxluupwGUW+dSOjWlAe7Fyy6NtylxzMygC6GZ\",\n    \"Yqy2XR6LAgMBAAECggEASt07UaqyofrtwPonrRShD3TZ6KZ5y20o0WsUSrRIxEMp\",\n    \"or3w7V2dcm1GkqsBClDwfd6bRl68PP3fZ71rOsd+FpmBluOs4RUnK5u9qQdga7Sr\",\n    \"N1OIskmX88IeIGgCnuZgu2+iEsCDqk++kKwOxscHrzGvQIfCDN+KuuHOcSvXuaPA\",\n    \"aWy/R+c98/8pMyii06T3uOqV90RfVuEDlfrWfzhh/vDxKWF7ywwbfZMJVMgBhMb+\",\n    \"j4M1SUSw+2uubhWRpQT8qrsHo00jUnDKMjmEZ9lvYvMeLrcL72a0oXKAbSxJi9Wm\",\n    \"Czz3UYpDYIoOmcJe8aaCQ2fOsEuzTZvVUMKxwe9cmQKBgQDqP5A1QgAFqUOnp2Hf\",\n    \"983/rkPlFDqQjcZqPSf2KxPNPyWmEOOPA6dGhbB5EMPS7SXgzDiLHW7vxRqX8olA\",\n    \"pn5xxrpG7hWJYjjAM9EVTX3dsjJWlgLWL5G8TK+dLLvlLs9+bkh/U4uqd/LhzlRG\",\n    \"MGe37cEILoXNeH4/rEVOnwEWWQKBgQC+wnikB9BX3kXq019Yz3jP8sbcQwvzGxTP\",\n    \"wCKwXWIbo9PrCsJW8O3KdDMvuWz7NGrZSdxU5krp8T47qgMDvAS0w9COxHkEMhCU\",\n    \"zvmf73BOkmwYm0G5QvKJiOgAurJEb5QZL0+EaV+Lxquuty4a8B0tMPsGPoiGVKpU\",\n    \"5HeM7PxHgwKBgGld1BkQqf/h5ku4b78VsTSMB4A4fCtfiltpTNte/xY4jE/JkwJW\",\n    \"a1y+b+XVE7CB+aLHWbvBro/tggvNDc3l1kSJVmrnVwqoAsz5wdeqNq6NJDVsXrRH\",\n    \"S29+sxOo9o+dYboGE1gqlU1FjRvi+mdkCJNkP4rVmlwVEfzEGZzGyu9pAoGBAJ7G\",\n    \"FsvQhSTdqKwviqjM5u2OUN58H7IU1Fmmvji1QTdoQLbdmavrlMBxvzj1yTO9CUIa\",\n    \"K/2uQKQ/W2ElvKSbFf+vDCQIfAF1+j8hlrv7+yoqzTYd47JjeqPnA9O3kTFM/aOI\",\n    \"sVKwsgoRLkyZwxJA0MgQgJ9N5SyJw8ws7SSrC8ApAoGBANB0UpLkoKvo5GEtqiLn\",\n    \"RHsaMa9U7w1Crbvm4JR5RhTe80kNVNx7znVXanyPOE3Qe251bHtSR2Qx1g1a52wx\",\n    \"r0eXgjwLIFtzt3ZmFLFGZ4bdrtxqTdHJDQFWamW1Y7K5w5kYyD3m3ISKjJrlePTU\",\n    \"Z6m4wqgHK1aErtx1REV9qsqb\",\n    \"-----END PRIVATE KEY-----\"\n  ];\n\n  const privateKeyPem = keyLines.join(\"\\n\");\n  const clientEmail = \"firebase-adminsdk-fbsvc@eldoleado.iam.gserviceaccount.com\";\n\n  const now = Math.floor(Date.now() / 1000);\n\n  const header = JSON.stringify({ alg: \"RS256\", typ: \"JWT\" });\n  const payload = JSON.stringify({\n    iss: clientEmail,\n    scope: \"https://www.googleapis.com/auth/firebase.messaging\",\n    aud: \"https://oauth2.googleapis.com/token\",\n    iat: now,\n    exp: now + 3600\n  });\n\n  const base64Header = Buffer.from(header).toString(\"base64url\");\n  const base64Payload = Buffer.from(payload).toString(\"base64url\");\n  const signatureInput = base64Header + \".\" + base64Payload;\n\n  const privateKey = crypto.createPrivateKey(privateKeyPem);\n  const sign = crypto.createSign(\"SHA256\");\n  sign.update(signatureInput);\n  const signature = sign.sign(privateKey, \"base64url\");\n\n  const jwt = signatureInput + \".\" + signature;\n\n  return $input.all().map(item => ({\n    json: {\n      ...item.json,\n      jwt: jwt\n    }\n  }));"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[448,-48],"id":"590df8d7-1528-41ff-868b-675920df13b3","name":"Generate JWT"},{"parameters":{"method":"POST","url":"https://fcm.googleapis.com/v1/projects/eldoleado/messages:send","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer  {{ $json.access_token }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n    \"message\": {\n      \"token\": \"{{ $('Generate JWT').first().json.fcm_token }}\",\n      \"notification\": {\n        \"title\": \"Новое сообщение\",\n        \"body\": \"{{ $('Webhook').first().json.text ? $('Webhook').first().json.text.substring(0, 100) : 'Новое сообщение' }}\"\n      },\n      \"data\": {\n        \"dialog_id\": \"{{ $('Webhook').first().json.dialog_id || '' }}\",\n        \"tenant_id\": \"{{ $('Webhook').first().json.tenant_id || '' }}\",\n        \"type\": \"new_message\"\n      },\n      \"android\": {\n        \"priority\": \"high\"\n      }\n    }\n  }","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[864,-48],"id":"e38e6ae5-7126-415b-82ea-2a6503eec3ec","name":"Send FCM Push"},{"parameters":{"method":"POST","url":"https://oauth2.googleapis.com/token","sendBody":true,"contentType":"form-urlencoded","bodyParameters":{"parameters":[{"name":"grant_type","value":"urn:ietf:params:oauth:grant-type:jwt-bearer"},{"name":"assertion","value":"={{ $json.jwt }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[656,-48],"id":"ffb06aa0-89ca-4475-9b37-cd561661bcfd","name":"Get Access Token"}],"connections":{"Webhook":{"main":[[{"node":"Build Test Response","type":"main","index":0}]]},"Build Test Response":{"main":[[{"node":"Get Operator FCM Tokens","type":"main","index":0}]]},"Get Operator FCM Tokens":{"main":[[{"node":"Generate JWT","type":"main","index":0}]]},"Generate JWT":{"main":[[{"node":"Get Access Token","type":"main","index":0}]]},"Send FCM Push":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Get Access Token":{"main":[[{"node":"Send FCM Push","type":"main","index":0}]]}},"authors":"Dmitriy Remacs","name":null,"description":null},"tags":[{"updatedAt":"2025-12-09T18:50:08.518Z","createdAt":"2025-12-09T18:50:08.518Z","id":"tMSCjbvPU3xrNUqz","name":"ELO"}]},{"updatedAt":"2025-12-20T17:13:57.081Z","createdAt":"2025-12-17T08:46:33.101Z","id":"EIBalgIkj2XP9iGm","name":"ELO_Message_Router","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"router","responseMode":"responseNode","options":{}},"id":"aa5e47d8-6743-4823-a802-c3456beb7f45","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-960,-208],"webhookId":"router-webhook"},{"parameters":{"jsCode":"const msg = $input.item.json.body || $input.item.json;\nconst direction = msg.direction || 'in';\nconst status = msg.status || '';\n\nlet messageType;\nif (direction === 'in') {\n  messageType = 'from_client';\n} else if (direction === 'out') {\n  messageType = (status === 'approved') ? 'approved' : 'from_operator';\n} else {\n  messageType = 'from_client';\n}\n\nreturn {\n  json: {\n    ...msg,\n    _message_type: messageType\n  }\n};"},"id":"7b253383-543a-4b2d-bd00-091d4f68291b","name":"Determine Type","type":"n8n-nodes-base.code","typeVersion":2,"position":[-736,-208]},{"parameters":{"conditions":{"string":[{"value1":"={{ $json._message_type }}","value2":"from_client"}]}},"id":"e58fe2a7-35fa-4ca8-be41-985f0f5126ff","name":"Is From Client?","type":"n8n-nodes-base.if","typeVersion":1,"position":[-512,-208]},{"parameters":{"conditions":{"string":[{"value1":"={{ $json._message_type }}","value2":"approved"}]}},"id":"d2d2d1cc-6d83-4924-b571-5395daa2b1a8","name":"Is Approved?","type":"n8n-nodes-base.if","typeVersion":1,"position":[-512,16]},{"parameters":{"jsCode":"const msg = $input.item.json;\n\nreturn {\n  json: {\n    route_action: 'push_to_operator',\n    payload: {\n      action: 'new_message',\n      message: {\n        id: msg.id,\n        channel: msg.channel,\n        chat_id: msg.chat_id,\n        sender_id: msg.sender_id,\n        sender_name: msg.sender_name,\n        sender_phone: msg.sender_phone,\n        text: msg.text,\n        has_audio: msg.has_audio || false,\n        transcription: msg.transcription,\n        has_media: msg.has_media || false,\n        media_type: msg.media_type,\n        media_url: msg.media_url,\n        media_local_path: msg.media_local_path,\n        timestamp: msg.timestamp,\n        server_id: msg.server_id\n      }\n    }\n  }\n};"},"id":"3582d751-8be4-4a4c-aa0a-758b779ab31a","name":"From Client","type":"n8n-nodes-base.code","typeVersion":2,"position":[-256,-336]},{"parameters":{"method":"POST","url":"https://openrouter.ai/api/v1/chat/completions","authentication":"predefinedCredentialType","nodeCredentialType":"openRouterApi","sendHeaders":true,"headerParameters":{"parameters":[{"name":"HTTP-Referer","value":"https://eldoleado.ru"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"model\": \"google/gemini-2.0-flash-001\",\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"You are a Russian text editor. Fix grammar, spelling, and punctuation errors. Keep the meaning intact. Output ONLY the corrected text, nothing else.\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": {{ JSON.stringify($json.text || '') }}\n    }\n  ],\n  \"max_tokens\": 1000,\n  \"temperature\": 0.1\n}","options":{"timeout":30000}},"id":"f50e0a98-91a2-4dc7-802f-3d7b2353b105","name":"Normalize Text","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-256,128],"credentials":{"openRouterApi":{"id":"ameOTCcGgTm3hbtM","name":"OpenRouter account"}}},{"parameters":{"jsCode":"const msg = $('Determine Type').item.json;\nconst response = $input.item.json;\nconst normalized = response.choices?.[0]?.message?.content?.trim() || msg.text;\n\nreturn {\n  json: {\n    route_action: 'push_to_operator',\n    payload: {\n      action: 'show_draft',\n      message: {\n        id: msg.id,\n        channel: msg.channel,\n        chat_id: msg.chat_id,\n        original_text: msg.text,\n        normalized_text: normalized,\n        timestamp: msg.timestamp,\n        server_id: msg.server_id\n      }\n    }\n  }\n};"},"id":"e7e434f8-2a82-4dd8-82d5-b65a9a206c8b","name":"Build Draft","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,128]},{"parameters":{"jsCode":"const msg = $input.item.json;\n\nreturn {\n  json: {\n    route_action: 'send_to_client',\n    payload: {\n      action: 'send_message',\n      channel: msg.channel,\n      chat_id: msg.chat_id,\n      text: msg.final_text || msg.text,\n      server_id: msg.server_id,\n      message_id: msg.id\n    }\n  }\n};"},"id":"4c03b269-b858-4cc2-8de5-0f7f76b07dd3","name":"Approved","type":"n8n-nodes-base.code","typeVersion":2,"position":[-240,-112]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{}},"id":"7465e5d9-492e-456d-9b65-e656b28e6d5c","name":"Respond","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[176,-112]}],"connections":{"Webhook":{"main":[[{"node":"Determine Type","type":"main","index":0}]]},"Determine Type":{"main":[[{"node":"Is From Client?","type":"main","index":0}]]},"Is From Client?":{"main":[[{"node":"From Client","type":"main","index":0}],[{"node":"Is Approved?","type":"main","index":0}]]},"Is Approved?":{"main":[[{"node":"Approved","type":"main","index":0}],[{"node":"Normalize Text","type":"main","index":0}]]},"From Client":{"main":[[{"node":"Respond","type":"main","index":0}]]},"Normalize Text":{"main":[[{"node":"Build Draft","type":"main","index":0}]]},"Build Draft":{"main":[[{"node":"Respond","type":"main","index":0}]]},"Approved":{"main":[[{"node":"Respond","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"b36d6a19-bd25-4850-af16-3ce4dcbc2e4c","activeVersionId":"b36d6a19-bd25-4850-af16-3ce4dcbc2e4c","triggerCount":1,"shared":[{"updatedAt":"2025-12-17T08:46:33.108Z","createdAt":"2025-12-17T08:46:33.108Z","role":"workflow:owner","workflowId":"EIBalgIkj2XP9iGm","projectId":"x7frUSUEowDAk8Dt"}],"activeVersion":{"updatedAt":"2025-12-20T17:13:57.082Z","createdAt":"2025-12-20T17:13:57.082Z","versionId":"b36d6a19-bd25-4850-af16-3ce4dcbc2e4c","workflowId":"EIBalgIkj2XP9iGm","nodes":[{"parameters":{"httpMethod":"POST","path":"router","responseMode":"responseNode","options":{}},"id":"aa5e47d8-6743-4823-a802-c3456beb7f45","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-960,-208],"webhookId":"router-webhook"},{"parameters":{"jsCode":"const msg = $input.item.json.body || $input.item.json;\nconst direction = msg.direction || 'in';\nconst status = msg.status || '';\n\nlet messageType;\nif (direction === 'in') {\n  messageType = 'from_client';\n} else if (direction === 'out') {\n  messageType = (status === 'approved') ? 'approved' : 'from_operator';\n} else {\n  messageType = 'from_client';\n}\n\nreturn {\n  json: {\n    ...msg,\n    _message_type: messageType\n  }\n};"},"id":"7b253383-543a-4b2d-bd00-091d4f68291b","name":"Determine Type","type":"n8n-nodes-base.code","typeVersion":2,"position":[-736,-208]},{"parameters":{"conditions":{"string":[{"value1":"={{ $json._message_type }}","value2":"from_client"}]}},"id":"e58fe2a7-35fa-4ca8-be41-985f0f5126ff","name":"Is From Client?","type":"n8n-nodes-base.if","typeVersion":1,"position":[-512,-208]},{"parameters":{"conditions":{"string":[{"value1":"={{ $json._message_type }}","value2":"approved"}]}},"id":"d2d2d1cc-6d83-4924-b571-5395daa2b1a8","name":"Is Approved?","type":"n8n-nodes-base.if","typeVersion":1,"position":[-512,16]},{"parameters":{"jsCode":"const msg = $input.item.json;\n\nreturn {\n  json: {\n    route_action: 'push_to_operator',\n    payload: {\n      action: 'new_message',\n      message: {\n        id: msg.id,\n        channel: msg.channel,\n        chat_id: msg.chat_id,\n        sender_id: msg.sender_id,\n        sender_name: msg.sender_name,\n        sender_phone: msg.sender_phone,\n        text: msg.text,\n        has_audio: msg.has_audio || false,\n        transcription: msg.transcription,\n        has_media: msg.has_media || false,\n        media_type: msg.media_type,\n        media_url: msg.media_url,\n        media_local_path: msg.media_local_path,\n        timestamp: msg.timestamp,\n        server_id: msg.server_id\n      }\n    }\n  }\n};"},"id":"3582d751-8be4-4a4c-aa0a-758b779ab31a","name":"From Client","type":"n8n-nodes-base.code","typeVersion":2,"position":[-256,-336]},{"parameters":{"method":"POST","url":"https://openrouter.ai/api/v1/chat/completions","authentication":"predefinedCredentialType","nodeCredentialType":"openRouterApi","sendHeaders":true,"headerParameters":{"parameters":[{"name":"HTTP-Referer","value":"https://eldoleado.ru"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"model\": \"google/gemini-2.0-flash-001\",\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"You are a Russian text editor. Fix grammar, spelling, and punctuation errors. Keep the meaning intact. Output ONLY the corrected text, nothing else.\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": {{ JSON.stringify($json.text || '') }}\n    }\n  ],\n  \"max_tokens\": 1000,\n  \"temperature\": 0.1\n}","options":{"timeout":30000}},"id":"f50e0a98-91a2-4dc7-802f-3d7b2353b105","name":"Normalize Text","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-256,128],"credentials":{"openRouterApi":{"id":"ameOTCcGgTm3hbtM","name":"OpenRouter account"}}},{"parameters":{"jsCode":"const msg = $('Determine Type').item.json;\nconst response = $input.item.json;\nconst normalized = response.choices?.[0]?.message?.content?.trim() || msg.text;\n\nreturn {\n  json: {\n    route_action: 'push_to_operator',\n    payload: {\n      action: 'show_draft',\n      message: {\n        id: msg.id,\n        channel: msg.channel,\n        chat_id: msg.chat_id,\n        original_text: msg.text,\n        normalized_text: normalized,\n        timestamp: msg.timestamp,\n        server_id: msg.server_id\n      }\n    }\n  }\n};"},"id":"e7e434f8-2a82-4dd8-82d5-b65a9a206c8b","name":"Build Draft","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,128]},{"parameters":{"jsCode":"const msg = $input.item.json;\n\nreturn {\n  json: {\n    route_action: 'send_to_client',\n    payload: {\n      action: 'send_message',\n      channel: msg.channel,\n      chat_id: msg.chat_id,\n      text: msg.final_text || msg.text,\n      server_id: msg.server_id,\n      message_id: msg.id\n    }\n  }\n};"},"id":"4c03b269-b858-4cc2-8de5-0f7f76b07dd3","name":"Approved","type":"n8n-nodes-base.code","typeVersion":2,"position":[-240,-112]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{}},"id":"7465e5d9-492e-456d-9b65-e656b28e6d5c","name":"Respond","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[176,-112]}],"connections":{"Webhook":{"main":[[{"node":"Determine Type","type":"main","index":0}]]},"Determine Type":{"main":[[{"node":"Is From Client?","type":"main","index":0}]]},"Is From Client?":{"main":[[{"node":"From Client","type":"main","index":0}],[{"node":"Is Approved?","type":"main","index":0}]]},"Is Approved?":{"main":[[{"node":"Approved","type":"main","index":0}],[{"node":"Normalize Text","type":"main","index":0}]]},"From Client":{"main":[[{"node":"Respond","type":"main","index":0}]]},"Normalize Text":{"main":[[{"node":"Build Draft","type":"main","index":0}]]},"Build Draft":{"main":[[{"node":"Respond","type":"main","index":0}]]},"Approved":{"main":[[{"node":"Respond","type":"main","index":0}]]}},"authors":"Dmitriy Remacs","name":null,"description":null},"tags":[{"updatedAt":"2025-12-20T17:13:48.080Z","createdAt":"2025-12-20T17:13:48.080Z","id":"ePhQXf5e7xS1lbk9","name":"OperatorCore"},{"updatedAt":"2025-12-09T18:50:08.518Z","createdAt":"2025-12-09T18:50:08.518Z","id":"tMSCjbvPU3xrNUqz","name":"ELO"}]},{"updatedAt":"2025-12-20T17:10:29.606Z","createdAt":"2025-12-18T10:23:46.134Z","id":"FKTNL7yNqFGfRrv3","name":"ELO_API_Android_Auth","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"android/auth/login","responseMode":"responseNode","options":{"allowedOrigins":"*"}},"id":"dc18bf24-fa16-4fc0-9500-7129b919d050","name":"Webhook - Auth Login","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1520,112],"webhookId":"android-auth-login"},{"parameters":{"operation":"executeQuery","query":"SELECT id, tenant_id, name, email, phone, password_hash, is_active\nFROM elo_t_operators\nWHERE (email = '{{ $json.body.login }}' OR phone = '{{ $json.body.login }}')\nAND is_active = true\nLIMIT 1;","options":{"queryBatching":"independently"}},"id":"d6f5550f-a325-4d1d-8e0e-eec17be7bd88","name":"Postgres - Find Operator","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-1296,112],"alwaysOutputData":true,"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"operator-found","leftValue":"={{ $json.id }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}},{"id":"operator-active","leftValue":"={{ $json.is_active }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"a297de72-68b1-4d58-bfa1-5ef78a9a2401","name":"IF - Operator Exists & Active","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1072,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"password-valid","leftValue":"={{ $json.password_valid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}]},"options":{}},"id":"7fe2a14f-8f7b-43b8-bf1f-e3979f07e817","name":"IF - Password Valid","type":"n8n-nodes-base.if","typeVersion":2,"position":[-608,16]},{"parameters":{"respondWith":"json","responseBody":"={\n  \"success\": true,\n  \"operator_id\": \"{{ $json.operator_id }}\",\n  \"tenant_id\": \"{{ $json.tenant_id }}\",\n  \"name\": \"{{ $json.name }}\",\n  \"email\": \"{{ $json.email }}\",\n  \"session_token\": \"{{ $json.session_token }}\",\n  \"app_mode\": \"{{ $json.app_mode }}\",\n  \"tunnel_url\": {{ $json.tunnel_url ? '\"' + $json.tunnel_url + '\"' : 'null' }},\n  \"tunnel_secret\": {{ $json.tunnel_secret ? '\"' + $json.tunnel_secret + '\"' : 'null' }}\n}","options":{"responseCode":200,"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"},{"name":"Access-Control-Allow-Origin","value":"*"}]}}},"id":"957f6ce9-e2ca-42f8-b8c0-16d8a1266c66","name":"Response - Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[640,-96]},{"parameters":{"respondWith":"json","responseBody":"={\n  \"success\": false,\n  \"error\": \"invalid_password\"\n}","options":{"responseCode":401,"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"},{"name":"Access-Control-Allow-Origin","value":"*"}]}}},"id":"9879ba27-b19e-4c6f-8885-5c096fb0e579","name":"Response - Invalid Password","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-384,112]},{"parameters":{"respondWith":"json","responseBody":"={\n  \"success\": false,\n  \"error\": \"operator_not_found_or_inactive\"\n}","options":{"responseCode":401,"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"},{"name":"Access-Control-Allow-Origin","value":"*"}]}}},"id":"9e0aa641-86bd-47b8-8773-c7bc243ea7b7","name":"Response - Not Found","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-864,208]},{"parameters":{"operation":"executeQuery","query":"SELECT \n  '{{ $('Postgres - Find Operator').item.json.id }}' as operator_id,\n  '{{ $('Postgres - Find Operator').item.json.tenant_id }}' as tenant_id,\n  '{{ $('Postgres - Find Operator').item.json.name }}' as name,\n  '{{ $('Postgres - Find Operator').item.json.email }}' as email,\n  (password_hash = crypt('{{ $('Webhook - Auth Login').item.json.body.password }}', password_hash)) as password_valid\nFROM elo_t_operators\nWHERE id = '{{ $('Postgres - Find Operator').item.json.id }}'\nLIMIT 1;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-864,16],"id":"00e1c7ec-4b7b-484c-818c-d35b1bd02468","name":"Postgres - Verify Password","credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"jsCode":"const body = $('Webhook - Auth Login').first().json.body || {};\nconst operatorData = $input.first().json;\nconst deviceInfo = body.device_info || null;\nconst deviceId = deviceInfo?.device_id || null;\nconst deviceInfoJson = deviceInfo ? JSON.stringify(deviceInfo) : null;\n\n// Get app_mode from request, default to 'client'\nconst appMode = body.app_mode || 'client';\n\nreturn {\n  ...operatorData,\n  device_info: deviceInfo,\n  device_id: deviceId,\n  device_info_json: deviceInfoJson,\n  app_mode: appMode\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-400,-96],"id":"4a48cef5-5cae-4ea7-8201-8f49ce6ab4ae","name":"Parse Device Info"},{"parameters":{"operation":"executeQuery","query":"DELETE FROM elo_t_operator_devices \nWHERE operator_id = '{{ $json.operator_id }}'::uuid\n  AND device_type = 'mobile'\n  AND tenant_id = '{{ $json.tenant_id }}'::uuid;\n\nSELECT \n  '{{ $json.operator_id }}' as operator_id,\n  '{{ $json.tenant_id }}' as tenant_id,\n  '{{ $json.name }}' as name,\n  '{{ $json.email }}' as email,\n  '{{ $json.device_id }}' as device_id,\n  '{{ $json.device_info_json }}' as device_info_json,\n  '{{ $json.app_mode }}' as app_mode;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-192,-96],"id":"b863844e-e3c5-48e6-9496-82575e271c84","name":"Delete Old Mobile Session","credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"jsCode":"const inputData = $input.first().json;\nconst crypto = require('crypto');\nconst sessionToken = crypto.randomUUID();\n\n// Generate tunnel secret for server/both modes\nlet tunnelSecret = null;\nif (inputData.app_mode === 'server' || inputData.app_mode === 'both') {\n  tunnelSecret = crypto.randomUUID().replace(/-/g, '');\n}\n\nreturn {\n  operator_id: inputData.operator_id,\n  tenant_id: inputData.tenant_id,\n  name: inputData.name,\n  email: inputData.email,\n  device_id: inputData.device_id,\n  device_info_json: inputData.device_info_json,\n  session_token: sessionToken,\n  app_mode: inputData.app_mode,\n  tunnel_secret: tunnelSecret\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[16,-96],"id":"e37b2cad-b927-4aa1-ad3a-778f99bea013","name":"Generate Session Token"},{"parameters":{"operation":"executeQuery","query":"INSERT INTO elo_t_operator_devices (\n  operator_id,\n  tenant_id,\n  device_type,\n  session_token,\n  device_id,\n  device_info,\n  app_mode,\n  tunnel_secret,\n  created_at,\n  last_active_at,\n  updated_at\n) VALUES (\n  '{{ $json.operator_id }}'::uuid,\n  '{{ $json.tenant_id }}'::uuid,\n  'mobile',\n  '{{ $json.session_token }}',\n  {{ $json.device_id && $json.device_id !== 'null' ? \"'\" + $json.device_id + \"'\" : \"NULL\" }},\n  {{ $json.device_info_json ? \"'\" + $json.device_info_json + \"'::jsonb\" : \"'{}'::jsonb\" }},\n  '{{ $json.app_mode }}',\n  {{ $json.tunnel_secret ? \"'\" + $json.tunnel_secret + \"'\" : \"NULL\" }},\n  NOW(),\n  NOW(),\n  NOW()\n) RETURNING id, tunnel_url;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[224,-96],"id":"76f9b0b7-b366-4908-8b9d-49e316d3798a","name":"Insert into elo_t_operator_devices","credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"jsCode":"const operatorData = $('Parse Device Info').first().json;\nconst sessionData = $('Generate Session Token').first().json;\nconst insertResult = $input.first().json;\n\n// Get tunnel_url from tenant config or generate based on session\nlet tunnelUrl = null;\nif (sessionData.app_mode === 'server' || sessionData.app_mode === 'both') {\n  // Tunnel URL format: https://tunnel.eldoleado.ru/{session_token}\n  tunnelUrl = `https://tunnel.eldoleado.ru/${sessionData.session_token}`;\n}\n\nreturn {\n  operator_id: operatorData.operator_id,\n  tenant_id: operatorData.tenant_id,\n  name: operatorData.name,\n  email: operatorData.email,\n  session_token: sessionData.session_token,\n  app_mode: sessionData.app_mode,\n  tunnel_url: tunnelUrl,\n  tunnel_secret: sessionData.tunnel_secret\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[432,-96],"id":"9b75623c-d0bc-4826-8272-25343e86905e","name":"Prepare Response Data"}],"connections":{"Webhook - Auth Login":{"main":[[{"node":"Postgres - Find Operator","type":"main","index":0}]]},"Postgres - Find Operator":{"main":[[{"node":"IF - Operator Exists & Active","type":"main","index":0}]]},"IF - Operator Exists & Active":{"main":[[{"node":"Postgres - Verify Password","type":"main","index":0}],[{"node":"Response - Not Found","type":"main","index":0}]]},"IF - Password Valid":{"main":[[{"node":"Parse Device Info","type":"main","index":0}],[{"node":"Response - Invalid Password","type":"main","index":0}]]},"Postgres - Verify Password":{"main":[[{"node":"IF - Password Valid","type":"main","index":0}]]},"Parse Device Info":{"main":[[{"node":"Delete Old Mobile Session","type":"main","index":0}]]},"Delete Old Mobile Session":{"main":[[{"node":"Generate Session Token","type":"main","index":0}]]},"Generate Session Token":{"main":[[{"node":"Insert into elo_t_operator_devices","type":"main","index":0}]]},"Insert into elo_t_operator_devices":{"main":[[{"node":"Prepare Response Data","type":"main","index":0}]]},"Prepare Response Data":{"main":[[{"node":"Response - Success","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"278c2e46-959a-48bc-90ff-8b51d11dc52c","activeVersionId":"278c2e46-959a-48bc-90ff-8b51d11dc52c","triggerCount":1,"shared":[{"updatedAt":"2025-12-18T10:23:46.141Z","createdAt":"2025-12-18T10:23:46.141Z","role":"workflow:owner","workflowId":"FKTNL7yNqFGfRrv3","projectId":"x7frUSUEowDAk8Dt"}],"activeVersion":{"updatedAt":"2025-12-20T17:10:29.607Z","createdAt":"2025-12-20T17:10:29.607Z","versionId":"278c2e46-959a-48bc-90ff-8b51d11dc52c","workflowId":"FKTNL7yNqFGfRrv3","nodes":[{"parameters":{"httpMethod":"POST","path":"android/auth/login","responseMode":"responseNode","options":{"allowedOrigins":"*"}},"id":"dc18bf24-fa16-4fc0-9500-7129b919d050","name":"Webhook - Auth Login","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1520,112],"webhookId":"android-auth-login"},{"parameters":{"operation":"executeQuery","query":"SELECT id, tenant_id, name, email, phone, password_hash, is_active\nFROM elo_t_operators\nWHERE (email = '{{ $json.body.login }}' OR phone = '{{ $json.body.login }}')\nAND is_active = true\nLIMIT 1;","options":{"queryBatching":"independently"}},"id":"d6f5550f-a325-4d1d-8e0e-eec17be7bd88","name":"Postgres - Find Operator","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-1296,112],"alwaysOutputData":true,"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"operator-found","leftValue":"={{ $json.id }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}},{"id":"operator-active","leftValue":"={{ $json.is_active }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"a297de72-68b1-4d58-bfa1-5ef78a9a2401","name":"IF - Operator Exists & Active","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1072,112]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"password-valid","leftValue":"={{ $json.password_valid }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}]},"options":{}},"id":"7fe2a14f-8f7b-43b8-bf1f-e3979f07e817","name":"IF - Password Valid","type":"n8n-nodes-base.if","typeVersion":2,"position":[-608,16]},{"parameters":{"respondWith":"json","responseBody":"={\n  \"success\": true,\n  \"operator_id\": \"{{ $json.operator_id }}\",\n  \"tenant_id\": \"{{ $json.tenant_id }}\",\n  \"name\": \"{{ $json.name }}\",\n  \"email\": \"{{ $json.email }}\",\n  \"session_token\": \"{{ $json.session_token }}\",\n  \"app_mode\": \"{{ $json.app_mode }}\",\n  \"tunnel_url\": {{ $json.tunnel_url ? '\"' + $json.tunnel_url + '\"' : 'null' }},\n  \"tunnel_secret\": {{ $json.tunnel_secret ? '\"' + $json.tunnel_secret + '\"' : 'null' }}\n}","options":{"responseCode":200,"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"},{"name":"Access-Control-Allow-Origin","value":"*"}]}}},"id":"957f6ce9-e2ca-42f8-b8c0-16d8a1266c66","name":"Response - Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[640,-96]},{"parameters":{"respondWith":"json","responseBody":"={\n  \"success\": false,\n  \"error\": \"invalid_password\"\n}","options":{"responseCode":401,"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"},{"name":"Access-Control-Allow-Origin","value":"*"}]}}},"id":"9879ba27-b19e-4c6f-8885-5c096fb0e579","name":"Response - Invalid Password","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-384,112]},{"parameters":{"respondWith":"json","responseBody":"={\n  \"success\": false,\n  \"error\": \"operator_not_found_or_inactive\"\n}","options":{"responseCode":401,"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"},{"name":"Access-Control-Allow-Origin","value":"*"}]}}},"id":"9e0aa641-86bd-47b8-8773-c7bc243ea7b7","name":"Response - Not Found","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-864,208]},{"parameters":{"operation":"executeQuery","query":"SELECT \n  '{{ $('Postgres - Find Operator').item.json.id }}' as operator_id,\n  '{{ $('Postgres - Find Operator').item.json.tenant_id }}' as tenant_id,\n  '{{ $('Postgres - Find Operator').item.json.name }}' as name,\n  '{{ $('Postgres - Find Operator').item.json.email }}' as email,\n  (password_hash = crypt('{{ $('Webhook - Auth Login').item.json.body.password }}', password_hash)) as password_valid\nFROM elo_t_operators\nWHERE id = '{{ $('Postgres - Find Operator').item.json.id }}'\nLIMIT 1;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-864,16],"id":"00e1c7ec-4b7b-484c-818c-d35b1bd02468","name":"Postgres - Verify Password","credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"jsCode":"const body = $('Webhook - Auth Login').first().json.body || {};\nconst operatorData = $input.first().json;\nconst deviceInfo = body.device_info || null;\nconst deviceId = deviceInfo?.device_id || null;\nconst deviceInfoJson = deviceInfo ? JSON.stringify(deviceInfo) : null;\n\n// Get app_mode from request, default to 'client'\nconst appMode = body.app_mode || 'client';\n\nreturn {\n  ...operatorData,\n  device_info: deviceInfo,\n  device_id: deviceId,\n  device_info_json: deviceInfoJson,\n  app_mode: appMode\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-400,-96],"id":"4a48cef5-5cae-4ea7-8201-8f49ce6ab4ae","name":"Parse Device Info"},{"parameters":{"operation":"executeQuery","query":"DELETE FROM elo_t_operator_devices \nWHERE operator_id = '{{ $json.operator_id }}'::uuid\n  AND device_type = 'mobile'\n  AND tenant_id = '{{ $json.tenant_id }}'::uuid;\n\nSELECT \n  '{{ $json.operator_id }}' as operator_id,\n  '{{ $json.tenant_id }}' as tenant_id,\n  '{{ $json.name }}' as name,\n  '{{ $json.email }}' as email,\n  '{{ $json.device_id }}' as device_id,\n  '{{ $json.device_info_json }}' as device_info_json,\n  '{{ $json.app_mode }}' as app_mode;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-192,-96],"id":"b863844e-e3c5-48e6-9496-82575e271c84","name":"Delete Old Mobile Session","credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"jsCode":"const inputData = $input.first().json;\nconst crypto = require('crypto');\nconst sessionToken = crypto.randomUUID();\n\n// Generate tunnel secret for server/both modes\nlet tunnelSecret = null;\nif (inputData.app_mode === 'server' || inputData.app_mode === 'both') {\n  tunnelSecret = crypto.randomUUID().replace(/-/g, '');\n}\n\nreturn {\n  operator_id: inputData.operator_id,\n  tenant_id: inputData.tenant_id,\n  name: inputData.name,\n  email: inputData.email,\n  device_id: inputData.device_id,\n  device_info_json: inputData.device_info_json,\n  session_token: sessionToken,\n  app_mode: inputData.app_mode,\n  tunnel_secret: tunnelSecret\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[16,-96],"id":"e37b2cad-b927-4aa1-ad3a-778f99bea013","name":"Generate Session Token"},{"parameters":{"operation":"executeQuery","query":"INSERT INTO elo_t_operator_devices (\n  operator_id,\n  tenant_id,\n  device_type,\n  session_token,\n  device_id,\n  device_info,\n  app_mode,\n  tunnel_secret,\n  created_at,\n  last_active_at,\n  updated_at\n) VALUES (\n  '{{ $json.operator_id }}'::uuid,\n  '{{ $json.tenant_id }}'::uuid,\n  'mobile',\n  '{{ $json.session_token }}',\n  {{ $json.device_id && $json.device_id !== 'null' ? \"'\" + $json.device_id + \"'\" : \"NULL\" }},\n  {{ $json.device_info_json ? \"'\" + $json.device_info_json + \"'::jsonb\" : \"'{}'::jsonb\" }},\n  '{{ $json.app_mode }}',\n  {{ $json.tunnel_secret ? \"'\" + $json.tunnel_secret + \"'\" : \"NULL\" }},\n  NOW(),\n  NOW(),\n  NOW()\n) RETURNING id, tunnel_url;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[224,-96],"id":"76f9b0b7-b366-4908-8b9d-49e316d3798a","name":"Insert into elo_t_operator_devices","credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"jsCode":"const operatorData = $('Parse Device Info').first().json;\nconst sessionData = $('Generate Session Token').first().json;\nconst insertResult = $input.first().json;\n\n// Get tunnel_url from tenant config or generate based on session\nlet tunnelUrl = null;\nif (sessionData.app_mode === 'server' || sessionData.app_mode === 'both') {\n  // Tunnel URL format: https://tunnel.eldoleado.ru/{session_token}\n  tunnelUrl = `https://tunnel.eldoleado.ru/${sessionData.session_token}`;\n}\n\nreturn {\n  operator_id: operatorData.operator_id,\n  tenant_id: operatorData.tenant_id,\n  name: operatorData.name,\n  email: operatorData.email,\n  session_token: sessionData.session_token,\n  app_mode: sessionData.app_mode,\n  tunnel_url: tunnelUrl,\n  tunnel_secret: sessionData.tunnel_secret\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[432,-96],"id":"9b75623c-d0bc-4826-8272-25343e86905e","name":"Prepare Response Data"}],"connections":{"Webhook - Auth Login":{"main":[[{"node":"Postgres - Find Operator","type":"main","index":0}]]},"Postgres - Find Operator":{"main":[[{"node":"IF - Operator Exists & Active","type":"main","index":0}]]},"IF - Operator Exists & Active":{"main":[[{"node":"Postgres - Verify Password","type":"main","index":0}],[{"node":"Response - Not Found","type":"main","index":0}]]},"IF - Password Valid":{"main":[[{"node":"Parse Device Info","type":"main","index":0}],[{"node":"Response - Invalid Password","type":"main","index":0}]]},"Postgres - Verify Password":{"main":[[{"node":"IF - Password Valid","type":"main","index":0}]]},"Parse Device Info":{"main":[[{"node":"Delete Old Mobile Session","type":"main","index":0}]]},"Delete Old Mobile Session":{"main":[[{"node":"Generate Session Token","type":"main","index":0}]]},"Generate Session Token":{"main":[[{"node":"Insert into elo_t_operator_devices","type":"main","index":0}]]},"Insert into elo_t_operator_devices":{"main":[[{"node":"Prepare Response Data","type":"main","index":0}]]},"Prepare Response Data":{"main":[[{"node":"Response - Success","type":"main","index":0}]]}},"authors":"Dmitriy Remacs","name":null,"description":null},"tags":[{"updatedAt":"2025-11-23T03:58:34.844Z","createdAt":"2025-11-23T03:58:34.844Z","id":"0yzk30hhaSzkl8bF","name":"API"},{"updatedAt":"2025-12-09T18:50:08.518Z","createdAt":"2025-12-09T18:50:08.518Z","id":"tMSCjbvPU3xrNUqz","name":"ELO"}]},{"updatedAt":"2025-12-21T11:26:49.204Z","createdAt":"2025-12-10T10:01:22.747Z","id":"GrChisyOV9ajgBDX","name":"ELO_Out_Telegram","active":false,"isArchived":false,"nodes":[{"parameters":{"rule":{"interval":[{"field":"seconds","secondsInterval":3}]}},"id":"d563b0f1-cc09-4698-a1b3-8cc686f16832","name":"Schedule Trigger","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[-1616,48]},{"parameters":{"operation":"pop","list":"queue:outgoing:telegram","options":{}},"id":"48c6ab95-6ded-47fa-b83f-9c19a9d38051","name":"Redis Pop Message","type":"n8n-nodes-base.redis","typeVersion":1,"position":[-1392,48],"credentials":{"redis":{"id":"7FQcEivUY94atW24","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"has-message","leftValue":"={{ $json.message_json }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"id":"eca098e2-47b1-443b-a883-1dda540be795","name":"IF Has Message","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1168,48]},{"parameters":{"jsCode":"const messageJson = $json.message_json;\nconst message = JSON.parse(messageJson);\n\n// Normalize chat_id - remove tg_ prefix if present\nlet chatId = message.external_chat_id || '';\nif (chatId.startsWith('tg_')) {\n  chatId = chatId.substring(3);\n}\n\nreturn {\n  out_message: message,\n  chat_id: chatId,\n  text: message.message_text,\n  tenant_id: message.tenant_id\n};"},"id":"d232df8b-2ab9-45e4-a82e-c0d9b7bb4586","name":"Parse Message","type":"n8n-nodes-base.code","typeVersion":2,"position":[-944,-48]},{"parameters":{"operation":"executeQuery","query":"SELECT \n  ca.credentials->>'bot_token' as bot_token,\n  ca.account_id,\n  ca.account_name\nFROM elo_t_channel_accounts ca\nWHERE ca.tenant_id = '{{ $json.tenant_id }}'::uuid\n  AND ca.channel_id = 1\n  AND ca.is_active = true\nLIMIT 1;","options":{}},"id":"80d4d08c-7623-4d15-a6cc-250f71f55768","name":"Get Bot Token","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-720,-48],"alwaysOutputData":true,"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"has-token","leftValue":"={{ $json.bot_token }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"id":"93976e95-786f-4c9c-90be-ecc69a21e923","name":"IF Token Exists","type":"n8n-nodes-base.if","typeVersion":2,"position":[-496,-48]},{"parameters":{"method":"POST","url":"=https://api.telegram.org/bot{{ $json.bot_token }}/sendMessage","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"chat_id\": \"{{ $('Parse Message').item.json.chat_id }}\",\n  \"text\": {{ JSON.stringify($('Parse Message').item.json.text) }},\n  \"parse_mode\": \"Markdown\"\n}","options":{"timeout":30000}},"id":"125b3b2c-d7af-4570-bafd-8e140b4d8562","name":"Send via Telegram API","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-272,-144]},{"parameters":{"jsCode":"const parsed = $('Parse Message').first().json;\nconst response = $input.first().json;\n\nconst success = response.ok === true;\nconst messageId = response.result?.message_id?.toString() || Date.now().toString();\n\nreturn {\n  ...parsed,\n  telegram_response: response,\n  message_id: messageId,\n  sent_at: new Date().toISOString(),\n  send_success: success\n};"},"id":"14211a09-016a-4052-a1a3-228a304b6656","name":"Process Telegram Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[-48,-144]},{"parameters":{"operation":"executeQuery","query":"UPDATE elo_t_dialogs SET\n  last_message_at = NOW(),\n  last_operator_message_at = NOW(),\n  updated_at = NOW()\nWHERE id = '{{ $json.out_message.dialog_id }}'::uuid;","options":{}},"id":"3b4cf12b-dc9c-40ab-8c39-cbf222dba995","name":"Update Dialog Timestamp","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[176,-144],"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"jsCode":"// No token found - log error\nconst parsed = $('Parse Message').first().json;\n\nconsole.error('No Telegram bot token found for tenant:', parsed.tenant_id);\n\nreturn {\n  success: false,\n  error: 'No Telegram bot token found for tenant',\n  tenant_id: parsed.tenant_id,\n  out_message: parsed.out_message\n};"},"id":"54e9ef15-1e65-4578-bcd5-9e98e90ea0fc","name":"No Token Error","type":"n8n-nodes-base.code","typeVersion":2,"position":[-272,48]},{"parameters":{"jsCode":"// No message in queue - just return\nreturn { empty: true };"},"id":"68af35e8-ea8a-401b-9e3f-0fd60a320dd7","name":"No Message","type":"n8n-nodes-base.code","typeVersion":2,"position":[-944,144]}],"connections":{"Schedule Trigger":{"main":[[{"node":"Redis Pop Message","type":"main","index":0}]]},"Redis Pop Message":{"main":[[{"node":"IF Has Message","type":"main","index":0}]]},"IF Has Message":{"main":[[{"node":"Parse Message","type":"main","index":0}],[{"node":"No Message","type":"main","index":0}]]},"Parse Message":{"main":[[{"node":"Get Bot Token","type":"main","index":0}]]},"Get Bot Token":{"main":[[{"node":"IF Token Exists","type":"main","index":0}]]},"IF Token Exists":{"main":[[{"node":"Send via Telegram API","type":"main","index":0}],[{"node":"No Token Error","type":"main","index":0}]]},"Send via Telegram API":{"main":[[{"node":"Process Telegram Response","type":"main","index":0}]]},"Process Telegram Response":{"main":[[{"node":"Update Dialog Timestamp","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"26cf192d-7a78-47b7-9b05-cce665c5958a","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2025-12-10T10:01:22.752Z","createdAt":"2025-12-10T10:01:22.752Z","role":"workflow:owner","workflowId":"GrChisyOV9ajgBDX","projectId":"x7frUSUEowDAk8Dt"}],"activeVersion":null,"tags":[{"updatedAt":"2025-11-23T04:03:34.766Z","createdAt":"2025-11-23T04:03:34.766Z","id":"IbDkJphbr4EygdRZ","name":"Out"},{"updatedAt":"2025-12-09T18:50:08.518Z","createdAt":"2025-12-09T18:50:08.518Z","id":"tMSCjbvPU3xrNUqz","name":"ELO"}]},{"updatedAt":"2025-12-15T17:27:34.374Z","createdAt":"2025-12-15T17:27:29.306Z","id":"IKYT3qf3XbmKmse3","name":"ELO_Core_Stage_Manager","active":false,"isArchived":false,"nodes":[{"parameters":{"path":"elo-core-stage-manager","responseMode":"responseNode","options":{}},"id":"3c4b2f28-016e-4de3-98cb-9d6dc4ce9cbb","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1664,48],"webhookId":"elo-core-stage-manager"},{"parameters":{"jsCode":"const input = $input.first().json;\nconst context = input.context;\nconst currentStage = context.current_stage || 'data_collection';\n\nreturn {\n  context: context,\n  current_stage_code: currentStage,\n  vertical_id: context.vertical_id || 1\n};"},"id":"7ed7c126-c45a-4533-8d4c-e33eb4d36011","name":"Prepare Query","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1440,48]},{"parameters":{"operation":"executeQuery","query":"SELECT\n    id,\n    code,\n    name,\n    name_ru,\n    sort_order,\n    exit_conditions,\n    config\nFROM elo_v_funnel_stages\nWHERE vertical_id = $1\n  AND is_active = true\nORDER BY sort_order;","options":{"queryReplacement":"={{ [$json.vertical_id] }}"}},"id":"f58cd31e-764c-407f-b654-c6a921eae56c","name":"PostgreSQL Load Stages","type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[-1216,48],"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"jsCode":"const prepareData = $('Prepare Query').first().json;\nconst context = prepareData.context;\nconst currentStageCode = prepareData.current_stage_code;\n\n// Build stage config from SQL results\nconst stages = $input.all().map(item => item.json);\nconst STAGE_CONFIG = {};\n\nfor (const stage of stages) {\n  STAGE_CONFIG[stage.code] = {\n    code: stage.code,\n    name: stage.name_ru || stage.name,\n    order: stage.sort_order,\n    exit_conditions: stage.exit_conditions || {},\n    required_slots: stage.config?.required_slots || [],\n    next_stage: stage.config?.next_stage || null,\n    on_complete: stage.config?.on_complete || null\n  };\n}\n\nconst stageConfig = STAGE_CONFIG[currentStageCode] || STAGE_CONFIG['data_collection'];\n\nreturn {\n  context: context,\n  current_stage_config: stageConfig,\n  all_stages: STAGE_CONFIG\n};"},"id":"c4c39ee4-34c8-47b5-970c-c540d0c83159","name":"Build Stage Config","type":"n8n-nodes-base.code","typeVersion":2,"position":[-992,48]},{"parameters":{"jsCode":"const context = $json.context;\nconst stageConfig = $json.current_stage_config;\n\nlet shouldTransition = false;\nlet transitionReason = null;\n\n// Check exit conditions based on type\nconst exitCond = stageConfig?.exit_conditions;\n\nif (exitCond && Object.keys(exitCond).length > 0) {\n  switch (exitCond.type) {\n    \n    case 'all_lines_complete':\n      // All lines must have required slots filled\n      const requiredSlots = exitCond.required_slots || ['device', 'symptom'];\n      const allComplete = context.lines?.length > 0 && context.lines.every(line => {\n        return requiredSlots.every(slot => {\n          return line.slots?.[slot] !== null && line.slots?.[slot] !== undefined;\n        });\n      });\n      shouldTransition = allComplete;\n      if (shouldTransition) {\n        transitionReason = 'all_lines_complete';\n      }\n      break;\n    \n    case 'slot_filled':\n      // Specific slot must be filled\n      const slotName = exitCond.slot;\n      shouldTransition = context[slotName] !== null && context[slotName] !== undefined;\n      if (shouldTransition) {\n        transitionReason = `slot_filled:${slotName}`;\n      }\n      break;\n    \n    case 'all_slots_filled':\n      // All specified slots must be filled\n      const slots = exitCond.slots || [];\n      const booking = context.booking || {};\n      const allFilled = slots.every(slot => {\n        return booking[slot] !== null && booking[slot] !== undefined;\n      });\n      shouldTransition = allFilled;\n      if (shouldTransition) {\n        transitionReason = 'all_booking_slots_filled';\n      }\n      break;\n    \n    case 'intent_detected':\n      // Check last AI extraction for intent\n      const lastIntent = context.last_intent;\n      shouldTransition = lastIntent === exitCond.intent;\n      if (shouldTransition) {\n        transitionReason = `intent:${exitCond.intent}`;\n      }\n      break;\n  }\n}\n\nreturn {\n  context: context,\n  current_stage_config: stageConfig,\n  all_stages: $json.all_stages,\n  should_transition: shouldTransition,\n  transition_reason: transitionReason\n};"},"id":"c80dc22d-b6a5-45f8-b065-60eafb24b2b8","name":"Check Exit Conditions","type":"n8n-nodes-base.code","typeVersion":2,"position":[-784,48]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"check-should-transition","leftValue":"={{ $json.should_transition }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"254ece8f-254b-4771-a3e6-c5f6b83eb648","name":"Should Transition?","type":"n8n-nodes-base.if","typeVersion":2,"position":[-560,48]},{"parameters":{"jsCode":"const context = $json.context;\nconst stageConfig = $json.current_stage_config;\nconst transitionReason = $json.transition_reason;\n\nconst previousStage = context.current_stage;\nconst nextStage = stageConfig.next_stage;\n\n// Update context\ncontext.previous_stage = previousStage;\ncontext.current_stage = nextStage || previousStage; // Stay on current if no next\ncontext.stage_entered_at = new Date().toISOString();\n\n// Handle final stage completion\nlet finalAction = null;\nif (!nextStage && stageConfig.on_complete) {\n  finalAction = stageConfig.on_complete;\n}\n\nreturn {\n  context: context,\n  stage_changed: nextStage !== null,\n  transition: {\n    from: previousStage,\n    to: nextStage,\n    reason: transitionReason\n  },\n  final_action: finalAction\n};"},"id":"a8da2ecd-978a-4825-b169-af3d6e149f9a","name":"Update Stage","type":"n8n-nodes-base.code","typeVersion":2,"position":[-336,-64]},{"parameters":{"jsCode":"const context = $json.context;\n\n// Check if focus needs to switch\nlet focusChanged = false;\nlet newFocusLine = null;\n\n// Get current focus line\nconst focusLine = context.lines?.find(l => l.id === context.focus_line_id);\n\n// If focus line is done, switch to next waiting\nif (focusLine && focusLine.status === 'done') {\n  const waitingLine = context.lines.find(l => l.status === 'waiting');\n  if (waitingLine) {\n    // Switch focus\n    waitingLine.status = 'active';\n    context.focus_line_id = waitingLine.id;\n    focusChanged = true;\n    newFocusLine = waitingLine.id;\n  }\n}\n\n// If no focus set, set to first non-done line\nif (!context.focus_line_id && context.lines?.length > 0) {\n  const firstActive = context.lines.find(l => l.status !== 'done');\n  if (firstActive) {\n    firstActive.status = 'active';\n    context.focus_line_id = firstActive.id;\n    focusChanged = true;\n    newFocusLine = firstActive.id;\n  }\n}\n\nreturn {\n  context: context,\n  stage_changed: false,\n  focus_changed: focusChanged,\n  new_focus_line: newFocusLine\n};"},"id":"c5a43530-df4c-4f76-a864-05b032442ac1","name":"Check Focus","type":"n8n-nodes-base.code","typeVersion":2,"position":[-336,144]},{"parameters":{"mode":"combine","options":{}},"id":"0ed6941f-1883-44a8-a71a-dd46a4415b7f","name":"Merge Results","type":"n8n-nodes-base.merge","typeVersion":3,"position":[-112,48]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"2953bd42-8dab-49bc-aa80-9817491efcb0","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[112,48]}],"connections":{"Webhook":{"main":[[{"node":"Prepare Query","type":"main","index":0}]]},"Prepare Query":{"main":[[{"node":"PostgreSQL Load Stages","type":"main","index":0}]]},"PostgreSQL Load Stages":{"main":[[{"node":"Build Stage Config","type":"main","index":0}]]},"Build Stage Config":{"main":[[{"node":"Check Exit Conditions","type":"main","index":0}]]},"Check Exit Conditions":{"main":[[{"node":"Should Transition?","type":"main","index":0}]]},"Should Transition?":{"main":[[{"node":"Update Stage","type":"main","index":0}],[{"node":"Check Focus","type":"main","index":0}]]},"Update Stage":{"main":[[{"node":"Merge Results","type":"main","index":0}]]},"Check Focus":{"main":[[{"node":"Merge Results","type":"main","index":1}]]},"Merge Results":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"5ef3c503-b494-41b1-92db-8c32de70535c","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2025-12-15T17:27:29.311Z","createdAt":"2025-12-15T17:27:29.311Z","role":"workflow:owner","workflowId":"IKYT3qf3XbmKmse3","projectId":"x7frUSUEowDAk8Dt"}],"activeVersion":null,"tags":[{"updatedAt":"2025-12-12T08:39:41.170Z","createdAt":"2025-12-12T08:39:41.170Z","id":"8dihLRJvdhkW2kZ1","name":"AI"},{"updatedAt":"2025-12-09T18:50:08.518Z","createdAt":"2025-12-09T18:50:08.518Z","id":"tMSCjbvPU3xrNUqz","name":"ELO"}]},{"updatedAt":"2025-12-17T08:58:32.503Z","createdAt":"2025-12-15T17:24:29.950Z","id":"KkCXa38EDLKJwy4i","name":"ELO_Context_Collector","active":false,"isArchived":false,"nodes":[{"parameters":{"path":"elo-context-collector","responseMode":"responseNode","options":{}},"id":"36e1350b-f1bd-4443-96ac-8c87aa026961","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-624,-208],"webhookId":"elo-context-collector"},{"parameters":{"jsCode":"const input = $input.first().json.body || $input.first().json;\n\n// Validate required fields\nconst required = ['tenant_id', 'client_id', 'dialog_id', 'text'];\nfor (const field of required) {\n  if (!input[field]) {\n    throw new Error(`Missing required field: ${field}`);\n  }\n}\n\n// Prepare input for AI Agent\nreturn {\n  input: input,\n  agent_input: `Collect context for this message:\n\nMessage: \"${input.text}\"\nClient ID: ${input.client_id}\nDialog ID: ${input.dialog_id}\nTenant ID: ${input.tenant_id}\nVertical ID: ${input.vertical_id || 1}\nChannel: ${input.channel_id || 'unknown'}\n\nTasks:\n1. Extract entities (device, symptom, intent, owner) from the message\n2. Load existing client context if available\n3. If symptom found - derive diagnosis, repair type and price\n4. Check for applicable triggers\n\nReturn complete context object.`\n};"},"id":"59a31ed9-c2bc-4978-8b6e-9575dda959bc","name":"Prepare Input","type":"n8n-nodes-base.code","typeVersion":2,"position":[-400,-208]},{"parameters":{"options":{"systemMessage":"You are a context collector for a phone repair service chatbot.\n\nYour job is to gather all relevant information about the customer's request using the available tools.\n\nAvailable tools:\n- extract_entities: Extract device, symptom, intent from customer message\n- load_client_context: Load client history from Neo4j\n- derive_chain: Get diagnosis, repair type and price for a symptom\n- check_triggers: Check for applicable triggers (discounts, info)\n\nAlways:\n1. First extract entities from the message\n2. Load client context if client_id provided\n3. If symptom extracted - run derive_chain\n4. Check triggers at the end\n\nReturn a complete context object with all collected data."}},"id":"b33ae204-9ae0-4207-a2f9-390b60833ffd","name":"AI Agent","type":"@n8n/n8n-nodes-langchain.agent","typeVersion":1.6,"position":[-176,-208]},{"parameters":{"model":"qwen/qwen3-30b-a3b","options":{"maxTokens":2000,"temperature":0.1}},"id":"a5ff0999-a45a-4207-8fd8-beac20dbd809","name":"OpenRouter LLM","type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[-576,48],"credentials":{"openRouterApi":{"id":"ameOTCcGgTm3hbtM","name":"OpenRouter account"}}},{"parameters":{"method":"POST","url":"https://n8n.n8nsrv.ru/webhook/elo-ai-extract","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ message: $fromAI('message', 'The customer message to analyze') }) }}"},"id":"a9f328e7-d655-4d4f-848e-ea2bdc9a428b","name":"Extract Entities Tool","type":"@n8n/n8n-nodes-langchain.toolHttpRequest","typeVersion":1.1,"position":[-320,48]},{"parameters":{"method":"POST","url":"https://n8n.n8nsrv.ru/webhook/elo-core-ai-derive","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ symptom: $fromAI('symptom', 'The symptom text'), device_brand: $fromAI('device_brand', 'Device brand like Apple, Samsung'), device_model: $fromAI('device_model', 'Device model like iPhone 14') }) }}"},"id":"02f8075b-1a51-4ac8-b893-a0f01aa663c8","name":"Derive Chain Tool","type":"@n8n/n8n-nodes-langchain.toolHttpRequest","typeVersion":1.1,"position":[-144,48]},{"parameters":{"method":"POST","url":"https://n8n.n8nsrv.ru/webhook/elo-core-triggers-checker","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ context: $fromAI('context', 'Current context object') }) }}"},"id":"a2d2799d-6262-4eaf-bf4d-773d58b3963f","name":"Check Triggers Tool","type":"@n8n/n8n-nodes-langchain.toolHttpRequest","typeVersion":1.1,"position":[48,48]},{"parameters":{"method":"POST","url":"https://n8n.n8nsrv.ru/webhook/elo-core-context-builder","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ action: 'get_context', client_id: $fromAI('client_id', 'The client UUID') }) }}"},"id":"af32c19b-c138-4fea-b944-583f669eb9ec","name":"Load Client Context Tool","type":"@n8n/n8n-nodes-langchain.toolHttpRequest","typeVersion":1.1,"position":[240,48]},{"parameters":{"jsCode":"const agentOutput = $input.first().json;\nconst inputData = $('Prepare Input').first().json.input;\n\n// Parse agent output and build final context\nlet context = {\n  tenant_id: inputData.tenant_id,\n  client_id: inputData.client_id,\n  dialog_id: inputData.dialog_id,\n  vertical_id: inputData.vertical_id || 1,\n  channel_id: inputData.channel_id,\n  external_chat_id: inputData.external_chat_id,\n  \n  message: {\n    text: inputData.text,\n    timestamp: inputData.timestamp || new Date().toISOString()\n  },\n  \n  // From agent\n  entities: agentOutput.entities || [],\n  client: agentOutput.client || {},\n  derived: agentOutput.derived || {},\n  triggers_fired: agentOutput.triggers_fired || [],\n  \n  // Lines structure\n  lines: [],\n  focus_line_id: null,\n  \n  // Stage (default)\n  current_stage: 'data_collection',\n  \n  trace_id: inputData.trace_id || `trace_${Date.now()}`\n};\n\n// Build lines from entities\nconst devices = context.entities.filter(e => e.type === 'device');\nconst symptoms = context.entities.filter(e => e.type === 'symptom');\n\ndevices.forEach((device, i) => {\n  const symptom = symptoms[i] || symptoms[0];\n  context.lines.push({\n    id: `line_${i}`,\n    status: i === 0 ? 'active' : 'waiting',\n    cursor: symptom ? 2 : 1,\n    slots: {\n      device: device,\n      symptom: symptom?.text || null,\n      diagnosis: context.derived?.diagnosis || null,\n      repair_type: context.derived?.repair_type || null,\n      price: context.derived?.price || null\n    }\n  });\n});\n\nif (context.lines.length > 0) {\n  context.focus_line_id = 'line_0';\n}\n\nreturn { context };"},"id":"b82a84ad-29d4-4fa3-9e59-107f645a88c6","name":"Build Context","type":"n8n-nodes-base.code","typeVersion":2,"position":[208,-208]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"8d967923-d8f6-4aa1-89f6-c5db07ebbf08","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[464,-208]}],"connections":{"Webhook":{"main":[[{"node":"Prepare Input","type":"main","index":0}]]},"Prepare Input":{"main":[[{"node":"AI Agent","type":"main","index":0}]]},"OpenRouter LLM":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]},"Extract Entities Tool":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"Derive Chain Tool":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"Check Triggers Tool":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"Load Client Context Tool":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"AI Agent":{"main":[[{"node":"Build Context","type":"main","index":0}]]},"Build Context":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"839c698b-ab6f-4ef4-86d3-dba41c19a431","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2025-12-15T17:24:29.959Z","createdAt":"2025-12-15T17:24:29.959Z","role":"workflow:owner","workflowId":"KkCXa38EDLKJwy4i","projectId":"x7frUSUEowDAk8Dt"}],"activeVersion":null,"tags":[{"updatedAt":"2025-12-12T08:39:41.170Z","createdAt":"2025-12-12T08:39:41.170Z","id":"8dihLRJvdhkW2kZ1","name":"AI"},{"updatedAt":"2025-12-09T18:50:08.518Z","createdAt":"2025-12-09T18:50:08.518Z","id":"tMSCjbvPU3xrNUqz","name":"ELO"}]},{"updatedAt":"2025-12-12T09:11:33.000Z","createdAt":"2025-12-09T18:50:29.931Z","id":"LcB53NcwVT0K3K6U","name":"ELO_Core_Dialog_Engine","active":false,"isArchived":true,"nodes":[{"parameters":{},"id":"1a60a182-e4fe-4284-8fcd-bbba34b4d060","name":"Execute Workflow Trigger","type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1,"position":[-2000,240]},{"parameters":{"jsCode":"const input = $input.first()?.json || {};\nconsole.log('═══ ELO DIALOG ENGINE START ═══');\nconsole.log('Channel:', input.channel);\nconsole.log('Tenant ID:', input.tenant_id);\nconsole.log('External chat ID:', input.external_chat_id);\nreturn input;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1792,240],"id":"560a1c4f-ba14-43ab-a81d-4a330207581a","name":"Attach Base"},{"parameters":{"operation":"executeQuery","query":"-- Find or create client by channel ID\nWITH channel_lookup AS (\n  SELECT\n    '{{ $json.tenant_id }}'::uuid AS tenant_id,\n    '{{ $json.channel }}' AS channel,\n    '{{ $json.external_user_id }}' AS external_user_id,\n    '{{ $json.client_name || \"\" }}' AS client_name,\n    '{{ $json.client_phone || \"\" }}' AS client_phone,\n    '{{ $json.client_email || \"\" }}' AS client_email,\n    '{{ $json.client_username || \"\" }}' AS client_username\n),\nexisting_client AS (\n  SELECT c.* FROM elo_clients c, channel_lookup cl\n  WHERE c.tenant_id = cl.tenant_id\n    AND (\n      (cl.channel = 'telegram' AND c.telegram_id = cl.external_user_id)\n      OR (cl.channel = 'whatsapp' AND c.whatsapp_id = cl.external_user_id)\n      OR (cl.channel = 'vk' AND c.vk_id = cl.external_user_id)\n      OR (cl.channel = 'avito' AND c.avito_id = cl.external_user_id)\n      OR (cl.client_phone != '' AND c.phone = cl.client_phone)\n    )\n  LIMIT 1\n),\ninserted_client AS (\n  INSERT INTO elo_clients (tenant_id, telegram_id, whatsapp_id, vk_id, avito_id, phone, email, name)\n  SELECT\n    cl.tenant_id,\n    CASE WHEN cl.channel = 'telegram' THEN cl.external_user_id ELSE NULL END,\n    CASE WHEN cl.channel = 'whatsapp' THEN cl.external_user_id ELSE NULL END,\n    CASE WHEN cl.channel = 'vk' THEN cl.external_user_id ELSE NULL END,\n    CASE WHEN cl.channel = 'avito' THEN cl.external_user_id ELSE NULL END,\n    NULLIF(cl.client_phone, ''),\n    NULLIF(cl.client_email, ''),\n    NULLIF(cl.client_name, '')\n  FROM channel_lookup cl\n  WHERE NOT EXISTS (SELECT 1 FROM existing_client)\n  RETURNING *\n)\nSELECT \n  COALESCE(e.id, i.id) AS id,\n  COALESCE(e.name, i.name) AS name,\n  COALESCE(e.phone, i.phone) AS phone,\n  COALESCE(e.telegram_id, i.telegram_id) AS telegram_id,\n  CASE WHEN e.id IS NOT NULL THEN true ELSE false END AS client_found\nFROM channel_lookup cl\nLEFT JOIN existing_client e ON true\nLEFT JOIN inserted_client i ON true;","options":{}},"id":"fe243581-708d-47a4-a3b3-40be87a39670","name":"Find or Create Client","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-1536,160],"alwaysOutputData":true,"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[-1328,240],"id":"32125e04-3709-48a0-885c-4d070f7d2f6e","name":"Merge"},{"parameters":{"jsCode":"const allItems = $input.all();\n\nconsole.log('═══ MERGE AFTER CLIENT ═══');\n\nlet baseData = null;\nlet clientResult = null;\n\nfor (const item of allItems) {\n  const json = item.json;\n  if (json?.tenant_id && json?.channel) {\n    baseData = json;\n  }\n  if (json?.id && json?.client_found !== undefined) {\n    clientResult = json;\n  }\n}\n\nif (!baseData) {\n  try {\n    baseData = $('Attach Base').first()?.json || {};\n  } catch (e) {\n    baseData = {};\n  }\n}\n\nconst output = {\n  ...baseData,\n  client_found: clientResult?.client_found || false,\n  client: clientResult ? {\n    id: clientResult.id,\n    name: clientResult.name,\n    phone: clientResult.phone,\n    telegram_id: clientResult.telegram_id\n  } : null\n};\n\nconsole.log('Client found:', output.client_found);\nconsole.log('Client ID:', output.client?.id);\n\nreturn output;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1120,240],"id":"3f415629-ab36-4542-bca2-817d11964cfa","name":"Merge After Client"},{"parameters":{"operation":"executeQuery","query":"-- Find active dialog for this client\nWITH vals AS (\n  SELECT\n    '{{ $json.client?.id || \"\" }}' AS client_id_text,\n    '{{ $json.tenant_id }}' AS tenant_id_text,\n    '{{ $json.channel }}' AS channel\n),\nv AS (\n  SELECT \n    CASE\n      WHEN client_id_text ~* '^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$'\n        THEN client_id_text::uuid\n      ELSE NULL\n    END AS client_id,\n    CASE\n      WHEN tenant_id_text ~* '^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$'\n        THEN tenant_id_text::uuid\n      ELSE NULL\n    END AS tenant_id,\n    channel\n  FROM vals\n)\nSELECT d.id, d.status, d.context, d.channel, d.external_chat_id, d.assigned_operator_id\nFROM elo_dialogs d\nJOIN v ON v.client_id IS NOT NULL\nWHERE d.client_id = v.client_id\n  AND d.tenant_id = v.tenant_id\n  AND d.status IN ('active', 'waiting')\n  AND d.created_at > NOW() - INTERVAL '7 days'\nORDER BY d.last_message_at DESC NULLS LAST\nLIMIT 1;","options":{}},"id":"f7211f0f-6765-43b8-9b5d-b6df3907e28c","name":"Find Active Dialog","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-896,144],"alwaysOutputData":true,"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[-688,240],"id":"6da04908-5089-4446-809e-c574c2981e4c","name":"Merge Dialog"},{"parameters":{"jsCode":"const allItems = $input.all();\n\nlet baseData = null;\nlet dialogResult = null;\n\nfor (const item of allItems) {\n  const json = item.json;\n  if (json?.client?.id) {\n    baseData = json;\n  }\n  if (json?.id && json?.status) {\n    dialogResult = json;\n  }\n}\n\nif (!baseData) {\n  try {\n    baseData = $('Merge After Client').first()?.json || {};\n  } catch (e) {\n    baseData = {};\n  }\n}\n\nconst dialogFound = dialogResult && dialogResult.id;\n\nconst output = {\n  ...baseData,\n  dialog_found: dialogFound || false,\n  dialog: dialogFound ? {\n    id: dialogResult.id,\n    status: dialogResult.status,\n    context: dialogResult.context || {},\n    channel: dialogResult.channel,\n    external_chat_id: dialogResult.external_chat_id,\n    assigned_operator_id: dialogResult.assigned_operator_id,\n    is_new: false\n  } : null\n};\n\nconsole.log('Dialog found:', output.dialog_found);\n\nreturn output;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-480,240],"id":"81a55b9e-4752-424d-b1c3-98dac0eca523","name":"Merge After Dialog"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":1},"conditions":[{"id":"dialog-found","operator":{"type":"boolean","operation":"true"},"leftValue":"={{ $json.dialog_found }}","rightValue":""}],"combinator":"and"},"options":{"looseTypeValidation":true}},"id":"bf5e5cb4-0a1c-4c7f-b7a3-03f1c5d9eb44","name":"Dialog Exists?","type":"n8n-nodes-base.if","typeVersion":2,"position":[-256,240]},{"parameters":{"jsCode":"const inputData = $input.first()?.json || {};\nconst existingDialog = inputData.dialog;\n\nconsole.log('═══ USE EXISTING DIALOG ═══');\nconsole.log('Dialog ID:', existingDialog?.id);\n\nreturn {\n  ...inputData,\n  dialog: {\n    ...existingDialog,\n    is_new: false\n  }\n};"},"id":"a1790d69-6080-4120-ad0f-c301e2850486","name":"Use Existing Dialog","type":"n8n-nodes-base.code","typeVersion":2,"position":[-32,128]},{"parameters":{"operation":"executeQuery","query":"INSERT INTO elo_dialogs (\n  tenant_id,\n  client_id,\n  channel,\n  external_chat_id,\n  status,\n  context,\n  metadata,\n  last_message_at\n)\nVALUES (\n  '{{ $json.tenant_id }}'::uuid,\n  '{{ $json.client.id }}'::uuid,\n  '{{ $json.channel }}',\n  '{{ $json.external_chat_id }}',\n  'active',\n  '{}'::jsonb,\n  '{{ JSON.stringify($json.meta || {}).replace(/'/g, \"''\") }}'::jsonb,\n  NOW()\n)\nRETURNING *;","options":{}},"id":"98061c82-1bf4-42b0-a96d-940da6e95660","name":"Create New Dialog","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[-32,336],"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"jsCode":"const sqlResult = $input.first()?.json;\nconst inMessage = $('Merge After Dialog').first()?.json || {};\n\nif (!sqlResult || !sqlResult.id) {\n  throw new Error('No dialog data returned from SQL');\n}\n\nconsole.log('═══ NEW DIALOG CREATED ═══');\nconsole.log('Dialog ID:', sqlResult.id);\n\nreturn {\n  ...inMessage,\n  dialog: {\n    id: sqlResult.id,\n    status: sqlResult.status,\n    context: sqlResult.context || {},\n    channel: sqlResult.channel,\n    external_chat_id: sqlResult.external_chat_id,\n    assigned_operator_id: sqlResult.assigned_operator_id,\n    is_new: true\n  }\n};"},"id":"2d06ad0e-4de0-4253-b711-2b16e166ee4d","name":"Merge New Dialog","type":"n8n-nodes-base.code","typeVersion":2,"position":[192,336]},{"parameters":{"operation":"executeQuery","query":"-- Save message as event\nINSERT INTO elo_events (\n  tenant_id,\n  dialog_id,\n  client_id,\n  event_type,\n  data,\n  actor_type,\n  actor_id,\n  external_id\n)\nVALUES (\n  '{{ $json.tenant_id }}'::uuid,\n  '{{ $json.dialog.id }}'::uuid,\n  '{{ $json.client.id }}'::uuid,\n  'message.inbound',\n  '{{ JSON.stringify({text: $json.text || \"\", channel: $json.channel, sender: \"client\", media: $json.media || {}}).replace(/'/g, \"''\") }}'::jsonb,\n  'client',\n  '{{ $json.client.id }}'::uuid,\n  '{{ $json.meta?.external_message_id || \"\" }}'\n)\nRETURNING *;","options":{}},"id":"04850e31-2ae6-426d-99b0-c610fec19fb9","name":"Save Message Event","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[416,240],"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"jsCode":"const sqlResult = $input.first()?.json || {};\nlet srcData = null;\n\ntry {\n  srcData = $('Use Existing Dialog').first()?.json || $('Merge New Dialog').first()?.json;\n} catch (e) {\n  srcData = {};\n}\n\nif (!srcData) {\n  srcData = {};\n}\n\nconst output = {\n  ...srcData,\n  event_id: sqlResult.id,\n  success: true\n};\n\nconsole.log('═══ MESSAGE SAVED AS EVENT ═══');\nconsole.log('Event ID:', output.event_id);\nconsole.log('Dialog ID:', output.dialog?.id);\n\nreturn output;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[640,240],"id":"0e31c7c2-6061-4086-adc6-606f41b3b84f","name":"Prepare for AI Router"},{"parameters":{"operation":"executeQuery","query":"-- Update dialog last_message_at and last_client_message_at\nUPDATE elo_dialogs\nSET \n  last_message_at = NOW(),\n  last_client_message_at = NOW(),\n  updated_at = NOW()\nWHERE id = '{{ $json.dialog.id }}'::uuid;","options":{}},"id":"17d27adf-772c-4d25-91f1-2cf2122c6eca","name":"Update Dialog Timestamp","type":"n8n-nodes-base.postgres","typeVersion":2.4,"position":[864,240],"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"jsCode":"// Prepare final output for AI Router\nlet srcData = null;\ntry {\n  srcData = $('Prepare for AI Router').first()?.json;\n} catch (e) {\n  srcData = $input.first()?.json || {};\n}\n\nreturn {\n  tenant_id: srcData.tenant_id,\n  dialog: srcData.dialog,\n  client: srcData.client,\n  text: srcData.text,\n  channel: srcData.channel,\n  external_chat_id: srcData.external_chat_id,\n  external_user_id: srcData.external_user_id,\n  media: srcData.media,\n  meta: srcData.meta,\n  event_id: srcData.event_id,\n  client_found: srcData.client_found,\n  success: true\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1088,240],"id":"8056c775-72bc-4bc2-afb1-7cdee7190e8d","name":"Final Output"}],"connections":{"Execute Workflow Trigger":{"main":[[{"node":"Attach Base","type":"main","index":0}]]},"Attach Base":{"main":[[{"node":"Find or Create Client","type":"main","index":0},{"node":"Merge","type":"main","index":1}]]},"Find or Create Client":{"main":[[{"node":"Merge","type":"main","index":0}]]},"Merge":{"main":[[{"node":"Merge After Client","type":"main","index":0}]]},"Merge After Client":{"main":[[{"node":"Find Active Dialog","type":"main","index":0},{"node":"Merge Dialog","type":"main","index":1}]]},"Find Active Dialog":{"main":[[{"node":"Merge Dialog","type":"main","index":0}]]},"Merge Dialog":{"main":[[{"node":"Merge After Dialog","type":"main","index":0}]]},"Merge After Dialog":{"main":[[{"node":"Dialog Exists?","type":"main","index":0}]]},"Dialog Exists?":{"main":[[{"node":"Use Existing Dialog","type":"main","index":0}],[{"node":"Create New Dialog","type":"main","index":0}]]},"Use Existing Dialog":{"main":[[{"node":"Save Message Event","type":"main","index":0}]]},"Create New Dialog":{"main":[[{"node":"Merge New Dialog","type":"main","index":0}]]},"Merge New Dialog":{"main":[[{"node":"Save Message Event","type":"main","index":0}]]},"Save Message Event":{"main":[[{"node":"Prepare for AI Router","type":"main","index":0}]]},"Prepare for AI Router":{"main":[[{"node":"Update Dialog Timestamp","type":"main","index":0}]]},"Update Dialog Timestamp":{"main":[[{"node":"Final Output","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"85b84ffe-7c1f-4103-98f0-603f81440680","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2025-12-09T18:50:29.937Z","createdAt":"2025-12-09T18:50:29.937Z","role":"workflow:owner","workflowId":"LcB53NcwVT0K3K6U","projectId":"x7frUSUEowDAk8Dt"}],"activeVersion":null,"tags":[{"updatedAt":"2025-11-23T04:04:01.292Z","createdAt":"2025-11-23T04:04:01.292Z","id":"eiI07cPEeFxzR69p","name":"Core"},{"updatedAt":"2025-12-09T18:50:08.518Z","createdAt":"2025-12-09T18:50:08.518Z","id":"tMSCjbvPU3xrNUqz","name":"ELO"}]},{"updatedAt":"2025-12-22T19:19:14.786Z","createdAt":"2025-12-11T17:21:02.716Z","id":"PrsqCxCgoZuxnKus","name":"ELO_In_WhatsApp","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"whatsapp-incoming","responseMode":"responseNode","options":{}},"id":"21e3b107-fdf9-4909-9a45-e12f2ade948e","name":"WhatsApp Trigger","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[-1456,320],"webhookId":"whatsapp-webhook"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":1},"conditions":[{"id":"is-message","leftValue":"={{ $json.body.type }}","rightValue":"notify","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"options":{"looseTypeValidation":true}},"id":"2c993461-e0e7-464b-acb1-7b8c59bc3530","name":"Is Message?","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1264,320]},{"parameters":{"respondWith":"json","responseBody":"={{ { \"success\": true, \"skipped\": true, \"event\": $json.event } }}","options":{}},"id":"b8878308-0611-4d2d-a851-67876bca3998","name":"Skip Non-Message","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[-1072,512]},{"parameters":{"jsCode":"const input = $input.first().json;\n  const event = input.body || input;\n  const msg = event.message || {};\n  const key = msg.key || {};\n  const content = msg.message || {};\n\n  const chatId = key.remoteJid || '';\n\n  // Только входящие от клиентов (@s.whatsapp.net)\n  const isClient = chatId.endsWith('@s.whatsapp.net') && !key.fromMe;\n\n  if (!isClient) {\n    return [];\n  }\n\n  // Has content?\n  const hasText = !!(content.conversation || content.extendedTextMessage?.text);\n  const hasMedia = !!(content.imageMessage || content.videoMessage || content.audioMessage || content.documentMessage);\n\n  if (!hasText && !hasMedia) {\n    return [];\n  }\n\n  const phone = '+' + chatId.replace('@s.whatsapp.net', '');\n\n  const messageText = content.conversation\n    || content.extendedTextMessage?.text\n    || content.imageMessage?.caption\n    || content.videoMessage?.caption\n    || '';\n\n  const timestamp = msg.messageTimestamp\n    ? new Date(msg.messageTimestamp * 1000).toISOString()\n    : new Date().toISOString();\n\n  return {\n    session_id: event.sessionId,\n    chat_id: chatId,\n    phone: phone,\n    message_text: messageText,\n    message_id: key.id,\n    timestamp: timestamp,\n    sender_name: msg.pushName || msg.verifiedBizName || null,\n    has_photo: !!content.imageMessage,\n    has_voice: !!content.audioMessage,\n    has_video: !!content.videoMessage,\n    has_document: !!content.documentMessage,\n    raw_event: event\n  };"},"id":"4d4a2c74-554f-492d-8b53-f4e660931ee1","name":"Extract WhatsApp Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1072,320]},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $json.has_voice }}","value2":true}]}},"id":"e8a40277-bf28-4f53-b12f-44900a16209f","name":"Has Voice?","type":"n8n-nodes-base.if","typeVersion":1,"position":[-848,320]},{"parameters":{"url":"={{ $json.voice_url }}","options":{"response":{"response":{"responseFormat":"file"}}}},"id":"e95b8580-c6fc-41ca-941d-48510ba29f6c","name":"Download Voice","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-624,208]},{"parameters":{"resource":"audio","operation":"transcribe","options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[-400,208],"id":"8b7db0dc-4ed9-4329-9f77-6b998a5317f5","name":"Transcribe Voice","credentials":{"openAiApi":{"id":"ptoy1RvCOn39G0Af","name":"OpenAi account"}}},{"parameters":{"jsCode":"const data = $('Extract WhatsApp Data').first().json;\nconst transcription = $input.first().json.text;\n\nlet messageText = data.message_text;\nif (transcription) {\n  messageText = (messageText ? messageText + '\\n\\n' : '') + transcription;\n}\n\nreturn {\n  channel: 'whatsapp',\n  profile_id: data.session_id,\n  external_user_id: data.phone?.replace(/\\+/g, ''),\n  external_chat_id: data.chat_id,\n  \n  text: messageText,\n  timestamp: data.timestamp,\n  \n  client_phone: data.phone,\n  client_name: data.sender_name,\n  client_email: null,\n  \n  media: {\n    has_voice: true,\n    voice_transcribed_text: transcription,\n    has_images: data.has_photo,\n    images: data.has_photo ? [{ url: data.photo_url }] : [],\n    has_video: data.has_video,\n    videos: data.has_video ? [{ url: data.video_url }] : [],\n    has_document: data.has_document\n  },\n  \n  meta: {\n    external_message_id: data.message_id,\n    ad_channel: 'whatsapp',\n    ad_id: null,\n    original_media_type: 'voice',\n    raw: data.raw_event,\n    provider: data.provider || 'baileys'\n  },\n  \n  prefilled_data: {\n    model: null,\n    parts_owner: null\n  }\n};"},"id":"07d603d1-8064-4f9a-a4d1-212084ccefbd","name":"Normalize with Voice","type":"n8n-nodes-base.code","typeVersion":2,"position":[-176,208]},{"parameters":{"jsCode":"const data = $input.first().json;\n\nreturn {\n  channel: 'whatsapp',\n  profile_id: data.session_id,\n  external_user_id: data.phone?.replace(/\\+/g, ''),\n  external_chat_id: data.chat_id,\n  \n  text: data.message_text,\n  timestamp: data.timestamp,\n  \n  client_phone: data.phone,\n  client_name: data.sender_name,\n  client_email: null,\n  \n  media: {\n    has_voice: false,\n    voice_transcribed_text: null,\n    has_images: data.has_photo,\n    images: data.has_photo ? [{ url: data.photo_url }] : [],\n    has_video: data.has_video,\n    videos: data.has_video ? [{ url: data.video_url }] : [],\n    has_document: data.has_document\n  },\n  \n  meta: {\n    external_message_id: data.message_id,\n    ad_channel: 'whatsapp',\n    ad_id: null,\n    original_media_type: data.has_photo ? 'photo' : data.has_video ? 'video' : 'text',\n    raw: data.raw_event,\n    provider: data.provider || 'baileys'\n  },\n  \n  prefilled_data: {\n    model: null,\n    parts_owner: null\n  }\n};"},"id":"31069778-bedf-4f95-aa65-d853247c74cc","name":"Normalize without Voice","type":"n8n-nodes-base.code","typeVersion":2,"position":[-624,416]},{"parameters":{"jsCode":"// Prepare message for Redis queue (batcher will handle DB writes)\nconst data = $input.first().json;\n\nreturn {\n  message_json: JSON.stringify(data),\n  batch_key: `${data.channel}:${data.external_chat_id}`\n};"},"id":"997f29f3-a685-49de-99a4-71a500494dd7","name":"Prepare for Queue","type":"n8n-nodes-base.code","typeVersion":2,"position":[48,320]},{"parameters":{"operation":"push","list":"queue:incoming","messageData":"={{ $json.message_json }}","tail":true},"id":"31e9b30b-cdcf-45ec-b46d-5d1a0100d152","name":"Push to Queue","type":"n8n-nodes-base.redis","typeVersion":1,"position":[272,320],"credentials":{"redis":{"id":"7FQcEivUY94atW24","name":"Redis account"}}},{"parameters":{"respondWith":"json","responseBody":"={{ { \"success\": true, \"queued\": true, \"batch_key\": $json.batch_key } }}","options":{}},"id":"bf22acf6-bb9e-4fb1-9b99-8df286a96893","name":"Respond Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[496,320]}],"connections":{"WhatsApp Trigger":{"main":[[{"node":"Is Message?","type":"main","index":0}]]},"Is Message?":{"main":[[{"node":"Extract WhatsApp Data","type":"main","index":0}],[{"node":"Skip Non-Message","type":"main","index":0}]]},"Extract WhatsApp Data":{"main":[[{"node":"Has Voice?","type":"main","index":0}]]},"Has Voice?":{"main":[[{"node":"Download Voice","type":"main","index":0}],[{"node":"Normalize without Voice","type":"main","index":0}]]},"Download Voice":{"main":[[{"node":"Transcribe Voice","type":"main","index":0}]]},"Transcribe Voice":{"main":[[{"node":"Normalize with Voice","type":"main","index":0}]]},"Normalize with Voice":{"main":[[{"node":"Prepare for Queue","type":"main","index":0}]]},"Normalize without Voice":{"main":[[{"node":"Prepare for Queue","type":"main","index":0}]]},"Prepare for Queue":{"main":[[{"node":"Push to Queue","type":"main","index":0}]]},"Push to Queue":{"main":[[{"node":"Respond Success","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{"WhatsApp Trigger":[{"json":{"headers":{"host":"n8n.n8nsrv.ru","user-agent":"node","content-length":"4175","accept":"*/*","accept-encoding":"br, gzip, deflate","accept-language":"*","content-type":"application/json","sec-fetch-mode":"cors","via":"1.1 Caddy","x-forwarded-for":"155.212.221.189","x-forwarded-host":"n8n.n8nsrv.ru","x-forwarded-proto":"https"},"params":{},"query":{},"body":{"sessionId":"eldoleado_arceos","message":{"key":{"remoteJid":"status@broadcast","fromMe":false,"id":"3A75B8271D932087B08D","participant":"79275852829@s.whatsapp.net","participantLid":"79275852829@lid","remoteLid":"status@lid","remoteJidNormalized":"status@broadcast"},"messageTimestamp":1766430180,"pushName":"Али","broadcast":true,"message":{"senderKeyDistributionMessage":{"groupId":"status@broadcast","axolotlSenderKeyDistributionMessage":"Mwi+m5OCARAAGiAr6QiRy9NvayFWms4MTJKwWH0Vh0FbMyk4eADDfw5nKCIhBdCmFOEIE9Tdo8BCmdNU73W/cpEJ09RmSmbrcbLCz+Bw"},"videoMessage":{"url":"https://mmg.whatsapp.net/v/t62.7161-24/557416401_921276850222204_2821392706377997194_n.enc?ccb=11-4&oh=01_Q5Aa3QFNzLvjAgiyprug4Ags-RviIx68zvHSegtqSP_X3fcrsg&oe=69711E51&_nc_sid=5e03e0&mms3=true","mimetype":"video/mp4","fileSha256":"QzdV7skJrRhohAriZyteNCxMuQ66njj1zpZCZxH559U=","fileLength":"4702780","seconds":29,"mediaKey":"1Y+1x+lHY8ElLg/EMurTGQVCkoI0WE1OgTaAoeoJDLE=","caption":"😔","height":848,"width":464,"fileEncSha256":"bK3F4rA+jpJbHeRbVqrbgtBStdcFQvo2xE5ckiAbO/4=","directPath":"/v/t62.7161-24/557416401_921276850222204_2821392706377997194_n.enc?ccb=11-4&oh=01_Q5Aa3QFNzLvjAgiyprug4Ags-RviIx68zvHSegtqSP_X3fcrsg&oe=69711E51&_nc_sid=5e03e0","mediaKeyTimestamp":"1766430034","jpegThumbnail":"/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDABEMDQ8NCxEPDg8TEhEUGSocGRcXGTQlJx8qPTZBQDw2OzpETGJTREhcSTo7VXRWXGVobW5tQlJ4gHdqf2JrbWn/2wBDARITExkWGTIcHDJpRjtGaWlpaWlpaWlpaWlpaWlpaWlpaWlpaWlpaWlpaWlpaWlpaWlpaWlpaWlpaWlpaWlpaWn/wgARCABgADUDASIAAhEBAxEB/8QAGwAAAgMBAQEAAAAAAAAAAAAAAwQAAgUBBgf/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAABbGWgfYX4eht570JJIeB1sbTNNdUwt6jB2xuVh8+cDc0ODsNa+HqmjOQyfNdGGOlcdFUZqTNhYTAwq76w0jUhaUhztBj1wkBV7YFDQ/8QAFBEBAAAAAAAAAAAAAAAAAAAAQP/aAAgBAgEBPwBH/8QAFBEBAAAAAAAAAAAAAAAAAAAAQP/aAAgBAwEBPwBH/8QALxAAAgEDAwIFAgUFAAAAAAAAAQIDAAQREiExQVEFEBMiYTJxBkJSwdEUJIGCof/aAAgBAQABPwC98ZSIlLcB2/V0FTTyztrmYk/JqO+eBh6UjAjoKs/GkkYJONDHqeDSuGGRx5hyd+f3pI3nfBJ09qhto0XaMD71cRJOhXSAw4NeB3kkc5s5jt+TJ4PbzDkkfNWYWPGRua3PPFTTpF8sdgBVzqDC4QnWnOBj7VY3AubSOX9Q3+9ZFQ7yAnpUcmEzkbV6853I9vWhCsoEuCRjGx4qK3VMgLkHY/NeHQLb2UcanIAznyjJWQVGGYgdKVQsLYzv3O9QXQgOk7hhwOhpJARqGATyAeK8Pk1waf0nyvbdrW4aKT6huCOoqCbSAaS4DAjHSgY2UBl3+Oa0OFzpEcfzya8I3ic/IHl4gfDc/wB5oL6f9sf4ovGXYRBggPt1nfFI4FJOy/Tpz3p7rIy7l2qG/uUdjDIyjO6g1D+IJ0BWVVc9CRg1O2snG57nrVvEZXKKcPj2jue1BcnY4PavSkqC3PqBn6dKI03LkcZzUkSuc8U8asNQ2oD0pcN/yri2MsTTp9abyAdQfzfzUMpRgsm6d+1BVVCynIxzUK62mPOF/eugoIVVkJ4GQe4ph6kYPVSRXhswikXXgrnDA9VOx/mry2/p7yW3PCN7T3HSlDRMdJODyO9Q+1X0n6iAakOnAzUD6kMbHLKMqfirZhrdG2Db16S5YBidPG3Iq5Jn9OR31Mq6c6eQO9MF1DBJHfFAYc44YUVyTmpkNvLkgh1PuBqU6ZQVqKXUgbtsaHxTbAfepfbGxHIqMK6Bh1r//gADAP/Z","contextInfo":{"featureEligibilities":{"canBeReshared":false},"statusSourceType":"VIDEO"},"streamingSidecar":"4XcXGjlpiKqBREPDGJZgnPlTUI1jON6xZ0pahgRWjorPF1ZeOGd2jJUtyBXOIu7gqtA35NSsb8ld7Al+3JfZqy6PzXTFr+EuVhXxD4Hokwa/Uo3CRnkBnOkbGFwvSOmjMSxeagt0nfYi58VKWd5VQIvcp6L2rWJxrCxuozLRGbLXMYLb/yImk1ugwv2wj/Bd8IhNlRr3VWi7La57YTJi8QE2eOJ9Job8/qhReqOUmyY4z4K/qUURCauYZESmnRZGSr8KYfF6ztYnBTvto3EisEQH+Ejzmt8OCv/gdcACgO0Ql1VhLuSEiAL+Xo4hG/9FdaukjZdxCIY432v3Ri9VAH4XKmiGY5epszstsextNkc5xWuv57LMWypEn/eUEKu6E+qB3skTu5to1ZKIqQ8nYOxxUr6j6YCXTfqwVAYnudxyps1qjS5zoJ+7gUMqLAEP0KNKuspqfCPp9turSvG0YDzPuZXbfJsyQkCjAytWE6fPTJ6ZvMRFsv4M8sctTN6K7/kHXdyKt+3Fssqa4C+nll9I8IUNrT7CrFPfM3vxO+EO9LG0qPS+hG1OdqjYr8nzqonleaekI8a3VsZafUSOOQ8A6PSdFle/f0I2ctjh4K7xmnQiLe+vJSSH3ZV7ZnUGigrkXqahZF52KIFY2vtOx7jG2nGXcrkNLTHdBl0FVJFMsSyMUkAxgW0qtqfw36Acm8b/0rcXp6ffKrqitDd3lvrOJOAEZMvyDginOr8baoCuJQTj+VnF1w9tRzjQTZILti6RbExavX+CKzAzq4yYvcqjP8qrlY4vavZjNb6Q4geOQ9nciMv/CDjtLyURTgClLKfk7Zhv77ThrAKSUwCB/aYWOYCz2BvKnsnRZLzJVAryc/21mLijvl+XYZHqqKIHOAcHbxoH/i00yqVVwbEsVL7LSM46+ma4cNwJe9IR384bJXJUpNVyKpri+znxfM+t","thumbnailDirectPath":"/v/t62.36147-24/557836400_855471970422373_115496922653043052_n.enc?ccb=11-4&oh=01_Q5Aa3QHoO3hARYF6qPUN_22ohaPPUHH-4WZbPltD1vdJop1VbA&oe=69712200&_nc_sid=5e03e0","thumbnailSha256":"RP8EJlzTCz0T53oVO+/XNzj9XxXdFpDKP8saj66kJa8=","thumbnailEncSha256":"JzHvZ6Bmwus56el5ddzki0Yt1FDk9UqnbrjHWETFuk0=","metadataUrl":"","videoSourceType":"USER_VIDEO"},"messageContextInfo":{"messageSecret":"lH0UjVh0mWUAvWLdym9AW37/qeOekBQywjubA/LSl0c="}}},"type":"notify"},"webhookUrl":"https://n8n.n8nsrv.ru/webhook/whatsapp-incoming","executionMode":"production"},"pairedItem":{"item":0}}]},"versionId":"ecda806f-6b4e-4068-bf16-506262bb1099","activeVersionId":"ecda806f-6b4e-4068-bf16-506262bb1099","triggerCount":1,"shared":[{"updatedAt":"2025-12-11T17:21:02.723Z","createdAt":"2025-12-11T17:21:02.723Z","role":"workflow:owner","workflowId":"PrsqCxCgoZuxnKus","projectId":"x7frUSUEowDAk8Dt"}],"activeVersion":{"updatedAt":"2025-12-22T19:19:14.790Z","createdAt":"2025-12-22T19:19:14.790Z","versionId":"ecda806f-6b4e-4068-bf16-506262bb1099","workflowId":"PrsqCxCgoZuxnKus","nodes":[{"parameters":{"httpMethod":"POST","path":"whatsapp-incoming","responseMode":"responseNode","options":{}},"id":"21e3b107-fdf9-4909-9a45-e12f2ade948e","name":"WhatsApp Trigger","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[-1456,320],"webhookId":"whatsapp-webhook"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":1},"conditions":[{"id":"is-message","leftValue":"={{ $json.body.type }}","rightValue":"notify","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"options":{"looseTypeValidation":true}},"id":"2c993461-e0e7-464b-acb1-7b8c59bc3530","name":"Is Message?","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1264,320]},{"parameters":{"respondWith":"json","responseBody":"={{ { \"success\": true, \"skipped\": true, \"event\": $json.event } }}","options":{}},"id":"b8878308-0611-4d2d-a851-67876bca3998","name":"Skip Non-Message","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[-1072,512]},{"parameters":{"jsCode":"const input = $input.first().json;\n  const event = input.body || input;\n  const msg = event.message || {};\n  const key = msg.key || {};\n  const content = msg.message || {};\n\n  const chatId = key.remoteJid || '';\n\n  // Только входящие от клиентов (@s.whatsapp.net)\n  const isClient = chatId.endsWith('@s.whatsapp.net') && !key.fromMe;\n\n  if (!isClient) {\n    return [];\n  }\n\n  // Has content?\n  const hasText = !!(content.conversation || content.extendedTextMessage?.text);\n  const hasMedia = !!(content.imageMessage || content.videoMessage || content.audioMessage || content.documentMessage);\n\n  if (!hasText && !hasMedia) {\n    return [];\n  }\n\n  const phone = '+' + chatId.replace('@s.whatsapp.net', '');\n\n  const messageText = content.conversation\n    || content.extendedTextMessage?.text\n    || content.imageMessage?.caption\n    || content.videoMessage?.caption\n    || '';\n\n  const timestamp = msg.messageTimestamp\n    ? new Date(msg.messageTimestamp * 1000).toISOString()\n    : new Date().toISOString();\n\n  return {\n    session_id: event.sessionId,\n    chat_id: chatId,\n    phone: phone,\n    message_text: messageText,\n    message_id: key.id,\n    timestamp: timestamp,\n    sender_name: msg.pushName || msg.verifiedBizName || null,\n    has_photo: !!content.imageMessage,\n    has_voice: !!content.audioMessage,\n    has_video: !!content.videoMessage,\n    has_document: !!content.documentMessage,\n    raw_event: event\n  };"},"id":"4d4a2c74-554f-492d-8b53-f4e660931ee1","name":"Extract WhatsApp Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1072,320]},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $json.has_voice }}","value2":true}]}},"id":"e8a40277-bf28-4f53-b12f-44900a16209f","name":"Has Voice?","type":"n8n-nodes-base.if","typeVersion":1,"position":[-848,320]},{"parameters":{"url":"={{ $json.voice_url }}","options":{"response":{"response":{"responseFormat":"file"}}}},"id":"e95b8580-c6fc-41ca-941d-48510ba29f6c","name":"Download Voice","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-624,208]},{"parameters":{"resource":"audio","operation":"transcribe","options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[-400,208],"id":"8b7db0dc-4ed9-4329-9f77-6b998a5317f5","name":"Transcribe Voice","credentials":{"openAiApi":{"id":"ptoy1RvCOn39G0Af","name":"OpenAi account"}}},{"parameters":{"jsCode":"const data = $('Extract WhatsApp Data').first().json;\nconst transcription = $input.first().json.text;\n\nlet messageText = data.message_text;\nif (transcription) {\n  messageText = (messageText ? messageText + '\\n\\n' : '') + transcription;\n}\n\nreturn {\n  channel: 'whatsapp',\n  profile_id: data.session_id,\n  external_user_id: data.phone?.replace(/\\+/g, ''),\n  external_chat_id: data.chat_id,\n  \n  text: messageText,\n  timestamp: data.timestamp,\n  \n  client_phone: data.phone,\n  client_name: data.sender_name,\n  client_email: null,\n  \n  media: {\n    has_voice: true,\n    voice_transcribed_text: transcription,\n    has_images: data.has_photo,\n    images: data.has_photo ? [{ url: data.photo_url }] : [],\n    has_video: data.has_video,\n    videos: data.has_video ? [{ url: data.video_url }] : [],\n    has_document: data.has_document\n  },\n  \n  meta: {\n    external_message_id: data.message_id,\n    ad_channel: 'whatsapp',\n    ad_id: null,\n    original_media_type: 'voice',\n    raw: data.raw_event,\n    provider: data.provider || 'baileys'\n  },\n  \n  prefilled_data: {\n    model: null,\n    parts_owner: null\n  }\n};"},"id":"07d603d1-8064-4f9a-a4d1-212084ccefbd","name":"Normalize with Voice","type":"n8n-nodes-base.code","typeVersion":2,"position":[-176,208]},{"parameters":{"jsCode":"const data = $input.first().json;\n\nreturn {\n  channel: 'whatsapp',\n  profile_id: data.session_id,\n  external_user_id: data.phone?.replace(/\\+/g, ''),\n  external_chat_id: data.chat_id,\n  \n  text: data.message_text,\n  timestamp: data.timestamp,\n  \n  client_phone: data.phone,\n  client_name: data.sender_name,\n  client_email: null,\n  \n  media: {\n    has_voice: false,\n    voice_transcribed_text: null,\n    has_images: data.has_photo,\n    images: data.has_photo ? [{ url: data.photo_url }] : [],\n    has_video: data.has_video,\n    videos: data.has_video ? [{ url: data.video_url }] : [],\n    has_document: data.has_document\n  },\n  \n  meta: {\n    external_message_id: data.message_id,\n    ad_channel: 'whatsapp',\n    ad_id: null,\n    original_media_type: data.has_photo ? 'photo' : data.has_video ? 'video' : 'text',\n    raw: data.raw_event,\n    provider: data.provider || 'baileys'\n  },\n  \n  prefilled_data: {\n    model: null,\n    parts_owner: null\n  }\n};"},"id":"31069778-bedf-4f95-aa65-d853247c74cc","name":"Normalize without Voice","type":"n8n-nodes-base.code","typeVersion":2,"position":[-624,416]},{"parameters":{"jsCode":"// Prepare message for Redis queue (batcher will handle DB writes)\nconst data = $input.first().json;\n\nreturn {\n  message_json: JSON.stringify(data),\n  batch_key: `${data.channel}:${data.external_chat_id}`\n};"},"id":"997f29f3-a685-49de-99a4-71a500494dd7","name":"Prepare for Queue","type":"n8n-nodes-base.code","typeVersion":2,"position":[48,320]},{"parameters":{"operation":"push","list":"queue:incoming","messageData":"={{ $json.message_json }}","tail":true},"id":"31e9b30b-cdcf-45ec-b46d-5d1a0100d152","name":"Push to Queue","type":"n8n-nodes-base.redis","typeVersion":1,"position":[272,320],"credentials":{"redis":{"id":"7FQcEivUY94atW24","name":"Redis account"}}},{"parameters":{"respondWith":"json","responseBody":"={{ { \"success\": true, \"queued\": true, \"batch_key\": $json.batch_key } }}","options":{}},"id":"bf22acf6-bb9e-4fb1-9b99-8df286a96893","name":"Respond Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[496,320]}],"connections":{"WhatsApp Trigger":{"main":[[{"node":"Is Message?","type":"main","index":0}]]},"Is Message?":{"main":[[{"node":"Extract WhatsApp Data","type":"main","index":0}],[{"node":"Skip Non-Message","type":"main","index":0}]]},"Extract WhatsApp Data":{"main":[[{"node":"Has Voice?","type":"main","index":0}]]},"Has Voice?":{"main":[[{"node":"Download Voice","type":"main","index":0}],[{"node":"Normalize without Voice","type":"main","index":0}]]},"Download Voice":{"main":[[{"node":"Transcribe Voice","type":"main","index":0}]]},"Transcribe Voice":{"main":[[{"node":"Normalize with Voice","type":"main","index":0}]]},"Normalize with Voice":{"main":[[{"node":"Prepare for Queue","type":"main","index":0}]]},"Normalize without Voice":{"main":[[{"node":"Prepare for Queue","type":"main","index":0}]]},"Prepare for Queue":{"main":[[{"node":"Push to Queue","type":"main","index":0}]]},"Push to Queue":{"main":[[{"node":"Respond Success","type":"main","index":0}]]}},"authors":"Dmitriy Remacs","name":null,"description":null},"tags":[{"updatedAt":"2025-11-23T04:03:40.721Z","createdAt":"2025-11-23T04:03:40.721Z","id":"nLdF41tEx70V7m3A","name":"In"},{"updatedAt":"2025-12-09T18:50:08.518Z","createdAt":"2025-12-09T18:50:08.518Z","id":"tMSCjbvPU3xrNUqz","name":"ELO"}]},{"updatedAt":"2025-12-17T08:34:20.329Z","createdAt":"2025-12-10T09:59:31.067Z","id":"X3hqn2RJfBPrN9ld","name":"ELO_In_MAX","active":false,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"max","responseMode":"responseNode","options":{}},"id":"868cc90e-3100-4184-9249-e9f670bca112","name":"MAX Trigger","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[-944,-48],"webhookId":"max-webhook"},{"parameters":{"jsCode":"const event = $input.first().json;\n\n// MAX.ru webhook structure\nconst msg = event.message || event;\nconst sender = msg.from || msg.sender;\n\n// Извлекаем текст сообщения\nconst messageText = msg.text || msg.body || '';\n\n// Определяем типы медиа\nconst hasPhoto = msg.type === 'image' || !!msg.image;\nconst hasVoice = msg.type === 'voice' || msg.type === 'audio' || !!msg.voice || !!msg.audio;\nconst hasVideo = msg.type === 'video' || !!msg.video;\nconst hasDocument = msg.type === 'document' || !!msg.document;\n\n// Извлекаем URL медиа\nconst urls = [];\nlet photoUrl = null;\nlet voiceUrl = null;\nlet videoUrl = null;\n\nif (msg.image?.url) {\n  photoUrl = msg.image.url;\n  urls.push(photoUrl);\n}\n\nif (msg.voice?.url || msg.audio?.url) {\n  voiceUrl = msg.voice?.url || msg.audio?.url;\n  urls.push(voiceUrl);\n}\n\nif (msg.video?.url) {\n  videoUrl = msg.video.url;\n  urls.push(videoUrl);\n}\n\nif (msg.document?.url) {\n  urls.push(msg.document.url);\n}\n\n// Извлекаем данные отправителя\nconst senderId = sender?.id || sender?.phone || msg.chat_id;\nconst senderName = sender?.name || sender?.display_name || null;\nconst senderPhone = sender?.phone || null;\n\n// Нормализуем телефон если есть\nlet cleanPhone = null;\nif (senderPhone) {\n  cleanPhone = senderPhone.replace(/\\D/g, '');\n  if (cleanPhone.length === 11 && cleanPhone.startsWith('8')) {\n    cleanPhone = '7' + cleanPhone.substring(1);\n  }\n  if (cleanPhone) {\n    cleanPhone = '+' + cleanPhone;\n  }\n}\n\nreturn {\n  has_voice: hasVoice,\n  voice_url: voiceUrl,\n  raw_event: event,\n  sender_id: senderId,\n  sender_name: senderName,\n  sender_phone: cleanPhone,\n  chat_id: msg.chat_id || senderId?.toString(),\n  message_id: msg.id || msg.message_id || Date.now().toString(),\n  message_text: messageText,\n  message_type: msg.type,\n  timestamp: msg.timestamp ? new Date(msg.timestamp * 1000).toISOString() : new Date().toISOString(),\n  has_photo: hasPhoto,\n  photo_url: photoUrl,\n  has_video: hasVideo,\n  video_url: videoUrl,\n  has_document: hasDocument,\n  urls: urls\n};"},"id":"d4162144-7cf4-43e9-8790-bf845607b8b5","name":"Extract MAX Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[-736,-48]},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $json.has_voice }}","value2":true}]}},"id":"f9f1f936-7fb5-42fa-bf63-c7af153ec71e","name":"Has Voice?","type":"n8n-nodes-base.if","typeVersion":1,"position":[-512,-48]},{"parameters":{"url":"={{ $json.voice_url }}","options":{"response":{"response":{"responseFormat":"file"}}}},"id":"f2210a58-2deb-457b-ba7c-ad1e480026dc","name":"Download Voice","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-288,-160]},{"parameters":{"resource":"audio","operation":"transcribe","options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[-64,-160],"id":"34f14e76-e95b-4955-8bd9-5b3540bbe00c","name":"Transcribe Voice","credentials":{"openAiApi":{"id":"ptoy1RvCOn39G0Af","name":"OpenAi account"}}},{"parameters":{"jsCode":"const data = $('Extract MAX Data').first().json;\nconst transcription = $input.first().json.text;\n\nlet messageText = data.message_text;\nif (transcription) {\n  messageText = (messageText ? messageText + '\\n\\n' : '') + transcription;\n}\n\nreturn {\n  channel: 'max',\n  external_user_id: data.sender_id?.toString(),\n  external_chat_id: data.chat_id,\n  \n  text: messageText,\n  timestamp: data.timestamp,\n  \n  client_phone: data.sender_phone,\n  client_name: data.sender_name,\n  client_email: null,\n  \n  media: {\n    has_voice: true,\n    voice_transcribed_text: transcription,\n    has_images: data.has_photo,\n    images: data.has_photo ? [{ url: data.photo_url }] : [],\n    has_video: data.has_video,\n    videos: data.has_video ? [{ url: data.video_url }] : [],\n    has_document: data.has_document\n  },\n  \n  meta: {\n    external_message_id: data.message_id,\n    ad_channel: 'max',\n    ad_id: null,\n    original_media_type: 'voice',\n    raw: data.raw_event\n  },\n  \n  prefilled_data: {\n    model: null,\n    parts_owner: null\n  }\n};"},"id":"dadb7e80-225b-408d-a683-d7a1a6ad8c47","name":"Normalize with Voice","type":"n8n-nodes-base.code","typeVersion":2,"position":[160,-160]},{"parameters":{"jsCode":"const data = $input.first().json;\n\nreturn {\n  channel: 'max',\n  external_user_id: data.sender_id?.toString(),\n  external_chat_id: data.chat_id,\n  \n  text: data.message_text,\n  timestamp: data.timestamp,\n  \n  client_phone: data.sender_phone,\n  client_name: data.sender_name,\n  client_email: null,\n  \n  media: {\n    has_voice: false,\n    voice_transcribed_text: null,\n    has_images: data.has_photo,\n    images: data.has_photo ? [{ url: data.photo_url }] : [],\n    has_video: data.has_video,\n    videos: data.has_video ? [{ url: data.video_url }] : [],\n    has_document: data.has_document\n  },\n  \n  meta: {\n    external_message_id: data.message_id,\n    ad_channel: 'max',\n    ad_id: null,\n    original_media_type: data.has_photo ? 'photo' : data.has_video ? 'video' : 'text',\n    raw: data.raw_event\n  },\n  \n  prefilled_data: {\n    model: null,\n    parts_owner: null\n  }\n};"},"id":"cb4ec01a-5ec9-433b-b6da-bcdb1498dde9","name":"Normalize without Voice","type":"n8n-nodes-base.code","typeVersion":2,"position":[-288,48]},{"parameters":{"workflowId":{"__rl":true,"value":"rRO6sxLqiCdgvLZz","mode":"list","cachedResultUrl":"/workflow/rRO6sxLqiCdgvLZz","cachedResultName":"ELO_Core_Tenant_Resolver"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[384,-48],"id":"48a078af-b817-4a0e-bd85-fd31f2e98f26","name":"Execute Tenant Resolver"},{"parameters":{"jsCode":"// Подготавливаем сообщение для Redis очереди\nconst data = $input.first().json;\n\nreturn {\n  message_json: JSON.stringify(data),\n  batch_key: `${data.channel}:${data.external_chat_id}`\n};"},"id":"d7490c19-9886-4e25-8169-b727082cd31f","name":"Prepare for Queue","type":"n8n-nodes-base.code","typeVersion":2,"position":[592,-48]},{"parameters":{"operation":"push","list":"queue:incoming","messageData":"={{ $json.message_json }}","tail":true},"id":"fc89e307-4af0-4c06-8887-a5e6e52978e5","name":"Push to Queue","type":"n8n-nodes-base.redis","typeVersion":1,"position":[816,-48],"credentials":{"redis":{"id":"7FQcEivUY94atW24","name":"Redis account"}}},{"parameters":{"respondWith":"json","responseBody":"={{ { \"success\": true, \"queued\": true, \"batch_key\": $('Prepare for Queue').item.json.batch_key } }}","options":{}},"id":"436810b1-8778-490f-928f-3a13935ed3b6","name":"Respond Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[1040,-48]}],"connections":{"MAX Trigger":{"main":[[{"node":"Extract MAX Data","type":"main","index":0}]]},"Extract MAX Data":{"main":[[{"node":"Has Voice?","type":"main","index":0}]]},"Has Voice?":{"main":[[{"node":"Download Voice","type":"main","index":0}],[{"node":"Normalize without Voice","type":"main","index":0}]]},"Download Voice":{"main":[[{"node":"Transcribe Voice","type":"main","index":0}]]},"Transcribe Voice":{"main":[[{"node":"Normalize with Voice","type":"main","index":0}]]},"Normalize with Voice":{"main":[[{"node":"Execute Tenant Resolver","type":"main","index":0}]]},"Normalize without Voice":{"main":[[{"node":"Execute Tenant Resolver","type":"main","index":0}]]},"Execute Tenant Resolver":{"main":[[{"node":"Prepare for Queue","type":"main","index":0}]]},"Prepare for Queue":{"main":[[{"node":"Push to Queue","type":"main","index":0}]]},"Push to Queue":{"main":[[{"node":"Respond Success","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"d9c4a8cb-46ef-4481-bf28-32c9a2f9bbf4","activeVersionId":null,"triggerCount":1,"shared":[{"updatedAt":"2025-12-10T09:59:31.077Z","createdAt":"2025-12-10T09:59:31.077Z","role":"workflow:owner","workflowId":"X3hqn2RJfBPrN9ld","projectId":"x7frUSUEowDAk8Dt"}],"activeVersion":null,"tags":[{"updatedAt":"2025-11-23T04:03:40.721Z","createdAt":"2025-11-23T04:03:40.721Z","id":"nLdF41tEx70V7m3A","name":"In"},{"updatedAt":"2025-12-09T18:50:08.518Z","createdAt":"2025-12-09T18:50:08.518Z","id":"tMSCjbvPU3xrNUqz","name":"ELO"}]},{"updatedAt":"2025-12-21T11:25:48.597Z","createdAt":"2025-12-10T10:00:56.185Z","id":"X5hxPPtz3OQGB8SS","name":"ELO_Out_Avito","active":false,"isArchived":false,"nodes":[{"parameters":{"rule":{"interval":[{"field":"seconds","secondsInterval":3}]}},"id":"8f889a72-df3f-4058-9b0e-444f7e545980","name":"Schedule Trigger","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[-1024,-208]},{"parameters":{"operation":"pop","list":"queue:outgoing:avito","options":{}},"id":"8f1406bd-b527-436e-bef7-5e3068da2197","name":"Redis Pop Message","type":"n8n-nodes-base.redis","typeVersion":1,"position":[-800,-208],"credentials":{"redis":{"id":"7FQcEivUY94atW24","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"has-message","leftValue":"={{ $json.message_json }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"id":"b93c5622-e124-43d9-8872-bd17080c82cd","name":"IF Has Message","type":"n8n-nodes-base.if","typeVersion":2,"position":[-576,-208]},{"parameters":{"jsCode":"const messageJson = $json.message_json;\nconst message = JSON.parse(messageJson);\n\nreturn {\n  out_message: message\n};"},"id":"0b3a4667-216a-4815-b2fd-27c5883d85b5","name":"Parse Message","type":"n8n-nodes-base.code","typeVersion":2,"position":[-352,-304]},{"parameters":{"operation":"get","key":"avito_access_token","options":{}},"id":"2d6ce0f4-7833-480a-97c4-4c892a6f10a9","name":"Get Access Token","type":"n8n-nodes-base.redis","typeVersion":1,"position":[-128,-304],"credentials":{"redis":{"id":"7FQcEivUY94atW24","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"has-token","leftValue":"={{ $json.value }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"id":"12a87547-7c68-4bdb-bd43-536d625588b3","name":"IF Token Exists","type":"n8n-nodes-base.if","typeVersion":2,"position":[96,-304]},{"parameters":{"jsCode":"const parsed = $('Parse Message').first().json;\nconst tokenData = $input.first().json;\n\nconst accessToken = tokenData.value;\n\n// Escape message text for JSON\nconst escapedText = parsed.out_message.message_text\n  .replace(/\\\\/g, '\\\\\\\\')\n  .replace(/\"/g, '\\\\\"')\n  .replace(/\\n/g, '\\\\n')\n  .replace(/\\r/g, '\\\\r')\n  .replace(/\\t/g, '\\\\t');\n\nreturn {\n  ...parsed,\n  access_token: accessToken,\n  escaped_message_text: escapedText\n};"},"id":"79f1b770-60bf-4f4b-aab5-47980d8270c2","name":"Prepare Send","type":"n8n-nodes-base.code","typeVersion":2,"position":[320,-400]},{"parameters":{"method":"POST","url":"=https://api.avito.ru/messenger/v3/accounts/{{ $env.AVITO_USER_ID }}/chats/{{ $json.out_message.external_chat_id }}/messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $json.access_token }}"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"message\": {\n    \"type\": \"text\",\n    \"text\": \"{{ $json.escaped_message_text }}\"\n  }\n}","options":{"timeout":30000}},"id":"9a2052d4-89dd-4a03-8d34-07898a84a168","name":"Send Avito Message","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[544,-400]},{"parameters":{"jsCode":"const prepared = $('Prepare Send').first().json;\nconst response = $input.first().json;\n\nconst success = !response.error;\nconst messageId = response.id || Date.now().toString();\n\nreturn {\n  ...prepared,\n  avito_response: response,\n  message_id: messageId,\n  sent_at: new Date().toISOString(),\n  send_success: success\n};"},"id":"43fd2c7a-f2cc-4e3f-aadc-cd22f5590863","name":"Process Avito Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[768,-400]},{"parameters":{"operation":"executeQuery","query":"UPDATE elo_t_dialogs SET\n  last_message_at = NOW(),\n  last_operator_message_at = NOW(),\n  updated_at = NOW()\nWHERE id = '{{ $json.out_message.dialog_id }}'::uuid;","options":{}},"id":"a2f2a9ab-a844-4c20-813e-75ec12a533ff","name":"Update Dialog Timestamp","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[992,-400],"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"jsCode":"// No token found - log error\nconst parsed = $('Parse Message').first().json;\n\nconsole.error('No Avito access token found');\n\nreturn {\n  success: false,\n  error: 'No Avito access token found - run token refresher',\n  out_message: parsed.out_message\n};"},"id":"667373af-8490-4388-b29d-a539f2e58244","name":"No Token Error","type":"n8n-nodes-base.code","typeVersion":2,"position":[320,-208]},{"parameters":{"jsCode":"// No message in queue - just return\nreturn { empty: true };"},"id":"6ceaac85-1078-4f5e-9cf1-3fdffbbec937","name":"No Message","type":"n8n-nodes-base.code","typeVersion":2,"position":[-352,-112]}],"connections":{"Schedule Trigger":{"main":[[{"node":"Redis Pop Message","type":"main","index":0}]]},"Redis Pop Message":{"main":[[{"node":"IF Has Message","type":"main","index":0}]]},"IF Has Message":{"main":[[{"node":"Parse Message","type":"main","index":0}],[{"node":"No Message","type":"main","index":0}]]},"Parse Message":{"main":[[{"node":"Get Access Token","type":"main","index":0}]]},"Get Access Token":{"main":[[{"node":"IF Token Exists","type":"main","index":0}]]},"IF Token Exists":{"main":[[{"node":"Prepare Send","type":"main","index":0}],[{"node":"No Token Error","type":"main","index":0}]]},"Prepare Send":{"main":[[{"node":"Send Avito Message","type":"main","index":0}]]},"Send Avito Message":{"main":[[{"node":"Process Avito Response","type":"main","index":0}]]},"Process Avito Response":{"main":[[{"node":"Update Dialog Timestamp","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"eb0a7af3-16d2-426b-b1b2-77942b854b1f","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2025-12-10T10:00:56.191Z","createdAt":"2025-12-10T10:00:56.191Z","role":"workflow:owner","workflowId":"X5hxPPtz3OQGB8SS","projectId":"x7frUSUEowDAk8Dt"}],"activeVersion":null,"tags":[{"updatedAt":"2025-11-23T04:03:34.766Z","createdAt":"2025-11-23T04:03:34.766Z","id":"IbDkJphbr4EygdRZ","name":"Out"},{"updatedAt":"2025-12-09T18:50:08.518Z","createdAt":"2025-12-09T18:50:08.518Z","id":"tMSCjbvPU3xrNUqz","name":"ELO"}]},{"updatedAt":"2025-12-20T17:10:51.949Z","createdAt":"2025-12-17T08:34:17.122Z","id":"ZC8ivCruNEq6Vc7b","name":"ELO_In_App","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"in-app","responseMode":"responseNode","options":{}},"id":"4ac8be90-f651-4e70-83d3-baeae045a7d8","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-976,80],"webhookId":"2b54cbe0-fab1-4454-8fbb-26bd452b2dc8"},{"parameters":{"jsCode":"// Determine what processing is needed\nconst body = $input.item.json.body;\n\nreturn {\n  json: {\n    ...body,\n    needs_transcription: body.has_audio && body.audio_url,\n    needs_media_download: body.has_media && body.media_url\n  }\n};"},"id":"1eb78a52-a656-4c48-a1c3-bbd86471b7c0","name":"Prepare","type":"n8n-nodes-base.code","typeVersion":2,"position":[-768,80]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"needs_transcription","leftValue":"={{ $json.needs_transcription }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"2eb7b363-eb87-4508-b0ed-668d1fbcdf1c","name":"Needs Transcription?","type":"n8n-nodes-base.if","typeVersion":2,"position":[-576,-32]},{"parameters":{"url":"={{ $json.audio_url }}","options":{"response":{"response":{"responseFormat":"file"}}}},"id":"985c8c2a-3cfd-4715-9398-ce5ff756b1c2","name":"Download Audio","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-368,-128]},{"parameters":{"method":"POST","url":"https://api.openai.com/v1/audio/transcriptions","authentication":"predefinedCredentialType","nodeCredentialType":"openAiApi","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"parameterType":"formBinaryData","name":"file","inputDataFieldName":"data"},{"name":"model","value":"whisper-1"},{"name":"language","value":"ru"}]},"options":{}},"id":"c90c25fa-74ba-4ecf-a521-cb4c255f3486","name":"Whisper","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-176,-128],"credentials":{"openAiApi":{"id":"ptoy1RvCOn39G0Af","name":"OpenAi account"}}},{"parameters":{"jsCode":"// Add transcription to message\nconst prepare = $('Prepare').item.json;\nconst transcription = $input.item.json.text || '';\n\nlet text = prepare.text || '';\nif (transcription) {\n  text = text ? `${text}\\n[Voice]: ${transcription}` : transcription;\n}\n\nreturn {\n  json: {\n    ...prepare,\n    text: text,\n    transcription: transcription\n  }\n};"},"id":"d3f22310-b258-4bb2-880c-04dfbb4a9810","name":"Add Transcription","type":"n8n-nodes-base.code","typeVersion":2,"position":[32,-128]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"needs_media","leftValue":"={{ $json.needs_media_download }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"21898851-3b9c-4002-adc4-7e51f535c2ae","name":"Needs Media Download?","type":"n8n-nodes-base.if","typeVersion":2,"position":[240,-32]},{"parameters":{"method":"POST","url":"http://155.212.221.189:8800/api/proxy/fetch","sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"tenant_id\": \"{{ $json.tenant_id || 'default' }}\",\n  \"url\": \"{{ $json.media_url }}\",\n  \"method\": \"GET\",\n  \"timeout\": 60,\n  \"server_id\": \"{{ $json.server_id }}\"\n}","options":{"response":{"response":{"responseFormat":"file"}},"timeout":90000}},"id":"527e1c2d-9ce1-43b0-926d-fb22aed16175","name":"Proxy Fetch Media","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[432,-128]},{"parameters":{"operation":"write","fileName":"={{ '/tmp/media_' + $('Prepare').item.json.id + '.' + ($('Prepare').item.json.media_type || 'bin').split('/').pop() }}","options":{}},"id":"d281c13f-8d00-46e9-b616-77b862851f00","name":"Save Media","type":"n8n-nodes-base.readWriteFile","typeVersion":1,"position":[640,-128]},{"parameters":{"jsCode":"// Add local media path\nconst prev = $('Check Media Download?').item.json;\nconst savedFile = $input.item.json;\n\nreturn {\n  json: {\n    ...prev,\n    media_local_path: savedFile.fileName,\n    media_downloaded: true\n  }\n};"},"id":"c2e5cb43-897a-4de1-bea9-e945e10bfd6e","name":"Add Media Path","type":"n8n-nodes-base.code","typeVersion":2,"position":[832,-128]},{"parameters":{"jsCode":"// Pass through without changes\nreturn $input.item;"},"id":"8163d80d-1771-4fb7-9782-dafa05ace2b3","name":"No Audio","type":"n8n-nodes-base.code","typeVersion":2,"position":[32,80]},{"parameters":{"jsCode":"// Pass through without media download\nreturn $input.item;"},"id":"bd213a35-7c0c-4148-80fa-8c22a6bcb821","name":"No Media","type":"n8n-nodes-base.code","typeVersion":2,"position":[832,80]},{"parameters":{"mode":"combine","options":{}},"id":"f52f14ff-e41b-4a32-bb84-5171a1de1792","name":"Merge","type":"n8n-nodes-base.merge","typeVersion":3,"position":[1040,-32]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{}},"id":"fff020c5-5525-4646-af40-7c45596d5e65","name":"Respond","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1232,-32]}],"connections":{"Webhook":{"main":[[{"node":"Prepare","type":"main","index":0}]]},"Prepare":{"main":[[{"node":"Needs Transcription?","type":"main","index":0}]]},"Needs Transcription?":{"main":[[{"node":"Download Audio","type":"main","index":0}],[{"node":"No Audio","type":"main","index":0}]]},"Download Audio":{"main":[[{"node":"Whisper","type":"main","index":0}]]},"Whisper":{"main":[[{"node":"Add Transcription","type":"main","index":0}]]},"Add Transcription":{"main":[[{"node":"Needs Media Download?","type":"main","index":0}]]},"No Audio":{"main":[[{"node":"Needs Media Download?","type":"main","index":0}]]},"Needs Media Download?":{"main":[[{"node":"Proxy Fetch Media","type":"main","index":0}],[{"node":"No Media","type":"main","index":0}]]},"Proxy Fetch Media":{"main":[[{"node":"Save Media","type":"main","index":0}]]},"Save Media":{"main":[[{"node":"Add Media Path","type":"main","index":0}]]},"Add Media Path":{"main":[[{"node":"Merge","type":"main","index":0}]]},"No Media":{"main":[[{"node":"Merge","type":"main","index":0}]]},"Merge":{"main":[[{"node":"Respond","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"03c7d4ac-d83d-4a6f-b3db-067cacb8d378","activeVersionId":"03c7d4ac-d83d-4a6f-b3db-067cacb8d378","triggerCount":1,"shared":[{"updatedAt":"2025-12-17T08:34:17.129Z","createdAt":"2025-12-17T08:34:17.129Z","role":"workflow:owner","workflowId":"ZC8ivCruNEq6Vc7b","projectId":"x7frUSUEowDAk8Dt"}],"activeVersion":{"updatedAt":"2025-12-20T17:10:51.951Z","createdAt":"2025-12-20T17:10:51.951Z","versionId":"03c7d4ac-d83d-4a6f-b3db-067cacb8d378","workflowId":"ZC8ivCruNEq6Vc7b","nodes":[{"parameters":{"httpMethod":"POST","path":"in-app","responseMode":"responseNode","options":{}},"id":"4ac8be90-f651-4e70-83d3-baeae045a7d8","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-976,80],"webhookId":"2b54cbe0-fab1-4454-8fbb-26bd452b2dc8"},{"parameters":{"jsCode":"// Determine what processing is needed\nconst body = $input.item.json.body;\n\nreturn {\n  json: {\n    ...body,\n    needs_transcription: body.has_audio && body.audio_url,\n    needs_media_download: body.has_media && body.media_url\n  }\n};"},"id":"1eb78a52-a656-4c48-a1c3-bbd86471b7c0","name":"Prepare","type":"n8n-nodes-base.code","typeVersion":2,"position":[-768,80]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"needs_transcription","leftValue":"={{ $json.needs_transcription }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"2eb7b363-eb87-4508-b0ed-668d1fbcdf1c","name":"Needs Transcription?","type":"n8n-nodes-base.if","typeVersion":2,"position":[-576,-32]},{"parameters":{"url":"={{ $json.audio_url }}","options":{"response":{"response":{"responseFormat":"file"}}}},"id":"985c8c2a-3cfd-4715-9398-ce5ff756b1c2","name":"Download Audio","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-368,-128]},{"parameters":{"method":"POST","url":"https://api.openai.com/v1/audio/transcriptions","authentication":"predefinedCredentialType","nodeCredentialType":"openAiApi","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"parameterType":"formBinaryData","name":"file","inputDataFieldName":"data"},{"name":"model","value":"whisper-1"},{"name":"language","value":"ru"}]},"options":{}},"id":"c90c25fa-74ba-4ecf-a521-cb4c255f3486","name":"Whisper","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-176,-128],"credentials":{"openAiApi":{"id":"ptoy1RvCOn39G0Af","name":"OpenAi account"}}},{"parameters":{"jsCode":"// Add transcription to message\nconst prepare = $('Prepare').item.json;\nconst transcription = $input.item.json.text || '';\n\nlet text = prepare.text || '';\nif (transcription) {\n  text = text ? `${text}\\n[Voice]: ${transcription}` : transcription;\n}\n\nreturn {\n  json: {\n    ...prepare,\n    text: text,\n    transcription: transcription\n  }\n};"},"id":"d3f22310-b258-4bb2-880c-04dfbb4a9810","name":"Add Transcription","type":"n8n-nodes-base.code","typeVersion":2,"position":[32,-128]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"needs_media","leftValue":"={{ $json.needs_media_download }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"21898851-3b9c-4002-adc4-7e51f535c2ae","name":"Needs Media Download?","type":"n8n-nodes-base.if","typeVersion":2,"position":[240,-32]},{"parameters":{"method":"POST","url":"http://155.212.221.189:8800/api/proxy/fetch","sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"tenant_id\": \"{{ $json.tenant_id || 'default' }}\",\n  \"url\": \"{{ $json.media_url }}\",\n  \"method\": \"GET\",\n  \"timeout\": 60,\n  \"server_id\": \"{{ $json.server_id }}\"\n}","options":{"response":{"response":{"responseFormat":"file"}},"timeout":90000}},"id":"527e1c2d-9ce1-43b0-926d-fb22aed16175","name":"Proxy Fetch Media","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[432,-128]},{"parameters":{"operation":"write","fileName":"={{ '/tmp/media_' + $('Prepare').item.json.id + '.' + ($('Prepare').item.json.media_type || 'bin').split('/').pop() }}","options":{}},"id":"d281c13f-8d00-46e9-b616-77b862851f00","name":"Save Media","type":"n8n-nodes-base.readWriteFile","typeVersion":1,"position":[640,-128]},{"parameters":{"jsCode":"// Add local media path\nconst prev = $('Check Media Download?').item.json;\nconst savedFile = $input.item.json;\n\nreturn {\n  json: {\n    ...prev,\n    media_local_path: savedFile.fileName,\n    media_downloaded: true\n  }\n};"},"id":"c2e5cb43-897a-4de1-bea9-e945e10bfd6e","name":"Add Media Path","type":"n8n-nodes-base.code","typeVersion":2,"position":[832,-128]},{"parameters":{"jsCode":"// Pass through without changes\nreturn $input.item;"},"id":"8163d80d-1771-4fb7-9782-dafa05ace2b3","name":"No Audio","type":"n8n-nodes-base.code","typeVersion":2,"position":[32,80]},{"parameters":{"jsCode":"// Pass through without media download\nreturn $input.item;"},"id":"bd213a35-7c0c-4148-80fa-8c22a6bcb821","name":"No Media","type":"n8n-nodes-base.code","typeVersion":2,"position":[832,80]},{"parameters":{"mode":"combine","options":{}},"id":"f52f14ff-e41b-4a32-bb84-5171a1de1792","name":"Merge","type":"n8n-nodes-base.merge","typeVersion":3,"position":[1040,-32]},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{}},"id":"fff020c5-5525-4646-af40-7c45596d5e65","name":"Respond","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1232,-32]}],"connections":{"Webhook":{"main":[[{"node":"Prepare","type":"main","index":0}]]},"Prepare":{"main":[[{"node":"Needs Transcription?","type":"main","index":0}]]},"Needs Transcription?":{"main":[[{"node":"Download Audio","type":"main","index":0}],[{"node":"No Audio","type":"main","index":0}]]},"Download Audio":{"main":[[{"node":"Whisper","type":"main","index":0}]]},"Whisper":{"main":[[{"node":"Add Transcription","type":"main","index":0}]]},"Add Transcription":{"main":[[{"node":"Needs Media Download?","type":"main","index":0}]]},"No Audio":{"main":[[{"node":"Needs Media Download?","type":"main","index":0}]]},"Needs Media Download?":{"main":[[{"node":"Proxy Fetch Media","type":"main","index":0}],[{"node":"No Media","type":"main","index":0}]]},"Proxy Fetch Media":{"main":[[{"node":"Save Media","type":"main","index":0}]]},"Save Media":{"main":[[{"node":"Add Media Path","type":"main","index":0}]]},"Add Media Path":{"main":[[{"node":"Merge","type":"main","index":0}]]},"No Media":{"main":[[{"node":"Merge","type":"main","index":0}]]},"Merge":{"main":[[{"node":"Respond","type":"main","index":0}]]}},"authors":"Dmitriy Remacs","name":null,"description":null},"tags":[{"updatedAt":"2025-11-23T04:03:40.721Z","createdAt":"2025-11-23T04:03:40.721Z","id":"nLdF41tEx70V7m3A","name":"In"},{"updatedAt":"2025-12-09T18:50:08.518Z","createdAt":"2025-12-09T18:50:08.518Z","id":"tMSCjbvPU3xrNUqz","name":"ELO"}]},{"updatedAt":"2025-12-21T11:27:07.611Z","createdAt":"2025-12-10T10:01:36.319Z","id":"ZqRsbSo0I0z71Bwb","name":"ELO_Out_VK","active":false,"isArchived":false,"nodes":[{"parameters":{"rule":{"interval":[{"field":"seconds","secondsInterval":3}]}},"id":"42f230c6-0ec1-4cc0-bbd2-c9c832105439","name":"Schedule Trigger","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[-1504,64]},{"parameters":{"operation":"pop","list":"queue:outgoing:vk","options":{}},"id":"02926d5f-a1ad-41ed-a5d0-9caf4cc773cb","name":"Redis Pop Message","type":"n8n-nodes-base.redis","typeVersion":1,"position":[-1280,64],"credentials":{"redis":{"id":"7FQcEivUY94atW24","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"has-message","leftValue":"={{ $json.message_json }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"id":"9f769393-428d-4f6e-b23f-5c0a4d63b029","name":"IF Has Message","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1056,64]},{"parameters":{"jsCode":"const messageJson = $json.message_json;\nconst message = JSON.parse(messageJson);\n\nreturn {\n  out_message: message\n};"},"id":"d25e2da8-2757-4965-b264-068df5f31fe7","name":"Parse Message","type":"n8n-nodes-base.code","typeVersion":2,"position":[-832,-32]},{"parameters":{"operation":"executeQuery","query":"SELECT \n  ca.credentials->>'access_token' as access_token,\n  ca.account_id,\n  ca.account_name\nFROM elo_t_channel_accounts ca\nWHERE ca.tenant_id = '{{ $json.out_message.tenant_id }}'::uuid\n  AND ca.channel_id = 4\n  AND ca.is_active = true\nLIMIT 1;","options":{}},"id":"0c757117-d2e8-4c13-b252-7b14f855c0d2","name":"Get VK Token","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-608,-32],"alwaysOutputData":true,"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"has-token","leftValue":"={{ $json.access_token }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"id":"01440499-4c99-41ae-8bc6-5aca1d2a80d7","name":"IF Token Exists","type":"n8n-nodes-base.if","typeVersion":2,"position":[-384,-32]},{"parameters":{"method":"POST","url":"https://api.vk.com/method/messages.send","sendQuery":true,"queryParameters":{"parameters":[{"name":"access_token","value":"={{ $json.access_token }}"},{"name":"peer_id","value":"={{ $('Parse Message').item.json.out_message.external_chat_id }}"},{"name":"message","value":"={{ $('Parse Message').item.json.out_message.message_text }}"},{"name":"random_id","value":"={{ Math.floor(Math.random() * 1000000000) }}"},{"name":"v","value":"5.131"}]},"options":{"timeout":30000}},"id":"bbe1fafc-ad28-4f60-8701-7e79704085a2","name":"Send VK Message","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-160,-128]},{"parameters":{"jsCode":"const parsed = $('Parse Message').first().json;\nconst response = $input.first().json;\n\nconst success = !response.error;\nconst messageId = response.response?.toString() || Date.now().toString();\n\nreturn {\n  ...parsed,\n  vk_response: response,\n  message_id: messageId,\n  sent_at: new Date().toISOString(),\n  send_success: success\n};"},"id":"65ea5399-4807-4451-b868-82b2afd7060c","name":"Process VK Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[64,-128]},{"parameters":{"operation":"executeQuery","query":"UPDATE elo_t_dialogs SET\n  last_message_at = NOW(),\n  last_operator_message_at = NOW(),\n  updated_at = NOW()\nWHERE id = '{{ $json.out_message.dialog_id }}'::uuid;","options":{}},"id":"093e0f8a-ab44-42e9-a907-0523564b1472","name":"Update Dialog Timestamp","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[288,-128],"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"jsCode":"// No token found - log error\nconst parsed = $('Parse Message').first().json;\n\nconsole.error('No VK access token found for tenant:', parsed.out_message?.tenant_id);\n\nreturn {\n  success: false,\n  error: 'No VK access token found for tenant',\n  tenant_id: parsed.out_message?.tenant_id,\n  out_message: parsed.out_message\n};"},"id":"62924467-6449-4e31-8fa8-c1cb27b70789","name":"No Token Error","type":"n8n-nodes-base.code","typeVersion":2,"position":[-160,64]},{"parameters":{"jsCode":"// No message in queue - just return\nreturn { empty: true };"},"id":"eb03b052-b1f5-4bd5-a29f-07e9610a69fe","name":"No Message","type":"n8n-nodes-base.code","typeVersion":2,"position":[-832,160]}],"connections":{"Schedule Trigger":{"main":[[{"node":"Redis Pop Message","type":"main","index":0}]]},"Redis Pop Message":{"main":[[{"node":"IF Has Message","type":"main","index":0}]]},"IF Has Message":{"main":[[{"node":"Parse Message","type":"main","index":0}],[{"node":"No Message","type":"main","index":0}]]},"Parse Message":{"main":[[{"node":"Get VK Token","type":"main","index":0}]]},"Get VK Token":{"main":[[{"node":"IF Token Exists","type":"main","index":0}]]},"IF Token Exists":{"main":[[{"node":"Send VK Message","type":"main","index":0}],[{"node":"No Token Error","type":"main","index":0}]]},"Send VK Message":{"main":[[{"node":"Process VK Response","type":"main","index":0}]]},"Process VK Response":{"main":[[{"node":"Update Dialog Timestamp","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"978868fe-2aa2-44e5-ab58-7c0d36beafab","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2025-12-10T10:01:36.325Z","createdAt":"2025-12-10T10:01:36.325Z","role":"workflow:owner","workflowId":"ZqRsbSo0I0z71Bwb","projectId":"x7frUSUEowDAk8Dt"}],"activeVersion":null,"tags":[{"updatedAt":"2025-11-23T04:03:34.766Z","createdAt":"2025-11-23T04:03:34.766Z","id":"IbDkJphbr4EygdRZ","name":"Out"},{"updatedAt":"2025-12-09T18:50:08.518Z","createdAt":"2025-12-09T18:50:08.518Z","id":"tMSCjbvPU3xrNUqz","name":"ELO"}]},{"updatedAt":"2025-12-23T08:27:46.510Z","createdAt":"2025-12-14T07:12:31.403Z","id":"afbJwet95gV9Evc5","name":"ELO_Input_Processor","active":false,"isArchived":false,"nodes":[{"parameters":{"rule":{"interval":[{"field":"seconds","secondsInterval":3}]}},"id":"a910abde-74b6-4434-b906-82156fe49a27","name":"Schedule Trigger","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[-1104,64]},{"parameters":{"operation":"keys","keyPattern":"deadline:*"},"id":"3e863806-ef40-4cc3-9ced-dc67e687fdcc","name":"Get All Deadlines","type":"n8n-nodes-base.redis","typeVersion":1,"position":[-912,64],"credentials":{"redis":{"id":"7FQcEivUY94atW24","name":"Redis account"}}},{"parameters":{"jsCode":"// Извлекаем ключи deadline:*\n// Redis KEYS возвращает ключи как свойства объекта\nconst now = Date.now();\nconst allKeys = Object.keys($json);\nconst deadlineKeys = allKeys.filter(k => k.startsWith('deadline:'));\n\nif (deadlineKeys.length === 0) {\n  return [{ json: { has_deadlines: false, items: [], now } }];\n}\n\n// Создаём items для проверки каждого deadline\nconst items = deadlineKeys.map(dk => {\n  const batch_key = dk.replace('deadline:', '');\n  return {\n    deadline_key: dk,\n    batch_key: batch_key,\n    batch_list_key: `batch:${batch_key}`,\n    first_seen_key: `first_seen:${batch_key}`,\n    deadline_value: $json[dk]  // значение deadline уже в ответе KEYS? нет, нужен GET\n  };\n});\n\nreturn [{ json: { has_deadlines: true, items, now } }];"},"id":"b6af8053-ce14-4be2-98b4-0f52add4d18f","name":"Parse Deadline Keys","type":"n8n-nodes-base.code","typeVersion":2,"position":[-704,64]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"has-deadlines","leftValue":"={{ $json.has_deadlines }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"looseTypeValidation":true,"options":{}},"id":"e6a3521f-1dd9-4d80-b28a-b5013cf6c18a","name":"If Has Deadlines","type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-512,64]},{"parameters":{},"id":"369ef66c-07fd-46db-99ed-3944f4cc3256","name":"End (No Deadlines)","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-240,208]},{"parameters":{"jsCode":"// Разбиваем items для обработки каждого deadline\nconst data = $json;\nconst now = data.now;\n\nreturn data.items.map(item => ({\n  json: {\n    ...item,\n    now\n  }\n}));"},"id":"e5e00404-6915-42d0-80da-b11ef4c9b8eb","name":"Split Items","type":"n8n-nodes-base.code","typeVersion":2,"position":[-256,-32]},{"parameters":{"operation":"get","key":"={{ $json.deadline_key }}","options":{}},"id":"25e2c7a8-ed0b-495a-b8da-aeb51e975299","name":"Get Deadline Value","type":"n8n-nodes-base.redis","typeVersion":1,"position":[-64,-32],"credentials":{"redis":{"id":"7FQcEivUY94atW24","name":"Redis account"}}},{"parameters":{"jsCode":"// Проверяем is_due\nconst prev = $('Split Items').item.json;\nconst now = prev.now;\n\n// Получаем значение deadline\nlet deadline_value = $json.value;\nif (!deadline_value) {\n  const keys = Object.keys($json);\n  for (const k of keys) {\n    if (k.startsWith('deadline:')) {\n      deadline_value = $json[k];\n      break;\n    }\n  }\n}\n\nconst deadline = parseInt(deadline_value || '0', 10);\n\n// is_due если deadline истёк или не существует (orphan)\nconst is_orphan = deadline === 0;\nconst is_expired = deadline > 0 && deadline <= now;\nconst is_due = is_orphan || is_expired;\n\nreturn [{\n  json: {\n    batch_key: prev.batch_key,\n    batch_list_key: prev.batch_list_key,\n    deadline_key: prev.deadline_key,\n    first_seen_key: prev.first_seen_key,\n    deadline,\n    now,\n    is_due,\n    reason: is_orphan ? 'orphan' : (is_expired ? 'timeout' : 'waiting')\n  }\n}];"},"id":"4830c76c-c3a4-4f82-9f4e-f1cfb777f3b9","name":"Check If Due","type":"n8n-nodes-base.code","typeVersion":2,"position":[144,-32]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"is-due","leftValue":"={{ $json.is_due }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"looseTypeValidation":true,"options":{}},"id":"1f2d6051-cef4-4eaa-85ca-95c0268a7fe4","name":"If Due","type":"n8n-nodes-base.if","typeVersion":2.2,"position":[352,-32]},{"parameters":{},"id":"fe3ad1b2-95af-4cc6-963e-cd66362cf423","name":"Not Due Yet","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[576,64]},{"parameters":{"operation":"get","key":"={{ $json.batch_list_key }}","keyType":"list","options":{}},"id":"51fd9317-b2ad-45f6-96ec-85f462e33d3b","name":"Get Batch Messages","type":"n8n-nodes-base.redis","typeVersion":1,"position":[576,-128],"credentials":{"redis":{"id":"7FQcEivUY94atW24","name":"Redis account"}}},{"parameters":{"jsCode":"// Мержим все сообщения из батча\nconst prev = $('Check If Due').item.json;\nconst batch_key = prev.batch_key;\nconst reason = prev.reason;\n\n// Redis GET list возвращает массив в propertyName или напрямую\nlet messagesRaw = $json.propertyName || [];\nif (!Array.isArray(messagesRaw)) {\n  // Попробуем найти массив в других полях\n  const keys = Object.keys($json);\n  for (const k of keys) {\n    if (Array.isArray($json[k])) {\n      messagesRaw = $json[k];\n      break;\n    }\n  }\n}\n\n// Парсим JSON строки в объекты\nconst messages = [];\nfor (const raw of messagesRaw) {\n  try {\n    const msg = typeof raw === 'string' ? JSON.parse(raw) : raw;\n    messages.push(msg);\n  } catch (e) {\n    // skip invalid\n  }\n}\n\nif (messages.length === 0) {\n  return [{\n    json: {\n      skip: true,\n      batch_key,\n      reason: 'empty_batch',\n      batch_list_key: prev.batch_list_key,\n      deadline_key: prev.deadline_key,\n      first_seen_key: prev.first_seen_key\n    }\n  }];\n}\n\n// Merge texts\nconst texts = messages.map(m => m.text || '').filter(Boolean);\nconst merged_text = texts.join('\\n\\n');\n\n// Merge media\nconst all_media = [];\nfor (const msg of messages) {\n  if (msg.media && Object.keys(msg.media).length > 0) {\n    all_media.push(msg.media);\n  }\n}\n\n// Message IDs\nconst message_ids = messages.map(m => m.message_id || m.meta?.external_message_id).filter(Boolean);\n\n// Sample = last message (most recent data)\nconst sample = messages[messages.length - 1];\n\nconst payload = {\n  channel: sample.channel,\n  bot_token: sample.bot_token,\n  external_user_id: sample.external_user_id,\n  external_chat_id: sample.external_chat_id,\n  client_name: sample.client_name,\n  client_phone: sample.client_phone,\n  text: merged_text,\n  timestamp: sample.timestamp,\n  message_ids: message_ids,\n  trace_id: sample.trace_id || `trace_${Date.now()}`,\n  media: all_media.length === 1 ? all_media[0] : (all_media.length > 1 ? { items: all_media } : {}),\n  tenant_id: sample.tenant_id,\n  tenant_name: sample.tenant_name,\n  tenant_config: sample.tenant_config,\n  meta: {\n    ...(sample.meta || {}),\n    batched: messages.length > 1,\n    batch_size: messages.length,\n    batch_reason: reason\n  }\n};\n\nreturn [{\n  json: {\n    skip: false,\n    batch_key,\n    payload,\n    batch_list_key: prev.batch_list_key,\n    deadline_key: prev.deadline_key,\n    first_seen_key: prev.first_seen_key\n  }\n}];"},"id":"a5389ba1-9a16-42ad-996f-24e0a9e5a2d5","name":"Merge Batch","type":"n8n-nodes-base.code","typeVersion":2,"position":[784,-128]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"skip-check","leftValue":"={{ $json.skip }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"f23cb593-2800-464e-aadb-036a09628948","name":"If Skip","type":"n8n-nodes-base.if","typeVersion":2.2,"position":[976,-128]},{"parameters":{"operation":"delete","key":"={{ $json.batch_list_key }}"},"id":"88b8a985-3874-46fc-9625-38f262d37a4d","name":"Delete Batch (Skip)","type":"n8n-nodes-base.redis","typeVersion":1,"position":[1184,-224],"credentials":{"redis":{"id":"7FQcEivUY94atW24","name":"Redis account"}}},{"parameters":{"workflowId":{"__rl":true,"value":"OHjjTQDguN2G6xin","mode":"list","cachedResultUrl":"/workflow/OHjjTQDguN2G6xin","cachedResultName":"ELO_Client_Resolve"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"id":"b464d2f7-63da-4540-91ae-7ead28ae0932","name":"Call Client Resolve","type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[1184,-32]},{"parameters":{"operation":"delete","key":"={{ $('Merge Batch').item.json.batch_list_key }}"},"id":"76b5e49e-b82c-4bb3-b6ee-ffc3161be80f","name":"Delete Batch","type":"n8n-nodes-base.redis","typeVersion":1,"position":[1376,-32],"credentials":{"redis":{"id":"7FQcEivUY94atW24","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"={{ $('Merge Batch').item.json.deadline_key }}"},"id":"fd1e86a5-31ec-4336-be87-b799075ecc2e","name":"Delete Deadline","type":"n8n-nodes-base.redis","typeVersion":1,"position":[1584,-32],"credentials":{"redis":{"id":"7FQcEivUY94atW24","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"={{ $('Merge Batch').item.json.first_seen_key }}"},"id":"c907e97c-13d2-45cf-bb70-4be83f59befc","name":"Delete First Seen","type":"n8n-nodes-base.redis","typeVersion":1,"position":[1776,-32],"credentials":{"redis":{"id":"7FQcEivUY94atW24","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"={{ $('Merge Batch').item.json.deadline_key }}"},"id":"03e22124-c4ac-45c3-8fe8-aec8104ffe29","name":"Delete Deadline (Skip)","type":"n8n-nodes-base.redis","typeVersion":1,"position":[1376,-224],"credentials":{"redis":{"id":"7FQcEivUY94atW24","name":"Redis account"}}},{"parameters":{"operation":"delete","key":"={{ $('Merge Batch').item.json.first_seen_key }}"},"id":"9182d62b-1250-4bdd-a8b4-8e48048648d6","name":"Delete First Seen (Skip)","type":"n8n-nodes-base.redis","typeVersion":1,"position":[1584,-224],"credentials":{"redis":{"id":"7FQcEivUY94atW24","name":"Redis account"}}},{"parameters":{},"id":"42baa2e1-4735-4576-94b4-d7100e0f3d1d","name":"End (Done)","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[1984,-128]}],"connections":{"Schedule Trigger":{"main":[[{"node":"Get All Deadlines","type":"main","index":0}]]},"Get All Deadlines":{"main":[[{"node":"Parse Deadline Keys","type":"main","index":0}]]},"Parse Deadline Keys":{"main":[[{"node":"If Has Deadlines","type":"main","index":0}]]},"If Has Deadlines":{"main":[[{"node":"Split Items","type":"main","index":0}],[{"node":"End (No Deadlines)","type":"main","index":0}]]},"Split Items":{"main":[[{"node":"Get Deadline Value","type":"main","index":0}]]},"Get Deadline Value":{"main":[[{"node":"Check If Due","type":"main","index":0}]]},"Check If Due":{"main":[[{"node":"If Due","type":"main","index":0}]]},"If Due":{"main":[[{"node":"Get Batch Messages","type":"main","index":0}],[{"node":"Not Due Yet","type":"main","index":0}]]},"Get Batch Messages":{"main":[[{"node":"Merge Batch","type":"main","index":0}]]},"Merge Batch":{"main":[[{"node":"If Skip","type":"main","index":0}]]},"If Skip":{"main":[[{"node":"Delete Batch (Skip)","type":"main","index":0}],[{"node":"Call Client Resolve","type":"main","index":0}]]},"Delete Batch (Skip)":{"main":[[{"node":"Delete Deadline (Skip)","type":"main","index":0}]]},"Delete Deadline (Skip)":{"main":[[{"node":"Delete First Seen (Skip)","type":"main","index":0}]]},"Delete First Seen (Skip)":{"main":[[{"node":"End (Done)","type":"main","index":0}]]},"Call Client Resolve":{"main":[[{"node":"Delete Batch","type":"main","index":0}]]},"Delete Batch":{"main":[[{"node":"Delete Deadline","type":"main","index":0}]]},"Delete Deadline":{"main":[[{"node":"Delete First Seen","type":"main","index":0}]]},"Delete First Seen":{"main":[[{"node":"End (Done)","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":{"node:Schedule Trigger":{"recurrenceRules":[]}},"meta":null,"pinData":{"Schedule Trigger":[{"json":{"timestamp":"2025-12-22T23:28:45.002+04:00","Readable date":"December 22nd 2025, 11:28:45 pm","Readable time":"11:28:45 pm","Day of week":"Monday","Year":"2025","Month":"December","Day of month":"22","Hour":"23","Minute":"28","Second":"45","Timezone":"Europe/Samara (UTC+04:00)"},"pairedItem":{"item":0}}]},"versionId":"aae4e889-8d84-432c-90c3-d1fabd083707","activeVersionId":null,"triggerCount":1,"shared":[{"updatedAt":"2025-12-14T07:12:31.411Z","createdAt":"2025-12-14T07:12:31.411Z","role":"workflow:owner","workflowId":"afbJwet95gV9Evc5","projectId":"x7frUSUEowDAk8Dt"}],"activeVersion":null,"tags":[{"updatedAt":"2025-12-20T17:11:33.502Z","createdAt":"2025-12-20T17:11:33.502Z","id":"cuxaBKwkHf1KFGXh","name":"InputCore"},{"updatedAt":"2025-12-09T18:50:08.518Z","createdAt":"2025-12-09T18:50:08.518Z","id":"tMSCjbvPU3xrNUqz","name":"ELO"}]},{"updatedAt":"2025-12-15T17:27:52.659Z","createdAt":"2025-12-15T17:27:45.757Z","id":"b9tW1Lfnf4kncdbA","name":"ELO_Core_Triggers_Checker","active":false,"isArchived":false,"nodes":[{"parameters":{"path":"elo-core-triggers-checker","responseMode":"responseNode","options":{}},"id":"106cb09b-07bd-45ac-a26e-4e5c66fb1584","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-400,-112],"webhookId":"elo-core-triggers-checker"},{"parameters":{"jsCode":"const input = $input.first().json;\nconst context = input.context;\nconst stage = input.stage || context.current_stage;\n\nreturn {\n  context: context,\n  stage: stage,\n  vertical_id: context.vertical_id || 1,\n  executed_trigger_ids: context.executed_triggers || []\n};"},"id":"5f82d964-a963-4449-8529-8fc0b2d006ab","name":"Prepare Query","type":"n8n-nodes-base.code","typeVersion":2,"position":[-176,-112]},{"parameters":{"operation":"executeQuery","query":"SELECT\n    id,\n    code as trigger_id,\n    name as trigger_name,\n    funnel_stage as stage,\n    conditions,\n    action_type,\n    action_data as action,\n    once_per_dialog,\n    priority\nFROM elo_v_triggers\nWHERE funnel_stage = $1\n  AND (vertical_id = $2 OR vertical_id IS NULL)\n  AND is_active = true\nORDER BY priority DESC;","options":{"queryReplacement":"={{ [$json.stage, $json.vertical_id] }}"}},"id":"aa43becd-8730-46f6-90e6-c44b3c813d5c","name":"PostgreSQL Load Triggers","type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[48,-112],"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"jsCode":"const prepareData = $('Prepare Query').first().json;\nconst context = prepareData.context;\nconst executedIds = prepareData.executed_trigger_ids;\n\n// Get triggers from SQL\nconst triggers = $input.all().map(item => {\n  const t = item.json;\n  return {\n    trigger_id: t.trigger_id,\n    trigger_name: t.trigger_name,\n    stage: t.stage,\n    conditions: t.conditions,\n    once_per_dialog: t.once_per_dialog,\n    action: {\n      type: t.action_type,\n      ...t.action\n    }\n  };\n});\n\nconst triggersToFire = [];\nconst triggersSkipped = [];\n\n// Build flat context for condition checking\nfunction buildFlatContext(ctx) {\n  const flat = {\n    stage: ctx.current_stage,\n    vertical_id: ctx.vertical_id,\n    tenant_id: ctx.tenant_id,\n    client_name: ctx.client?.name,\n    client_phone: ctx.client?.phone\n  };\n  \n  // Add line data (focus line)\n  const focusLine = ctx.lines?.find(l => l.id === ctx.focus_line_id) || ctx.lines?.[0];\n  if (focusLine?.slots) {\n    flat['device.brand'] = focusLine.slots.device?.brand;\n    flat['device.model'] = focusLine.slots.device?.model;\n    flat['symptom.text'] = focusLine.slots.symptom?.text;\n    flat['diagnosis.code'] = focusLine.slots.diagnosis?.code;\n    flat['repair_type.code'] = focusLine.slots.repair_type?.code;\n    flat['price.amount'] = focusLine.slots.price?.amount;\n  }\n  \n  return flat;\n}\n\n// Check if conditions match\nfunction matchConditions(conditions, flatContext) {\n  if (!conditions || Object.keys(conditions).length === 0) return true;\n  \n  for (const [key, expectedValue] of Object.entries(conditions)) {\n    const actualValue = flatContext[key];\n    \n    // Handle different comparison types\n    if (expectedValue === null) {\n      if (actualValue !== null && actualValue !== undefined) return false;\n    } else if (typeof expectedValue === 'object' && expectedValue !== null) {\n      // Advanced conditions ($gt, $lt, $in)\n      if (expectedValue.$gt !== undefined && !(actualValue > expectedValue.$gt)) return false;\n      if (expectedValue.$gte !== undefined && !(actualValue >= expectedValue.$gte)) return false;\n      if (expectedValue.$lt !== undefined && !(actualValue < expectedValue.$lt)) return false;\n      if (expectedValue.$lte !== undefined && !(actualValue <= expectedValue.$lte)) return false;\n      if (expectedValue.$in && !expectedValue.$in.includes(actualValue)) return false;\n      if (expectedValue.$ne !== undefined && actualValue === expectedValue.$ne) return false;\n    } else {\n      // Simple equality (case-insensitive for strings)\n      const actual = typeof actualValue === 'string' ? actualValue.toLowerCase() : actualValue;\n      const expected = typeof expectedValue === 'string' ? expectedValue.toLowerCase() : expectedValue;\n      if (actual !== expected) return false;\n    }\n  }\n  \n  return true;\n}\n\nconst flatContext = buildFlatContext(context);\n\nfor (const trigger of triggers) {\n  // Check if already executed\n  if (trigger.once_per_dialog && executedIds.includes(trigger.trigger_id)) {\n    triggersSkipped.push({\n      trigger_id: trigger.trigger_id,\n      reason: 'already_executed'\n    });\n    continue;\n  }\n  \n  // Check conditions\n  if (matchConditions(trigger.conditions, flatContext)) {\n    triggersToFire.push({\n      trigger_id: trigger.trigger_id,\n      trigger_name: trigger.trigger_name,\n      action: trigger.action,\n      once_per_dialog: trigger.once_per_dialog,\n      executed: true\n    });\n  }\n}\n\n// Mark executed triggers in context\nconst updatedContext = { ...context };\nupdatedContext.executed_triggers = [\n  ...(context.executed_triggers || []),\n  ...triggersToFire.filter(t => t.once_per_dialog).map(t => t.trigger_id)\n];\n\nreturn {\n  triggers_fired: triggersToFire,\n  triggers_skipped: triggersSkipped,\n  context: updatedContext\n};"},"id":"6954cd45-45ee-4b18-a7bb-c6ce888bd3f8","name":"Evaluate Triggers","type":"n8n-nodes-base.code","typeVersion":2,"position":[272,-112]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"c935d62d-6c7a-4638-855b-04497bc72a9c","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[480,-112]}],"connections":{"Webhook":{"main":[[{"node":"Prepare Query","type":"main","index":0}]]},"Prepare Query":{"main":[[{"node":"PostgreSQL Load Triggers","type":"main","index":0}]]},"PostgreSQL Load Triggers":{"main":[[{"node":"Evaluate Triggers","type":"main","index":0}]]},"Evaluate Triggers":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"f7117522-174d-4fec-9c5f-ea87eebcc27d","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2025-12-15T17:27:45.762Z","createdAt":"2025-12-15T17:27:45.762Z","role":"workflow:owner","workflowId":"b9tW1Lfnf4kncdbA","projectId":"x7frUSUEowDAk8Dt"}],"activeVersion":null,"tags":[{"updatedAt":"2025-12-12T08:39:41.170Z","createdAt":"2025-12-12T08:39:41.170Z","id":"8dihLRJvdhkW2kZ1","name":"AI"},{"updatedAt":"2025-12-09T18:50:08.518Z","createdAt":"2025-12-09T18:50:08.518Z","id":"tMSCjbvPU3xrNUqz","name":"ELO"}]},{"updatedAt":"2025-12-12T09:11:33.000Z","createdAt":"2025-12-09T18:51:03.920Z","id":"fuRDk8dKF5ViY8ad","name":"ELO_Core_Tenant_Resolver","active":false,"isArchived":true,"nodes":[{"parameters":{"inputSource":"passthrough"},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-704,0],"id":"9b6d18bc-5b69-49f3-8aad-df0ff2604165","name":"When Executed by Another Workflow"},{"parameters":{"jsCode":"const data = $input.first().json;\n\n// Определяем параметры для поиска tenant через elo_channel_accounts\nconst channel = data.channel;\nlet lookupValue = '';\n\n// Извлекаем credential в зависимости от канала\nif (channel === 'telegram' && data.bot_token) {\n  lookupValue = data.bot_token;\n} else if (channel === 'vk' && data.meta?.raw?.group_id) {\n  lookupValue = data.meta.raw.group_id.toString();\n} else if (channel === 'whatsapp' && data.meta?.profile_id) {\n  lookupValue = data.meta.profile_id;\n} else if (channel === 'avito' && data.meta?.user_id) {\n  lookupValue = data.meta.user_id.toString();\n} else if (channel === 'max' && data.meta?.bot_token) {\n  lookupValue = data.meta.bot_token;\n}\n\n// Если нет credential - используем default tenant\nconst needsDefaultTenant = !lookupValue;\n\nreturn {\n  ...data,\n  lookup_channel: channel,\n  lookup_value: lookupValue,\n  needs_default_tenant: needsDefaultTenant\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-496,0],"id":"8bbbf8c9-b1aa-4c7e-9bb4-7f88979a4409","name":"Prepare Lookup"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"skip-lookup-check","leftValue":"={{ $json.needs_default_tenant }}","rightValue":true,"operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-288,0],"id":"d0379cf8-d2b6-4670-9a23-084c91edc4c4","name":"Skip DB Lookup?"},{"parameters":{"operation":"executeQuery","query":"SELECT \n  ca.tenant_id,\n  t.name as tenant_name,\n  t.is_active,\n  t.settings as tenant_settings,\n  ca.credentials as channel_config\nFROM elo_channel_accounts ca\nJOIN elo_tenants t ON t.id = ca.tenant_id\nWHERE ca.channel = '{{ $json.lookup_channel }}'\n  AND (\n    ca.account_id = '{{ $json.lookup_value }}'\n    OR ca.credentials->>'bot_token' = '{{ $json.lookup_value }}'\n    OR ca.credentials->>'token' = '{{ $json.lookup_value }}'\n    OR ca.credentials->>'group_id' = '{{ $json.lookup_value }}'\n    OR ca.credentials->>'profile_id' = '{{ $json.lookup_value }}'\n  )\n  AND ca.is_active = true\n  AND t.is_active = true\nLIMIT 1;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-64,64],"id":"0d670d12-c649-4198-8971-55b364a959a1","name":"Find Tenant","alwaysOutputData":true,"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"tenant-found-check","leftValue":"={{ $json.tenant_id }}","rightValue":"","operator":{"type":"string","operation":"notEmpty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[144,64],"id":"c66dfbf1-998c-4d43-9e74-3791df3bfa70","name":"Tenant Found?"},{"parameters":{"jsCode":"const originalData = $('When Executed by Another Workflow').first().json;\n\n// Default tenant - используется для тестирования или неизвестных каналов\nreturn {\n  ...originalData,\n  tenant_id: 'a0000000-0000-0000-0000-000000000001',\n  tenant_name: 'Default Tenant',\n  tenant_settings: {},\n  channel_config: {}\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[512,-32],"id":"9b000904-768b-4c3b-a0ab-de71dbe6cb40","name":"Use Default Tenant"},{"parameters":{"jsCode":"const tenantData = $input.first().json;\nconst originalData = $('When Executed by Another Workflow').first().json;\n\nreturn {\n  ...originalData,\n  tenant_id: tenantData.tenant_id,\n  tenant_name: tenantData.tenant_name,\n  tenant_settings: tenantData.tenant_settings || {},\n  channel_config: tenantData.channel_config || {}\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[304,-160],"id":"8006b3e3-b2c3-4f6a-aab7-65a98495b8ba","name":"Attach Tenant From DB"}],"connections":{"When Executed by Another Workflow":{"main":[[{"node":"Prepare Lookup","type":"main","index":0}]]},"Prepare Lookup":{"main":[[{"node":"Skip DB Lookup?","type":"main","index":0}]]},"Skip DB Lookup?":{"main":[[{"node":"Use Default Tenant","type":"main","index":0}],[{"node":"Find Tenant","type":"main","index":0}]]},"Find Tenant":{"main":[[{"node":"Tenant Found?","type":"main","index":0}]]},"Tenant Found?":{"main":[[{"node":"Attach Tenant From DB","type":"main","index":0}],[{"node":"Use Default Tenant","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"d3dfe9fa-c780-4d18-a17a-9e02296630b6","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2025-12-09T18:51:03.927Z","createdAt":"2025-12-09T18:51:03.927Z","role":"workflow:owner","workflowId":"fuRDk8dKF5ViY8ad","projectId":"x7frUSUEowDAk8Dt"}],"activeVersion":null,"tags":[{"updatedAt":"2025-11-23T04:04:01.292Z","createdAt":"2025-11-23T04:04:01.292Z","id":"eiI07cPEeFxzR69p","name":"Core"},{"updatedAt":"2025-12-09T18:50:08.518Z","createdAt":"2025-12-09T18:50:08.518Z","id":"tMSCjbvPU3xrNUqz","name":"ELO"}]},{"updatedAt":"2025-12-20T17:14:11.250Z","createdAt":"2025-12-15T17:28:36.615Z","id":"i6LnKuEIUETjrNBl","name":"ELO_Executor","active":false,"isArchived":false,"nodes":[{"parameters":{"path":"elo-executor","responseMode":"responseNode","options":{}},"id":"f32e0906-8abc-4212-b797-4a83565aae64","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-288,-80],"webhookId":"elo-executor"},{"parameters":{"jsCode":"const input = $input.first().json.body || $input.first().json;\n\n// Validate required fields\nif (!input.context) {\n  throw new Error('Missing required field: context');\n}\nif (!input.prompt) {\n  throw new Error('Missing required field: prompt');\n}\n\n// Build agent instruction from prompt\nconst context = input.context;\nconst prompt = input.prompt;\n\nreturn {\n  context: context,\n  prompt: prompt,\n  agent_input: `${prompt.instruction}\n\nContext:\n- Client: ${context.client?.name || 'Unknown'}\n- Device: ${context.lines?.[0]?.slots?.device?.brand || ''} ${context.lines?.[0]?.slots?.device?.model || ''}\n- Symptom: ${context.lines?.[0]?.slots?.symptom || 'Not specified'}\n- Diagnosis: ${context.lines?.[0]?.slots?.diagnosis?.code || 'Pending'}\n- Price: ${context.lines?.[0]?.slots?.price?.amount || 'TBD'}\n- Stage: ${context.current_stage}\n- Triggers: ${context.triggers_fired?.map(t => t.trigger_id).join(', ') || 'None'}\n\nUse the available tools to:\n1. Generate response text based on the instruction\n2. Write context to graph (Neo4j)\n3. Format the response for the channel\n\nReturn the final response object.`\n};"},"id":"a665f5c0-dda9-4daf-bf77-ab272788ba6b","name":"Prepare Input","type":"n8n-nodes-base.code","typeVersion":2,"position":[-64,-80]},{"parameters":{"options":{"systemMessage":"You are an executor for a phone repair service chatbot.\n\nYour job is to execute the instructions from the decision layer using the available tools.\n\nAvailable tools:\n- generate_text: Generate response text using AI based on prompt and context\n- write_graph: Write/update data in Neo4j graph database\n- get_price: Get price for a specific repair from database\n- format_response: Format response for specific channel (telegram, whatsapp, etc)\n\nFollow the instructions exactly. Use tools as needed to complete the task.\n\nReturn a response object with: {text, buttons (optional), metadata}"}},"id":"46d80796-b914-49de-89c9-dd7d9d149aae","name":"AI Agent","type":"@n8n/n8n-nodes-langchain.agent","typeVersion":1.6,"position":[160,-80]},{"parameters":{"model":"qwen/qwen3-4b:free","options":{"maxTokens":1500,"temperature":0.3}},"id":"4c285c5f-ba34-4f55-ae89-bdcdaf9ce30c","name":"OpenRouter LLM","type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[-240,112],"credentials":{"openRouterApi":{"id":"ameOTCcGgTm3hbtM","name":"OpenRouter account"}}},{"parameters":{"method":"POST","url":"https://n8n.n8nsrv.ru/webhook/elo-core-response-generator","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ context: $fromAI('context', 'The context object'), goal: $fromAI('goal', 'Response goal like ask_device, present_offer') }) }}"},"id":"818541fc-f262-427e-b149-4664f27ce8b4","name":"Generate Text Tool","type":"@n8n/n8n-nodes-langchain.toolHttpRequest","typeVersion":1.1,"position":[32,128]},{"parameters":{"method":"POST","url":"https://n8n.n8nsrv.ru/webhook/elo-core-graph-writer","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({ context: $fromAI('context', 'The context object to write'), write_mode: $fromAI('write_mode', 'Write mode: full or incremental', 'incremental') }) }}"},"id":"ce244346-2ea4-456c-b5e6-e8777e7356e1","name":"Write Graph Tool","type":"@n8n/n8n-nodes-langchain.toolHttpRequest","typeVersion":1.1,"position":[224,128]},{"parameters":{"name":"get_price","description":"Get price for repair from database. Input: {brand: string, model: string, repair_action: string}. Returns: {price_min, price_max, currency}","jsCode":"// Direct PostgreSQL query for price\nconst brand = $fromAI('brand', 'Device brand');\nconst model = $fromAI('model', 'Device model');\nconst repair = $fromAI('repair_action', 'Repair action code');\n\n// This would be a SQL query in real implementation\nreturn {\n  price_min: 3000,\n  price_max: 5000,\n  currency: 'RUB',\n  note: 'Price lookup - implement with PostgreSQL node'\n};"},"id":"cb5df279-ad7f-4782-a11b-0aba4a47b052","name":"Get Price Tool","type":"@n8n/n8n-nodes-langchain.toolCode","typeVersion":1,"position":[416,128]},{"parameters":{"name":"format_response","description":"Format response for specific channel. Input: {text: string, buttons: array, channel: string}. Returns formatted response","jsCode":"const text = $fromAI('text', 'Response text');\nconst buttons = $fromAI('buttons', 'Array of button objects', []);\nconst channel = $fromAI('channel', 'Channel type: telegram, whatsapp, etc', 'telegram');\n\nlet formatted = { text };\n\nif (buttons && buttons.length > 0) {\n  switch(channel) {\n    case 'telegram':\n      formatted.reply_markup = {\n        inline_keyboard: buttons.map(b => [{ text: b.text, callback_data: b.callback_data || b.text }])\n      };\n      break;\n    case 'whatsapp':\n      formatted.buttons = buttons.map(b => ({ type: 'reply', reply: { id: b.callback_data, title: b.text } }));\n      break;\n    default:\n      formatted.buttons = buttons;\n  }\n}\n\nreturn formatted;"},"id":"7fc8f9f4-da37-4980-8013-cc33deaee4e5","name":"Format Response Tool","type":"@n8n/n8n-nodes-langchain.toolCode","typeVersion":1,"position":[592,128]},{"parameters":{"jsCode":"const agentOutput = $input.first().json;\nconst inputData = $('Prepare Input').first().json;\nconst context = inputData.context;\n\n// Build final response\nconst response = {\n  tenant_id: context.tenant_id,\n  dialog_id: context.dialog_id,\n  channel_id: context.channel_id,\n  external_chat_id: context.external_chat_id,\n  \n  message: {\n    text: agentOutput.text || agentOutput.response?.text || 'No response generated',\n    buttons: agentOutput.buttons || agentOutput.response?.buttons || [],\n    metadata: {\n      stage: context.current_stage,\n      trace_id: context.trace_id\n    }\n  },\n  \n  context_updated: true,\n  trace_id: context.trace_id\n};\n\nreturn response;"},"id":"0319938c-1fcb-49ee-90a7-7aad6ec562e9","name":"Build Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[592,-80]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"7e8e50d2-fb7e-4377-9931-9f8e9c736306","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[800,-80]}],"connections":{"Webhook":{"main":[[{"node":"Prepare Input","type":"main","index":0}]]},"Prepare Input":{"main":[[{"node":"AI Agent","type":"main","index":0}]]},"OpenRouter LLM":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]},"Generate Text Tool":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"Write Graph Tool":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"Get Price Tool":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"Format Response Tool":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"AI Agent":{"main":[[{"node":"Build Response","type":"main","index":0}]]},"Build Response":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"6de6ef34-d7af-4bda-bacd-b453d26dbc4c","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2025-12-15T17:28:36.623Z","createdAt":"2025-12-15T17:28:36.623Z","role":"workflow:owner","workflowId":"i6LnKuEIUETjrNBl","projectId":"x7frUSUEowDAk8Dt"}],"activeVersion":null,"tags":[{"updatedAt":"2025-12-12T08:39:41.170Z","createdAt":"2025-12-12T08:39:41.170Z","id":"8dihLRJvdhkW2kZ1","name":"AI"},{"updatedAt":"2025-12-09T18:50:08.518Z","createdAt":"2025-12-09T18:50:08.518Z","id":"tMSCjbvPU3xrNUqz","name":"ELO"}]},{"updatedAt":"2025-12-17T08:57:58.742Z","createdAt":"2025-12-15T17:25:08.704Z","id":"i9aZ3bd5btVjzZs8","name":"ELO_Core_AI_Derive","active":false,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"derive","responseMode":"responseNode","options":{}},"id":"9e6f39a4-92e2-4ac9-99bb-1a904e2f477e","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-832,16],"webhookId":"ef57356f-aa75-4747-8561-b3f062e40251"},{"parameters":{"jsCode":"const input = $input.first().json;\nconst context = input.context;\nconst linesToDerive = input.lines_to_derive || [];\n\n// Get lines that need derivation\nconst lines = context.lines.filter(line => {\n  if (linesToDerive.length > 0) {\n    return linesToDerive.includes(line.id);\n  }\n  return line.slots?.symptom && !line.slots?.diagnosis;\n});\n\nreturn {\n  context: context,\n  lines: lines,\n  has_lines_to_derive: lines.length > 0\n};"},"id":"65082b91-31b3-4a41-8faf-b77295ae6691","name":"Filter Lines","type":"n8n-nodes-base.code","typeVersion":2,"position":[-624,16]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"condition1","leftValue":"={{ $json.has_lines_to_derive }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"b378d6d2-7e22-4e94-a5d8-e9ec0fb2e251","name":"Has Lines?","type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-400,16]},{"parameters":{"options":{}},"id":"0369acd0-0faf-4ffa-8639-086440d36c1a","name":"Split Lines","type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[-112,-336]},{"parameters":{"jsCode":"const context = $('Filter Lines').first().json.context;\nconst lines = $('Filter Lines').first().json.lines;\nconst currentIndex = $itemIndex;\nconst line = lines[currentIndex];\n\nconst symptomText = line?.slots?.symptom?.text || '';\nconst deviceBrand = line?.slots?.device?.brand || '';\nconst deviceModel = line?.slots?.device?.model || '';\nconst tenantId = context.tenant_id;\nconst verticalId = context.vertical_id || 1;\n\nreturn {\n  line_id: line.id,\n  symptom_text: symptomText.toLowerCase(),\n  device_brand: deviceBrand,\n  device_model: deviceModel,\n  tenant_id: tenantId,\n  vertical_id: verticalId\n};"},"id":"94e81fc5-4aa9-4126-a7c6-199a766e3b92","name":"Prepare Query","type":"n8n-nodes-base.code","typeVersion":2,"position":[240,-352]},{"parameters":{"operation":"executeQuery","query":"WITH symptom_match AS (\n  SELECT \n    st.id as symptom_type_id,\n    st.uuid as symptom_type_uuid,\n    st.code as symptom_code,\n    st.name_ru as symptom_name,\n    sm.aliases,\n    1 as match_rank\n  FROM elo_symptom_types st\n  JOIN elo_v_symptom_mappings sm ON sm.symptom_type_id = st.id\n  WHERE sm.vertical_id = {{ $json.vertical_id }}\n    AND sm.is_active = true\n    AND EXISTS (\n      SELECT 1 FROM jsonb_array_elements_text(sm.aliases) alias\n      WHERE $1 LIKE '%' || lower(alias) || '%'\n         OR lower(alias) LIKE '%' || $1 || '%'\n    )\n  ORDER BY \n    CASE WHEN $1 = ANY(SELECT lower(x) FROM jsonb_array_elements_text(sm.aliases) x) THEN 0 ELSE 1 END\n  LIMIT 1\n),\ndiagnosis_match AS (\n  SELECT \n    dt.id as diagnosis_type_id,\n    dt.uuid as diagnosis_type_uuid,\n    dt.code as diagnosis_code,\n    dt.name_ru as diagnosis_name,\n    sdl.confidence\n  FROM symptom_match sm\n  JOIN elo_symptom_diagnosis_links sdl ON sdl.symptom_type_id = sm.symptom_type_id\n  JOIN elo_diagnosis_types dt ON dt.id = sdl.diagnosis_type_id\n  WHERE sdl.is_primary = true AND sdl.is_active = true\n  LIMIT 1\n),\nrepair_match AS (\n  SELECT \n    ra.id as repair_action_id,\n    ra.uuid as repair_action_uuid,\n    ra.code as repair_code,\n    ra.name_ru as repair_name\n  FROM diagnosis_match dm\n  JOIN elo_diagnosis_repair_links drl ON drl.diagnosis_type_id = dm.diagnosis_type_id\n  JOIN elo_repair_actions ra ON ra.id = drl.repair_action_id\n  WHERE drl.is_primary = true AND drl.is_active = true\n  LIMIT 1\n),\nprice_match AS (\n  SELECT \n    p.id as price_id,\n    p.price_min,\n    p.price_max,\n    p.currency,\n    CASE WHEN p.price_min = p.price_max THEN false ELSE true END as is_estimate\n  FROM elo_t_price_list p\n  JOIN repair_match rm ON p.repair_action_id = rm.repair_action_id\n  WHERE p.is_active = true\n    AND (p.tenant_id = $2::uuid OR p.tenant_id IS NULL)\n    AND (\n      (lower(p.brand) = lower($3) AND lower(p.model) LIKE '%' || lower($4) || '%')\n      OR (lower(p.brand) = lower($3) AND p.model IS NULL)\n      OR p.brand IS NULL\n    )\n  ORDER BY \n    CASE WHEN p.tenant_id = $2::uuid THEN 0 ELSE 1 END,\n    CASE WHEN p.model IS NOT NULL THEN 0 ELSE 1 END\n  LIMIT 1\n)\nSELECT \n  sm.symptom_type_uuid,\n  sm.symptom_code,\n  sm.symptom_name,\n  dm.diagnosis_type_uuid,\n  dm.diagnosis_code,\n  dm.diagnosis_name,\n  dm.confidence,\n  rm.repair_action_uuid,\n  rm.repair_code,\n  rm.repair_name,\n  pm.price_id,\n  pm.price_min,\n  pm.price_max,\n  pm.currency,\n  pm.is_estimate\nFROM symptom_match sm\nLEFT JOIN diagnosis_match dm ON true\nLEFT JOIN repair_match rm ON true\nLEFT JOIN price_match pm ON true;","options":{"queryReplacement":"={{ [$json.symptom_text, $json.tenant_id, $json.device_brand, $json.device_model] }}"}},"id":"3865c9bb-7352-4d1f-b484-6a74065cec58","name":"PostgreSQL Derive","type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[560,-352],"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"jsCode":"const queryResult = $input.first().json;\nconst prepareData = $('Prepare Query').first().json;\n\nconst derivation = {\n  line_id: prepareData.line_id,\n  derived: {}\n};\n\nif (queryResult.symptom_type_uuid) {\n  derivation.derived.symptom_type = {\n    uuid: queryResult.symptom_type_uuid,\n    code: queryResult.symptom_code,\n    name: queryResult.symptom_name\n  };\n}\n\nif (queryResult.diagnosis_type_uuid) {\n  derivation.derived.diagnosis = {\n    uuid: queryResult.diagnosis_type_uuid,\n    code: queryResult.diagnosis_code,\n    text: queryResult.diagnosis_name,\n    confidence: parseFloat(queryResult.confidence) || 0.8\n  };\n}\n\nif (queryResult.repair_action_uuid) {\n  derivation.derived.repair_type = {\n    uuid: queryResult.repair_action_uuid,\n    code: queryResult.repair_code,\n    text: queryResult.repair_name\n  };\n}\n\nif (queryResult.price_min) {\n  derivation.derived.price = {\n    amount: queryResult.price_min === queryResult.price_max \n      ? parseFloat(queryResult.price_min)\n      : (parseFloat(queryResult.price_min) + parseFloat(queryResult.price_max)) / 2,\n    min: parseFloat(queryResult.price_min),\n    max: parseFloat(queryResult.price_max),\n    currency: queryResult.currency || 'RUB',\n    is_estimate: queryResult.is_estimate || false\n  };\n}\n\nreturn derivation;"},"id":"df4c689b-8ca3-460d-9c8a-0e11eae63f09","name":"Format Derivation","type":"n8n-nodes-base.code","typeVersion":2,"position":[896,-352]},{"parameters":{"jsCode":"const items = $input.all();\nconst context = $('Filter Lines').first().json.context;\n\nconst derivations = items.map(item => item.json);\n\nreturn {\n  derivations: derivations,\n  context: context\n};"},"id":"e6ac961d-f13d-4e3c-a421-6cd012478d13","name":"Aggregate","type":"n8n-nodes-base.code","typeVersion":2,"position":[128,-80]},{"parameters":{"jsCode":"return {\n  derivations: [],\n  context: $('Filter Lines').first().json.context\n};"},"id":"4c4dc571-856a-450d-b926-a1f3c35786a3","name":"Empty Derivations","type":"n8n-nodes-base.code","typeVersion":2,"position":[-160,32]},{"parameters":{"mode":"combine","combineBy":"combineAll","options":{}},"id":"7441cf24-e71d-451d-8249-5ff099f5db94","name":"Merge","type":"n8n-nodes-base.merge","typeVersion":3,"position":[384,16]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"60855ba6-eb31-4aa5-ac31-a55085584c5e","name":"Respond","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[624,16]}],"connections":{"Webhook":{"main":[[{"node":"Filter Lines","type":"main","index":0}]]},"Filter Lines":{"main":[[{"node":"Has Lines?","type":"main","index":0}]]},"Has Lines?":{"main":[[{"node":"Split Lines","type":"main","index":0}],[{"node":"Empty Derivations","type":"main","index":0}]]},"Split Lines":{"main":[[{"node":"Prepare Query","type":"main","index":0}],[{"node":"Aggregate","type":"main","index":0}]]},"Prepare Query":{"main":[[{"node":"PostgreSQL Derive","type":"main","index":0}]]},"PostgreSQL Derive":{"main":[[{"node":"Format Derivation","type":"main","index":0}]]},"Format Derivation":{"main":[[{"node":"Split Lines","type":"main","index":0}]]},"Aggregate":{"main":[[{"node":"Merge","type":"main","index":0}]]},"Empty Derivations":{"main":[[{"node":"Merge","type":"main","index":1}]]},"Merge":{"main":[[{"node":"Respond","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"512be403-bec4-4616-aca4-a4b601b66eff","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2025-12-15T17:25:08.710Z","createdAt":"2025-12-15T17:25:08.710Z","role":"workflow:owner","workflowId":"i9aZ3bd5btVjzZs8","projectId":"x7frUSUEowDAk8Dt"}],"activeVersion":null,"tags":[{"updatedAt":"2025-12-12T08:39:41.170Z","createdAt":"2025-12-12T08:39:41.170Z","id":"8dihLRJvdhkW2kZ1","name":"AI"},{"updatedAt":"2025-12-09T18:50:08.518Z","createdAt":"2025-12-09T18:50:08.518Z","id":"tMSCjbvPU3xrNUqz","name":"ELO"}]},{"updatedAt":"2025-12-23T09:17:54.464Z","createdAt":"2025-12-10T10:01:53.940Z","id":"j8SAGf1ZIC8uqDya","name":"ELO_Out_WhatsApp","active":false,"isArchived":false,"nodes":[{"parameters":{"rule":{"interval":[{"field":"seconds","secondsInterval":3}]}},"id":"59cd4f62-3516-4944-89d3-2539af6b306c","name":"Schedule Trigger","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[-1728,160]},{"parameters":{"operation":"pop","list":"queue:outgoing:whatsapp","options":{}},"id":"a0de0a32-33b2-4734-8481-0bfaebd70180","name":"Redis Pop Message","type":"n8n-nodes-base.redis","typeVersion":1,"position":[-1504,160],"credentials":{"redis":{"id":"7FQcEivUY94atW24","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"has-message","leftValue":"={{ $json.propertyName.message_text }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"id":"70c011af-fa6b-4baf-97ac-1276e1c40b7c","name":"IF Has Message","type":"n8n-nodes-base.if","typeVersion":2,"position":[-1280,160]},{"parameters":{"jsCode":"let message;\n  if ($json.message_json) {\n    message = typeof $json.message_json === 'string'\n      ? JSON.parse($json.message_json)\n      : $json.message_json;\n  } else if ($json.propertyName) {\n    message = typeof $json.propertyName === 'string'\n      ? JSON.parse($json.propertyName)\n      : $json.propertyName;\n  } else {\n    throw new Error('No message data found');\n  }\n\n  return {\n    out_message: message\n  };"},"id":"995fddb5-479d-49aa-8955-4dcbba4f660b","name":"Parse Message","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1056,64]},{"parameters":{"operation":"executeQuery","query":"SELECT\n    ca.session_id,\n    ca.ip_node_id,\n    n.server_host,\n    n.ip_address::text as ip_address,\n    n.port_whatsapp as port\n  FROM elo_t_channel_accounts ca\n  LEFT JOIN elo_ip_nodes n ON n.id = ca.ip_node_id\n  WHERE ca.tenant_id = '{{ $json.out_message.tenant_id }}'::uuid\n    AND ca.channel_id = 2\n    AND ca.is_active = true\n    AND ca.session_status = 'connected'\n  LIMIT 1;\n","options":{}},"id":"10c77e06-1e26-4a57-8ce1-91937182bcc7","name":"Get WhatsApp Session","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-832,64],"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"has-session","leftValue":"={{ $json.session_id }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"id":"c7e551d9-3089-49b0-a08b-1a0989f4afb7","name":"IF Session Exists","type":"n8n-nodes-base.if","typeVersion":2,"position":[-608,64]},{"parameters":{"method":"POST","url":"=http://155.212.221.189:8769/messages/text","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n    \"sessionId\": \"{{ $('Get WhatsApp Session').item.json.session_id }}\",\n    \"to\": \"{{ $('Parse Message').item.json.out_message.external_chat_id }}\",\n    \"text\": \"{{ $('Parse Message').item.json.out_message.message_text.replace(/\\\"/g, '\\\\\\\"').replace(/\\n/g, '\\\\n') }}\"\n  }","options":{"timeout":30000}},"id":"98360e13-d3b9-41e1-8d0f-239f2478a211","name":"Send via Baileys","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-384,-32]},{"parameters":{"jsCode":"const parsed = $('Parse Message').first().json;\nconst sessionData = $('Get WhatsApp Session').first().json;\nconst response = $input.first().json;\n\nconst success = response.success === true;\nconst messageId = response.data?.messageId || Date.now().toString();\n\nreturn {\n  ...parsed,\n  baileys_response: response,\n  message_id: messageId,\n  sent_at: new Date().toISOString(),\n  send_success: success,\n  session_id: sessionData.session_id\n};"},"id":"f400bceb-522e-465e-9095-1c96f7546402","name":"Process Baileys Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[-160,-32]},{"parameters":{"operation":"executeQuery","query":"UPDATE elo_t_dialogs SET\n  last_message_at = NOW(),\n  last_operator_message_at = NOW(),\n  updated_at = NOW()\nWHERE id = '{{ $json.out_message.dialog_id }}'::uuid;","options":{}},"id":"b33a1571-905e-4858-8fa0-36f84d07f3dc","name":"Update Dialog Timestamp","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[64,-32],"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"jsCode":"// No session found - log error\nconst parsed = $('Parse Message').first().json;\n\nconsole.error('No active WhatsApp session found for tenant:', parsed.out_message?.tenant_id);\n\nreturn {\n  success: false,\n  error: 'No active WhatsApp session found for tenant',\n  tenant_id: parsed.out_message?.tenant_id,\n  out_message: parsed.out_message\n};"},"id":"37912a38-7d7e-420e-acba-d99483a5274b","name":"No Session Error","type":"n8n-nodes-base.code","typeVersion":2,"position":[-384,160]},{"parameters":{"jsCode":"// No message in queue - just return\nreturn { empty: true };"},"id":"c22a1ecb-64fa-4cd0-8bbf-9b92a7693e41","name":"No Message","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1056,256]}],"connections":{"Schedule Trigger":{"main":[[{"node":"Redis Pop Message","type":"main","index":0}]]},"Redis Pop Message":{"main":[[{"node":"IF Has Message","type":"main","index":0}]]},"IF Has Message":{"main":[[{"node":"Parse Message","type":"main","index":0}],[{"node":"No Message","type":"main","index":0}]]},"Parse Message":{"main":[[{"node":"Get WhatsApp Session","type":"main","index":0}]]},"Get WhatsApp Session":{"main":[[{"node":"IF Session Exists","type":"main","index":0}]]},"IF Session Exists":{"main":[[{"node":"Send via Baileys","type":"main","index":0}],[{"node":"No Session Error","type":"main","index":0}]]},"Send via Baileys":{"main":[[{"node":"Process Baileys Response","type":"main","index":0}]]},"Process Baileys Response":{"main":[[{"node":"Update Dialog Timestamp","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":{"node:Schedule Trigger":{"recurrenceRules":[]}},"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"fcf054c2-3b5d-4c73-bdaa-f98eb750ed62","activeVersionId":null,"triggerCount":1,"shared":[{"updatedAt":"2025-12-10T10:01:53.948Z","createdAt":"2025-12-10T10:01:53.948Z","role":"workflow:owner","workflowId":"j8SAGf1ZIC8uqDya","projectId":"x7frUSUEowDAk8Dt"}],"activeVersion":null,"tags":[{"updatedAt":"2025-11-23T04:03:34.766Z","createdAt":"2025-11-23T04:03:34.766Z","id":"IbDkJphbr4EygdRZ","name":"Out"},{"updatedAt":"2025-12-09T18:50:08.518Z","createdAt":"2025-12-09T18:50:08.518Z","id":"tMSCjbvPU3xrNUqz","name":"ELO"}]},{"updatedAt":"2025-12-20T17:10:22.072Z","createdAt":"2025-12-17T18:20:44.950Z","id":"j9VlTpdXIdlfBZhO","name":"ELO_API_Android_Logout","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"android/logout","responseMode":"responseNode","options":{"allowedOrigins":"*"}},"id":"ba11760b-cabb-4706-9c23-7a5bae38ad48","name":"Webhook - Logout","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-560,-32],"webhookId":"android-logout"},{"parameters":{"jsCode":"const headers = $json.headers || {};\nlet token = null;\n\n// Try Authorization: Bearer <token>\nconst authHeader = headers.authorization || headers.Authorization || '';\nif (authHeader.startsWith('Bearer ')) {\n  token = authHeader.substring(7);\n} else if (authHeader.startsWith('bearer ')) {\n  token = authHeader.substring(7);\n}\n\n// Try X-Session-Token\nif (!token) {\n  token = headers['x-session-token'] || headers['X-Session-Token'];\n}\n\nreturn { session_token: token || null };"},"id":"060973f4-10ca-461c-9ef5-bde7dc1d2b18","name":"Parse Token","type":"n8n-nodes-base.code","typeVersion":2,"position":[-352,-32]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"token-exists","leftValue":"={{ $json.session_token }}","rightValue":"","operator":{"type":"string","operation":"notEmpty","singleValue":true}}],"combinator":"and"},"options":{}},"id":"a4cc0357-a566-49d3-a837-a0c79d585f87","name":"IF - Token Provided","type":"n8n-nodes-base.if","typeVersion":2,"position":[-128,-32]},{"parameters":{"operation":"executeQuery","query":"DELETE FROM operator_devices \nWHERE session_token = '{{ $json.session_token }}'\nRETURNING operator_id;","options":{}},"id":"857e46e6-d887-4726-8d2f-7322fd7da496","name":"Delete Device Session","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[96,-144],"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"jsCode":"const input = $input.first()?.json;\n\nconst hasResult = \n  (Array.isArray(input) && input.length > 0 && input[0]?.operator_id) ||\n  (input?.operator_id);\n\nif (hasResult) {\n  return { \n    success: true, \n    message: 'Logged out successfully' \n  };\n} else {\n  return { \n    success: true,\n    message: 'Already logged out'\n  };\n}"},"id":"82ffd145-3d32-4130-99fb-89641234eb0d","name":"Check Result","type":"n8n-nodes-base.code","typeVersion":2,"position":[304,-144]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{"responseCode":200,"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"},{"name":"Access-Control-Allow-Origin","value":"*"}]}}},"id":"ada48c95-0374-45a7-b51d-a2417e021b5d","name":"Response - Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[512,-32]},{"parameters":{"respondWith":"json","responseBody":"={{ { success: false, error: 'Token not provided' } }}","options":{"responseCode":400,"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"},{"name":"Access-Control-Allow-Origin","value":"*"}]}}},"id":"65c0f60a-ab12-4256-ba4f-631c22067355","name":"Response - No Token","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[96,80]}],"connections":{"Webhook - Logout":{"main":[[{"node":"Parse Token","type":"main","index":0}]]},"Parse Token":{"main":[[{"node":"IF - Token Provided","type":"main","index":0}]]},"IF - Token Provided":{"main":[[{"node":"Delete Device Session","type":"main","index":0}],[{"node":"Response - No Token","type":"main","index":0}]]},"Delete Device Session":{"main":[[{"node":"Check Result","type":"main","index":0}]]},"Check Result":{"main":[[{"node":"Response - Success","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"e859163d-2c90-40ce-9e0a-eec323bcdb3b","activeVersionId":"e859163d-2c90-40ce-9e0a-eec323bcdb3b","triggerCount":1,"shared":[{"updatedAt":"2025-12-17T18:20:44.956Z","createdAt":"2025-12-17T18:20:44.956Z","role":"workflow:owner","workflowId":"j9VlTpdXIdlfBZhO","projectId":"x7frUSUEowDAk8Dt"}],"activeVersion":{"updatedAt":"2025-12-20T17:10:22.073Z","createdAt":"2025-12-20T17:10:22.073Z","versionId":"e859163d-2c90-40ce-9e0a-eec323bcdb3b","workflowId":"j9VlTpdXIdlfBZhO","nodes":[{"parameters":{"httpMethod":"POST","path":"android/logout","responseMode":"responseNode","options":{"allowedOrigins":"*"}},"id":"ba11760b-cabb-4706-9c23-7a5bae38ad48","name":"Webhook - Logout","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-560,-32],"webhookId":"android-logout"},{"parameters":{"jsCode":"const headers = $json.headers || {};\nlet token = null;\n\n// Try Authorization: Bearer <token>\nconst authHeader = headers.authorization || headers.Authorization || '';\nif (authHeader.startsWith('Bearer ')) {\n  token = authHeader.substring(7);\n} else if (authHeader.startsWith('bearer ')) {\n  token = authHeader.substring(7);\n}\n\n// Try X-Session-Token\nif (!token) {\n  token = headers['x-session-token'] || headers['X-Session-Token'];\n}\n\nreturn { session_token: token || null };"},"id":"060973f4-10ca-461c-9ef5-bde7dc1d2b18","name":"Parse Token","type":"n8n-nodes-base.code","typeVersion":2,"position":[-352,-32]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"token-exists","leftValue":"={{ $json.session_token }}","rightValue":"","operator":{"type":"string","operation":"notEmpty","singleValue":true}}],"combinator":"and"},"options":{}},"id":"a4cc0357-a566-49d3-a837-a0c79d585f87","name":"IF - Token Provided","type":"n8n-nodes-base.if","typeVersion":2,"position":[-128,-32]},{"parameters":{"operation":"executeQuery","query":"DELETE FROM operator_devices \nWHERE session_token = '{{ $json.session_token }}'\nRETURNING operator_id;","options":{}},"id":"857e46e6-d887-4726-8d2f-7322fd7da496","name":"Delete Device Session","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[96,-144],"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"jsCode":"const input = $input.first()?.json;\n\nconst hasResult = \n  (Array.isArray(input) && input.length > 0 && input[0]?.operator_id) ||\n  (input?.operator_id);\n\nif (hasResult) {\n  return { \n    success: true, \n    message: 'Logged out successfully' \n  };\n} else {\n  return { \n    success: true,\n    message: 'Already logged out'\n  };\n}"},"id":"82ffd145-3d32-4130-99fb-89641234eb0d","name":"Check Result","type":"n8n-nodes-base.code","typeVersion":2,"position":[304,-144]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{"responseCode":200,"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"},{"name":"Access-Control-Allow-Origin","value":"*"}]}}},"id":"ada48c95-0374-45a7-b51d-a2417e021b5d","name":"Response - Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[512,-32]},{"parameters":{"respondWith":"json","responseBody":"={{ { success: false, error: 'Token not provided' } }}","options":{"responseCode":400,"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"},{"name":"Access-Control-Allow-Origin","value":"*"}]}}},"id":"65c0f60a-ab12-4256-ba4f-631c22067355","name":"Response - No Token","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[96,80]}],"connections":{"Webhook - Logout":{"main":[[{"node":"Parse Token","type":"main","index":0}]]},"Parse Token":{"main":[[{"node":"IF - Token Provided","type":"main","index":0}]]},"IF - Token Provided":{"main":[[{"node":"Delete Device Session","type":"main","index":0}],[{"node":"Response - No Token","type":"main","index":0}]]},"Delete Device Session":{"main":[[{"node":"Check Result","type":"main","index":0}]]},"Check Result":{"main":[[{"node":"Response - Success","type":"main","index":0}]]}},"authors":"Dmitriy Remacs","name":null,"description":null},"tags":[{"updatedAt":"2025-11-23T03:58:34.844Z","createdAt":"2025-11-23T03:58:34.844Z","id":"0yzk30hhaSzkl8bF","name":"API"},{"updatedAt":"2025-12-09T18:50:08.518Z","createdAt":"2025-12-09T18:50:08.518Z","id":"tMSCjbvPU3xrNUqz","name":"ELO"}]},{"updatedAt":"2025-12-16T19:37:23.790Z","createdAt":"2025-12-11T17:21:36.152Z","id":"ksqmLjxbsBgfkToV","name":"ELO_In_VK","active":false,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"vk","responseMode":"responseNode","options":{}},"id":"da69373c-10e5-47c8-af14-1586061409dc","name":"VK Trigger","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[-688,192],"webhookId":"vk-webhook"},{"parameters":{"conditions":{"string":[{"value1":"={{ $json.type }}","operation":"equals","value2":"confirmation"}]}},"id":"306ba5ce-4be2-455d-9495-4b3049d6eff1","name":"Is Confirmation?","type":"n8n-nodes-base.if","typeVersion":1,"position":[-464,192]},{"parameters":{"respondWith":"text","responseBody":"={{ $env.VK_CONFIRMATION_STRING }}","options":{}},"id":"f2522400-b755-486c-8a41-233708ca9800","name":"Send Confirmation","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[-240,80]},{"parameters":{"conditions":{"string":[{"value1":"={{ $json.type }}","operation":"equals","value2":"message_new"}]}},"id":"abaa3d03-a3c8-4a0b-99ff-ae5166b2dc05","name":"Is New Message?","type":"n8n-nodes-base.if","typeVersion":1,"position":[-240,288]},{"parameters":{"respondWith":"text","responseBody":"ok","options":{}},"id":"06bad1ad-1845-4b42-b941-e7f92af694b2","name":"Respond OK (Other)","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[-16,384]},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $json.object.message.attachments && $json.object.message.attachments.some(a => a.type === 'audio_message') }}","value2":true}]}},"id":"fd3fb4aa-add5-4e56-b657-7a5332c1faba","name":"Has Voice?","type":"n8n-nodes-base.if","typeVersion":1,"position":[-16,192]},{"parameters":{"jsCode":"const msg = $input.first().json.object.message;\n\n// Находим голосовое сообщение\nconst voiceAttachment = msg.attachments.find(a => a.type === 'audio_message');\nconst voiceUrl = voiceAttachment?.audio_message?.link_mp3;\n\nif (!voiceUrl) {\n  throw new Error('Voice URL not found');\n}\n\nreturn {\n  voice_url: voiceUrl,\n  original_message: msg\n};"},"id":"913b5270-22c7-434b-a3d4-fbdffbeece19","name":"Extract Voice URL","type":"n8n-nodes-base.code","typeVersion":2,"position":[208,80]},{"parameters":{"url":"={{ $json.voice_url }}","options":{"response":{"response":{"responseFormat":"file"}}}},"id":"809a3dba-14c5-408f-908b-04054282ee8a","name":"Download Voice","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[432,80]},{"parameters":{"resource":"audio","operation":"transcribe","options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[640,80],"id":"8126401a-eac5-4e36-8613-fa364a1c3c90","name":"Transcribe Voice","credentials":{"openAiApi":{"id":"ptoy1RvCOn39G0Af","name":"OpenAi account"}}},{"parameters":{"jsCode":"const msg = $('Extract Voice URL').first().json.original_message;\nconst transcription = $input.first().json.text;\n\nlet messageText = msg.text || '';\n\nconst hasPhoto = msg.attachments?.some(a => a.type === 'photo') || false;\nconst hasVoice = true;\nconst hasVideo = msg.attachments?.some(a => a.type === 'video') || false;\nconst hasDocument = msg.attachments?.some(a => a.type === 'doc') || false;\n\nconst urls = [];\nlet photoUrl = null;\n\nif (hasPhoto) {\n  const photoAttachment = msg.attachments.find(a => a.type === 'photo');\n  if (photoAttachment?.photo?.sizes) {\n    const maxSize = photoAttachment.photo.sizes.reduce((max, size) => \n      (size.width * size.height > max.width * max.height) ? size : max\n    );\n    photoUrl = maxSize.url;\n    urls.push(photoUrl);\n  }\n}\n\n// Добавляем транскрипцию\nif (transcription) {\n  messageText = (messageText ? messageText + '\\n\\n' : '') + transcription;\n}\n\nreturn {\n  channel: 'vk',\n  external_user_id: msg.from_id.toString(),\n  external_chat_id: msg.peer_id.toString(),\n  \n  text: messageText,\n  timestamp: new Date(msg.date * 1000).toISOString(),\n  \n  client_phone: null,\n  client_name: null,\n  client_email: null,\n  \n  media: {\n    has_voice: true,\n    voice_transcribed_text: transcription,\n    has_images: hasPhoto,\n    images: hasPhoto ? [{ url: photoUrl }] : [],\n    has_video: hasVideo,\n    videos: [],\n    has_document: hasDocument\n  },\n  \n  meta: {\n    external_message_id: msg.id.toString(),\n    ad_channel: 'vk',\n    ad_id: null,\n    original_media_type: 'voice',\n    raw: msg,\n    group_id: msg.group_id?.toString()\n  },\n  \n  prefilled_data: {\n    model: null,\n    parts_owner: null\n  }\n};"},"id":"8eace2c9-1126-4ad0-be90-64125734f706","name":"Normalize with Voice","type":"n8n-nodes-base.code","typeVersion":2,"position":[864,80]},{"parameters":{"jsCode":"const msg = $input.first().json.object.message;\n\nlet messageText = msg.text || '';\n\nconst hasPhoto = msg.attachments?.some(a => a.type === 'photo') || false;\nconst hasVoice = false;\nconst hasVideo = msg.attachments?.some(a => a.type === 'video') || false;\nconst hasDocument = msg.attachments?.some(a => a.type === 'doc') || false;\n\nconst urls = [];\nlet photoUrl = null;\n\nif (hasPhoto) {\n  const photoAttachment = msg.attachments.find(a => a.type === 'photo');\n  if (photoAttachment?.photo?.sizes) {\n    const maxSize = photoAttachment.photo.sizes.reduce((max, size) => \n      (size.width * size.height > max.width * max.height) ? size : max\n    );\n    photoUrl = maxSize.url;\n    urls.push(photoUrl);\n  }\n}\n\nreturn {\n  channel: 'vk',\n  external_user_id: msg.from_id.toString(),\n  external_chat_id: msg.peer_id.toString(),\n  \n  text: messageText,\n  timestamp: new Date(msg.date * 1000).toISOString(),\n  \n  client_phone: null,\n  client_name: null,\n  client_email: null,\n  \n  media: {\n    has_voice: false,\n    voice_transcribed_text: null,\n    has_images: hasPhoto,\n    images: hasPhoto ? [{ url: photoUrl }] : [],\n    has_video: hasVideo,\n    videos: [],\n    has_document: hasDocument\n  },\n  \n  meta: {\n    external_message_id: msg.id.toString(),\n    ad_channel: 'vk',\n    ad_id: null,\n    original_media_type: hasPhoto ? 'photo' : 'text',\n    raw: msg\n  },\n  \n  prefilled_data: {\n    model: null,\n    parts_owner: null\n  }\n};"},"id":"c57bef0b-f6e2-4a2a-bedf-f3414a5f09c9","name":"Normalize without Voice","type":"n8n-nodes-base.code","typeVersion":2,"position":[208,288]},{"parameters":{"workflowId":{"__rl":true,"value":"rRO6sxLqiCdgvLZz","mode":"list","cachedResultUrl":"/workflow/rRO6sxLqiCdgvLZz","cachedResultName":"ELO_Core_Tenant_Resolver"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[1088,192],"id":"ee9c582e-62db-41d3-94f4-7ad5866e453f","name":"Execute Tenant Resolver"},{"parameters":{"jsCode":"// Подготавливаем сообщение для Redis очереди\nconst data = $input.first().json;\n\nreturn {\n  message_json: JSON.stringify(data),\n  batch_key: `${data.channel}:${data.external_chat_id}`\n};"},"id":"c138be9f-f20a-4289-b29b-7e6e758be9ad","name":"Prepare for Queue","type":"n8n-nodes-base.code","typeVersion":2,"position":[1312,192]},{"parameters":{"operation":"push","list":"queue:incoming","messageData":"={{ $json.message_json }}","tail":true},"id":"303a0c33-5147-4670-883a-f00f3ba0d433","name":"Push to Queue","type":"n8n-nodes-base.redis","typeVersion":1,"position":[1520,192],"credentials":{"redis":{"id":"7FQcEivUY94atW24","name":"Redis account"}}},{"parameters":{"respondWith":"text","responseBody":"ok","options":{}},"id":"8cd0d59f-fc07-414f-ad3b-641735eed5d2","name":"Respond OK","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[1744,192]}],"connections":{"VK Trigger":{"main":[[{"node":"Is Confirmation?","type":"main","index":0}]]},"Is Confirmation?":{"main":[[{"node":"Send Confirmation","type":"main","index":0}],[{"node":"Is New Message?","type":"main","index":0}]]},"Is New Message?":{"main":[[{"node":"Has Voice?","type":"main","index":0}],[{"node":"Respond OK (Other)","type":"main","index":0}]]},"Has Voice?":{"main":[[{"node":"Extract Voice URL","type":"main","index":0}],[{"node":"Normalize without Voice","type":"main","index":0}]]},"Extract Voice URL":{"main":[[{"node":"Download Voice","type":"main","index":0}]]},"Download Voice":{"main":[[{"node":"Transcribe Voice","type":"main","index":0}]]},"Transcribe Voice":{"main":[[{"node":"Normalize with Voice","type":"main","index":0}]]},"Normalize with Voice":{"main":[[{"node":"Execute Tenant Resolver","type":"main","index":0}]]},"Normalize without Voice":{"main":[[{"node":"Execute Tenant Resolver","type":"main","index":0}]]},"Execute Tenant Resolver":{"main":[[{"node":"Prepare for Queue","type":"main","index":0}]]},"Prepare for Queue":{"main":[[{"node":"Push to Queue","type":"main","index":0}]]},"Push to Queue":{"main":[[{"node":"Respond OK","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"9a9763c2-e89a-4394-b283-ca146257782b","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2025-12-11T17:21:36.158Z","createdAt":"2025-12-11T17:21:36.158Z","role":"workflow:owner","workflowId":"ksqmLjxbsBgfkToV","projectId":"x7frUSUEowDAk8Dt"}],"activeVersion":null,"tags":[{"updatedAt":"2025-11-23T04:03:40.721Z","createdAt":"2025-11-23T04:03:40.721Z","id":"nLdF41tEx70V7m3A","name":"In"},{"updatedAt":"2025-12-09T18:50:08.518Z","createdAt":"2025-12-09T18:50:08.518Z","id":"tMSCjbvPU3xrNUqz","name":"ELO"}]},{"updatedAt":"2025-12-12T09:11:33.000Z","createdAt":"2025-12-09T18:50:14.629Z","id":"lmMxcDEJAcverxhC","name":"ELO_Core_Batcher","active":false,"isArchived":true,"nodes":[{"parameters":{},"id":"ca4b77f3-55e7-45c0-9544-ac06c1feca39","name":"Execute Workflow Trigger","type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1,"position":[-1488,208]},{"parameters":{"jsCode":"const msg = $input.first().json;\n\n// Генерируем ключи для Redis\nconst batchKey = `elo:${msg.channel}:${msg.external_chat_id}`;\n\n// Получаем batch_timeout из tenant_settings или используем default 10 сек\nconst batchTimeout = msg.tenant_settings?.batch_timeout_sec || 10;\n\nreturn {\n  batch_key: batchKey,\n  queue_key: `queue:${batchKey}`,\n  last_seen_key: `last_seen:${batchKey}`,\n  lock_key: `lock:${batchKey}`,\n  now_iso: new Date().toISOString(),\n  batch_timeout_sec: batchTimeout,\n  batch_timeout_ms: batchTimeout * 1000,\n  message: msg\n};"},"id":"d79b7c02-aa60-476f-aff1-7923127a196d","name":"Prepare Keys","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1200,208]},{"parameters":{"operation":"push","list":"={{ $json.queue_key }}","messageData":"={{ JSON.stringify($json.message) }}","tail":true},"id":"1e6fc3a1-9737-4263-9cba-8339d640c05d","name":"Push to Queue","type":"n8n-nodes-base.redis","typeVersion":1,"position":[-1008,208],"credentials":{"redis":{"id":"7FQcEivUY94atW24","name":"Redis account"}}},{"parameters":{"operation":"set","key":"={{ $json.last_seen_key }}","value":"={{ $json.now_iso }}","expire":true,"ttl":600},"id":"372ea1b5-efe6-4ea8-ab70-0a64017c2548","name":"Update Last Seen","type":"n8n-nodes-base.redis","typeVersion":1,"position":[-800,208],"credentials":{"redis":{"id":"7FQcEivUY94atW24","name":"Redis account"}}},{"parameters":{"operation":"get","key":"={{ $json.lock_key }}","options":{}},"id":"4bd89ba2-bc5d-404f-9fa5-f0094f9e8e5f","name":"Get Lock","type":"n8n-nodes-base.redis","typeVersion":1,"position":[-608,208],"credentials":{"redis":{"id":"7FQcEivUY94atW24","name":"Redis account"}}},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $json.value === null || $json.value === undefined || $json.value === '' }}","value2":true}]},"options":{}},"id":"c896e484-0006-40b7-bbea-8b0b0b8e8cb8","name":"Lock Exists?","type":"n8n-nodes-base.if","typeVersion":2,"position":[-400,208]},{"parameters":{"operation":"set","key":"={{ $('Prepare Keys').item.json.lock_key }}","value":"busy","expire":true,"ttl":300},"id":"d55adfc2-6a17-4ec6-96dc-ffd557c2f734","name":"Acquire Lock (TTL 300s)","type":"n8n-nodes-base.redis","typeVersion":1,"position":[-192,96],"credentials":{"redis":{"id":"7FQcEivUY94atW24","name":"Redis account"}}},{"parameters":{"respondWith":"json","responseBody":"={{ {success:true, queued:true, is_first:false, batch_key: $('Prepare Keys').item.json.batch_key} }}","options":{}},"id":"eceeea69-97e8-47ef-9d4a-fa7897c09559","name":"Respond Queued","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[-192,304]},{"parameters":{"respondWith":"json","responseBody":"={{ {success:true, queued:true, is_first:true, batch_timeout_sec: $('Prepare Keys').item.json.batch_timeout_sec, batch_key: $('Prepare Keys').item.json.batch_key} }}","options":{}},"id":"1e10589e-d6ef-482a-824a-2f1cc018221d","name":"Respond First","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[16,96]},{"parameters":{"amount":"={{ $('Prepare Keys').item.json.batch_timeout_sec }}","unit":"seconds"},"id":"cac9d2a7-b31a-4fa2-b0a9-20c2133db1ab","name":"Wait Batch Timeout","type":"n8n-nodes-base.wait","typeVersion":1,"position":[208,96],"webhookId":"elo-batcher-wait"},{"parameters":{"operation":"get","key":"={{ $('Prepare Keys').item.json.last_seen_key }}","options":{}},"id":"cbae15e5-e900-48f7-8a3e-e4f5e339f412","name":"Get Last Seen","type":"n8n-nodes-base.redis","typeVersion":1,"position":[416,96],"credentials":{"redis":{"id":"7FQcEivUY94atW24","name":"Redis account"}}},{"parameters":{"jsCode":"const last = $json.value ? Date.parse($json.value) : 0;\nconst batchTimeoutMs = $('Prepare Keys').item.json.batch_timeout_ms || 10000;\nconst quiet = Date.now() - last >= batchTimeoutMs;\nreturn { quiet, last_seen: $json.value, elapsed_ms: Date.now() - last };"},"id":"ee20a209-5ced-4566-90d0-31923fc93359","name":"Quiet >= Timeout?","type":"n8n-nodes-base.code","typeVersion":2,"position":[608,96]},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $json.quiet === true }}","value2":true}]},"options":{}},"id":"c039f393-1a16-4d94-bbc9-2c1681657685","name":"Silence Reached?","type":"n8n-nodes-base.if","typeVersion":2,"position":[816,96]},{"parameters":{"operation":"get","key":"={{ $('Prepare Keys').item.json.queue_key }}","options":{}},"id":"12ff6047-e8a6-433a-9041-271920d88497","name":"Get Queue","type":"n8n-nodes-base.redis","typeVersion":1,"position":[1040,96],"credentials":{"redis":{"id":"7FQcEivUY94atW24","name":"Redis account"}}},{"parameters":{"jsCode":"// Получаем массив из Redis\nconst raw = Array.isArray($json.value) ? $json.value : ($json.propertyName || []);\n\nconst items = raw.map(s => {\n  try {\n    return typeof s === 'string' ? JSON.parse(s) : s;\n  } catch (e) {\n    return { text: String(s) };\n  }\n});\n\nreturn { snapshot: items, count: items.length };"},"id":"bcd92b60-4ca1-4d2f-9441-18d0f17ad340","name":"Normalize Snapshot","type":"n8n-nodes-base.code","typeVersion":2,"position":[1232,96]},{"parameters":{"conditions":{"number":[{"value1":"={{ $json.count }}","operation":"smaller","value2":1}]},"options":{}},"id":"ef512731-d892-4786-9105-0c789e090846","name":"Empty?","type":"n8n-nodes-base.if","typeVersion":2,"position":[1440,96]},{"parameters":{"operation":"delete","key":"={{ $('Prepare Keys').item.json.queue_key }}"},"id":"c4ea5d09-90f5-41d2-8a74-f250d6511715","name":"Delete Queue","type":"n8n-nodes-base.redis","typeVersion":1,"position":[1648,96],"credentials":{"redis":{"id":"7FQcEivUY94atW24","name":"Redis account"}}},{"parameters":{"jsCode":"// Объединяем сообщения из батча\nconst rawArr = $json.snapshot || [];\n\n// Парсим каждое сообщение\nconst messages = rawArr.map(s => {\n  try {\n    return typeof s === 'string' ? JSON.parse(s) : s;\n  } catch {\n    return { text: String(s) };\n  }\n});\n\nif (messages.length === 0) {\n  return [{ json: { error: 'empty_batch' } }];\n}\n\n// Сортируем по timestamp\nconst toTs = (m) => {\n  const t = m.timestamp ? Date.parse(m.timestamp) : NaN;\n  return Number.isFinite(t) ? t : Number.MAX_SAFE_INTEGER;\n};\nmessages.sort((a, b) => toTs(a) - toTs(b));\n\n// Собираем тексты\nconst texts = messages\n  .map(m => m.media?.voice_transcribed_text\n    ? `[Голосовое]: ${m.media.voice_transcribed_text}`\n    : (m.text || ''))\n  .filter(t => t.trim());\n\nconst combinedText = texts.join('\\n\\n');\n\n// Берём первое сообщение как базу\nconst base = messages[0];\n\n// Находим последнее с raw данными\nconst lastWithRaw = [...messages].reverse().find(m => m?.meta?.raw);\n\n// Формируем выход\nconst output = {\n  ...base,\n  text: combinedText,\n  meta: {\n    ...base.meta,\n    ...(lastWithRaw?.meta?.raw ? { raw: lastWithRaw.meta.raw } : {}),\n    batched: true,\n    batch_size: messages.length,\n    batch_timeout_sec: $('Prepare Keys').item.json.batch_timeout_sec,\n    original_messages: messages.map(m => ({\n      timestamp: m.timestamp,\n      type: m.meta?.original_media_type || 'text',\n      text_length: (m.text || '').length\n    })),\n    combined_at: new Date().toISOString()\n  }\n};\n\nreturn [{ json: output }];"},"id":"3f8895b4-8aa2-41c0-b052-3aa43a10d016","name":"Combine Messages","type":"n8n-nodes-base.code","typeVersion":2,"position":[1856,96]},{"parameters":{"operation":"delete","key":"={{ $('Prepare Keys').item.json.lock_key }}"},"id":"df99a9a6-725c-4097-af60-d3d2b3590942","name":"Release Lock","type":"n8n-nodes-base.redis","typeVersion":1,"position":[2080,96],"credentials":{"redis":{"id":"7FQcEivUY94atW24","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"empty-batch-check","leftValue":"={{ $json.error }}","rightValue":"empty_batch","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[2288,96],"id":"09610bbe-a7c3-4367-87be-dfda8f8c93bf","name":"Skip Empty?"},{"parameters":{"jsCode":"// Подготавливаем итоговый контракт для Dialog Engine\nconst input = $input.first()?.json || {};\n\nconst output = {\n  ...input,\n  success: true\n};\n\n// Сохраняем tenant_id\nif (input.tenant_id) {\n  output.tenant_id = input.tenant_id;\n}\n\nreturn output;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2496,192],"id":"59b43466-0653-4456-bddb-5fabf96715d9","name":"Prepare Output"}],"connections":{"Execute Workflow Trigger":{"main":[[{"node":"Prepare Keys","type":"main","index":0}]]},"Prepare Keys":{"main":[[{"node":"Push to Queue","type":"main","index":0}]]},"Push to Queue":{"main":[[{"node":"Update Last Seen","type":"main","index":0}]]},"Update Last Seen":{"main":[[{"node":"Get Lock","type":"main","index":0}]]},"Get Lock":{"main":[[{"node":"Lock Exists?","type":"main","index":0}]]},"Lock Exists?":{"main":[[{"node":"Acquire Lock (TTL 300s)","type":"main","index":0}],[{"node":"Respond Queued","type":"main","index":0}]]},"Acquire Lock (TTL 300s)":{"main":[[{"node":"Respond First","type":"main","index":0}]]},"Respond First":{"main":[[{"node":"Wait Batch Timeout","type":"main","index":0}]]},"Wait Batch Timeout":{"main":[[{"node":"Get Last Seen","type":"main","index":0}]]},"Get Last Seen":{"main":[[{"node":"Quiet >= Timeout?","type":"main","index":0}]]},"Quiet >= Timeout?":{"main":[[{"node":"Silence Reached?","type":"main","index":0}]]},"Silence Reached?":{"main":[[{"node":"Get Queue","type":"main","index":0}],[{"node":"Wait Batch Timeout","type":"main","index":0}]]},"Get Queue":{"main":[[{"node":"Normalize Snapshot","type":"main","index":0}]]},"Normalize Snapshot":{"main":[[{"node":"Empty?","type":"main","index":0}]]},"Empty?":{"main":[[{"node":"Delete Queue","type":"main","index":0}],[{"node":"Delete Queue","type":"main","index":0}]]},"Delete Queue":{"main":[[{"node":"Combine Messages","type":"main","index":0}]]},"Combine Messages":{"main":[[{"node":"Release Lock","type":"main","index":0}]]},"Release Lock":{"main":[[{"node":"Skip Empty?","type":"main","index":0}]]},"Skip Empty?":{"main":[[],[{"node":"Prepare Output","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"b75360ab-c14a-4e40-a5d1-1a7fa121a93b","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2025-12-09T18:50:14.639Z","createdAt":"2025-12-09T18:50:14.639Z","role":"workflow:owner","workflowId":"lmMxcDEJAcverxhC","projectId":"x7frUSUEowDAk8Dt"}],"activeVersion":null,"tags":[{"updatedAt":"2025-11-23T04:04:01.292Z","createdAt":"2025-11-23T04:04:01.292Z","id":"eiI07cPEeFxzR69p","name":"Core"},{"updatedAt":"2025-12-09T18:50:08.518Z","createdAt":"2025-12-09T18:50:08.518Z","id":"tMSCjbvPU3xrNUqz","name":"ELO"}]},{"updatedAt":"2025-12-22T18:24:03.738Z","createdAt":"2025-12-19T08:32:05.137Z","id":"nsMrS7SmpsxutrfN","name":"ELO_API_Android_Normalize","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"android/normalize","responseMode":"responseNode","options":{"allowedOrigins":"*"}},"id":"4f05fef1-2808-4b6d-acbe-76035c46ad8b","name":"Webhook - Normalize","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-960,32],"webhookId":"android-normalize"},{"parameters":{"operation":"executeQuery","query":"SELECT od.operator_id, od.tenant_id\nFROM elo_t_operator_devices od\nWHERE od.session_token = '{{ $json.body.session_token }}'\n  AND od.is_active = true\nLIMIT 1;","options":{}},"id":"01b0a9bd-4d2f-43af-92ab-2f199258e371","name":"Postgres - Validate Session","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-736,32],"alwaysOutputData":true,"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"session-valid","leftValue":"={{ $json.operator_id }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"id":"b9ead139-584c-43f5-9fdb-b86a60437ce8","name":"IF - Session Valid","type":"n8n-nodes-base.if","typeVersion":2,"position":[-512,32]},{"parameters":{"method":"POST","url":"https://openrouter.ai/api/v1/chat/completions","authentication":"predefinedCredentialType","nodeCredentialType":"openRouterApi","sendHeaders":true,"headerParameters":{"parameters":[{"name":"HTTP-Referer","value":"https://eldoleado.ru"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"model\": \"openai/gpt-4o-mini\",\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"Ты помощник оператора сервисного центра по ремонту телефонов. Твоя задача - нормализовать текст сообщения оператора:\\n1. Исправить орфографические и грамматические ошибки\\n2. Сделать текст более вежливым и профессиональным\\n3. Сохранить смысл и ключевую информацию\\n4. Убрать лишние слова-паразиты\\n5. Отвечай ТОЛЬКО нормализованным текстом, без пояснений\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": {{ JSON.stringify($('Webhook - Normalize').item.json.body.text) }}\n    }\n  ],\n  \"max_tokens\": 500,\n  \"temperature\": 0.3\n}","options":{}},"id":"40906ce7-69dc-462d-80b5-d60bf94de148","name":"OpenRouter - Normalize","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-288,-80],"credentials":{"openRouterApi":{"id":"ameOTCcGgTm3hbtM","name":"OpenRouter account"}}},{"parameters":{"jsCode":"const response = $input.first().json;\nconst normalizedText = response.choices?.[0]?.message?.content || '';\n\nreturn {\n  normalized_text: normalizedText.trim()\n};"},"id":"682206bd-3ae3-4211-947b-4fba86ab6ea0","name":"Extract Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[-64,-80]},{"parameters":{"respondWith":"json","responseBody":"={\n  \"success\": true,\n  \"normalized_text\": {{ JSON.stringify($json.normalized_text) }}\n}","options":{"responseCode":200,"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"},{"name":"Access-Control-Allow-Origin","value":"*"}]}}},"id":"2078f314-c406-4cc1-8c14-6a529392580c","name":"Response - Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[160,-80]},{"parameters":{"respondWith":"json","responseBody":"={\n  \"success\": false,\n  \"error\": \"invalid_session\"\n}","options":{"responseCode":401,"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"},{"name":"Access-Control-Allow-Origin","value":"*"}]}}},"id":"74cd3da3-4e0b-4430-97af-5637bcbf3115","name":"Response - Unauthorized","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-288,128]}],"connections":{"Webhook - Normalize":{"main":[[{"node":"Postgres - Validate Session","type":"main","index":0}]]},"Postgres - Validate Session":{"main":[[{"node":"IF - Session Valid","type":"main","index":0}]]},"IF - Session Valid":{"main":[[{"node":"OpenRouter - Normalize","type":"main","index":0}],[{"node":"Response - Unauthorized","type":"main","index":0}]]},"OpenRouter - Normalize":{"main":[[{"node":"Extract Response","type":"main","index":0}]]},"Extract Response":{"main":[[{"node":"Response - Success","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"2d7a76ab-1b61-4100-8442-f364f7d5d756","activeVersionId":"2d7a76ab-1b61-4100-8442-f364f7d5d756","triggerCount":1,"shared":[{"updatedAt":"2025-12-19T08:32:05.146Z","createdAt":"2025-12-19T08:32:05.146Z","role":"workflow:owner","workflowId":"nsMrS7SmpsxutrfN","projectId":"x7frUSUEowDAk8Dt"}],"activeVersion":{"updatedAt":"2025-12-22T18:24:03.740Z","createdAt":"2025-12-22T18:24:03.740Z","versionId":"2d7a76ab-1b61-4100-8442-f364f7d5d756","workflowId":"nsMrS7SmpsxutrfN","nodes":[{"parameters":{"httpMethod":"POST","path":"android/normalize","responseMode":"responseNode","options":{"allowedOrigins":"*"}},"id":"4f05fef1-2808-4b6d-acbe-76035c46ad8b","name":"Webhook - Normalize","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-960,32],"webhookId":"android-normalize"},{"parameters":{"operation":"executeQuery","query":"SELECT od.operator_id, od.tenant_id\nFROM elo_t_operator_devices od\nWHERE od.session_token = '{{ $json.body.session_token }}'\n  AND od.is_active = true\nLIMIT 1;","options":{}},"id":"01b0a9bd-4d2f-43af-92ab-2f199258e371","name":"Postgres - Validate Session","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-736,32],"alwaysOutputData":true,"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"session-valid","leftValue":"={{ $json.operator_id }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"id":"b9ead139-584c-43f5-9fdb-b86a60437ce8","name":"IF - Session Valid","type":"n8n-nodes-base.if","typeVersion":2,"position":[-512,32]},{"parameters":{"method":"POST","url":"https://openrouter.ai/api/v1/chat/completions","authentication":"predefinedCredentialType","nodeCredentialType":"openRouterApi","sendHeaders":true,"headerParameters":{"parameters":[{"name":"HTTP-Referer","value":"https://eldoleado.ru"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"model\": \"openai/gpt-4o-mini\",\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"Ты помощник оператора сервисного центра по ремонту телефонов. Твоя задача - нормализовать текст сообщения оператора:\\n1. Исправить орфографические и грамматические ошибки\\n2. Сделать текст более вежливым и профессиональным\\n3. Сохранить смысл и ключевую информацию\\n4. Убрать лишние слова-паразиты\\n5. Отвечай ТОЛЬКО нормализованным текстом, без пояснений\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": {{ JSON.stringify($('Webhook - Normalize').item.json.body.text) }}\n    }\n  ],\n  \"max_tokens\": 500,\n  \"temperature\": 0.3\n}","options":{}},"id":"40906ce7-69dc-462d-80b5-d60bf94de148","name":"OpenRouter - Normalize","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-288,-80],"credentials":{"openRouterApi":{"id":"ameOTCcGgTm3hbtM","name":"OpenRouter account"}}},{"parameters":{"jsCode":"const response = $input.first().json;\nconst normalizedText = response.choices?.[0]?.message?.content || '';\n\nreturn {\n  normalized_text: normalizedText.trim()\n};"},"id":"682206bd-3ae3-4211-947b-4fba86ab6ea0","name":"Extract Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[-64,-80]},{"parameters":{"respondWith":"json","responseBody":"={\n  \"success\": true,\n  \"normalized_text\": {{ JSON.stringify($json.normalized_text) }}\n}","options":{"responseCode":200,"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"},{"name":"Access-Control-Allow-Origin","value":"*"}]}}},"id":"2078f314-c406-4cc1-8c14-6a529392580c","name":"Response - Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[160,-80]},{"parameters":{"respondWith":"json","responseBody":"={\n  \"success\": false,\n  \"error\": \"invalid_session\"\n}","options":{"responseCode":401,"responseHeaders":{"entries":[{"name":"Content-Type","value":"application/json"},{"name":"Access-Control-Allow-Origin","value":"*"}]}}},"id":"74cd3da3-4e0b-4430-97af-5637bcbf3115","name":"Response - Unauthorized","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-288,128]}],"connections":{"Webhook - Normalize":{"main":[[{"node":"Postgres - Validate Session","type":"main","index":0}]]},"Postgres - Validate Session":{"main":[[{"node":"IF - Session Valid","type":"main","index":0}]]},"IF - Session Valid":{"main":[[{"node":"OpenRouter - Normalize","type":"main","index":0}],[{"node":"Response - Unauthorized","type":"main","index":0}]]},"OpenRouter - Normalize":{"main":[[{"node":"Extract Response","type":"main","index":0}]]},"Extract Response":{"main":[[{"node":"Response - Success","type":"main","index":0}]]}},"authors":"Dmitriy Remacs","name":null,"description":null},"tags":[{"updatedAt":"2025-11-23T03:58:34.844Z","createdAt":"2025-11-23T03:58:34.844Z","id":"0yzk30hhaSzkl8bF","name":"API"},{"updatedAt":"2025-12-09T18:50:08.518Z","createdAt":"2025-12-09T18:50:08.518Z","id":"tMSCjbvPU3xrNUqz","name":"ELO"}]},{"updatedAt":"2025-12-20T17:11:48.809Z","createdAt":"2025-12-11T17:08:59.805Z","id":"peUaEixC2W6l75s5","name":"ELO_Input_Ingest","active":false,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"elo-input-ingest","responseMode":"responseNode","options":{}},"id":"5fdb7a74-cf31-499c-b640-4392a46351a7","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1184,160],"webhookId":"elo-input-ingest-001"},{"parameters":{"jsCode":"// Validate and normalize input\nconst input = $input.first().json;\nconst now = Date.now();\nconst rand = Math.random().toString(36).slice(2, 10);\n\n// Required fields validation\nconst errors = [];\nif (!input.channel) errors.push('channel is required');\nif (!input.external_chat_id && !input.external_user_id) {\n  errors.push('external_chat_id or external_user_id is required');\n}\n\nif (errors.length > 0) {\n  return [{\n    json: {\n      valid: false,\n      error: errors.join('; '),\n      received_at: new Date().toISOString()\n    }\n  }];\n}\n\n// Generate IDs if not provided\nconst message_id = input.message_id || `msg_${now}_${rand}`;\nconst trace_id = input.trace_id || `trace_${now}_${rand}`;\n\n// Normalize data\nreturn [{\n  json: {\n    valid: true,\n    // Core fields\n    channel: input.channel,\n    bot_token: input.bot_token || null,\n    external_user_id: input.external_user_id || input.external_chat_id,\n    external_chat_id: input.external_chat_id || input.external_user_id,\n    // Client info\n    client_name: input.client_name || null,\n    client_phone: input.client_phone || null,\n    // Message content\n    text: input.text || '',\n    media: input.media || {},\n    meta: input.meta || {},\n    // Timestamps and IDs\n    timestamp: input.timestamp || new Date().toISOString(),\n    received_at: new Date().toISOString(),\n    message_id: message_id,\n    trace_id: trace_id\n  }\n}];"},"id":"6efdf3ed-18f7-4587-af36-e8e51f37cf49","name":"Validate Input","type":"n8n-nodes-base.code","typeVersion":2,"position":[-976,160]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"valid-check","leftValue":"={{$json.valid}}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}]},"options":{}},"id":"06685e32-6657-468b-bd8e-28af5b83d2c1","name":"If Valid","type":"n8n-nodes-base.if","typeVersion":2,"position":[-752,160]},{"parameters":{"respondWith":"json","responseBody":"={{ { accepted: false, error: $json.error, trace_id: $json.trace_id || null } }}","options":{"responseCode":400}},"id":"047fb041-52c8-44d9-86a2-713de0661d11","name":"Respond Invalid","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-528,48]},{"parameters":{"operation":"get","key":"=dedup:{{$json.message_id}}","options":{}},"id":"a1ac64a8-fbbe-41d2-9c78-25a1fc6ebeec","name":"Check Duplicate","type":"n8n-nodes-base.redis","typeVersion":1,"position":[-528,256],"credentials":{"redis":{"id":"7FQcEivUY94atW24","name":"Redis account"}},"onError":"continueErrorOutput"},{"parameters":{"jsCode":"// Check if duplicate or Redis error\nconst result = $json;\nconst prevData = $('Validate Input').first().json;\n\n// Redis returned value = duplicate exists\nif (result.value) {\n  return [{ json: { ...prevData, is_duplicate: true } }];\n}\n\n// No value = not duplicate\nreturn [{ json: { ...prevData, is_duplicate: false } }];"},"id":"44aebfab-9281-475f-aa98-4f34c3d2af83","name":"Check Result","type":"n8n-nodes-base.code","typeVersion":2,"position":[-304,256]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"dup-check","leftValue":"={{$json.is_duplicate}}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}]},"options":{}},"id":"a528d07b-5350-4aea-a8a7-fca69bd384c8","name":"If Duplicate","type":"n8n-nodes-base.if","typeVersion":2,"position":[-96,256]},{"parameters":{"respondWith":"json","responseBody":"={{ { accepted: true, duplicate: true, message_id: $json.message_id, trace_id: $json.trace_id } }}","options":{"responseCode":200}},"id":"2f9f14d3-1463-427e-b94e-a627ebc11925","name":"Respond Duplicate","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[144,160]},{"parameters":{"operation":"set","key":"=dedup:{{$json.message_id}}","value":"1","expire":true,"ttl":86400},"id":"36237e25-d397-442d-8cda-1db023860748","name":"Mark Processed","type":"n8n-nodes-base.redis","typeVersion":1,"position":[144,352],"credentials":{"redis":{"id":"7FQcEivUY94atW24","name":"Redis account"}}},{"parameters":{"operation":"push","list":"queue:incoming","messageData":"={{ JSON.stringify($('Check Result').first().json) }}","tail":true},"id":"ebe49292-2db3-4f64-84cf-66a28b8b367f","name":"Enqueue","type":"n8n-nodes-base.redis","typeVersion":1,"position":[352,352],"credentials":{"redis":{"id":"7FQcEivUY94atW24","name":"Redis account"}},"onError":"continueErrorOutput"},{"parameters":{"jsCode":"// Check if enqueue succeeded\nconst input = $('Check Result').first().json;\n\n// If we got here without error, success\nif ($json.error) {\n  return [{ json: { success: false, error: $json.error, ...input } }];\n}\n\nreturn [{ json: { success: true, ...input } }];"},"id":"b9e64042-d25d-4afd-93e2-b3e626fb3a73","name":"Check Enqueue","type":"n8n-nodes-base.code","typeVersion":2,"position":[576,352]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict"},"conditions":[{"id":"success-check","leftValue":"={{$json.success}}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}]},"options":{}},"id":"c588cba1-479b-4fd1-839d-eb280521e2d1","name":"If Enqueued","type":"n8n-nodes-base.if","typeVersion":2,"position":[800,352]},{"parameters":{"respondWith":"json","responseBody":"={{ { accepted: false, error: 'queue_error', message_id: $json.message_id, trace_id: $json.trace_id } }}","options":{"responseCode":503}},"id":"dcdf55e6-11db-489d-ba96-268772f73064","name":"Respond Error","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1024,256]},{"parameters":{"respondWith":"json","responseBody":"={{ { accepted: true, message_id: $json.message_id, trace_id: $json.trace_id } }}","options":{"responseCode":202}},"id":"e4a95e9d-5b63-413d-8d98-f518e0e1c3f3","name":"Respond Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1024,448]}],"connections":{"Webhook":{"main":[[{"node":"Validate Input","type":"main","index":0}]]},"Validate Input":{"main":[[{"node":"If Valid","type":"main","index":0}]]},"If Valid":{"main":[[{"node":"Respond Invalid","type":"main","index":0}],[{"node":"Check Duplicate","type":"main","index":0}]]},"Check Duplicate":{"main":[[{"node":"Check Result","type":"main","index":0}],[{"node":"Check Result","type":"main","index":0}]]},"Check Result":{"main":[[{"node":"If Duplicate","type":"main","index":0}]]},"If Duplicate":{"main":[[{"node":"Respond Duplicate","type":"main","index":0}],[{"node":"Mark Processed","type":"main","index":0}]]},"Mark Processed":{"main":[[{"node":"Enqueue","type":"main","index":0}]]},"Enqueue":{"main":[[{"node":"Check Enqueue","type":"main","index":0}],[{"node":"Check Enqueue","type":"main","index":0}]]},"Check Enqueue":{"main":[[{"node":"If Enqueued","type":"main","index":0}]]},"If Enqueued":{"main":[[{"node":"Respond Error","type":"main","index":0}],[{"node":"Respond Success","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"2399cecc-5731-4a8c-831d-56c78d3e7417","activeVersionId":null,"triggerCount":1,"shared":[{"updatedAt":"2025-12-11T17:08:59.812Z","createdAt":"2025-12-11T17:08:59.812Z","role":"workflow:owner","workflowId":"peUaEixC2W6l75s5","projectId":"x7frUSUEowDAk8Dt"}],"activeVersion":null,"tags":[{"updatedAt":"2025-12-20T17:11:33.502Z","createdAt":"2025-12-20T17:11:33.502Z","id":"cuxaBKwkHf1KFGXh","name":"InputCore"},{"updatedAt":"2025-12-09T18:50:08.518Z","createdAt":"2025-12-09T18:50:08.518Z","id":"tMSCjbvPU3xrNUqz","name":"ELO"}]},{"updatedAt":"2025-12-15T17:28:12.290Z","createdAt":"2025-12-15T17:28:07.703Z","id":"qaSDHs718S7rl1vX","name":"ELO_Decision","active":false,"isArchived":false,"nodes":[{"parameters":{"path":"elo-decision","responseMode":"responseNode","options":{}},"id":"8914c17c-dcdd-444a-a67b-35b88e56902e","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-240,-32],"webhookId":"elo-decision"},{"parameters":{"jsCode":"const input = $input.first().json.body || $input.first().json;\n\nif (!input.context) {\n  throw new Error('Missing required field: context');\n}\n\nconst context = input.context;\n\n// Prepare evaluation context with helper flags\nconst evalContext = {\n  // Stage\n  stage: context.current_stage || 'data_collection',\n  \n  // Device\n  has_device: !!(context.lines?.[0]?.slots?.device),\n  device: context.lines?.[0]?.slots?.device || null,\n  \n  // Symptom\n  has_symptom: !!(context.lines?.[0]?.slots?.symptom),\n  symptom: context.lines?.[0]?.slots?.symptom || null,\n  \n  // Derived data\n  has_diagnosis: !!(context.lines?.[0]?.slots?.diagnosis),\n  has_price: !!(context.lines?.[0]?.slots?.price),\n  price: context.lines?.[0]?.slots?.price || null,\n  repair: context.lines?.[0]?.slots?.repair_type || null,\n  \n  // Booking\n  has_booking_date: !!(context.booking?.date),\n  has_booking_time: !!(context.booking?.time),\n  has_booking_name: !!(context.booking?.name),\n  has_booking_phone: !!(context.booking?.phone),\n  booking: context.booking || {},\n  \n  // Intent (from last extraction)\n  intent: context.last_intent || context.entities?.find(e => e.type === 'intent')?.value || null,\n  \n  // Meta\n  is_first_message: !context.message_count || context.message_count <= 1,\n  \n  // Full context for template substitution\n  _full: context\n};\n\nreturn {\n  context: context,\n  eval_context: evalContext,\n  vertical_id: context.vertical_id || 1\n};"},"id":"de17c4a5-eee0-4254-8185-2a2475e54b5b","name":"Prepare Context","type":"n8n-nodes-base.code","typeVersion":2,"position":[-16,-32]},{"parameters":{"operation":"executeQuery","query":"SELECT rule_code, rule_name, priority, conditions, actions\nFROM elo_v_decision_rules\nWHERE vertical_id = $1 AND is_active = true\nORDER BY priority DESC;","options":{"queryReplacement":"={{ [$json.vertical_id] }}"}},"id":"06781442-01b0-4636-8ae8-c8b27b3d5ff6","name":"Load Rules","type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[208,-32],"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"jsCode":"const prepareData = $('Prepare Context').first().json;\nconst evalContext = prepareData.eval_context;\nconst rules = $input.all().map(item => item.json);\n\n// Helper: get nested value by path (e.g., 'device.brand')\nfunction getByPath(obj, path) {\n  return path.split('.').reduce((o, k) => o?.[k], obj);\n}\n\n// Helper: match single condition\nfunction matchCondition(actual, expected) {\n  if (expected === null) {\n    return actual === null || actual === undefined;\n  }\n  \n  if (typeof expected === 'object' && expected !== null) {\n    // Operators\n    if ('$exists' in expected) {\n      const exists = actual !== null && actual !== undefined;\n      return exists === expected.$exists;\n    }\n    if ('$gt' in expected) {\n      return actual > expected.$gt;\n    }\n    if ('$gte' in expected) {\n      return actual >= expected.$gte;\n    }\n    if ('$lt' in expected) {\n      return actual < expected.$lt;\n    }\n    if ('$lte' in expected) {\n      return actual <= expected.$lte;\n    }\n    if ('$in' in expected) {\n      return expected.$in.includes(actual);\n    }\n    if ('$ne' in expected) {\n      return actual !== expected.$ne;\n    }\n    // Object comparison\n    return JSON.stringify(actual) === JSON.stringify(expected);\n  }\n  \n  // Direct comparison\n  return actual === expected;\n}\n\n// Helper: match all conditions in a rule\nfunction matchAllConditions(context, conditions) {\n  for (const [path, expected] of Object.entries(conditions)) {\n    const actual = getByPath(context, path);\n    if (!matchCondition(actual, expected)) {\n      return false;\n    }\n  }\n  return true;\n}\n\n// Find first matching rule\nlet matchedRule = null;\nfor (const rule of rules) {\n  const conditions = typeof rule.conditions === 'string' \n    ? JSON.parse(rule.conditions) \n    : rule.conditions;\n    \n  if (matchAllConditions(evalContext, conditions)) {\n    matchedRule = rule;\n    break;\n  }\n}\n\n// Fallback if no rule matched\nif (!matchedRule) {\n  matchedRule = {\n    rule_code: 'fallback',\n    rule_name: 'Fallback',\n    actions: { goal: 'clarify', prompt_id: 'clarify' }\n  };\n}\n\nconst actions = typeof matchedRule.actions === 'string'\n  ? JSON.parse(matchedRule.actions)\n  : matchedRule.actions;\n\nreturn {\n  matched_rule: matchedRule.rule_code,\n  rule_name: matchedRule.rule_name,\n  actions: actions,\n  eval_context: evalContext,\n  context: prepareData.context,\n  vertical_id: prepareData.vertical_id\n};"},"id":"4b31a69a-0091-41db-a7d8-d789994e9ae0","name":"Evaluate Rules","type":"n8n-nodes-base.code","typeVersion":2,"position":[432,-32]},{"parameters":{"operation":"executeQuery","query":"SELECT prompt_id, goal_type, template, config\nFROM elo_v_prompts\nWHERE vertical_id = $1 AND prompt_id = $2 AND is_active = true\nLIMIT 1;","options":{"queryReplacement":"={{ [$json.vertical_id, $json.actions.prompt_id] }}"}},"id":"6b0f4ca2-12d0-478a-b0f5-d32a4df8f2c2","name":"Load Prompt","type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[640,-32],"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"jsCode":"const evalData = $('Evaluate Rules').first().json;\nconst promptRow = $input.first()?.json || {};\nconst context = evalData.context;\nconst actions = evalData.actions;\n\n// Helper: substitute template variables\nfunction substituteTemplate(template, context) {\n  if (!template) return '';\n  \n  return template.replace(/\\{([^}]+)\\}/g, (match, path) => {\n    const parts = path.split('.');\n    let value = context;\n    \n    for (const part of parts) {\n      if (value === null || value === undefined) return match;\n      value = value[part];\n    }\n    \n    if (value === null || value === undefined) return match;\n    if (typeof value === 'object') return JSON.stringify(value);\n    return String(value);\n  });\n}\n\n// Build template context\nconst templateContext = {\n  device: context.lines?.[0]?.slots?.device || {},\n  symptom: context.lines?.[0]?.slots?.symptom || '',\n  diagnosis: context.lines?.[0]?.slots?.diagnosis || {},\n  repair: context.lines?.[0]?.slots?.repair_type || {},\n  price: context.lines?.[0]?.slots?.price || {},\n  booking: context.booking || {},\n  client: context.client || {}\n};\n\n// Substitute variables in template\nconst instruction = substituteTemplate(promptRow.template || 'Please clarify your request.', templateContext);\n\n// Build output for Executor\nconst output = {\n  instruction: instruction,\n  goal: actions.goal,\n  prompt_id: actions.prompt_id,\n  \n  // Optional elements from actions\n  buttons: actions.buttons || [],\n  side_effects: actions.side_effects || [],\n  next_stage: actions.next_stage || null,\n  \n  // Config\n  config: promptRow.config || {},\n  \n  // Pass through context\n  context: context,\n  \n  // Debug info\n  _debug: {\n    matched_rule: evalData.matched_rule,\n    rule_name: evalData.rule_name\n  }\n};\n\nreturn output;"},"id":"2b064e01-fd21-414a-9d72-d7d30de57098","name":"Build Output","type":"n8n-nodes-base.code","typeVersion":2,"position":[864,-32]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"a913bf78-5b8d-4e95-892b-fabe3785510c","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1088,-32]}],"connections":{"Webhook":{"main":[[{"node":"Prepare Context","type":"main","index":0}]]},"Prepare Context":{"main":[[{"node":"Load Rules","type":"main","index":0}]]},"Load Rules":{"main":[[{"node":"Evaluate Rules","type":"main","index":0}]]},"Evaluate Rules":{"main":[[{"node":"Load Prompt","type":"main","index":0}]]},"Load Prompt":{"main":[[{"node":"Build Output","type":"main","index":0}]]},"Build Output":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"f1c88d0a-dbfa-407e-80f7-1ac2e26749e2","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2025-12-15T17:28:07.708Z","createdAt":"2025-12-15T17:28:07.708Z","role":"workflow:owner","workflowId":"qaSDHs718S7rl1vX","projectId":"x7frUSUEowDAk8Dt"}],"activeVersion":null,"tags":[{"updatedAt":"2025-12-12T08:39:41.170Z","createdAt":"2025-12-12T08:39:41.170Z","id":"8dihLRJvdhkW2kZ1","name":"AI"},{"updatedAt":"2025-12-09T18:50:08.518Z","createdAt":"2025-12-09T18:50:08.518Z","id":"tMSCjbvPU3xrNUqz","name":"ELO"}]},{"updatedAt":"2025-12-11T13:00:47.007Z","createdAt":"2025-12-10T09:59:17.093Z","id":"s1GvbRvYjv88hCdW","name":"ELO_In_Form","active":false,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"form","responseMode":"lastNode","options":{}},"id":"5fcd2bf8-e6f7-4418-916a-21b282708ebe","name":"Form Trigger","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[-560,-48],"webhookId":"form-webhook"},{"parameters":{"jsCode":"const formData = $input.first().json;\n\n// Извлекаем данные из формы/квиза\n// Поддерживаем различные варианты названий полей\nconst phone = formData.phone || formData.telephone || formData.mobile || formData.cell || null;\nconst name = formData.name || formData.full_name || formData.client_name || formData.customer_name || null;\nconst phoneModel = formData.phone_model || formData.model || formData.device_model || formData.device || null;\nconst message = formData.message || formData.comment || formData.description || formData.text || '';\n\n// Дополнительные поля\nconst email = formData.email || null;\nconst source = formData.source || formData.utm_source || formData.form_source || 'form';\nconst formId = formData.form_id || formData.quiz_id || formData.id || null;\nconst formName = formData.form_name || formData.quiz_name || null;\n\n// Формируем текст сообщения\nlet messageText = '';\n\n// Добавляем модель телефона если указана\nif (phoneModel) {\n  messageText += `Модель: ${phoneModel}\\\\n`;\n}\n\n// Добавляем основное сообщение\nif (message) {\n  messageText += message;\n}\n\n// Если текста совсем нет\nif (!messageText.trim()) {\n  messageText = '[Заявка с формы без текста]';\n}\n\n// Очищаем и нормализуем телефон\nlet cleanPhone = null;\nif (phone) {\n  cleanPhone = phone.replace(/\\\\D/g, '');\n  \n  // Если начинается с 8, меняем на 7\n  if (cleanPhone.length === 11 && cleanPhone.startsWith('8')) {\n    cleanPhone = '7' + cleanPhone.substring(1);\n  }\n  \n  // Если начинается с 9 (без кода страны), добавляем 7\n  if (cleanPhone.length === 10 && cleanPhone.startsWith('9')) {\n    cleanPhone = '7' + cleanPhone;\n  }\n  \n  // Добавляем +\n  if (cleanPhone) {\n    cleanPhone = '+' + cleanPhone;\n  }\n}\n\nreturn {\n  channel: 'form',\n  external_user_id: cleanPhone?.replace(/\\\\+/g, '') || email || 'unknown',\n  external_chat_id: cleanPhone || email || 'unknown',\n  \n  text: messageText.trim(),\n  timestamp: new Date().toISOString(),\n  \n  client_phone: cleanPhone,\n  client_name: name,\n  client_email: email,\n  \n  media: {\n    has_voice: false,\n    voice_transcribed_text: null,\n    has_images: false,\n    images: [],\n    has_video: false,\n    videos: [],\n    has_document: false\n  },\n  \n  meta: {\n    external_message_id: formId || Date.now().toString(),\n    ad_channel: 'form',\n    ad_id: null,\n    original_media_type: 'text',\n    raw: formData,\n    form_source: source,\n    form_id: formId,\n    form_name: formName\n  },\n  \n  prefilled_data: {\n    model: phoneModel,\n    parts_owner: null\n  }\n};"},"id":"b4a90710-0fc6-4cff-bc25-99ac537be1c2","name":"Normalize Form","type":"n8n-nodes-base.code","typeVersion":2,"position":[-336,-48]},{"parameters":{"workflowId":"={{ $env.CLIENT_RESOLVER_WORKFLOW_ID }}","options":{}},"id":"319581cd-6ef0-4909-b31b-d8f191d3167e","name":"Execute Client Resolver","type":"n8n-nodes-base.executeWorkflow","typeVersion":1,"position":[-112,-48]},{"parameters":{"respondWith":"json","responseBody":"={{ { \\\"success\\\": true, \\\"message\\\": \\\"Спасибо! Мы свяжемся с вами в ближайшее время.\\\" } }}","options":{}},"id":"e694d3fc-33e0-4a39-bc99-840b7c371509","name":"Respond Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[336,-48]},{"parameters":{"workflowId":{"__rl":true,"value":"rRO6sxLqiCdgvLZz","mode":"list","cachedResultUrl":"/workflow/rRO6sxLqiCdgvLZz","cachedResultName":"ELO_Core_Tenant_Resolver"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[96,-48],"id":"37172b86-dbdd-4b31-bab3-e31fb64ebe6c","name":"Execute Tenant Resolver"}],"connections":{"Form Trigger":{"main":[[{"node":"Normalize Form","type":"main","index":0}]]},"Normalize Form":{"main":[[{"node":"Execute Client Resolver","type":"main","index":0}]]},"Execute Client Resolver":{"main":[[{"node":"Execute Tenant Resolver","type":"main","index":0}]]},"Execute Tenant Resolver":{"main":[[{"node":"Respond Success","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"47f1407e-8217-4624-af74-4b7acc4f8ee7","activeVersionId":null,"triggerCount":1,"shared":[{"updatedAt":"2025-12-10T09:59:17.099Z","createdAt":"2025-12-10T09:59:17.099Z","role":"workflow:owner","workflowId":"s1GvbRvYjv88hCdW","projectId":"x7frUSUEowDAk8Dt"}],"activeVersion":null,"tags":[{"updatedAt":"2025-11-23T04:03:40.721Z","createdAt":"2025-11-23T04:03:40.721Z","id":"nLdF41tEx70V7m3A","name":"In"},{"updatedAt":"2025-12-09T18:50:08.518Z","createdAt":"2025-12-09T18:50:08.518Z","id":"tMSCjbvPU3xrNUqz","name":"ELO"}]},{"updatedAt":"2025-12-17T08:34:29.035Z","createdAt":"2025-12-10T10:00:01.408Z","id":"sGJxAIwGzMrfCjeA","name":"ELO_In_Telegram","active":false,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"telegram-in","responseMode":"responseNode","options":{}},"id":"5b0747d6-1dfc-450a-b480-e6a3a3aec55b","name":"Telegram Webhook","type":"n8n-nodes-base.webhook","typeVersion":1.1,"position":[-912,32],"webhookId":"telegram-in-webhook"},{"parameters":{"jsCode":"// MCP Telegram присылает нормализованные данные\n  // Webhook передает данные в body\n  const rawInput = $input.first().json;\n  const event = rawInput.body || rawInput;\n\n  // Извлекаем данные из MCP формата\n  const chatId = event.chat_id?.toString() || '';\n  const userId = event.user_id?.toString() || '';\n  const messageText = event.text || '';\n  const messageId = event.message_id?.toString() || Date.now().toString();\n  const timestamp = event.timestamp || new Date().toISOString();\n  const botToken = event.bot_token || '';\n\n  // Имя пользователя\n  let clientName = event.first_name || '';\n  if (event.last_name) {\n    clientName += (clientName ? ' ' : '') + event.last_name;\n  }\n  if (!clientName && event.username) {\n    clientName = '@' + event.username;\n  }\n\n  // Проверяем медиа из attachments\n  const attachments = event.attachments || [];\n  const hasVoice = attachments.some(a => a.type === 'voice');\n  const hasPhoto = attachments.some(a => a.type === 'photo');\n  const hasVideo = attachments.some(a => a.type === 'video' || a.type === 'video_note');\n  const hasDocument = attachments.some(a => a.type === 'document');\n\n  // Получаем file_id для голосового\n  const voiceAttachment = attachments.find(a => a.type === 'voice');\n  const voiceFileId = voiceAttachment?.file_id || null;\n\n  // Получаем фото\n  const photoAttachments = attachments.filter(a => a.type === 'photo');\n  const videoAttachments = attachments.filter(a => a.type === 'video' || a.type === 'video_note');\n\n  return {\n    has_voice: hasVoice,\n    voice_file_id: voiceFileId,\n    bot_token: botToken,\n    raw_event: event.raw_data || event,\n    chat_id: chatId,\n    user_id: userId,\n    phone: null,\n    message_text: messageText,\n    message_id: messageId,\n    timestamp: timestamp,\n    sender_name: clientName,\n    username: event.username,\n    has_photo: hasPhoto,\n    photo_attachments: photoAttachments,\n    has_video: hasVideo,\n    video_attachments: videoAttachments,\n    has_document: hasDocument,\n    is_callback: event.is_callback || false,\n    callback_data: event.callback_data || null\n  };"},"id":"376d90f2-04bd-4986-b2c2-523d170ca91d","name":"Extract Telegram Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[-704,32]},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $json.has_voice }}","value2":true}]}},"id":"1dc15de9-7409-40ee-9d30-d852d9b6732f","name":"Has Voice?","type":"n8n-nodes-base.if","typeVersion":1,"position":[-480,32]},{"parameters":{"url":"=https://api.telegram.org/bot{{ $json.bot_token }}/getFile?file_id={{ $json.voice_file_id }}","options":{}},"id":"c0203645-d49c-4e13-a026-8681ef9bbea5","name":"Get Voice File Path","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-256,-80]},{"parameters":{"url":"=https://api.telegram.org/file/bot{{ $('Extract Telegram Data').item.json.bot_token }}/{{ $json.result.file_path }}","options":{"response":{"response":{"responseFormat":"file"}}}},"id":"49d3678e-790e-4da4-a361-1b655f4e000d","name":"Download Voice","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-32,-80]},{"parameters":{"resource":"audio","operation":"transcribe","options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[192,-80],"id":"6b0eee14-8777-420f-8f0c-4f4a20d9fd6c","name":"Transcribe Voice","credentials":{"openAiApi":{"id":"ptoy1RvCOn39G0Af","name":"OpenAi account"}}},{"parameters":{"jsCode":"const data = $('Extract Telegram Data').first().json;\nconst transcription = $input.first().json.text;\n\nlet messageText = data.message_text;\nif (transcription) {\n  messageText = (messageText ? messageText + '\\n\\n' : '') + transcription;\n}\n\nreturn {\n  channel: 'telegram',\n  bot_token: data.bot_token,\n  external_user_id: 'tg_' + data.user_id,\n  external_chat_id: 'tg_' + data.chat_id,\n  \n  text: messageText,\n  timestamp: data.timestamp,\n  \n  client_phone: null,\n  client_name: data.sender_name,\n  client_email: null,\n  client_username: data.username,\n  \n  media: {\n    has_voice: true,\n    voice_transcribed_text: transcription,\n    has_images: data.has_photo,\n    images: data.photo_attachments.map(a => ({ file_id: a.file_id, type: 'telegram_photo' })),\n    has_video: data.has_video,\n    videos: data.video_attachments.map(a => ({ file_id: a.file_id, type: 'telegram_video' })),\n    has_document: data.has_document\n  },\n  \n  meta: {\n    external_message_id: data.message_id,\n    ad_channel: 'telegram',\n    ad_id: null,\n    original_media_type: 'voice',\n    telegram_user_id: data.user_id,\n    telegram_chat_id: data.chat_id,\n    is_callback: data.is_callback,\n    callback_data: data.callback_data,\n    raw: data.raw_event,\n    provider: 'mcp-telegram'\n  },\n  \n  prefilled_data: {\n    model: null,\n    parts_owner: null\n  }\n};"},"id":"a5c0d2e9-8b6a-4969-94f8-675bb4cec235","name":"Normalize with Voice","type":"n8n-nodes-base.code","typeVersion":2,"position":[416,-80]},{"parameters":{"jsCode":"const data = $input.first().json;\n\nreturn {\n  channel: 'telegram',\n  bot_token: data.bot_token,\n  external_user_id: 'tg_' + data.user_id,\n  external_chat_id: 'tg_' + data.chat_id,\n  \n  text: data.message_text,\n  timestamp: data.timestamp,\n  \n  client_phone: null,\n  client_name: data.sender_name,\n  client_email: null,\n  client_username: data.username,\n  \n  media: {\n    has_voice: false,\n    voice_transcribed_text: null,\n    has_images: data.has_photo,\n    images: data.photo_attachments.map(a => ({ file_id: a.file_id, type: 'telegram_photo' })),\n    has_video: data.has_video,\n    videos: data.video_attachments.map(a => ({ file_id: a.file_id, type: 'telegram_video' })),\n    has_document: data.has_document,\n    has_callback: data.is_callback\n  },\n  \n  meta: {\n    external_message_id: data.message_id,\n    ad_channel: 'telegram',\n    ad_id: null,\n    original_media_type: data.has_photo ? 'photo' : data.has_video ? 'video' : data.is_callback ? 'callback' : 'text',\n    telegram_user_id: data.user_id,\n    telegram_chat_id: data.chat_id,\n    is_callback: data.is_callback,\n    callback_data: data.callback_data,\n    raw: data.raw_event,\n    provider: 'mcp-telegram'\n  },\n  \n  prefilled_data: {\n    model: null,\n    parts_owner: null\n  }\n};"},"id":"91c80983-f5a3-45b8-9ac2-d881ee0045d1","name":"Normalize without Voice","type":"n8n-nodes-base.code","typeVersion":2,"position":[-256,128]},{"parameters":{"workflowId":{"__rl":true,"value":"rRO6sxLqiCdgvLZz","mode":"list","cachedResultUrl":"/workflow/rRO6sxLqiCdgvLZz","cachedResultName":"ELO_Core_Tenant_Resolver"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[640,32],"id":"7ae8d1ee-29e5-4b26-8690-2b44d35b1210","name":"Execute Tenant Resolver"},{"parameters":{"jsCode":"// Подготавливаем сообщение для Redis очереди\nconst data = $input.first().json;\n\nreturn {\n  message_json: JSON.stringify(data),\n  batch_key: `${data.channel}:${data.external_chat_id}`\n};"},"id":"079e650e-d873-4313-9580-51cd997a6e2f","name":"Prepare for Queue","type":"n8n-nodes-base.code","typeVersion":2,"position":[864,32]},{"parameters":{"operation":"push","list":"queue:incoming","messageData":"={{ $json.message_json }}","tail":true},"id":"bccf0b86-046d-4a66-8002-b115b04e2875","name":"Push to Queue","type":"n8n-nodes-base.redis","typeVersion":1,"position":[1088,32],"credentials":{"redis":{"id":"7FQcEivUY94atW24","name":"Redis account"}}},{"parameters":{"respondWith":"json","responseBody":"={{ { \"success\": true, \"queued\": true, \"batch_key\": $('Prepare for Queue').item.json.batch_key } }}","options":{}},"id":"85fdc02f-dd4a-4201-9dd7-e0380cc5a6de","name":"Respond Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[1312,32]}],"connections":{"Telegram Webhook":{"main":[[{"node":"Extract Telegram Data","type":"main","index":0}]]},"Extract Telegram Data":{"main":[[{"node":"Has Voice?","type":"main","index":0}]]},"Has Voice?":{"main":[[{"node":"Get Voice File Path","type":"main","index":0}],[{"node":"Normalize without Voice","type":"main","index":0}]]},"Get Voice File Path":{"main":[[{"node":"Download Voice","type":"main","index":0}]]},"Download Voice":{"main":[[{"node":"Transcribe Voice","type":"main","index":0}]]},"Transcribe Voice":{"main":[[{"node":"Normalize with Voice","type":"main","index":0}]]},"Normalize with Voice":{"main":[[{"node":"Execute Tenant Resolver","type":"main","index":0}]]},"Normalize without Voice":{"main":[[{"node":"Execute Tenant Resolver","type":"main","index":0}]]},"Execute Tenant Resolver":{"main":[[{"node":"Prepare for Queue","type":"main","index":0}]]},"Prepare for Queue":{"main":[[{"node":"Push to Queue","type":"main","index":0}]]},"Push to Queue":{"main":[[{"node":"Respond Success","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"903c41a2-9c7d-4a22-9859-45708759fe2f","activeVersionId":null,"triggerCount":1,"shared":[{"updatedAt":"2025-12-10T10:00:01.419Z","createdAt":"2025-12-10T10:00:01.419Z","role":"workflow:owner","workflowId":"sGJxAIwGzMrfCjeA","projectId":"x7frUSUEowDAk8Dt"}],"activeVersion":null,"tags":[{"updatedAt":"2025-11-23T04:03:40.721Z","createdAt":"2025-11-23T04:03:40.721Z","id":"nLdF41tEx70V7m3A","name":"In"},{"updatedAt":"2025-12-09T18:50:08.518Z","createdAt":"2025-12-09T18:50:08.518Z","id":"tMSCjbvPU3xrNUqz","name":"ELO"}]},{"updatedAt":"2025-12-17T08:57:24.722Z","createdAt":"2025-12-15T17:27:13.441Z","id":"vwcZwvOGoLnIrS3e","name":"ELO_Core_Response_Generator","active":false,"isArchived":false,"nodes":[{"parameters":{"path":"elo-core-response-generator","responseMode":"responseNode","options":{}},"id":"e4fcde0d-c4ae-4dd4-b2f3-d03154864d26","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-288,-128],"webhookId":"elo-core-response-generator"},{"parameters":{"jsCode":"const input = $input.first().json;\nconst context = input.context;\nconst triggersFired = input.triggers_fired || [];\n\nconst stage = context.current_stage;\nconst focusLine = context.lines?.find(l => l.id === context.focus_line_id) || context.lines?.[0];\n\nlet responseGoal = {\n  type: 'ask_slot',\n  slot: null,\n  stage: stage\n};\n\n// Determine what to ask for based on stage\nswitch (stage) {\n  case 'data_collection':\n    if (focusLine) {\n      // Find first empty required slot\n      const requiredSlots = ['device', 'symptom'];\n      for (const slot of requiredSlots) {\n        if (!focusLine.slots?.[slot]) {\n          responseGoal.slot = slot;\n          break;\n        }\n      }\n      \n      // If all required filled, confirm data\n      if (!responseGoal.slot) {\n        responseGoal.type = 'confirm_data';\n      }\n    }\n    break;\n  \n  case 'presentation':\n    responseGoal.type = 'present_offer';\n    responseGoal.include_price = true;\n    break;\n  \n  case 'agreement':\n    responseGoal.type = 'ask_confirmation';\n    break;\n  \n  case 'booking':\n    const bookingSlots = ['date', 'time', 'name', 'phone'];\n    const booking = context.booking || {};\n    for (const slot of bookingSlots) {\n      if (!booking[slot]) {\n        responseGoal.type = 'ask_slot';\n        responseGoal.slot = slot;\n        break;\n      }\n    }\n    break;\n  \n  case 'confirmation':\n    responseGoal.type = 'ask_final_confirmation';\n    break;\n}\n\n// Add trigger messages to include\nresponseGoal.trigger_messages = triggersFired\n  .filter(t => t.action?.type === 'send_message')\n  .map(t => t.action.message);\n\nreturn {\n  context: context,\n  response_goal: responseGoal,\n  focus_line: focusLine,\n  vertical_id: context.vertical_id || 1\n};"},"id":"3b7c07d2-4922-4a8c-a4a8-e736a817dc3c","name":"Determine Goal","type":"n8n-nodes-base.code","typeVersion":2,"position":[-64,-128]},{"parameters":{"operation":"executeQuery","query":"SELECT\n    system_prompt,\n    user_prompt_template\nFROM elo_v_prompts\nWHERE vertical_id = $1\n  AND prompt_type = 'response'\n  AND goal_type = $2\n  AND (slot_name = $3 OR (slot_name IS NULL AND $3 IS NULL))\n  AND is_active = true\nORDER BY version DESC\nLIMIT 1;","options":{"queryReplacement":"={{ [$json.vertical_id, $json.response_goal.type, $json.response_goal.slot || null] }}"}},"id":"d883e007-3372-4295-af33-7db45bb5fbcc","name":"PostgreSQL Load Prompt","type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[160,-128],"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"jsCode":"const determineData = $('Determine Goal').first().json;\nconst context = determineData.context;\nconst goal = determineData.response_goal;\nconst focusLine = determineData.focus_line;\nconst promptData = $input.first().json || {};\n\n// Build device string\nconst deviceStr = focusLine?.slots?.device\n  ? `${focusLine.slots.device.brand} ${focusLine.slots.device.model}`\n  : 'device';\n\nconst symptomStr = focusLine?.slots?.symptom?.text || 'problem';\nconst diagnosisStr = focusLine?.slots?.diagnosis?.text || 'diagnostics';\nconst repairStr = focusLine?.slots?.repair_type?.text || 'repair';\nconst priceStr = focusLine?.slots?.price?.amount || '???';\nconst dateStr = context.booking?.date || '';\nconst timeStr = context.booking?.time || '';\n\n// Template variables\nconst vars = {\n  device: deviceStr,\n  symptom: symptomStr,\n  diagnosis: diagnosisStr,\n  repair: repairStr,\n  price: priceStr,\n  date: dateStr,\n  time: timeStr,\n  client_name: context.client?.name || 'client'\n};\n\n// Replace {{var}} placeholders in template\nlet userPrompt = promptData.user_prompt_template || `Ask about ${goal.slot || goal.type}`;\nfor (const [key, value] of Object.entries(vars)) {\n  userPrompt = userPrompt.replace(new RegExp(`{{${key}}}`, 'g'), String(value));\n}\n\n// Add trigger messages\nif (goal.trigger_messages?.length > 0) {\n  userPrompt += '\\n\\nAlso include: ' + goal.trigger_messages.join('; ');\n}\n\n// Build system prompt\nlet systemPrompt = promptData.system_prompt || 'You are a helpful service center assistant.';\n\n// Add context to system prompt\nsystemPrompt += `\\n\\nRULES:\\n1. Respond in Russian\\n2. Be brief (1-3 sentences)\\n3. Use client name: ${context.client?.name || 'client'}\\n4. Don't ask multiple questions at once\\n5. Be friendly and professional`;\n\nif (goal.trigger_messages?.length > 0) {\n  systemPrompt += `\\n\\nALSO INCLUDE IN RESPONSE:\\n${goal.trigger_messages.join('\\n')}`;\n}\n\nreturn {\n  system_prompt: systemPrompt,\n  user_message: userPrompt,\n  goal: goal,\n  context: context,\n  focus_line: focusLine\n};"},"id":"82ad72e8-87fa-4688-a1d7-27676fe067b3","name":"Build Prompt","type":"n8n-nodes-base.code","typeVersion":2,"position":[384,-128]},{"parameters":{"method":"POST","url":"https://openrouter.ai/api/v1/chat/completions","authentication":"predefinedCredentialType","nodeCredentialType":"openRouterApi","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify({\n  model: 'qwen/qwen3-30b-a3b:free',\n  messages: [\n    { role: 'system', content: $json.system_prompt },\n    { role: 'user', content: $json.user_message }\n  ],\n  temperature: 0.7,\n  max_tokens: 300\n}) }}","options":{"timeout":60000}},"id":"34ab3628-2f28-49b6-afb8-655131605f03","name":"Call OpenRouter","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[592,-128],"credentials":{"openRouterApi":{"id":"ameOTCcGgTm3hbtM","name":"OpenRouter account"}}},{"parameters":{"jsCode":"const response = $json;\nconst goal = $('Build Prompt').first().json.goal;\nconst context = $('Build Prompt').first().json.context;\nconst focusLine = $('Build Prompt').first().json.focus_line;\n\nlet responseText = '';\ntry {\n  responseText = response.choices?.[0]?.message?.content || '';\n  // Clean up\n  responseText = responseText.trim();\n  // Remove thinking tags if present (Qwen3)\n  responseText = responseText.replace(/<think>[\\s\\S]*?<\\/think>/g, '').trim();\n} catch (e) {\n  responseText = 'Thanks for your message! How can I help?';\n}\n\n// Build buttons based on stage/goal\nlet buttons = [];\n\nswitch (goal.stage) {\n  case 'presentation':\n    buttons = [\n      { text: 'Book', callback_data: 'book' },\n      { text: 'Questions', callback_data: 'clarify' }\n    ];\n    break;\n  \n  case 'agreement':\n    buttons = [\n      { text: 'Yes, book', callback_data: 'confirm_book' },\n      { text: 'No, thanks', callback_data: 'decline' }\n    ];\n    break;\n  \n  case 'booking':\n    if (goal.slot === 'date') {\n      const today = new Date();\n      buttons = [0, 1, 2].map(offset => {\n        const date = new Date(today);\n        date.setDate(date.getDate() + offset);\n        const dateStr = date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });\n        return {\n          text: offset === 0 ? 'Today' : offset === 1 ? 'Tomorrow' : dateStr,\n          callback_data: `date_${date.toISOString().split('T')[0]}`\n        };\n      });\n    } else if (goal.slot === 'time') {\n      buttons = [\n        { text: '10:00', callback_data: 'time_10:00' },\n        { text: '14:00', callback_data: 'time_14:00' },\n        { text: '18:00', callback_data: 'time_18:00' }\n      ];\n    }\n    break;\n  \n  case 'confirmation':\n    buttons = [\n      { text: 'Confirm', callback_data: 'confirm' },\n      { text: 'Change', callback_data: 'change' }\n    ];\n    break;\n}\n\nreturn {\n  response: {\n    text: responseText,\n    buttons: buttons,\n    attachments: [],\n    metadata: {\n      stage: goal.stage,\n      asking_for: goal.slot || goal.type,\n      ai_model: response.model,\n      tokens_used: response.usage?.total_tokens\n    }\n  }\n};"},"id":"f215a9fd-2b78-44ea-b01a-cb4571180f2e","name":"Parse Response","type":"n8n-nodes-base.code","typeVersion":2,"position":[816,-128]},{"parameters":{"respondWith":"json","responseBody":"={{ $json }}","options":{}},"id":"62cd870b-8e7f-4a1a-b38a-75f0e85045f7","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[1040,-128]}],"connections":{"Webhook":{"main":[[{"node":"Determine Goal","type":"main","index":0}]]},"Determine Goal":{"main":[[{"node":"PostgreSQL Load Prompt","type":"main","index":0}]]},"PostgreSQL Load Prompt":{"main":[[{"node":"Build Prompt","type":"main","index":0}]]},"Build Prompt":{"main":[[{"node":"Call OpenRouter","type":"main","index":0}]]},"Call OpenRouter":{"main":[[{"node":"Parse Response","type":"main","index":0}]]},"Parse Response":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"bdddafb1-3921-428b-bc65-a28713d0f413","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2025-12-15T17:27:13.448Z","createdAt":"2025-12-15T17:27:13.448Z","role":"workflow:owner","workflowId":"vwcZwvOGoLnIrS3e","projectId":"x7frUSUEowDAk8Dt"}],"activeVersion":null,"tags":[{"updatedAt":"2025-12-12T08:39:41.170Z","createdAt":"2025-12-12T08:39:41.170Z","id":"8dihLRJvdhkW2kZ1","name":"AI"},{"updatedAt":"2025-12-09T18:50:08.518Z","createdAt":"2025-12-09T18:50:08.518Z","id":"tMSCjbvPU3xrNUqz","name":"ELO"}]},{"updatedAt":"2025-12-20T18:01:29.580Z","createdAt":"2025-12-17T18:19:32.143Z","id":"yW11VXCx1UCfJqXd","name":"ELO_API_Android_Register_FCM","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"android-register-fcm","responseMode":"responseNode","options":{}},"id":"56260b5f-d1e2-453f-a415-e5856fc892c1","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1264,160],"webhookId":"android-register-fcm"},{"parameters":{"jsCode":"const body = $input.item.json.body || {};\nconst deviceInfo = body.device_info || null;\nconst deviceId = deviceInfo?.device_id || null;\nconst deviceInfoJson = deviceInfo ? JSON.stringify(deviceInfo) : null;\n\nreturn {\n  operator_id: body.operator_id?.trim() || '',\n  session_token: body.session_token?.trim() || '',\n  fcm_token: body.fcm_token?.trim() || '',\n  device_info: deviceInfo,\n  device_id: deviceId,\n  device_info_json: deviceInfoJson\n};"},"id":"a74e43ed-2081-4f7f-9676-1e6158e5c779","name":"Parse Body","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1056,160]},{"parameters":{"conditions":{"string":[{"value1":"={{ $json.session_token }}","operation":"isNotEmpty"},{"value1":"={{ $json.fcm_token }}","operation":"isNotEmpty"}]},"options":{}},"id":"43b54681-eda4-439a-84c1-c395c253e0b7","name":"Validate Input","type":"n8n-nodes-base.if","typeVersion":2,"position":[-864,160]},{"parameters":{"operation":"executeQuery","query":"SELECT id, operator_id, tenant_id, device_type\n  FROM elo_t_operator_devices\n  WHERE session_token = '{{ $json.session_token }}'\n    AND device_type = 'mobile'\n  LIMIT 1;","options":{}},"id":"93e2f2fe-1039-4ec7-ad2e-1808a78df3fa","name":"Find Device by Session","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-656,48],"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"device-found","leftValue":"={{ $json.id }}","rightValue":"","operator":{"type":"string","operation":"exists"}}],"combinator":"and"},"options":{}},"id":"4f1849af-e9c2-4cb7-a762-abfe3b7a4847","name":"Check Device Exists","type":"n8n-nodes-base.if","typeVersion":2,"position":[-448,48]},{"parameters":{"jsCode":"const deviceData = $('Find Device by Session').first().json;\nconst parsedData = $('Parse Body').first().json;\n\nreturn {\n  device_id_db: deviceData.id,\n  operator_id: deviceData.operator_id,\n  tenant_id: deviceData.tenant_id,\n  session_token: parsedData.session_token,\n  fcm_token: parsedData.fcm_token,\n  device_id: parsedData.device_id,\n  device_info_json: parsedData.device_info_json\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-240,-64],"id":"98927e46-2e85-4b65-9455-94301c927e57","name":"Prepare Update Data"},{"parameters":{"operation":"executeQuery","query":"UPDATE elo_t_operator_devices\n  SET\n    fcm_token = '{{ $json.fcm_token }}',\n    device_id = {{ $json.device_id && $json.device_id !== 'null' ? \"'\" + $json.device_id + \"'\" : \"device_id\" }},\n    device_info = {{ $json.device_info_json ? \"'\" + $json.device_info_json + \"'::jsonb\" : \"device_info\" }},\n    last_active_at = NOW()\n  WHERE session_token = '{{ $json.session_token }}'\n    AND device_type = 'mobile'\n  RETURNING id, operator_id;","options":{}},"id":"8ab2a60c-2017-4544-93cc-6a3d0bc70aec","name":"Update FCM Token","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-32,-64],"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"respondWith":"json","responseBody":"={{ { success: true, message: 'FCM token registered', operator_id: $json.operator_id } }}","options":{"responseCode":200}},"id":"099d0d12-1aa9-4802-8407-89d666638388","name":"Response - Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[176,-64]},{"parameters":{"respondWith":"json","responseBody":"={{ { success: false, error: 'invalid_session_token' } }}","options":{"responseCode":401}},"id":"03dcf48d-07e3-411a-bf1d-19a78c5b268a","name":"Response - Invalid Session","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-240,160]},{"parameters":{"respondWith":"json","responseBody":"={{ { success: false, error: 'missing_required_fields' } }}","options":{"responseCode":400}},"id":"d1ac8008-f5bb-4689-bb38-c48d60ad32bc","name":"Response - Missing Fields","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-592,304]}],"connections":{"Webhook":{"main":[[{"node":"Parse Body","type":"main","index":0}]]},"Parse Body":{"main":[[{"node":"Validate Input","type":"main","index":0}]]},"Validate Input":{"main":[[{"node":"Find Device by Session","type":"main","index":0}],[{"node":"Response - Missing Fields","type":"main","index":0}]]},"Find Device by Session":{"main":[[{"node":"Check Device Exists","type":"main","index":0}]]},"Check Device Exists":{"main":[[{"node":"Prepare Update Data","type":"main","index":0}],[{"node":"Response - Invalid Session","type":"main","index":0}]]},"Prepare Update Data":{"main":[[{"node":"Update FCM Token","type":"main","index":0}]]},"Update FCM Token":{"main":[[{"node":"Response - Success","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"5df9a147-5263-47ae-aff9-7c6a5f901dff","activeVersionId":"5df9a147-5263-47ae-aff9-7c6a5f901dff","triggerCount":1,"shared":[{"updatedAt":"2025-12-17T18:19:32.151Z","createdAt":"2025-12-17T18:19:32.151Z","role":"workflow:owner","workflowId":"yW11VXCx1UCfJqXd","projectId":"x7frUSUEowDAk8Dt"}],"activeVersion":{"updatedAt":"2025-12-20T18:01:29.582Z","createdAt":"2025-12-20T18:01:29.582Z","versionId":"5df9a147-5263-47ae-aff9-7c6a5f901dff","workflowId":"yW11VXCx1UCfJqXd","nodes":[{"parameters":{"httpMethod":"POST","path":"android-register-fcm","responseMode":"responseNode","options":{}},"id":"56260b5f-d1e2-453f-a415-e5856fc892c1","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1264,160],"webhookId":"android-register-fcm"},{"parameters":{"jsCode":"const body = $input.item.json.body || {};\nconst deviceInfo = body.device_info || null;\nconst deviceId = deviceInfo?.device_id || null;\nconst deviceInfoJson = deviceInfo ? JSON.stringify(deviceInfo) : null;\n\nreturn {\n  operator_id: body.operator_id?.trim() || '',\n  session_token: body.session_token?.trim() || '',\n  fcm_token: body.fcm_token?.trim() || '',\n  device_info: deviceInfo,\n  device_id: deviceId,\n  device_info_json: deviceInfoJson\n};"},"id":"a74e43ed-2081-4f7f-9676-1e6158e5c779","name":"Parse Body","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1056,160]},{"parameters":{"conditions":{"string":[{"value1":"={{ $json.session_token }}","operation":"isNotEmpty"},{"value1":"={{ $json.fcm_token }}","operation":"isNotEmpty"}]},"options":{}},"id":"43b54681-eda4-439a-84c1-c395c253e0b7","name":"Validate Input","type":"n8n-nodes-base.if","typeVersion":2,"position":[-864,160]},{"parameters":{"operation":"executeQuery","query":"SELECT id, operator_id, tenant_id, device_type\n  FROM elo_t_operator_devices\n  WHERE session_token = '{{ $json.session_token }}'\n    AND device_type = 'mobile'\n  LIMIT 1;","options":{}},"id":"93e2f2fe-1039-4ec7-ad2e-1808a78df3fa","name":"Find Device by Session","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-656,48],"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"device-found","leftValue":"={{ $json.id }}","rightValue":"","operator":{"type":"string","operation":"exists"}}],"combinator":"and"},"options":{}},"id":"4f1849af-e9c2-4cb7-a762-abfe3b7a4847","name":"Check Device Exists","type":"n8n-nodes-base.if","typeVersion":2,"position":[-448,48]},{"parameters":{"jsCode":"const deviceData = $('Find Device by Session').first().json;\nconst parsedData = $('Parse Body').first().json;\n\nreturn {\n  device_id_db: deviceData.id,\n  operator_id: deviceData.operator_id,\n  tenant_id: deviceData.tenant_id,\n  session_token: parsedData.session_token,\n  fcm_token: parsedData.fcm_token,\n  device_id: parsedData.device_id,\n  device_info_json: parsedData.device_info_json\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-240,-64],"id":"98927e46-2e85-4b65-9455-94301c927e57","name":"Prepare Update Data"},{"parameters":{"operation":"executeQuery","query":"UPDATE elo_t_operator_devices\n  SET\n    fcm_token = '{{ $json.fcm_token }}',\n    device_id = {{ $json.device_id && $json.device_id !== 'null' ? \"'\" + $json.device_id + \"'\" : \"device_id\" }},\n    device_info = {{ $json.device_info_json ? \"'\" + $json.device_info_json + \"'::jsonb\" : \"device_info\" }},\n    last_active_at = NOW()\n  WHERE session_token = '{{ $json.session_token }}'\n    AND device_type = 'mobile'\n  RETURNING id, operator_id;","options":{}},"id":"8ab2a60c-2017-4544-93cc-6a3d0bc70aec","name":"Update FCM Token","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-32,-64],"credentials":{"postgres":{"id":"n2SyhP9QhMnp1ryk","name":"Postgres account"}}},{"parameters":{"respondWith":"json","responseBody":"={{ { success: true, message: 'FCM token registered', operator_id: $json.operator_id } }}","options":{"responseCode":200}},"id":"099d0d12-1aa9-4802-8407-89d666638388","name":"Response - Success","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[176,-64]},{"parameters":{"respondWith":"json","responseBody":"={{ { success: false, error: 'invalid_session_token' } }}","options":{"responseCode":401}},"id":"03dcf48d-07e3-411a-bf1d-19a78c5b268a","name":"Response - Invalid Session","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-240,160]},{"parameters":{"respondWith":"json","responseBody":"={{ { success: false, error: 'missing_required_fields' } }}","options":{"responseCode":400}},"id":"d1ac8008-f5bb-4689-bb38-c48d60ad32bc","name":"Response - Missing Fields","type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-592,304]}],"connections":{"Webhook":{"main":[[{"node":"Parse Body","type":"main","index":0}]]},"Parse Body":{"main":[[{"node":"Validate Input","type":"main","index":0}]]},"Validate Input":{"main":[[{"node":"Find Device by Session","type":"main","index":0}],[{"node":"Response - Missing Fields","type":"main","index":0}]]},"Find Device by Session":{"main":[[{"node":"Check Device Exists","type":"main","index":0}]]},"Check Device Exists":{"main":[[{"node":"Prepare Update Data","type":"main","index":0}],[{"node":"Response - Invalid Session","type":"main","index":0}]]},"Prepare Update Data":{"main":[[{"node":"Update FCM Token","type":"main","index":0}]]},"Update FCM Token":{"main":[[{"node":"Response - Success","type":"main","index":0}]]}},"authors":"Dmitriy Remacs","name":null,"description":null},"tags":[{"updatedAt":"2025-11-23T03:58:34.844Z","createdAt":"2025-11-23T03:58:34.844Z","id":"0yzk30hhaSzkl8bF","name":"API"},{"updatedAt":"2025-12-09T18:50:08.518Z","createdAt":"2025-12-09T18:50:08.518Z","id":"tMSCjbvPU3xrNUqz","name":"ELO"}]}],"nextCursor":null}