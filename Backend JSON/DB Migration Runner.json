{
  "name": "DB Migration Runner",
  "nodes": [
    {
      "parameters": {},
      "id": "f5c6d7e8-9a0b-1c2d-3e4f-567890abcdef",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- ============================================================================\n-- –ú–ò–ì–†–ê–¶–ò–Ø: Multi-Device & Conversation Focus Architecture\n-- –î–∞—Ç–∞: 2025-11-22\n-- –û–ø–∏—Å–∞–Ω–∏–µ: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –≤ –æ–¥–Ω–æ–π –∑–∞—è–≤–∫–µ\n--           + —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–æ–∫—É—Å–æ–º –¥–∏–∞–ª–æ–≥–∞\n-- ============================================================================\n\n-- ============================================================================\n-- 1. –ù–û–í–ê–Ø –¢–ê–ë–õ–ò–¶–ê: appeal_devices (–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤ –∑–∞—è–≤–∫–µ)\n-- ============================================================================\n\nCREATE TABLE IF NOT EXISTS appeal_devices (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  appeal_id UUID NOT NULL REFERENCES appeals(id) ON DELETE CASCADE,\n  tenant_id UUID NOT NULL REFERENCES tenants(id),\n\n  -- –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ\n  brand_id UUID REFERENCES brands(id),\n  model_id UUID REFERENCES models(id),\n  device_type_id UUID REFERENCES device_types(id),\n\n  -- –¢–µ–∫—Å—Ç–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ (–¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è)\n  phone_model VARCHAR(255), -- \"iPhone 14 Pro\", \"Samsung Galaxy S21\"\n\n  -- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã\n  serial_number VARCHAR(255),\n  imei VARCHAR(255),\n\n  -- –°—Ç–∞—Ç—É—Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤ –∑–∞—è–≤–∫–µ\n  status VARCHAR(50) DEFAULT 'active',\n  -- –í–∞—Ä–∏–∞–Ω—Ç—ã: 'active', 'cancelled', 'completed'\n\n  -- –°—Ç–∞—Ç—É—Å –æ–±—Å—É–∂–¥–µ–Ω–∏—è (–¥–ª—è —Ñ–æ–∫—É—Å–∞ –¥–∏–∞–ª–æ–≥–∞)\n  discussion_status VARCHAR(50) DEFAULT 'pending',\n  -- –í–∞—Ä–∏–∞–Ω—Ç—ã: 'pending', 'discussing', 'discussed', 'cancelled'\n\n  -- –ü–æ—Ä—è–¥–æ–∫ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–º (–¥–ª—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±—Å—É–∂–¥–µ–Ω–∏—è)\n  device_order INT DEFAULT 1,\n\n  -- –ó–∞–º–µ—Ç–∫–∏\n  notes TEXT,\n\n  -- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ\n  created_at TIMESTAMPTZ DEFAULT NOW(),\n  updated_at TIMESTAMPTZ DEFAULT NOW()\n);\n\n-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏\nCREATE INDEX IF NOT EXISTS idx_appeal_devices_appeal ON appeal_devices(appeal_id);\nCREATE INDEX IF NOT EXISTS idx_appeal_devices_tenant ON appeal_devices(tenant_id);\nCREATE INDEX IF NOT EXISTS idx_appeal_devices_status ON appeal_devices(status);\nCREATE INDEX IF NOT EXISTS idx_appeal_devices_discussion ON appeal_devices(discussion_status);\n\n-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏\nCOMMENT ON TABLE appeal_devices IS '–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–π –∑–∞—è–≤–∫–∏ (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤)';\nCOMMENT ON COLUMN appeal_devices.discussion_status IS '–°—Ç–∞—Ç—É—Å –æ–±—Å—É–∂–¥–µ–Ω–∏—è: pending (–Ω–µ –æ–±—Å—É–∂–¥–∞–ª–æ—Å—å), discussing (–æ–±—Å—É–∂–¥–∞–µ—Ç—Å—è —Å–µ–π—á–∞—Å), discussed (–∑–∞–≤–µ—Ä—à–µ–Ω–æ), cancelled (–æ—Ç–º–µ–Ω–µ–Ω–æ)';\nCOMMENT ON COLUMN appeal_devices.device_order IS '–ü–æ—Ä—è–¥–æ–∫ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–º (1, 2, 3...) –¥–ª—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±—Å—É–∂–¥–µ–Ω–∏—è';",
        "additionalFields": {}
      },
      "id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
      "name": "Step 1: Create appeal_devices",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [450, 200],
      "credentials": {
        "postgres": {
          "id": "supabase_postgres",
          "name": "Supabase PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- ============================================================================\n-- 2. –ù–û–í–ê–Ø –¢–ê–ë–õ–ò–¶–ê: repair_categories (–¢–∏–ø—ã/–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–µ–º–æ–Ω—Ç–∞)\n-- ============================================================================\n\nCREATE TABLE IF NOT EXISTS repair_categories (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  tenant_id UUID REFERENCES tenants(id),\n\n  -- –ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏\n  name VARCHAR(100) NOT NULL, -- \"–î–∏—Å–ø–ª–µ–π\", \"–ê–ö–ë\", \"–ö–æ—Ä–ø—É—Å\", \"–ó–≤—É–∫\", \"–°–≤—è–∑—å\"\n  code VARCHAR(50) UNIQUE, -- \"display\", \"battery\", \"body\", \"sound\", \"connection\"\n  description TEXT,\n\n  -- –ò–∫–æ–Ω–∫–∞ –¥–ª—è UI\n  icon VARCHAR(50), -- \"üì±\", \"üîã\", \"üì¶\", \"üîä\", \"üì°\"\n\n  -- –ü–æ—Ä—è–¥–æ–∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è\n  display_order INT DEFAULT 0,\n\n  -- –°—Ç–∞—Ç—É—Å\n  is_active BOOLEAN DEFAULT true,\n\n  -- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ\n  created_at TIMESTAMPTZ DEFAULT NOW(),\n  updated_at TIMESTAMPTZ DEFAULT NOW()\n);\n\n-- –ò–Ω–¥–µ–∫—Å—ã\nCREATE INDEX IF NOT EXISTS idx_repair_categories_tenant ON repair_categories(tenant_id);\nCREATE INDEX IF NOT EXISTS idx_repair_categories_active ON repair_categories(is_active);\n\n-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏\nCOMMENT ON TABLE repair_categories IS '–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–µ–º–æ–Ω—Ç–∞: –î–∏—Å–ø–ª–µ–π, –ê–ö–ë, –ö–æ—Ä–ø—É—Å, –ó–≤—É–∫, –°–≤—è–∑—å –∏ —Ç.–¥.';\nCOMMENT ON COLUMN repair_categories.code IS '–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥ –¥–ª—è –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è';",
        "additionalFields": {}
      },
      "id": "b2c3d4e5-f6a7-8901-bcde-f12345678901",
      "name": "Step 2: Create repair_categories",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [650, 200],
      "credentials": {
        "postgres": {
          "id": "supabase_postgres",
          "name": "Supabase PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- ============================================================================\n-- 3. –ù–û–í–ê–Ø –¢–ê–ë–õ–ò–¶–ê: issue_types (–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã/–Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç–∏)\n-- ============================================================================\n\nCREATE TABLE IF NOT EXISTS issue_types (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  tenant_id UUID REFERENCES tenants(id),\n  repair_category_id UUID NOT NULL REFERENCES repair_categories(id) ON DELETE CASCADE,\n\n  -- –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã\n  name VARCHAR(100) NOT NULL, -- \"–†–∞–∑–±–∏—Ç\", \"–ü–æ–ª–æ—Å—ã\", \"–ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–∞—á—Å–∫—Ä–∏–Ω\"\n  code VARCHAR(50), -- \"cracked\", \"lines\", \"touchscreen_broken\"\n  description TEXT,\n\n  -- –°—Ç–æ–∏–º–æ—Å—Ç—å –∏ –≤—Ä–µ–º—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é\n  default_cost DECIMAL(10,2),\n  default_time VARCHAR(50), -- \"30 –º–∏–Ω—É—Ç\", \"1 —á–∞—Å\"\n\n  -- –ü–æ—Ä—è–¥–æ–∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è\n  display_order INT DEFAULT 0,\n\n  -- –°—Ç–∞—Ç—É—Å\n  is_active BOOLEAN DEFAULT true,\n\n  -- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ\n  created_at TIMESTAMPTZ DEFAULT NOW(),\n  updated_at TIMESTAMPTZ DEFAULT NOW()\n);\n\n-- –ò–Ω–¥–µ–∫—Å—ã\nCREATE INDEX IF NOT EXISTS idx_issue_types_tenant ON issue_types(tenant_id);\nCREATE INDEX IF NOT EXISTS idx_issue_types_category ON issue_types(repair_category_id);\nCREATE INDEX IF NOT EXISTS idx_issue_types_active ON issue_types(is_active);\n\n-- –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å (–¥–ª—è –æ–¥–Ω–æ–≥–æ tenant + category –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –∫–æ–¥–∞)\nCREATE UNIQUE INDEX IF NOT EXISTS idx_issue_types_unique\nON issue_types(tenant_id, repair_category_id, code)\nWHERE code IS NOT NULL;\n\n-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏\nCOMMENT ON TABLE issue_types IS '–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –¥–ª—è –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–µ–º–æ–Ω—Ç–∞';\nCOMMENT ON COLUMN issue_types.repair_category_id IS '–ü—Ä–∏–≤—è–∑–∫–∞ –∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–Ω–∞–ø—Ä. \"–†–∞–∑–±–∏—Ç\" ‚Üí \"–î–∏—Å–ø–ª–µ–π\")';",
        "additionalFields": {}
      },
      "id": "c3d4e5f6-a7b8-9012-cdef-123456789012",
      "name": "Step 3: Create issue_types",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [850, 200],
      "credentials": {
        "postgres": {
          "id": "supabase_postgres",
          "name": "Supabase PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- ============================================================================\n-- 4. –ù–û–í–ê–Ø –¢–ê–ë–õ–ò–¶–ê: appeal_repairs (–†–µ–º–æ–Ω—Ç—ã/–ø—Ä–æ–±–ª–µ–º—ã –≤ –∑–∞—è–≤–∫–µ)\n-- ============================================================================\n\nCREATE TABLE IF NOT EXISTS appeal_repairs (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  appeal_id UUID NOT NULL REFERENCES appeals(id) ON DELETE CASCADE,\n  appeal_device_id UUID NOT NULL REFERENCES appeal_devices(id) ON DELETE CASCADE,\n  tenant_id UUID NOT NULL REFERENCES tenants(id),\n\n  -- –ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ä–µ–º–æ–Ω—Ç–∞ (—É—Ä–æ–≤–µ–Ω—å 1)\n  repair_category_id UUID REFERENCES repair_categories(id),\n  repair_category_name VARCHAR(100), -- \"–î–∏—Å–ø–ª–µ–π\", \"–ê–ö–ë\", \"–ö–æ—Ä–ø—É—Å\"\n\n  -- –ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ (—É—Ä–æ–≤–µ–Ω—å 2)\n  issue_type_id UUID REFERENCES issue_types(id),\n  issue_type_name VARCHAR(100), -- \"–†–∞–∑–±–∏—Ç\", \"–í–∑–¥—É—Ç–∞—è\", \"–ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç\"\n\n  -- –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ —Å—Ç–∞—Ä–æ–π —Å—Ö–µ–º–æ–π (DEPRECATED)\n  repair_type_id UUID REFERENCES repair_types(id),\n  repair_type_name VARCHAR(255),\n\n  -- –î–µ—Ç–∞–ª–∏ —Ä–µ–º–æ–Ω—Ç–∞\n  parts_owner VARCHAR(50) DEFAULT '–Ω–∞—à–∞',\n  -- –í–∞—Ä–∏–∞–Ω—Ç—ã: '–Ω–∞—à–∞', '–∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è', '–Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è'\n\n  estimated_cost DECIMAL(10,2),\n  estimated_time VARCHAR(50), -- '30 –º–∏–Ω—É—Ç', '2 —á–∞—Å–∞', '1 –¥–µ–Ω—å'\n\n  -- –°—Ç–∞—Ç—É—Å —Ä–µ–º–æ–Ω—Ç–∞\n  status VARCHAR(50) DEFAULT 'pending',\n  -- –í–∞—Ä–∏–∞–Ω—Ç—ã: 'pending', 'confirmed', 'rejected', 'in_progress', 'completed'\n\n  -- –°—Ç–∞—Ç—É—Å –æ–±—Å—É–∂–¥–µ–Ω–∏—è (–¥–ª—è —Ñ–æ–∫—É—Å–∞ –¥–∏–∞–ª–æ–≥–∞)\n  discussion_status VARCHAR(50) DEFAULT 'pending',\n  -- –í–∞—Ä–∏–∞–Ω—Ç—ã: 'pending', 'discussing', 'confirmed', 'rejected'\n\n  -- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–¥–ª—è –æ—á–µ—Ä–µ–¥–Ω–æ—Å—Ç–∏ –æ–±—Å—É–∂–¥–µ–Ω–∏—è)\n  priority INT DEFAULT 1, -- 1 = –≤—ã—Å–æ–∫–∏–π, 2 = —Å—Ä–µ–¥–Ω–∏–π, 3 = –Ω–∏–∑–∫–∏–π\n\n  -- –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞\n  problem_description TEXT,\n\n  -- –ó–∞–º–µ—Ç–∫–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞\n  notes TEXT,\n\n  -- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ\n  created_at TIMESTAMPTZ DEFAULT NOW(),\n  updated_at TIMESTAMPTZ DEFAULT NOW()\n);\n\n-- –ò–Ω–¥–µ–∫—Å—ã\nCREATE INDEX IF NOT EXISTS idx_appeal_repairs_appeal ON appeal_repairs(appeal_id);\nCREATE INDEX IF NOT EXISTS idx_appeal_repairs_device ON appeal_repairs(appeal_device_id);\nCREATE INDEX IF NOT EXISTS idx_appeal_repairs_tenant ON appeal_repairs(tenant_id);\nCREATE INDEX IF NOT EXISTS idx_appeal_repairs_category ON appeal_repairs(repair_category_id);\nCREATE INDEX IF NOT EXISTS idx_appeal_repairs_issue ON appeal_repairs(issue_type_id);\nCREATE INDEX IF NOT EXISTS idx_appeal_repairs_status ON appeal_repairs(status);\nCREATE INDEX IF NOT EXISTS idx_appeal_repairs_discussion ON appeal_repairs(discussion_status);\nCREATE INDEX IF NOT EXISTS idx_appeal_repairs_priority ON appeal_repairs(priority);\n\n-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏\nCOMMENT ON TABLE appeal_repairs IS '–†–µ–º–æ–Ω—Ç—ã/–ø—Ä–æ–±–ª–µ–º—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤ –∑–∞—è–≤–∫–µ';\nCOMMENT ON COLUMN appeal_repairs.discussion_status IS '–°—Ç–∞—Ç—É—Å –æ–±—Å—É–∂–¥–µ–Ω–∏—è: pending, discussing, confirmed, rejected';\nCOMMENT ON COLUMN appeal_repairs.priority IS '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –æ–±—Å—É–∂–¥–µ–Ω–∏—è (1-–≤—ã—Å–æ–∫–∏–π, 2-—Å—Ä–µ–¥–Ω–∏–π, 3-–Ω–∏–∑–∫–∏–π)';\nCOMMENT ON COLUMN appeal_repairs.parts_owner IS '–ß—å—è –∑–∞–ø—á–∞—Å—Ç—å: –Ω–∞—à–∞, –∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è, –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è';",
        "additionalFields": {}
      },
      "id": "d4e5f6a7-b8c9-0123-def1-234567890123",
      "name": "Step 4: Create appeal_repairs",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [1050, 200],
      "credentials": {
        "postgres": {
          "id": "supabase_postgres",
          "name": "Supabase PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- ============================================================================\n-- 3. –û–ë–ù–û–í–õ–ï–ù–ò–ï –¢–ê–ë–õ–ò–¶–´: appeals (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π)\n-- ============================================================================\n\n-- –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞\nALTER TABLE appeals\nADD COLUMN IF NOT EXISTS conversation_context JSONB DEFAULT '{}';\n\nCOMMENT ON COLUMN appeals.conversation_context IS '–ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞: —É–ø–æ–º—è–Ω—É—Ç—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, –∏—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π, clarifications';\n\n-- –°—Ç–∞—Ç—É—Å –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞\nALTER TABLE appeals\nADD COLUMN IF NOT EXISTS context_completion_status JSONB DEFAULT '{}';\n\nCOMMENT ON COLUMN appeals.context_completion_status IS '–°—Ç–∞—Ç—É—Å –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è: fields_collected, required_fields_count, completion_percentage';\n\n-- –§–æ–∫—É—Å –¥–∏–∞–ª–æ–≥–∞\nALTER TABLE appeals\nADD COLUMN IF NOT EXISTS conversation_focus JSONB DEFAULT '{}';\n\nCOMMENT ON COLUMN appeals.conversation_focus IS '–¢–µ–∫—É—â–∏–π —Ñ–æ–∫—É—Å: current_device_id, current_repair_id, focus_history, last_updated_by, auto_switch';\n\n-- –ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ \"–ø—Ä–æ—à–ª–æ > 24 —á–∞—Å–∞\")\nALTER TABLE appeals\nADD COLUMN IF NOT EXISTS last_greeting_at TIMESTAMPTZ;\n\nCOMMENT ON COLUMN appeals.last_greeting_at IS '–í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω—É–∂–Ω–æ –ª–∏ –∑–¥–æ—Ä–æ–≤–∞—Ç—å—Å—è —Å–Ω–æ–≤–∞)';",
        "additionalFields": {}
      },
      "id": "e5f6a7b8-c9d0-1234-ef12-345678901234",
      "name": "Step 5: Update appeals table",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [450, 400],
      "credentials": {
        "postgres": {
          "id": "supabase_postgres",
          "name": "Supabase PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- ============================================================================\n-- 4. –ù–û–í–ê–Ø –¢–ê–ë–õ–ò–¶–ê: context_fields_config (–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ–ª–µ–π –¥–ª—è —Å–±–æ—Ä–∞)\n-- ============================================================================\n\nCREATE TABLE IF NOT EXISTS context_fields_config (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  tenant_id UUID NOT NULL REFERENCES tenants(id),\n  deal_type_id UUID REFERENCES deal_types(id), -- NULL = –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤\n\n  -- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ–ª—è\n  field_name VARCHAR(100) NOT NULL, -- 'type', 'model_id', 'repair_type_id', 'parts_owner'\n  field_label VARCHAR(255) NOT NULL, -- '–¢–∏–ø –æ–±—Ä–∞—â–µ–Ω–∏—è', '–ú–æ–¥–µ–ª—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞'\n  field_type VARCHAR(50) DEFAULT 'text', -- 'text', 'select', 'number', 'boolean'\n\n  -- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–±–æ—Ä–∞\n  is_required BOOLEAN DEFAULT false, -- –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ?\n  collection_order INT, -- –ü–æ—Ä—è–¥–æ–∫ —Å–±–æ—Ä–∞ (1, 2, 3...)\n\n  -- AI Tool –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è\n  tool_name VARCHAR(100), -- 'Tool-Type', 'Tool-Model', 'Tool-Repair', 'Tool-Parts'\n\n  -- –ü—Ä–æ–º–ø—Ç –¥–ª—è AI (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)\n  prompt_template TEXT, -- –®–∞–±–ª–æ–Ω –≤–æ–ø—Ä–æ—Å–∞ –∫–ª–∏–µ–Ω—Ç—É\n\n  -- –ü—Ä–∞–≤–∏–ª–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)\n  validation_rules JSONB, -- { \"min_length\": 3, \"max_length\": 100, \"pattern\": \"...\" }\n\n  -- –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é\n  default_value VARCHAR(255),\n\n  -- –°—Ç–∞—Ç—É—Å\n  is_active BOOLEAN DEFAULT true,\n\n  -- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ\n  created_at TIMESTAMPTZ DEFAULT NOW(),\n  updated_at TIMESTAMPTZ DEFAULT NOW()\n);\n\n-- –ò–Ω–¥–µ–∫—Å—ã\nCREATE INDEX IF NOT EXISTS idx_context_fields_tenant ON context_fields_config(tenant_id);\nCREATE INDEX IF NOT EXISTS idx_context_fields_deal_type ON context_fields_config(deal_type_id);\nCREATE INDEX IF NOT EXISTS idx_context_fields_active ON context_fields_config(is_active);\n\n-- –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å (–æ–¥–∏–Ω field_name –¥–ª—è –æ–¥–Ω–æ–≥–æ tenant + deal_type)\nCREATE UNIQUE INDEX IF NOT EXISTS idx_context_fields_unique\nON context_fields_config(tenant_id, field_name, COALESCE(deal_type_id, '00000000-0000-0000-0000-000000000000'::uuid));\n\n-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏\nCOMMENT ON TABLE context_fields_config IS '–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ–ª–µ–π –¥–ª—è —Å–±–æ—Ä–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–≥–∏–±–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å–¥–µ–ª–æ–∫)';\nCOMMENT ON COLUMN context_fields_config.is_required IS '–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ \"–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞—è–≤–∫–∏\"';\nCOMMENT ON COLUMN context_fields_config.collection_order IS '–ü–æ—Ä—è–¥–æ–∫ —Å–±–æ—Ä–∞ (1 - –ø–µ—Ä–≤—ã–º, 2 - –≤—Ç–æ—Ä—ã–º, ...)';",
        "additionalFields": {}
      },
      "id": "f6a7b8c9-d0e1-2345-f123-456789012345",
      "name": "Step 6: Create context_fields_config",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [650, 400],
      "credentials": {
        "postgres": {
          "id": "supabase_postgres",
          "name": "Supabase PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- ============================================================================\n-- 5. –¢–ï–°–¢–û–í–´–ï –î–ê–ù–ù–´–ï: repair_categories –∏ issue_types\n-- ============================================================================\n\nDO $$\nDECLARE\n  default_tenant_id UUID;\n  category_display_id UUID;\n  category_battery_id UUID;\n  category_body_id UUID;\n  category_sound_id UUID;\n  category_connection_id UUID;\n  category_camera_id UUID;\n  category_ports_id UUID;\nBEGIN\n  -- –ò—â–µ–º –ø–µ—Ä–≤—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–µ–Ω–∞–Ω—Ç\n  SELECT id INTO default_tenant_id\n  FROM tenants\n  WHERE is_active = true\n  LIMIT 1;\n\n  IF default_tenant_id IS NOT NULL THEN\n\n    -- ========================================\n    -- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–µ–º–æ–Ω—Ç–∞\n    -- ========================================\n\n    INSERT INTO repair_categories (tenant_id, name, code, icon, display_order)\n    VALUES\n      (default_tenant_id, '–î–∏—Å–ø–ª–µ–π', 'display', 'üì±', 1),\n      (default_tenant_id, '–ê–ö–ë', 'battery', 'üîã', 2),\n      (default_tenant_id, '–ö–æ—Ä–ø—É—Å', 'body', 'üì¶', 3),\n      (default_tenant_id, '–ó–≤—É–∫', 'sound', 'üîä', 4),\n      (default_tenant_id, '–°–≤—è–∑—å', 'connection', 'üì°', 5),\n      (default_tenant_id, '–ö–∞–º–µ—Ä–∞', 'camera', 'üì∑', 6),\n      (default_tenant_id, '–†–∞–∑—ä–µ–º—ã', 'ports', 'üîå', 7)\n    ON CONFLICT DO NOTHING;\n\n    -- –ü–æ–ª—É—á–∞–µ–º ID –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º\n    SELECT id INTO category_display_id FROM repair_categories WHERE code = 'display' LIMIT 1;\n    SELECT id INTO category_battery_id FROM repair_categories WHERE code = 'battery' LIMIT 1;\n    SELECT id INTO category_body_id FROM repair_categories WHERE code = 'body' LIMIT 1;\n    SELECT id INTO category_sound_id FROM repair_categories WHERE code = 'sound' LIMIT 1;\n    SELECT id INTO category_connection_id FROM repair_categories WHERE code = 'connection' LIMIT 1;\n    SELECT id INTO category_camera_id FROM repair_categories WHERE code = 'camera' LIMIT 1;\n    SELECT id INTO category_ports_id FROM repair_categories WHERE code = 'ports' LIMIT 1;\n\n    -- –ü—Ä–æ–±–ª–µ–º—ã –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ \"–î–∏—Å–ø–ª–µ–π\"\n    IF category_display_id IS NOT NULL THEN\n      INSERT INTO issue_types (tenant_id, repair_category_id, name, code, default_cost, default_time, display_order)\n      VALUES\n        (default_tenant_id, category_display_id, '–†–∞–∑–±–∏—Ç', 'cracked', 8500, '40 –º–∏–Ω—É—Ç', 1),\n        (default_tenant_id, category_display_id, '–ü–æ–ª–æ—Å—ã', 'lines', 8500, '40 –º–∏–Ω—É—Ç', 2),\n        (default_tenant_id, category_display_id, '–ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–∞—á—Å–∫—Ä–∏–Ω', 'touchscreen_broken', 8500, '40 –º–∏–Ω—É—Ç', 3),\n        (default_tenant_id, category_display_id, '–ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–∞—Ä—Ç–∏–Ω–∫—É', 'no_display', 8500, '40 –º–∏–Ω—É—Ç', 4),\n        (default_tenant_id, category_display_id, '–ü—è—Ç–Ω–∞ –Ω–∞ —ç–∫—Ä–∞–Ω–µ', 'spots', 8500, '40 –º–∏–Ω—É—Ç', 5)\n      ON CONFLICT DO NOTHING;\n    END IF;\n\n    -- –ü—Ä–æ–±–ª–µ–º—ã –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ \"–ê–ö–ë\"\n    IF category_battery_id IS NOT NULL THEN\n      INSERT INTO issue_types (tenant_id, repair_category_id, name, code, default_cost, default_time, display_order)\n      VALUES\n        (default_tenant_id, category_battery_id, '–í–∑–¥—É—Ç–∞—è', 'swollen', 3500, '30 –º–∏–Ω—É—Ç', 1),\n        (default_tenant_id, category_battery_id, '–ò–∑–Ω–æ—Å', 'wear', 3500, '30 –º–∏–Ω—É—Ç', 2),\n        (default_tenant_id, category_battery_id, '–ù–µ –¥–µ—Ä–∂–∏—Ç –∑–∞—Ä—è–¥', 'not_holding', 3500, '30 –º–∏–Ω—É—Ç', 3),\n        (default_tenant_id, category_battery_id, '–ë—ã—Å—Ç—Ä–æ —Ä–∞–∑—Ä—è–∂–∞–µ—Ç—Å—è', 'fast_drain', 3500, '30 –º–∏–Ω—É—Ç', 4),\n        (default_tenant_id, category_battery_id, '–ù–µ –∑–∞—Ä—è–∂–∞–µ—Ç—Å—è', 'not_charging', 3500, '30 –º–∏–Ω—É—Ç', 5)\n      ON CONFLICT DO NOTHING;\n    END IF;\n\n    -- –ü—Ä–æ–±–ª–µ–º—ã –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ \"–ö–æ—Ä–ø—É—Å\"\n    IF category_body_id IS NOT NULL THEN\n      INSERT INTO issue_types (tenant_id, repair_category_id, name, code, default_cost, default_time, display_order)\n      VALUES\n        (default_tenant_id, category_body_id, '–ó–∞–¥–Ω—è—è –∫—Ä—ã—à–∫–∞ —Å–ª–æ–º–∞–Ω–∞', 'back_cover_broken', 2500, '20 –º–∏–Ω—É—Ç', 1),\n        (default_tenant_id, category_body_id, '–ü–æ–≥–Ω—É—Ç', 'bent', 4500, '1 —á–∞—Å', 2),\n        (default_tenant_id, category_body_id, '–ö–Ω–æ–ø–∫–∏', 'buttons', 1500, '15 –º–∏–Ω—É—Ç', 3),\n        (default_tenant_id, category_body_id, '–†–∞–º–∫–∞ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∞', 'frame_damaged', 3000, '30 –º–∏–Ω—É—Ç', 4)\n      ON CONFLICT DO NOTHING;\n    END IF;\n\n    -- –ü—Ä–æ–±–ª–µ–º—ã –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ \"–ó–≤—É–∫\"\n    IF category_sound_id IS NOT NULL THEN\n      INSERT INTO issue_types (tenant_id, repair_category_id, name, code, default_cost, default_time, display_order)\n      VALUES\n        (default_tenant_id, category_sound_id, '–ù–µ—Ç –ø–æ–ª–∏—Ñ–æ–Ω–∏–∏', 'no_polyphony', 2000, '30 –º–∏–Ω—É—Ç', 1),\n        (default_tenant_id, category_sound_id, '–ù–µ —Å–ª—ã—à–∏—Ç –∞–±–æ–Ω–µ–Ω—Ç–∞', 'cant_hear', 2000, '30 –º–∏–Ω—É—Ç', 2),\n        (default_tenant_id, category_sound_id, '–ê–±–æ–Ω–µ–Ω—Ç –Ω–µ —Å–ª—ã—à–∏—Ç', 'not_heard', 2000, '30 –º–∏–Ω—É—Ç', 3),\n        (default_tenant_id, category_sound_id, '–•—Ä–∏–ø–∏—Ç –¥–∏–Ω–∞–º–∏–∫', 'speaker_distortion', 2000, '30 –º–∏–Ω—É—Ç', 4),\n        (default_tenant_id, category_sound_id, '–¢–∏—Ö–∏–π –∑–≤—É–∫', 'low_volume', 2000, '30 –º–∏–Ω—É—Ç', 5)\n      ON CONFLICT DO NOTHING;\n    END IF;\n\n    -- –ü—Ä–æ–±–ª–µ–º—ã –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ \"–°–≤—è–∑—å\"\n    IF category_connection_id IS NOT NULL THEN\n      INSERT INTO issue_types (tenant_id, repair_category_id, name, code, default_cost, default_time, display_order)\n      VALUES\n        (default_tenant_id, category_connection_id, '–ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç WiFi', 'wifi_broken', 3000, '45 –º–∏–Ω—É—Ç', 1),\n        (default_tenant_id, category_connection_id, '–ù–µ—Ç —Å–∏–≥–Ω–∞–ª–∞ —Å–µ—Ç–∏', 'no_signal', 3500, '1 —á–∞—Å', 2),\n        (default_tenant_id, category_connection_id, 'Bluetooth –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è', 'bluetooth_broken', 2500, '40 –º–∏–Ω—É—Ç', 3),\n        (default_tenant_id, category_connection_id, 'GPS –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç', 'gps_broken', 3000, '45 –º–∏–Ω—É—Ç', 4)\n      ON CONFLICT DO NOTHING;\n    END IF;\n\n    -- –ü—Ä–æ–±–ª–µ–º—ã –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ \"–ö–∞–º–µ—Ä–∞\"\n    IF category_camera_id IS NOT NULL THEN\n      INSERT INTO issue_types (tenant_id, repair_category_id, name, code, default_cost, default_time, display_order)\n      VALUES\n        (default_tenant_id, category_camera_id, '–ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω–∞—è –∫–∞–º–µ—Ä–∞', 'main_camera_broken', 4500, '40 –º–∏–Ω—É—Ç', 1),\n        (default_tenant_id, category_camera_id, '–ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω–∞—è –∫–∞–º–µ—Ä–∞', 'front_camera_broken', 3500, '30 –º–∏–Ω—É—Ç', 2),\n        (default_tenant_id, category_camera_id, '–ú—É—Ç–Ω—ã–µ —Ñ–æ—Ç–æ', 'blurry_photos', 2000, '20 –º–∏–Ω—É—Ç', 3),\n        (default_tenant_id, category_camera_id, '–°—Ç–µ–∫–ª–æ –∫–∞–º–µ—Ä—ã —Ä–∞–∑–±–∏—Ç–æ', 'camera_glass_broken', 1500, '15 –º–∏–Ω—É—Ç', 4)\n      ON CONFLICT DO NOTHING;\n    END IF;\n\n    -- –ü—Ä–æ–±–ª–µ–º—ã –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ \"–†–∞–∑—ä–µ–º—ã\"\n    IF category_ports_id IS NOT NULL THEN\n      INSERT INTO issue_types (tenant_id, repair_category_id, name, code, default_cost, default_time, display_order)\n      VALUES\n        (default_tenant_id, category_ports_id, '–†–∞–∑—ä–µ–º –∑–∞—Ä—è–¥–∫–∏ —Å–ª–æ–º–∞–Ω', 'charging_port_broken', 2500, '30 –º–∏–Ω—É—Ç', 1),\n        (default_tenant_id, category_ports_id, '–†–∞–∑—ä–µ–º –Ω–∞—É—à–Ω–∏–∫–æ–≤ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç', 'headphone_jack_broken', 2000, '25 –º–∏–Ω—É—Ç', 2),\n        (default_tenant_id, category_ports_id, '–ü–ª–æ—Ö–æ–π –∫–æ–Ω—Ç–∞–∫—Ç –ø—Ä–∏ –∑–∞—Ä—è–¥–∫–µ', 'loose_charging', 2000, '25 –º–∏–Ω—É—Ç', 3)\n      ON CONFLICT DO NOTHING;\n    END IF;\n\n    RAISE NOTICE '‚úÖ –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è repair_categories –∏ issue_types –¥–æ–±–∞–≤–ª–µ–Ω—ã';\n\n  ELSE\n    RAISE WARNING '–ê–∫—Ç–∏–≤–Ω—ã–π —Ç–µ–Ω–∞–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω! –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö.';\n  END IF;\nEND $$;",
        "additionalFields": {}
      },
      "id": "a7b8c9d0-e1f2-3456-1234-567890123456",
      "name": "Step 7: Insert test data",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [850, 400],
      "credentials": {
        "postgres": {
          "id": "supabase_postgres",
          "name": "Supabase PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- ============================================================================\n-- 6. –¢–ï–°–¢–û–í–´–ï –î–ê–ù–ù–´–ï: context_fields_config\n-- ============================================================================\n\nDO $$\nDECLARE\n  default_tenant_id UUID;\nBEGIN\n  -- –ò—â–µ–º –ø–µ—Ä–≤—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–µ–Ω–∞–Ω—Ç\n  SELECT id INTO default_tenant_id\n  FROM tenants\n  WHERE is_active = true\n  LIMIT 1;\n\n  -- –ï—Å–ª–∏ –Ω–∞—à–ª–∏ —Ç–µ–Ω–∞–Ω—Ç, –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø–æ–ª–µ–π\n  IF default_tenant_id IS NOT NULL THEN\n    INSERT INTO context_fields_config\n      (tenant_id, field_name, field_label, is_required, collection_order, tool_name, field_type, default_value)\n    VALUES\n      -- –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è\n      (default_tenant_id, 'type', '–¢–∏–ø –æ–±—Ä–∞—â–µ–Ω–∏—è', true, 1, 'Tool-Type', 'select', NULL),\n      (default_tenant_id, 'model_id', '–ú–æ–¥–µ–ª—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞', true, 2, 'Tool-Model', 'select', NULL),\n      (default_tenant_id, 'repair_type_id', '–¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞', true, 3, 'Tool-Repair', 'select', NULL),\n\n      -- –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ–ª—è\n      (default_tenant_id, 'parts_owner', '–ß—å—è –∑–∞–ø—á–∞—Å—Ç—å', false, 4, 'Tool-Parts', 'select', '–Ω–∞—à–∞')\n    ON CONFLICT DO NOTHING;\n\n    RAISE NOTICE '–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ–ª–µ–π –¥–æ–±–∞–≤–ª–µ–Ω–∞ –¥–ª—è tenant_id: %', default_tenant_id;\n  ELSE\n    RAISE WARNING '–ê–∫—Ç–∏–≤–Ω—ã–π —Ç–µ–Ω–∞–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω! –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø–æ–ª–µ–π.';\n  END IF;\nEND $$;",
        "additionalFields": {}
      },
      "id": "b8c9d0e1-f2a3-4567-2345-678901234567",
      "name": "Step 8: Insert context config",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [1050, 400],
      "credentials": {
        "postgres": {
          "id": "supabase_postgres",
          "name": "Supabase PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- ============================================================================\n-- 7. –§–£–ù–ö–¶–ò–Ø: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ updated_at\n-- ============================================================================\n\n-- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è timestamp\nCREATE OR REPLACE FUNCTION update_updated_at_column()\nRETURNS TRIGGER AS $$\nBEGIN\n  NEW.updated_at = NOW();\n  RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql;\n\n-- –¢—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è updated_at\nDROP TRIGGER IF EXISTS update_repair_categories_updated_at ON repair_categories;\nCREATE TRIGGER update_repair_categories_updated_at\n  BEFORE UPDATE ON repair_categories\n  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();\n\nDROP TRIGGER IF EXISTS update_issue_types_updated_at ON issue_types;\nCREATE TRIGGER update_issue_types_updated_at\n  BEFORE UPDATE ON issue_types\n  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();\n\nDROP TRIGGER IF EXISTS update_appeal_devices_updated_at ON appeal_devices;\nCREATE TRIGGER update_appeal_devices_updated_at\n  BEFORE UPDATE ON appeal_devices\n  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();\n\nDROP TRIGGER IF EXISTS update_appeal_repairs_updated_at ON appeal_repairs;\nCREATE TRIGGER update_appeal_repairs_updated_at\n  BEFORE UPDATE ON appeal_repairs\n  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();\n\nDROP TRIGGER IF EXISTS update_context_fields_config_updated_at ON context_fields_config;\nCREATE TRIGGER update_context_fields_config_updated_at\n  BEFORE UPDATE ON context_fields_config\n  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();",
        "additionalFields": {}
      },
      "id": "c9d0e1f2-a3b4-5678-3456-789012345678",
      "name": "Step 9: Create triggers",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [450, 600],
      "credentials": {
        "postgres": {
          "id": "supabase_postgres",
          "name": "Supabase PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- ============================================================================\n-- 8. VIEW: –£–¥–æ–±–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –∑–∞—è–≤–æ–∫ —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ –∏ —Ä–µ–º–æ–Ω—Ç–∞–º–∏\n-- ============================================================================\n\nCREATE OR REPLACE VIEW v_appeals_with_devices AS\nSELECT\n  a.id as appeal_id,\n  a.tenant_id,\n  a.client_id,\n  a.stage,\n  a.type as appeal_type,\n  a.operation_mode,\n  a.conversation_focus,\n  a.last_greeting_at,\n\n  -- –ö–ª–∏–µ–Ω—Ç\n  c.name as client_name,\n  c.phone as client_phone,\n\n  -- –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–∞–≥—Ä–µ–≥–∞—Ü–∏—è)\n  COALESCE(\n    jsonb_agg(\n      DISTINCT jsonb_build_object(\n        'device_id', ad.id,\n        'model', ad.phone_model,\n        'brand_id', ad.brand_id,\n        'model_id', ad.model_id,\n        'status', ad.status,\n        'discussion_status', ad.discussion_status,\n        'device_order', ad.device_order\n      ) ORDER BY ad.device_order\n    ) FILTER (WHERE ad.id IS NOT NULL),\n    '[]'::jsonb\n  ) as devices,\n\n  -- –†–µ–º–æ–Ω—Ç—ã (–∞–≥—Ä–µ–≥–∞—Ü–∏—è)\n  COALESCE(\n    jsonb_agg(\n      DISTINCT jsonb_build_object(\n        'repair_id', ar.id,\n        'device_id', ar.appeal_device_id,\n        'repair_type', ar.repair_type_name,\n        'parts_owner', ar.parts_owner,\n        'cost', ar.estimated_cost,\n        'time', ar.estimated_time,\n        'status', ar.status,\n        'discussion_status', ar.discussion_status,\n        'priority', ar.priority\n      ) ORDER BY ar.priority\n    ) FILTER (WHERE ar.id IS NOT NULL),\n    '[]'::jsonb\n  ) as repairs,\n\n  -- –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å\n  COALESCE(SUM(ar.estimated_cost) FILTER (WHERE ar.status != 'rejected'), 0) as total_cost,\n\n  -- –°—á—ë—Ç—á–∏–∫–∏\n  COUNT(DISTINCT ad.id) FILTER (WHERE ad.status = 'active') as devices_count,\n  COUNT(DISTINCT ar.id) FILTER (WHERE ar.status != 'rejected') as repairs_count,\n\n  a.created_at,\n  a.updated_at\n\nFROM appeals a\nLEFT JOIN clients c ON c.id = a.client_id\nLEFT JOIN appeal_devices ad ON ad.appeal_id = a.id\nLEFT JOIN appeal_repairs ar ON ar.appeal_id = a.id\nGROUP BY a.id, c.name, c.phone;\n\nCOMMENT ON VIEW v_appeals_with_devices IS '–£–¥–æ–±–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∑–∞—è–≤–æ–∫ —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ –∏ —Ä–µ–º–æ–Ω—Ç–∞–º–∏ (–¥–ª—è API)';",
        "additionalFields": {}
      },
      "id": "d0e1f2a3-b4c5-6789-4567-890123456789",
      "name": "Step 10: Create VIEW",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [650, 600],
      "credentials": {
        "postgres": {
          "id": "supabase_postgres",
          "name": "Supabase PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "return [\n  {\n    json: {\n      status: 'success',\n      message: '‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è Multi-Device Architecture –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!',\n      created: [\n        '–¢–∞–±–ª–∏—Ü–∞ repair_categories (7 –∫–∞—Ç–µ–≥–æ—Ä–∏–π)',\n        '–¢–∞–±–ª–∏—Ü–∞ issue_types (~40 –ø—Ä–æ–±–ª–µ–º)',\n        '–¢–∞–±–ª–∏—Ü–∞ appeal_devices',\n        '–¢–∞–±–ª–∏—Ü–∞ appeal_repairs',\n        '–¢–∞–±–ª–∏—Ü–∞ context_fields_config',\n        '–û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ appeals (4 –Ω–æ–≤—ã—Ö –ø–æ–ª—è)',\n        'VIEW v_appeals_with_devices',\n        '–¢—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è updated_at',\n        '–¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Å–µ—Ö —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤'\n      ],\n      next_step: '–û–±–Ω–æ–≤–∏—Ç—å n8n –≤–æ—Ä–∫–µ—Ä—ã (AI Tools)'\n    }\n  }\n];"
      },
      "id": "e1f2a3b4-c5d6-7890-5678-901234567890",
      "name": "Migration Complete",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [850, 600]
    }
  ],
  "pinData": {},
  "connections": {
    "Manual Trigger": {
      "main": [
        [
          {
            "node": "Step 1: Create appeal_devices",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Step 1: Create appeal_devices": {
      "main": [
        [
          {
            "node": "Step 2: Create repair_categories",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Step 2: Create repair_categories": {
      "main": [
        [
          {
            "node": "Step 3: Create issue_types",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Step 3: Create issue_types": {
      "main": [
        [
          {
            "node": "Step 4: Create appeal_repairs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Step 4: Create appeal_repairs": {
      "main": [
        [
          {
            "node": "Step 5: Update appeals table",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Step 5: Update appeals table": {
      "main": [
        [
          {
            "node": "Step 6: Create context_fields_config",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Step 6: Create context_fields_config": {
      "main": [
        [
          {
            "node": "Step 7: Insert test data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Step 7: Insert test data": {
      "main": [
        [
          {
            "node": "Step 8: Insert context config",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Step 8: Insert context config": {
      "main": [
        [
          {
            "node": "Step 9: Create triggers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Step 9: Create triggers": {
      "main": [
        [
          {
            "node": "Step 10: Create VIEW",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Step 10: Create VIEW": {
      "main": [
        [
          {
            "node": "Migration Complete",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "1",
  "id": "db-migration-runner-001",
  "meta": {
    "instanceId": "battcrm-n8n"
  },
  "tags": []
}
