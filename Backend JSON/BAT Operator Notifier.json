{
  "nodes": [
    {
      "parameters": {},
      "id": "42bff8b2-97cb-4f65-ac96-79069adf5c2a",
      "name": "Execute Workflow Trigger",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1,
      "position": [
        -128,
        -528
      ]
    },
    {
      "parameters": {
        "jsCode": "const d = $input.first().json;\n\n// –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML\nconst esc = s => (s ?? '').toString()\n  .replace(/&/g, '&amp;')\n  .replace(/</g, '&lt;')\n  .replace(/>/g, '&gt;');\n\n// –î–∞–Ω–Ω—ã–µ\nconst prop = d.propertyName || {};\nconst meta = prop.meta || {};\nconst raw = meta.raw || {};\nconst appeal = d.appeal || {};\nconst client = d.client || {};\nconst extractedData = d.extracted_data || {};\n\nconsole.log('‚ïî‚ïê‚ïê‚ïê PREPARE NOTIFICATION ‚ïê‚ïê‚ïê');\nconsole.log('Input data:', JSON.stringify(d, null, 2));\n\n// –ò–∑–≤–ª–µ–∫–∞–µ–º –≤—Å–µ –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è\nconst channel = d.channel ?? prop.channel ?? meta.ad_channel ?? '';\nconst clientName = client.name ?? prop.client_name ?? d.client_name ?? '';\nconst clientPhone = client.phone ?? prop.client_phone ?? '';\nconst appealId = appeal.id ?? d.appeal_id ?? '';\n\n// –î–∞–Ω–Ω—ã–µ –æ–±—Ä–∞—â–µ–Ω–∏—è - –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç extractedData\nconst appealType = extractedData.type ?? appeal.type ?? '';\nconst phoneModel = extractedData.model ?? appeal.phone_model ?? '';\nconst repairType = extractedData.repair_type ?? appeal.malfunction_category ?? '';\nconst partsOwner = extractedData.parts_owner ?? appeal.parts_owner ?? '';\n\n// –°—Ç–æ–∏–º–æ—Å—Ç—å\nconst estimatedCost = appeal.estimated_cost ? `${appeal.estimated_cost}‚ÇΩ` : '';\nconst partsCost = appeal.parts_cost ? `${appeal.parts_cost}‚ÇΩ` : '';\n\n// –¢–µ–∫—Å—Ç –∫–ª–∏–µ–Ω—Ç–∞\nconst lastText = (d.text && d.text.trim()) ? d.text : (prop.text || raw.text || '');\n\n// –ë–µ—Ä–µ–º —Ä–µ–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç AI\nconst aiResponseClean = d.response_text || d.ai_response || meta.ai_response || '';\n\nconsole.log('Extracted values:');\nconsole.log('- clientName:', clientName);\nconsole.log('- phoneModel:', phoneModel);\nconsole.log('- repairType:', repairType);\nconsole.log('- appealType:', appealType);\nconsole.log('- partsOwner:', partsOwner);\nconsole.log('- aiResponse:', aiResponseClean);\nconsole.log('- tenant_id:', d.tenant_id);\nconsole.log('- media_type:', d.media_type);\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞\nconst fullLines = [];\nfullLines.push('<b>üîî –ù–æ–≤–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ</b>\\n');\n\nif (clientName) fullLines.push(`<b>üë§ –ö–ª–∏–µ–Ω—Ç:</b> ${esc(clientName)}`);\nif (clientPhone) fullLines.push(`<b>üì± –¢–µ–ª–µ—Ñ–æ–Ω:</b> ${esc(clientPhone)}`);\nif (channel) fullLines.push(`<b>üí¨ –ö–∞–Ω–∞–ª:</b> ${esc(channel)}`);\n\nif (clientName || clientPhone || channel) fullLines.push('');\n\nconst modelIcon = phoneModel && phoneModel !== '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞' ? '‚úÖ' : '‚ùå';\nconst repairIcon = repairType && repairType !== '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞' ? '‚úÖ' : '‚ùå';\nconst typeIcon = appealType && appealType !== '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω' ? '‚úÖ' : '‚ùå';\n\nif (phoneModel) fullLines.push(`<b>${modelIcon} –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ:</b> ${esc(phoneModel)}`);\nif (repairType) fullLines.push(`<b>${repairIcon} –ü—Ä–æ–±–ª–µ–º–∞:</b> ${esc(repairType)}`);\nif (partsOwner) fullLines.push(`<b>üì¶ –ó–∞–ø—á–∞—Å—Ç—å:</b> ${esc(partsOwner)}`);\nif (appealType) fullLines.push(`<b>${typeIcon} –¢–∏–ø:</b> ${esc(appealType)}`);\n\nif (estimatedCost) fullLines.push(`<b>üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–µ–º–æ–Ω—Ç–∞:</b> ${estimatedCost}`);\nif (partsCost) fullLines.push(`<b>üî© –°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–ø—á–∞—Å—Ç–∏:</b> ${partsCost}`);\n\nif (fullLines.length > 2) fullLines.push('');\n\nif (lastText) {\n  fullLines.push('<b>üí¨ –°–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞:</b>');\n  fullLines.push(`\"${esc(lastText)}\"`);\n  fullLines.push('');\n}\n\nif (aiResponseClean) {\n  fullLines.push('<b>ü§ñ –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç:</b>');\n  fullLines.push(`\"${esc(aiResponseClean)}\"`);\n  fullLines.push('');\n}\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –∫–æ—Ä–æ—Ç–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ (–±–µ–∑ —Å–æ–æ–±—â–µ–Ω–∏–π)\nconst shortLines = [];\nshortLines.push('<b>üîî –ù–æ–≤–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ</b>\\n');\n\nif (clientName) shortLines.push(`<b>üë§ –ö–ª–∏–µ–Ω—Ç:</b> ${esc(clientName)}`);\nif (clientPhone) shortLines.push(`<b>üì± –¢–µ–ª–µ—Ñ–æ–Ω:</b> ${esc(clientPhone)}`);\nif (channel) shortLines.push(`<b>üí¨ –ö–∞–Ω–∞–ª:</b> ${esc(channel)}`);\n\nif (clientName || clientPhone || channel) shortLines.push('');\n\nif (phoneModel) shortLines.push(`<b>${modelIcon} –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ:</b> ${esc(phoneModel)}`);\nif (repairType) shortLines.push(`<b>${repairIcon} –ü—Ä–æ–±–ª–µ–º–∞:</b> ${esc(repairType)}`);\nif (partsOwner) shortLines.push(`<b>üì¶ –ó–∞–ø—á–∞—Å—Ç—å:</b> ${esc(partsOwner)}`);\nif (appealType) shortLines.push(`<b>${typeIcon} –¢–∏–ø:</b> ${esc(appealType)}`);\n\nif (estimatedCost) shortLines.push(`<b>üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–µ–º–æ–Ω—Ç–∞:</b> ${estimatedCost}`);\nif (partsCost) shortLines.push(`<b>üî© –°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–ø—á–∞—Å—Ç–∏:</b> ${partsCost}`);\n\nconst shortText = shortLines.join('\\n');\nconst fullText = fullLines.join('\\n') + (appealId ? `\\n<code>${appealId}</code>` : '');\n\nconsole.log('‚úÖ Notification prepared');\n\nreturn {\n  ...d,\n  operator_notification: {\n    text: fullText,\n    short_text: shortText,\n    appeal_id: appealId || null,\n    client_id: client.id || null,\n    client_name: clientName,\n    client_phone: clientPhone,\n    channel: channel,\n    external_chat_id: d.external_chat_id,\n    media_type: d.media_type || 'text',\n    media_data: d.media_data || null,\n    parse_mode: 'HTML',\n    disable_web_page_preview: true,\n    original_response_text: aiResponseClean\n  }\n};"
      },
      "id": "ae0c7f15-64e3-4f05-8d69-66c98926d01f",
      "name": "Prepare Notification",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        80,
        -528
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  id,\n  telegram_id,\n  fcm_token,\n  name\nFROM operators\nWHERE is_active = true\n  AND tenant_id = '{{ $json.tenant_id }}'::uuid\n  AND (telegram_id IS NOT NULL OR fcm_token IS NOT NULL);",
        "options": {}
      },
      "id": "828af8c1-b64b-4496-b0d8-717599c40a62",
      "name": "Get Active Operators",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        256,
        -752
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "n2SyhP9QhMnp1ryk",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–ª—É—á–∞–µ–º –ü–û–õ–ù–´–ï –¥–∞–Ω–Ω—ã–µ –∏–∑ Prepare Notification\nconst prepareData = $('Prepare Notification').first().json;\n\n// –ü–æ–ª—É—á–∞–µ–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤\nconst operators = $input.all();\n\nconsole.log('=== MERGE NOTIFICATION WITH OPERATORS ===');\nconsole.log('Operators count:', operators.length);\nconsole.log('PrepareData keys:', Object.keys(prepareData));\nconsole.log('tenant_id from prepareData:', prepareData.tenant_id);\n\n// –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω—É–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞\nconst notificationText = prepareData.message || prepareData.text || prepareData.telegram_message;\nconst appealId = prepareData.appeal?.id || prepareData.appeal_id;\n\n// –î–ª—è –∫–∞–∂–¥–æ–≥–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ —Å–æ–∑–¥–∞—ë–º –ü–û–õ–ù–´–ô –ø–∞–∫–µ—Ç –¥–∞–Ω–Ω—ã—Ö\nconst result = operators.map(operator => {\n  const operatorData = operator.json;\n  \n  return {\n    // –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –°–Ω–∞—á–∞–ª–∞ –∫–æ–ø–∏—Ä—É–µ–º –í–°–ï –¥–∞–Ω–Ω—ã–µ –∏–∑ Prepare Notification\n    ...prepareData,\n    \n    // –ó–∞—Ç–µ–º –¥–æ–±–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –ø–æ–ª—è\n    id: operatorData.id,\n    telegram_id: operatorData.telegram_id,\n    fcm_token: operatorData.fcm_token,\n    name: operatorData.name,\n    \n    // –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ —ç—Ç–∏ –ø–æ–ª—è —Ç–æ—á–Ω–æ –µ—Å—Ç—å –¥–ª—è Send to Operators\n    notification_text: notificationText,\n    appeal_id: appealId\n  };\n});\n\nconsole.log('‚úÖ Merged! First item keys:', Object.keys(result[0]));\nconsole.log('tenant_id in result[0]:', result[0].tenant_id);\nconsole.log('Has operator_notification:', !!result[0].operator_notification);\nconsole.log('Has client:', !!result[0].client);\nconsole.log('Has appeal:', !!result[0].appeal);\nconsole.log('Has fcm_token:', !!result[0].fcm_token);\n\nreturn result;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        464,
        -752
      ],
      "id": "a983f8c5-0ac0-4efb-a20e-aecaff44689d",
      "name": "Merge Notification with Operators"
    },
    {
      "parameters": {
        "chatId": "={{ $json.telegram_id }}",
        "text": "={{ $json.operator_notification.short_text }}",
        "additionalFields": {
          "disable_web_page_preview": true,
          "parse_mode": "HTML"
        }
      },
      "id": "0d900ee6-297f-4d77-b1a7-477c2ff23459",
      "name": "Send to Operators",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        1056,
        -976
      ],
      "webhookId": "db5dc1f9-a11e-439a-8c9c-cf08ee285839",
      "credentials": {
        "telegramApi": {
          "id": "QIs2m5gKKih3bnhF",
          "name": "Operator TG"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH vals AS (\n  SELECT\n    '{{ $('Merge Notification with Operators').item.json.tenant_id || \"\" }}' AS tenant_id_text,\n    NULLIF('{{ $('Merge Notification with Operators').item.json.telegram_id || \"\" }}','') AS op_tg,\n    '{{ $('Merge Notification with Operators').item.json.id || \"\" }}' AS op_id_text,\n    '{{ $('Merge Notification with Operators').item.json.appeal_id || \"\" }}' AS appeal_id_text,\n    '{{ $('Merge Notification with Operators').item.json.client.id || \"\" }}' AS client_id_text,\n    '{{ $('Merge Notification with Operators').item.json.meta?.ai_response || $('Merge Notification with Operators').item.json.text || \"\" }}' AS ai_response,\n    '{{ $json.message_id || \"\" }}'  AS message_id,\n    '[]' AS missing_fields_json\n),\nvalidated AS (\n  SELECT\n    CASE WHEN tenant_id_text ~* '^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$' THEN tenant_id_text::uuid ELSE NULL END AS tenant_id,\n    op_tg,\n    CASE WHEN op_id_text ~* '^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$' THEN op_id_text::uuid ELSE NULL END AS op_id,\n    CASE WHEN appeal_id_text ~* '^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$' THEN appeal_id_text::uuid ELSE NULL END AS appeal_id,\n    CASE WHEN client_id_text ~* '^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$' THEN client_id_text::uuid ELSE NULL END AS client_id,\n    ai_response,\n    message_id,\n    missing_fields_json::jsonb AS missing_fields\n  FROM vals\n),\nins AS (\n  INSERT INTO operator_actions (\n    tenant_id,\n    operator_telegram_id,\n    operator_id,\n    action_type,\n    details\n  )\n  SELECT\n    v.tenant_id,\n    v.op_tg,\n    v.op_id,\n    'notify_appeal_ready',\n    jsonb_build_object(\n      'appeal_id', v.appeal_id,\n      'client_id', v.client_id,\n      'ai_response', v.ai_response,\n      'message_id', v.message_id,\n      'missing_fields', v.missing_fields,\n      'notification_sent', true\n    )\n  FROM validated v\n  WHERE v.op_tg IS NOT NULL\n    AND v.op_id IS NOT NULL\n    AND v.tenant_id IS NOT NULL\n  RETURNING *\n)\nSELECT * FROM ins;",
        "options": {}
      },
      "id": "d00efada-de16-4378-915a-16618765d464",
      "name": "Log Notification",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        2208,
        -752
      ],
      "credentials": {
        "postgres": {
          "id": "n2SyhP9QhMnp1ryk",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH vals AS (\n  SELECT\n    '{{ $json.tenant_id || \"\" }}' AS tenant_id_text,\n    '{{ $json.appeal?.id || \"\" }}' AS appeal_id_text\n),\nvalidated AS (\n  SELECT\n    CASE\n      WHEN tenant_id_text ~* '^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$'\n        THEN tenant_id_text::uuid\n      ELSE NULL\n    END AS tenant_id,\n    CASE\n      WHEN appeal_id_text ~* '^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$'\n        THEN appeal_id_text::uuid\n      ELSE NULL\n    END AS appeal_id\n  FROM vals\n)\nUPDATE appeals a\nSET\n  stage = '–¢—Ä–µ–±—É–µ—Ç—Å—è —É—Ç–æ—á–Ω–µ–Ω–∏–µ',\n  operation_mode = 'manual',\n  updated_at = NOW()\nFROM validated v\nWHERE v.appeal_id IS NOT NULL\n  AND v.tenant_id IS NOT NULL\n  AND a.id = v.appeal_id\n  AND a.tenant_id = v.tenant_id\nRETURNING a.*;",
        "options": {}
      },
      "id": "ae98c039-11ac-4d26-bc47-617cd1b88b1d",
      "name": "Update Appeal Stage",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        2480,
        -752
      ],
      "credentials": {
        "postgres": {
          "id": "n2SyhP9QhMnp1ryk",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        2352,
        -528
      ],
      "id": "8766b741-e4b4-4824-8eda-11a45d44b954",
      "name": "Merge"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all().map(i => i.json || {});\nconst one =\n  items.find(i => i.__base) ||\n  items.find(i => i.appeal) ||\n  items[0] || {};\nreturn one;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2576,
        -528
      ],
      "id": "e55a607c-64d5-4335-a36e-cb9fcd72f898",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "jsCode": "const data = $json;\n\nreturn {\n  message_id: data.result?.message_id || data.message_id,\n  appeal_id: $(\"Prepare Notification\").item.json.appeal_id || $(\"Prepare Notification\").item.json.appeal?.id,\n  operator_telegram_id: data.result?.chat?.id || data.chat?.id,\n  tenant_id: $(\"Prepare Notification\").item.json.tenant_id\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1408,
        -752
      ],
      "id": "0d7a6d69-c24f-4ec7-9673-1a759938d1af",
      "name": "Extract Message ID"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO operator_actions (\n  tenant_id,\n  operator_telegram_id,\n  action_type,\n  details,\n  context_appeal_id\n)\nVALUES (\n  '{{ $json.tenant_id }}'::uuid,\n  '{{ $json.operator_telegram_id }}',\n  'notify_appeal_ready',\n  jsonb_build_object(\n    'appeal_id', '{{ $json.appeal_id }}',\n    'message_id', {{ $json.message_id }},\n    'ai_response', '{{ $(\"Merge Notification with Operators\").item.json.operator_notification.original_response_text || \"\" }}'\n  ),\n  '{{ $json.appeal_id }}'::uuid\n)\nRETURNING *;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1936,
        -752
      ],
      "id": "b1a3ec6a-d105-47df-b2ba-762840d7cdde",
      "name": "Log Operator Action",
      "credentials": {
        "postgres": {
          "id": "n2SyhP9QhMnp1ryk",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO operator_message_appeal_map (\n  tenant_id,\n  operator_telegram_id,\n  message_id,\n  appeal_id\n)\nVALUES (\n  '{{ $json.tenant_id }}'::uuid,\n  '{{ $json.operator_telegram_id }}',\n  {{ $json.message_id }},\n  '{{ $json.appeal_id }}'::uuid\n)\nON CONFLICT (tenant_id, operator_telegram_id, message_id) \nDO UPDATE SET appeal_id = EXCLUDED.appeal_id\nRETURNING tenant_id, operator_telegram_id, message_id, appeal_id;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1632,
        -752
      ],
      "id": "6fadef4f-dc4e-49c0-8181-4eb57da4d6d7",
      "name": "Execute a SQL query",
      "credentials": {
        "postgres": {
          "id": "n2SyhP9QhMnp1ryk",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { \"success\": true, \"operators_notified\": $('Get Active Operators').all().length } }}",
        "options": {}
      },
      "id": "952b9c53-0b04-4fcc-821d-d267f1b27b8f",
      "name": "Respond Success",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        2848,
        -528
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "Ldeg4SOqteYuYZbx",
          "mode": "list",
          "cachedResultUrl": "/workflow/Ldeg4SOqteYuYZbx",
          "cachedResultName": "BAT_FCM_Sender"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        1152,
        -752
      ],
      "id": "ee616448-8ee2-47c9-9f9a-2da4df6d9211",
      "name": "Call 'BAT_FCM_Sender'"
    },
    {
      "parameters": {
        "jsCode": "return {\n  tenant_id: $json.tenant_id,\n  notification_type: 'new_appeal',\n  appeal_id: $json.appeal_id,\n  title: 'üîî –ù–æ–≤–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ',\n  body: `${$json.client?.name || '–ö–ª–∏–µ–Ω—Ç'} - ${$json.operator_notification?.channel || '–∫–∞–Ω–∞–ª'}`,\n  data: {\n    client_name: $json.client?.name || '',\n    channel: $json.operator_notification?.channel || ''\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        848,
        -752
      ],
      "id": "01b1f5bf-c648-40ac-86df-ff38fdad1413",
      "name": "Code in JavaScript1"
    }
  ],
  "connections": {
    "Execute Workflow Trigger": {
      "main": [
        [
          {
            "node": "Prepare Notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Notification": {
      "main": [
        [
          {
            "node": "Get Active Operators",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Get Active Operators": {
      "main": [
        [
          {
            "node": "Merge Notification with Operators",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Notification with Operators": {
      "main": [
        [
          {
            "node": "Send to Operators",
            "type": "main",
            "index": 0
          },
          {
            "node": "Code in JavaScript1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send to Operators": {
      "main": [
        []
      ]
    },
    "Log Notification": {
      "main": [
        [
          {
            "node": "Update Appeal Stage",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Appeal Stage": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Respond Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Message ID": {
      "main": [
        [
          {
            "node": "Execute a SQL query",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Operator Action": {
      "main": [
        [
          {
            "node": "Log Notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute a SQL query": {
      "main": [
        [
          {
            "node": "Log Operator Action",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call 'BAT_FCM_Sender'": {
      "main": [
        [
          {
            "node": "Extract Message ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript1": {
      "main": [
        [
          {
            "node": "Call 'BAT_FCM_Sender'",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {
    "Execute Workflow Trigger": [
      {
        "channel": "telegram",
        "external_user_id": "1132511247",
        "external_chat_id": "1132511247",
        "text": "–ú–Ω–µ –Ω—É–∂–µ–Ω —Ä–µ–º–æ–Ω—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞\n–ó–∞–º–µ–Ω —ç–∫—Ä–∞–Ω–∞ –æ—Ç –ø–æ—Ç–µ–∫–∞",
        "timestamp": "2025-11-15T09:21:17.000Z",
        "client_phone": null,
        "client_name": "–†–µ–º–ê–∫—Å MD",
        "client_email": null,
        "media": {
          "has_voice": false,
          "voice_transcribed_text": null,
          "has_images": false,
          "images": [],
          "has_video": false,
          "videos": [],
          "has_document": false,
          "documents": []
        },
        "meta": {
          "external_message_id": "1091",
          "ad_channel": "telegram",
          "ad_id": null,
          "original_media_type": "text",
          "raw": {
            "message_id": 1091,
            "from": {
              "id": 1132511247,
              "is_bot": false,
              "first_name": "–†–µ–º–ê–∫—Å MD",
              "username": "RemacsMD",
              "language_code": "ru",
              "is_premium": true
            },
            "chat": {
              "id": 1132511247,
              "first_name": "–†–µ–º–ê–∫—Å MD",
              "username": "RemacsMD",
              "type": "private"
            },
            "date": 1763198477,
            "text": "–ú–Ω–µ –Ω—É–∂–µ–Ω —Ä–µ–º–æ–Ω—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞\n–ó–∞–º–µ–Ω —ç–∫—Ä–∞–Ω–∞ –æ—Ç –ø–æ—Ç–µ–∫–∞"
          },
          "username": "RemacsMD",
          "batched": true,
          "batch_size": 1,
          "batch_wait_time": 20,
          "original_messages": [
            {
              "timestamp": "2025-11-15T09:21:17.000Z",
              "type": "text",
              "text_length": 48
            }
          ],
          "combined_at": "2025-11-15T09:21:39.982Z"
        },
        "prefilled_data": {
          "model": null,
          "parts_owner": null
        },
        "bot_token": "8411509872:AAFmR4xk6kJFBgKsYdXRJAULhxHWe1McJQ8",
        "external_message_id": "1091",
        "tenant_id": "a0000000-0000-0000-0000-000000000001",
        "tenant_name": "Default Tenant",
        "tenant_config": {
          "token": "8411509872:AAFmR4xk6kJFBgKsYdXRJAULhxHWe1McJQ8"
        },
        "success": true,
        "client": {
          "id": "94f3bf7c-f2f3-4dc1-bdfb-e9d9d7a8ba93",
          "phone": null,
          "name": "–†–µ–º–ê–∫—Å MD",
          "telegram_id": "1132511247",
          "vk_id": null,
          "whatsapp_id": null,
          "avito_id": null,
          "was_merged": false
        },
        "client_found": true,
        "appeal": {
          "id": "07af5e27-4532-4d6b-bdff-6f8c089a76d5",
          "client_id": "94f3bf7c-f2f3-4dc1-bdfb-e9d9d7a8ba93",
          "phone_brand": null,
          "phone_model": null,
          "malfunction_category": null,
          "malfunction_type": null,
          "problem_description": null,
          "appeal_status": null,
          "stage": "–ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–æ–Ω—Ç–∞–∫—Ç",
          "ad_channel": null,
          "ad_id": "null",
          "estimated_cost": null,
          "estimated_time": null,
          "appointment_datetime": null,
          "master_id": null,
          "qr_code": null,
          "livesklad_order_id": null,
          "synced_with_livesklad": false,
          "synced_at": null,
          "visited_at": null,
          "completed_at": null,
          "notified_2h_after_contact": false,
          "notified_1day_before": false,
          "notified_2h_before": false,
          "notified_after_completion": false,
          "notified_review_request": false,
          "notified_warranty_reminder": false,
          "created_at": "2025-11-15T09:21:40.489Z",
          "updated_at": "2025-11-15T09:21:55.139Z",
          "device_type_id": null,
          "brand_id": null,
          "model_id": null,
          "deal_type_id": null,
          "repair_type_id": "9e1fa155-7982-42f3-9a2b-c625c0e899aa",
          "ad_channel_id": "c5c20ca5-2d6e-42cf-8a5e-cec4a6a549a5",
          "operation_mode": "assist",
          "notified_": false,
          "type": "—Ä–µ–º–æ–Ω—Ç",
          "type_confidence": "0.00",
          "type_identified": false,
          "type_reasoning": null,
          "pending_operator_approval": false,
          "draft_response": null,
          "routing_history": [
            {
              "route": "partial",
              "action": "ask_model",
              "reasoning": "–î–∞–Ω–Ω—ã–µ –∏–∑–≤–ª–µ—á–µ–Ω—ã –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–º–∏ –≤—ã–∑–æ–≤–∞–º–∏ tools",
              "timestamp": "2025-11-15T09:21:55.117Z"
            }
          ],
          "parts_owner": "–Ω–∞—à–∞",
          "client_parts": false,
          "tenant_id": "a0000000-0000-0000-0000-000000000001",
          "location_id": null
        },
        "appeal_id": "07af5e27-4532-4d6b-bdff-6f8c089a76d5",
        "conversation_history": "[09:21] –ö–ª–∏–µ–Ω—Ç: –ú–Ω–µ –Ω—É–∂–µ–Ω —Ä–µ–º–æ–Ω—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞\n–ó–∞–º–µ–Ω —ç–∫—Ä–∞–Ω–∞ –æ—Ç –ø–æ—Ç–µ–∫–∞\n\n[–ù–û–í–û–ï] –ö–ª–∏–µ–Ω—Ç: –ú–Ω–µ –Ω—É–∂–µ–Ω —Ä–µ–º–æ–Ω—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞\n–ó–∞–º–µ–Ω —ç–∫—Ä–∞–Ω–∞ –æ—Ç –ø–æ—Ç–µ–∫–∞",
        "current_state": {
          "type": null,
          "type_identified": false,
          "brand": null,
          "brand_id": null,
          "model": null,
          "model_id": null,
          "repair_type": null,
          "repair_type_id": null,
          "parts_owner": null,
          "estimated_cost": null,
          "stage": "–ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–æ–Ω—Ç–∞–∫—Ç"
        },
        "completeness": {
          "has_type": false,
          "has_brand": false,
          "has_model": false,
          "has_repair_type": false,
          "has_parts_owner": false,
          "has_cost": false
        },
        "missing_fields": "–º–æ–¥–µ–ª—å",
        "brands_list": "- Apple",
        "models_list": "",
        "repair_types_list": "- –î–∏—Å–ø–ª–µ–π\n- –ë–∞—Ç–∞—Ä–µ—è\n- –ó–∞—Ä—è–¥–∫–∞\n- –ó–∞–¥–Ω—è—è –∫—Ä—ã—à–∫–∞\n- –ö–∞–º–µ—Ä–∞\n- –ó–≤—É–∫\n- –ü–û",
        "available_brands": [
          {
            "id": "b808bcda-1db3-46ca-8f2b-9885fe4c0e42",
            "name": "Apple",
            "normalized_name": "Apple"
          }
        ],
        "available_models": [],
        "available_repair_types": [
          {
            "id": "9e1fa155-7982-42f3-9a2b-c625c0e899aa",
            "name": "–î–∏—Å–ø–ª–µ–π",
            "description": "–ó–∞–º–µ–Ω–∞ –¥–∏—Å–ø–ª–µ—è/—Å—Ç–µ–∫–ª–∞"
          },
          {
            "id": "34962870-282f-43ca-a99a-32d6279b65b6",
            "name": "–ë–∞—Ç–∞—Ä–µ—è",
            "description": "–ó–∞–º–µ–Ω–∞ –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä–∞"
          },
          {
            "id": "ab65d134-44cb-4d6b-9cc0-c75ffa0a607d",
            "name": "–ó–∞—Ä—è–¥–∫–∞",
            "description": "–†–µ–º–æ–Ω—Ç —Ä–∞–∑—ä—ë–º–∞"
          },
          {
            "id": "16842909-4f35-47d0-b92f-e86370a7aa32",
            "name": "–ó–∞–¥–Ω—è—è –∫—Ä—ã—à–∫–∞",
            "description": "–ó–∞–º–µ–Ω–∞ –∑–∞–¥–Ω–µ–π –∫—Ä—ã—à–∫–∏"
          },
          {
            "id": "28f9ac2e-e792-4d4c-97ed-47556a87eb80",
            "name": "–ö–∞–º–µ—Ä–∞",
            "description": "–†–µ–º–æ–Ω—Ç/–∑–∞–º–µ–Ω–∞ –∫–∞–º–µ—Ä—ã"
          },
          {
            "id": "1bd55721-5e70-4a8e-ae5f-2c1387e58dc9",
            "name": "–ó–≤—É–∫",
            "description": "–î–∏–Ω–∞–º–∏–∫/–º–∏–∫—Ä–æ—Ñ–æ–Ω"
          },
          {
            "id": "6cd94e2f-52d4-4b23-a071-7501f6f68106",
            "name": "–ü–û",
            "description": "–ü—Ä–æ–≥—Ä–∞–º–º–Ω—ã–µ —Ä–∞–±–æ—Ç—ã"
          }
        ],
        "sessionId": "07af5e27-4532-4d6b-bdff-6f8c089a76d5",
        "tool_type_result": {
          "type": "—Ä–µ–º–æ–Ω—Ç",
          "confidence": 0.9,
          "reasoning": "–ö–ª–∏–µ–Ω—Ç —Ö–æ—á–µ—Ç –æ—Ç—Ä–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å iPhone, —á—Ç–æ —è–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –ø–æ—á–∏–Ω–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞."
        },
        "tool_model_result": {
          "brand": null,
          "brand_id": null,
          "model": null,
          "model_id": null,
          "found": false,
          "message": "–ú–æ–¥–µ–ª—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞. –ü–æ–ø—Ä–æ—Å–∏ –∫–ª–∏–µ–Ω—Ç–∞ —É—Ç–æ—á–Ω–∏—Ç—å."
        },
        "tool_repair_result": {
          "repair_type": "–î–∏—Å–ø–ª–µ–π",
          "repair_type_id": "9e1fa155-7982-42f3-9a2b-c625c0e899aa",
          "found": true,
          "confidence": 0.95,
          "reasoning": "–ö–ª–∏–µ–Ω—Ç —É–ø–æ–º—è–Ω—É–ª '—ç–∫—Ä–∞–Ω'"
        },
        "tool_parts_result": {
          "parts_owner": "–Ω–∞—à–∞",
          "confidence": 1,
          "reasoning": "–í –∑–∞–ø—Ä–æ—Å–µ –Ω–µ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è, —á—Ç–æ –∫–ª–∏–µ–Ω—Ç –ø—Ä–∏–Ω–µ—Å–µ—Ç —Å–≤–æ—é –¥–µ—Ç–∞–ª—å, –ø–æ—ç—Ç–æ–º—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–∞–ø—á–∞—Å—Ç—å —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∞."
        },
        "extracted_data": {
          "type": "—Ä–µ–º–æ–Ω—Ç",
          "model": null,
          "model_id": null,
          "brand_id": null,
          "repair_type": "–î–∏—Å–ø–ª–µ–π",
          "repair_type_id": "9e1fa155-7982-42f3-9a2b-c625c0e899aa",
          "parts_owner": "–Ω–∞—à–∞"
        },
        "next_action": "ask_model",
        "chatInput": "–î–∞–Ω–Ω—ã–µ –æ–± –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞ (—É–∂–µ –∏–∑–≤–ª–µ—á–µ–Ω—ã):\n- –¢–∏–ø: —Ä–µ–º–æ–Ω—Ç\n- –ú–æ–¥–µ–ª—å: –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞\n- –ü—Ä–æ–±–ª–µ–º–∞: –î–∏—Å–ø–ª–µ–π\n- –ó–∞–ø—á–∞—Å—Ç—å: –Ω–∞—à–∞\n\n–ß—Ç–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç: –º–æ–¥–µ–ª—å\n\n–°–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞: \"–ú–Ω–µ –Ω—É–∂–µ–Ω —Ä–µ–º–æ–Ω—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞\n–ó–∞–º–µ–Ω —ç–∫—Ä–∞–Ω–∞ –æ—Ç –ø–æ—Ç–µ–∫–∞\"\n\n\n\n–¢–≤–æ—è –∑–∞–¥–∞—á–∞: –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –æ—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É.",
        "is_first_message": false,
        "should_greet": false,
        "response_text": "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –£ –Ω–∞—Å –µ—Å—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–º–µ–Ω–µ –¥–∏—Å–ø–ª–µ—è, –Ω–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–æ–¥–µ–ª–∏ –≤–∞—à–µ–≥–æ —Ç–µ–ª–µ—Ñ–æ–Ω–∞. –ú–æ–∂–µ—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Ç–æ—á–Ω–∏—Ç—å, –∫–∞–∫–∞—è –º–æ–¥–µ–ª—å —É –≤–∞—Å?",
        "reasoning": "–î–∞–Ω–Ω—ã–µ –∏–∑–≤–ª–µ—á–µ–Ω—ã –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–º–∏ –≤—ã–∑–æ–≤–∞–º–∏ tools",
        "parse_error": false,
        "should_call_approver": true,
        "approval_data": {
          "channel": "telegram",
          "external_chat_id": "1132511247",
          "appeal_id": "07af5e27-4532-4d6b-bdff-6f8c089a76d5",
          "client_name": "–†–µ–º–ê–∫—Å MD",
          "response_text": "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –£ –Ω–∞—Å –µ—Å—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–º–µ–Ω–µ –¥–∏—Å–ø–ª–µ—è, –Ω–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–æ–¥–µ–ª–∏ –≤–∞—à–µ–≥–æ —Ç–µ–ª–µ—Ñ–æ–Ω–∞. –ú–æ–∂–µ—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Ç–æ—á–Ω–∏—Ç—å, –∫–∞–∫–∞—è –º–æ–¥–µ–ª—å —É –≤–∞—Å?",
          "reasoning": "–î–∞–Ω–Ω—ã–µ –∏–∑–≤–ª–µ—á–µ–Ω—ã –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–º–∏ –≤—ã–∑–æ–≤–∞–º–∏ tools",
          "next_action": "ask_model",
          "appeal": {
            "id": "07af5e27-4532-4d6b-bdff-6f8c089a76d5",
            "client_id": "94f3bf7c-f2f3-4dc1-bdfb-e9d9d7a8ba93",
            "phone_brand": null,
            "phone_model": null,
            "malfunction_category": null,
            "malfunction_type": null,
            "problem_description": null,
            "appeal_status": null,
            "stage": "–ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–æ–Ω—Ç–∞–∫—Ç",
            "ad_channel": null,
            "ad_id": "null",
            "estimated_cost": null,
            "estimated_time": null,
            "appointment_datetime": null,
            "master_id": null,
            "qr_code": null,
            "livesklad_order_id": null,
            "synced_with_livesklad": false,
            "synced_at": null,
            "visited_at": null,
            "completed_at": null,
            "notified_2h_after_contact": false,
            "notified_1day_before": false,
            "notified_2h_before": false,
            "notified_after_completion": false,
            "notified_review_request": false,
            "notified_warranty_reminder": false,
            "created_at": "2025-11-15T09:21:40.489Z",
            "updated_at": "2025-11-15T09:21:55.139Z",
            "device_type_id": null,
            "brand_id": null,
            "model_id": null,
            "deal_type_id": null,
            "repair_type_id": "9e1fa155-7982-42f3-9a2b-c625c0e899aa",
            "ad_channel_id": "c5c20ca5-2d6e-42cf-8a5e-cec4a6a549a5",
            "operation_mode": "assist",
            "notified_": false,
            "type": "—Ä–µ–º–æ–Ω—Ç",
            "type_confidence": "0.00",
            "type_identified": false,
            "type_reasoning": null,
            "pending_operator_approval": false,
            "draft_response": null,
            "routing_history": [
              {
                "route": "partial",
                "action": "ask_model",
                "reasoning": "–î–∞–Ω–Ω—ã–µ –∏–∑–≤–ª–µ—á–µ–Ω—ã –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–º–∏ –≤—ã–∑–æ–≤–∞–º–∏ tools",
                "timestamp": "2025-11-15T09:21:55.117Z"
              }
            ],
            "parts_owner": "–Ω–∞—à–∞",
            "client_parts": false,
            "tenant_id": "a0000000-0000-0000-0000-000000000001",
            "location_id": null
          },
          "client": {
            "id": "94f3bf7c-f2f3-4dc1-bdfb-e9d9d7a8ba93",
            "phone": null,
            "name": "–†–µ–º–ê–∫—Å MD",
            "telegram_id": "1132511247",
            "vk_id": null,
            "whatsapp_id": null,
            "avito_id": null,
            "was_merged": false
          },
          "extracted_data": {
            "type": "—Ä–µ–º–æ–Ω—Ç",
            "model": null,
            "model_id": null,
            "brand_id": null,
            "repair_type": "–î–∏—Å–ø–ª–µ–π",
            "repair_type_id": "9e1fa155-7982-42f3-9a2b-c625c0e899aa",
            "parts_owner": "–Ω–∞—à–∞"
          },
          "completeness": {
            "missing": [
              "–º–æ–¥–µ–ª—å"
            ]
          },
          "propertyName": {
            "channel": "telegram",
            "external_chat_id": "1132511247",
            "text": "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –£ –Ω–∞—Å –µ—Å—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–º–µ–Ω–µ –¥–∏—Å–ø–ª–µ—è, –Ω–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–æ–¥–µ–ª–∏ –≤–∞—à–µ–≥–æ —Ç–µ–ª–µ—Ñ–æ–Ω–∞. –ú–æ–∂–µ—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Ç–æ—á–Ω–∏—Ç—å, –∫–∞–∫–∞—è –º–æ–¥–µ–ª—å —É –≤–∞—Å?",
            "meta": {
              "ai_response": "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –£ –Ω–∞—Å –µ—Å—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–º–µ–Ω–µ –¥–∏—Å–ø–ª–µ—è, –Ω–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–æ–¥–µ–ª–∏ –≤–∞—à–µ–≥–æ —Ç–µ–ª–µ—Ñ–æ–Ω–∞. –ú–æ–∂–µ—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Ç–æ—á–Ω–∏—Ç—å, –∫–∞–∫–∞—è –º–æ–¥–µ–ª—å —É –≤–∞—Å?",
              "reasoning": "–î–∞–Ω–Ω—ã–µ –∏–∑–≤–ª–µ—á–µ–Ω—ã –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–º–∏ –≤—ã–∑–æ–≤–∞–º–∏ tools",
              "appeal": {
                "id": "07af5e27-4532-4d6b-bdff-6f8c089a76d5",
                "client_id": "94f3bf7c-f2f3-4dc1-bdfb-e9d9d7a8ba93",
                "phone_brand": null,
                "phone_model": null,
                "malfunction_category": null,
                "malfunction_type": null,
                "problem_description": null,
                "appeal_status": null,
                "stage": "–ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–æ–Ω—Ç–∞–∫—Ç",
                "ad_channel": null,
                "ad_id": "null",
                "estimated_cost": null,
                "estimated_time": null,
                "appointment_datetime": null,
                "master_id": null,
                "qr_code": null,
                "livesklad_order_id": null,
                "synced_with_livesklad": false,
                "synced_at": null,
                "visited_at": null,
                "completed_at": null,
                "notified_2h_after_contact": false,
                "notified_1day_before": false,
                "notified_2h_before": false,
                "notified_after_completion": false,
                "notified_review_request": false,
                "notified_warranty_reminder": false,
                "created_at": "2025-11-15T09:21:40.489Z",
                "updated_at": "2025-11-15T09:21:55.139Z",
                "device_type_id": null,
                "brand_id": null,
                "model_id": null,
                "deal_type_id": null,
                "repair_type_id": "9e1fa155-7982-42f3-9a2b-c625c0e899aa",
                "ad_channel_id": "c5c20ca5-2d6e-42cf-8a5e-cec4a6a549a5",
                "operation_mode": "assist",
                "notified_": false,
                "type": "—Ä–µ–º–æ–Ω—Ç",
                "type_confidence": "0.00",
                "type_identified": false,
                "type_reasoning": null,
                "pending_operator_approval": false,
                "draft_response": null,
                "routing_history": [
                  {
                    "route": "partial",
                    "action": "ask_model",
                    "reasoning": "–î–∞–Ω–Ω—ã–µ –∏–∑–≤–ª–µ—á–µ–Ω—ã –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–º–∏ –≤—ã–∑–æ–≤–∞–º–∏ tools",
                    "timestamp": "2025-11-15T09:21:55.117Z"
                  }
                ],
                "parts_owner": "–Ω–∞—à–∞",
                "client_parts": false,
                "tenant_id": "a0000000-0000-0000-0000-000000000001",
                "location_id": null
              },
              "extracted_data": {
                "type": "—Ä–µ–º–æ–Ω—Ç",
                "model": null,
                "model_id": null,
                "brand_id": null,
                "repair_type": "–î–∏—Å–ø–ª–µ–π",
                "repair_type_id": "9e1fa155-7982-42f3-9a2b-c625c0e899aa",
                "parts_owner": "–Ω–∞—à–∞"
              }
            }
          }
        }
      }
    ]
  },
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "8ae77ca901b15c37bb42b26ea9b5a21b78217dd557a563108d875a64964c49bb"
  }
}